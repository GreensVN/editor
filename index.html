<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="theme-color" content="#0b0f14"/>
<meta name="color-scheme" content="dark light"/>
<link rel="manifest" id="pwa-manifest" href=""/>
<link rel="icon" id="pwa-favicon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMGIwZjE0Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzYzNjZmMSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJ1cmwoI2cpIi8+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS1vcGFjaXR5PSIwLjM1IiBzdHJva2Utd2lkdGg9IjYiLz4KICA8dGV4dCB4PSIxMjgiIHk9IjE0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkludGVyLHN5c3RlbS11aSxTZWdvZSBVSSxBcmlhbCIgZm9udC1zaXplPSI5NiIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iI2ZmZmZmZiI+UEM8L3RleHQ+CiAgPHRleHQgeD0iMTI4IiB5PSIxODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJJbnRlcixzeXN0ZW0tdWksU2Vnb2UgVUksQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSI2MDAiIGZpbGw9IiMyMmM1NWUiPklERTwvdGV4dD4KPC9zdmc+Cg==" type="image/svg+xml"/>
<link rel="apple-touch-icon" id="pwa-apple-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAbWElEQVR4nO2de3gU1d3Hf+fM7D3ZZHMBSYjccYNRiIqAAcGKF14pCGjBC4oI0tZq61utF2j7WGmt0teK7VuloL5abblpBbWAiFiRm1QUSJBbIAESCFly2Vz3Ou8fySZ7mdmd3Znd2dn9fZ5H9yGzM3Nm9nPmnDnznRliysqzAhAAIEBI8Cfl/TsA5fmuwDxAAEi4eWjId0XNE/Tdrk/+8vqmiZonaFrYeUKmUZ7vdn8KTuP/u/A2CswTobzB3+35LSPNw/f7C80T5vfiK2/I7y80jwgne+YR46Tf3ynKj/Knq/yr1wz5jqL8KH+6yg8AQFF+lD9d5YfuNaL8KH9ayh/UAqD8KH96yQ/Q0wKg/Ch/+skPAEBRfpQ/XeUHCDkHQPlR/vSRH4BnFAjlR/nTRX6AoBYA5Uf500l+AAA22eWvPLYxT8yGIMnL7LsP2pJRfgAAkp03yJpM8p86/jEKn+Lcde8RWzLIDwBAsvOGWJWWv+rEJkHpFyyyY4VQOatWmG1C0+65r9KmlPwAAMSSP9SqhPzVlZ/wih0s/Of/fuAI9vkFtsNve5O5z5+RUWT1/02FKsTcedW2RMoPAEAs+cN4WoDEyu8v/fbP7zvCu5Eovyrl5yuv0XhJT4UIrgz3PXDWlij5AQBITp/h1rArklH+6sqtvOJ/tv2eI7wio/wpJ3+wX3p9rpWvItw//5yI8wRp8ndXgMusiZa/R/zP7j4iKDLKn/Ly+39qtdkhFWHeg3W2eMoPAEBy+1qt8ZT/9MlPQ4762z6760hYkVH+tJLfv8+v0WRYg1uD+Qsv2oKXJYf83RWg2JoI+X1HfZQf5ReS3/fJssaQ1uDBhxptcssPAEDyLrk88BwgTvJv2zbnSMgORflRft5pXX9nGG1Aa7Bgkd0mp/wAwWE4lB/lTxL5CSHg9bqP+I8Qrlphlv2aEEX5Uf5klN/3yXHegErQ2lQ/QdYKgPKj/Mkqv+/vq9cM+We8KgFF+VH+JJf/OwCIWyWgcsjf9Ynyo/zxkd9HcCWQAyrnRS6UH+WPl/w+/CuBHK0Az3OBYpO/B5Qf5Y+T/HxIrQSUr8Diuz2kZ0F4hRflT5T8cnaFqBT5falOlB/lT5T8PuTqClHejY9Cfh8oP8qfKPn5iLUS0Fjk7/rsYsEiex6mOlF+JeSXoytEY5OfBi4F5QeUP7Hyy0VIFEKM/L57eBcssufhzSwov5LySz0XoNHK37VTekH5UX41Hvl90OAdGlF+ElgBUH6UX63yA3RHIaKR3/fcngWL7Hl4AzvKnwzyS+kGiQvDBexIf1B+lF9Z+aVCo5KfBFYAlB/lV7P8AMHDoBHk79pJ/qD8KL965QcIiUKEl9/3oNoFi+x5+MQ2lD+Z5I/1PICKlb9Lyl5QfpQ/WeSXQmgYLoyUgaD8KL+65QcIDsNFFLkXlB/lV7v8AP5hOBEiB4Dyo/wqlx/ANwokRmTeFgDlR/nVKz8ATxRCWP7ACoDyo/xqlx8gKAoRTn4SVAFQfpRf7fIDhLQAYeQPGgZF+VF+tcsPENAChJe/a0f2gvKj/GqXH6CnBRAhPwmsACg/yh8HHxMOFSt/1w71B+VH+dUP5d1IgR/MH5Qf5U8FQsNwYX8wf1B+lF/9BLYAEUXuBeVH+VMBKl7+oBYA5Uf5UwAqVv6uHdILyo/ypwKUhPvBgnZMACh/wHdRfnVCo0p1+oHyo/ypgLgwXI98fqD84uZB+ZMayvcj88nftdN7QflR/lQgfBguZJofKH/4eVB+VSAchuMVoBeUH+VPBfjDcALSBIDyo/wpQGgYLqw0/qD8KL/64YlCCEgT1AKg/Ch/KiDwggwRYTiUH+VPAfyiEBHkDxoFQvlR/lQgZBhUWH6+FgDlR/nVDRWUJkh+ElQBUH6UPxUQF4brEdUPlJ9nHpRfbUQOwwX8mL2g/Ch/KhA+DBcirB8ov98nyq9WhMNwfFL6gfKj/KkAfxhOQMoAUH7+bUf5VUVoGC6clH6g/Ch/KhAYhosgZdCsKD/Kr3rYqFKd/qD8qpI/KyuLG3nlFZ5RI6/0DBo4wFvYv5ArLCjw5ubmcEaDgdMbDKDX6TiXyw1Op4M02+2kvt5Gzp0/TysrT9Ljx0/Qb749wJRXHGZcLpcM6iUHrGj5g1oAJeVf8sz1SydNHDg5njuG4zivy8W5XC6vs73d09bU7GxobHTZamo7q2tqOqqOV7Ydrq3prOI4wiWj/FqtFsquG+eecuvN7ptu/J5r6NAhXhLSioei02lBp9NymZmZXP/CQiiFkR7/6Z2dDtizdy/z6bbtmk1bPtEcPXqMCi1LDbBiRQ7fAiT2yA/BZYkDhBCq1RKdVkt1JhObmZ+vuyT4O812h/3Qodbdu3Y3bTtwsGW3ywUupeUfNmyod8H8ec577prtzM7O5uTeL3q9DiZNvN4zaeL1nqW/+XVnRcVhWL12vf5v7/5da7NdjP8PIzNUvPzRheHi2+1JDrLMOvP4stxbfvH4kBf/tHz4R7Nm5i8wmdhMJeS/8ooSz3tr/9H2zb7dLQ//aJEjHvLzcfnlI+C5Z3/VebTiQPNfX/1z62WXDfcmYr1yQcNK6S9/cPOpmPwkpCjJQI7FmDX7zsIFLy0b+MH3JplmE0pIIuTv27cP98bK19p3fvFZ6y03T3Yrs/UAOp2O3H3XbM++3TtaHv3Jj5qVKke0ULHyBx95FT/hTVKys02mhxYOfuzRh7Wvm82sJZ7yz5p5u2vf7h0tP7hzlktM/z4RUEphQFFhlcvRUaF0WcRAo0l1BoDyh2Xc2KEjFj+VsTo7q32o3PK/9771u7/8eXnHW2+sbM/JyUlIVydavF6PXekyiIEnCsEvf2gLoJD8fPcmJCmXXtov61dLClca9PXD5ZJ/yyfXHN74z3Vt9917t1OxDUsh+MNwIoZBlZI/uCImO5dc0sfws0ezlrvddflyyL/lXxvaJowvU6yvn2qEtgDhrvD6oZj8SdLXjYaSkhGWieOP/c7t7tTEKv9HH488/MF7a9pGFBd7wqwKiZLAFiBCvCEAheRXayVYtGhuSXvb6jtjkX/N2qHf/e3/Xm+/+qpSlF9mWLHyh3Y9lIw3qA9KKbn37pJZf3v32FZLjrVerPyr1wz57qlf/Nxx0+TvydrtaW5udm3evPnCzp07L5aXl9tPnTrV3tDQ4Gxra/NoNBpqNBqZ/Px87aBBg0zDhw/PGDt2rGX8+PG5RUVFBjnLoTSsaPmDjrrKyd89LUYWLlz4zapVq6rDfSczM5O1WCyakpISc1lZWe79999/aWFhoT7mlXYzc+aMghdenHezJefFd8XKP3bstZ6nn3yiU+q6fezdu7dx2bJlxz/88MPzLpeLZVhtAWXZwZSyFkqZDJ0pW0cIYR0eznvmnM19uvZC5+c7drW+tvJ1u9ftPnbllSUdM2fMsMyfP39Av379JO8TpWGjSnX6o5T8RHr0pPSqX2waOPj7B8IF29zuTq3L1aLftKUy/x+rf3PpTZNzZyxduuRqo9HIxLpehmHI+LK8iecu2D4wGPq0RZKfYRh4+X+WdTBMzKvsoba2tvOxxx47tHbt2hrKsHkaneF6o8FcBMGX+HsgDCHAEMLogDJZDEAhaKH46Ilq+O3v/9Dw2+dfPD1t6hT7kiVLBpWUlJglF1AhBIZBZQrDxUF+WTpAvhNRAfkBKGg0JqfR2M9eUDihckTJw9trzs/+6Q9//NZLra2tkroikyff2Kfq1MZiMfGGBQ8+4Cy5fITkfv/27dtto0aN2r5u/fpGnTFzoiEj+zZWoxsAgvKHhzJsDmW1oz7avG3C6LFlnnvuvfdwTU2NbK1UIuEZBhW+whuAYvJL6wJ1Fz6s/Hxj9oSwnNM98b3/fbXiz1LWXFZWlnuu9ouBkeTX6bTw5OP/LVmqDRs2nLv11lt3NTQ2WQwZ2d9nNbqBUpfpB2FY7cANH20ZN/Kqazr++PLL1V6vNykvzAkhKgzXc8Lrh1Lyy3LJn4BAGSJHmg8czFpzorL+bKyrtlgsGo6rGhop1XnX7B84+/TJlyTTl19+efHOO+/c5+GgUG/KuokQGrc+e6fDPXDJr5eOuPmWKWerqqra47UeuYkYhvMf7QlAMflJSFGiJVb5u1sf7sBBulnK+ov65+Z0dNhM4fL8D/94kaQrvRcuXHDMmjXrKy8HeXqjeRLE2N2JBkIIu2ff/pKX//TqYEqZjHivTw7ChuFChjr9UPxOLknEJr9vWmWlQ1LQKycnR9vaUp0tJP8VJZd7iq1WSX3/Rx555GB9vY3ojJk3QALk94dhNX01OsMViVxnrAiG4fjG+QNQrfw9GxCT/IRQaLZ7G6Ss2WQyMQ5Hk17oNsbbp0+TdM/h3r17G9euXVujNZjGxLPbkwrwjgIJXuTyQzH5ZQnDxS4/APE9U14SHk+HRuge3u9PnSJppGnp0qVHKcPmyXzCm5KEjAKFu8IbgELyB1fEWOjalNjv4TWbGYuU9be1tXl27nrkj3zTsrKyOCndn5qams5NmzbVafXGkbGXMH2gYuXnDcMpIb/0gy9IvYF92DC9pP5tQ0ODkxDC8k0bfc1VHikNzPr162u8HGdgWG1hzAtJI2ivVJGzPYEoI78clYB0/z8W+SkldPTVpklS1n/y5Mk2QqiOb9pVpaMknfxu3rz5QvdFLjmOFCkPFSt/SNdDQfll6ATFJD8hBMaXZU4pLNQMjnXNDQ0Nzrq6OgehlHeYcNCgQZJuKt+zZ08Dw2rw6C8SGk2q0x/l5O+eJgUCEIv8Q4foS+bdl/OElFXv3LmzgRCiI4TypioHXFoUcwWoqqpqb2pqclFGkx97CdMLnucC8csf2gIoJb8cQ9rRyc+ylLnxhsyZs39g+YlWS3i7LmLZunXrBcpq+ghNL+rfP+YKcOrUqXZCmQxCiDbWZaQbrHj5w7UAiZNfjmsBkeTX6xlDhokx9++vHXzZcMPICeMzbrNYGMlHVY/Hw61du7aGYTWCIzRmsznm+ENNTU0HFehaIfyIezJct5QBqFT+lStXlgLACkkLiZH333+/tq6uzmk05wwU+o7BGPv9Js3NzS5CqDHmBaQhkcNwAcL2opT8soThFMDr9XLPPffcUVajGyDU/wcAMOj1MbcAnZ2dXuz+REf4MFyQlAEoJr86K8Err7xy8tChQy0aneHKeK2D4zgAQqTfPZNGCIfheI/wvaD84ikvL7cvXrz4sEZnKKYMawn33Y7Ozpg30GAwqPpJzUrAH4YTkDIAxeRXz4OxAADq6uocU6dO3dPpcGRqdcbSSN/vaO+IeV1ms1kDHIdPjoiC0DBcWCl7UUx+FbUAp0+f7pgwYcKO06fPcHpj1o0gEH/wx263x7yBhYWFeo7jUuftFQmAipY/5GZ0ZeQProjJyrZt2+rHjBnz7xOVlZw+I+tWoSu/wZytqYm5GzNo0CATx3lVczdWMkDFyh/SAiglvwxDofGksbHR9eijjx68+eabd9XbLloMGdm3UcqIfmpC9ekzUiqAMTMzM/Y+VBrCipY/pOuhjPzJ2gLU19c7Xnvttarly5dXNjQ0gEZvHK3RGqwQZW09deqUpBPZMdeO1u7Y/R8nDoeKgxUrf4h4islPkuY04OLFi86tW7deWLduXe3HH3983ul0aVmtvtiQmVNMSGyRif3ffCtpGHPKlCl9//3lbhvDagukLCddYKNJdfqjnPyJ6QJxHAdOp9PrcDi8zc3Nrrq6OkdtbW3nsWPHWg8fPmzft29fU0VFhR0AdAyrLWA0uuuN5oz+ANLG4b/a9zXDcVzMw7133HFH4ZNPL64GAKwAIhAIwwld5PJDMfmlDXWLeTSi30YCw2g9lNG6tRqzw2Ds097YVDGaUsZMKVOkN2XnUYbJllSgIJqbm8mRI0dpcbE1plBcYWGh/qYbb2jfvmMPB8l8spQk8IThwlzh9UMp+eVoAcZd98KmocPvPsBX3khPbNMb4/8UwA8/3qQpLrY6Yp1/8eLFAz6dfEsNw2r7y1muVISKlj9SGE4l8ncXnre8yfIG9g82bNRImX/s2LE506b+V61c5UllqFj5CW8LkHj55YlCJK/8AAAHD5Uz3x05KmkZryx/eWB2VqbIrl76QkXLH3IOoJT8MlQCApCs8vv4y6srJD2Hv2/fvrp/vPMWx7JMQh9aW3bdOPfPH/tpzN23REOjSnX6oVr5faVPYvkBAP6+eo22vr5e0v3BEyZMsLz1+l/PaTSauL+82mQycc//9jedmz76oK2of2Gby9FxKN7rlIOQKEQ4kQNRSn7pYTjS0wIkp/wAAA6HE174w0uS38Yyffq0nPfX/r02Ly83LiE5QgjMmnm7a/++Xa2PPPwjB6UUPG7nGa/X0xqP9ckNFSt/SAuglPyytQDJK7+Plave1JdXVEgOt91ww6TMXV9sb7h92lTZckIMw8D0aVNdu7/8vPWtN1a2FxYUxL2ViQdUtPyxhOHiIH9wRYwN/u5bMskPAODxeOCxnz+Z7fVKd6ugoJ/2nbffdH32yb8uTp821aXVxpaUGFFc7HnmqScchw/tb3n37Tfb5XiBh5KwYuUXagESL7/vPykkv/w+du/Zyy793e/dv1ryTMQotRiuvXY0++7bb7Y3NTdzn376mWbPV19pyssP09Onz9CGxkbS0dFBWJYBg8HI5eXlcgMuvdQ7bNgQ7zVXXeUeN26sR8pjW5IRVrz8oecASsgvx0lw7zlAcsvv4w8vLc8dN+ba8zfdNFm2NzRmZ2WRO2bNcN8xa0Zav3SbipU/NAqhlPxyVAL1yA8A4PV6Ye4DC/t8/fXXbUqXJdUIHQYVlD+oC6SY/NJve+1dZvLL76O1tZVOnzUnr7yiAiuBjIQPw4U76iomvxwnwSBJ/unTdlUbDH17ug7ffLM07+ixN7OEpgMAcJyHeDwO4nK10I6OOsZur9Ser9tpOHPmXxkej0Nwo4KX9fIrAAB23pteBg9i2GeeMmXHsk3pinAYLkTKMC1AAuXnK0vUEJLwIz8hDMeyRo5ljV6Doa87J+dKx8CBM1pKRy2+eODgizknT65V7bt21Qx/GI5PfqEwnNrkB4B9+555TvJCZEKns3iuHf18/dVXP2tTuizpCCtWfsLXAiggvzxRiMTi6yIxjIEzmQrc/fpNbLNetrDJYOjTM4Y+bOi9za0tVRr/rlS4Zfn+nZdrqX5+6bMdc+bM6ZcM+4bjOKisrGwDufqqcYaKlj9k5yolvzorAQCAx9NB7PZKzdGjb2Rv+WRqkd1+IuBqVEnJzxq02uyoxtltFxsHLPjhTwZcO2bcsc2bN9fJW2LxOJ1O7zvvvHOmpKRk27Jly45TymQqVZZooFGlOv1A+aXR2XmR2bP38YDHpGs0Gd4BA6a1RLssQqjhu2OVo2feeVfeFVeMLF++fHllY2NjQp4PVFFR0fL0008fLioq2jJ37txvjh2vzDdkWqZrdIaSRKxfKqxo+UPEU0p+dT0ZLhwNDYd0zc3HtFlZw3teit2373Udx4+/LdgNKi1dYistXcJ7vrBr90/7njr9UdnTv3y2efEvf32sbNyYpttuuy13ypQpfYcNGybLY9OdTqd3z549jVu2bKnbuHHj+fLycjtlmGxWo7/caM4ZprbXsrJi5Q/fAiRW/r+81rhkzpw5+6pObSyOZaN1hoykeYVQY9NhnX8FMJkKJV+ZpZTJAmBG79y73/vFzr3nH3/iqbPmTFPdqFEjmdLS0qwhQ4aYioqKDP379zfk5eXpDAYDNRgMjF6vZ9xut+9BAO4LFy44amtrO06cONF29OjR1v379zd9++23zQ6HAxhWk8+wmqGGDEuR3PdFJxJWvPxCYbjEyu/728QbVmyYeMNfN6gh1RkOl7MlYMdqNZlyZm0ow2oKGFZT0OkG2L3vW+fOPf+56PW4G7xeTyPn9Z7lOG87x3k7geM8HIC7+9milBBCgRAtIVRPCDVShskklLmM0RhyTfoMC0h8+kWyIC4M1yNyL0rKH3kedcgPAKDVmgPSlE5XS/CRJoDgUaBoIIRoGVbTj2E1/WKZPxWh4uUPHQVC+aVjsVzu9P93W1uNLKlPRBzhw3DhbkZH+SWTm1vaaTYPDagAdXW7ZEt8IpERDsPxiOwPyi8NvT7PM3bMixf8/+ZytdLq6o2qGD9PFfjDcGJuRkf5o4ZhdJzRWOguKJjUVmx9qEmvzw/o/5eXv5zjdDbhW14SSGgYLuzN6L2g/OIJN3bv4/iJd7LEnNxGWta69SMGh0uXIoGwouUPbgFQfllwOBqZAwdeyD15ah12fRSAFSs/CT4HQPmjguM84PU6idNpZzo6LjD2lkrt+fNfRrwfAIkvrGj5Q1qA9JV/w8brBkiZLue6EGnQ6FKdvaSr/EhqQcXLL3QOgPIj6oWKlT94GBTlR1IBKl5+EWE4lB9RGVSs/PwtAMqPqBsqXv7QUSCUH1E7NJpU5+y7D9oAAFatMNsyMoqsKD+SLMyZXTlj1QqzDQAgIzt/h9j5qFj5+U6EUX5E7Qi8IENkHgjlR1QOzwsyos0DofyIeqHRyE+AwF33Huk5DzAaL7Gi/IjSxNr/BwgaBo14VZjnPADlR9QMjV7+cCfCKD+iLsSF4YKEvee+yp5ukF6fa0X5EaWQ0v0BEBOGExS5F5QfUSvhw3BhRPaxaoXZptVmC5wMo/xI/PA/+seKcBgugshz51UHrBjlR5Qklu4PgFAYTpTIBO574GzPuYBGk2FF+ZFEIbXv7yM0DCdS/uCnNK9aYbaxrNGK8iPxRo6ujw8qRX5CCNw//1xQQVB+JHFIOfoD8EYhxMvv+5z3YF1PV4hhtFaUH4kXcnV9fFCp8vfO08WqFWYbpawV5UfkRs6ujw8qj/wE5i+82FOwVSvMNkKoFeVH5CJYfjmO/gABw6DSU50PPtQYUAnmzK6cIUchkfQmXvID9LQA8kWaFyyyYyVAZCOe8gMA0Hjk+f0LiZUAiZV4yw8g8JI8ObI9Gdn5O1qb6icAdFUCgK5KsHrNkH/KvRFIauE7YMZbfgCel+TJGWwLrQQAAJUzsBIgQvCN9MRLfgDeFkDeVKev8NgaIOFI5FHfHzae8vsj1BoAYEVIZ/jEB0iM/AABLUD88/z8rQGAryIAYGVIB/wHRZQS3werxM0s/q0BQPBOCBwxwgqhfoJHAYWu5iZafgAAVqk7ufw3VrgyAARXCER9hIsvKCG9P2TuvLPWRMsfDv/KgKQmSkvvD88wqLJ5/uCdgxVC/SST8MGwySQ/H8m88xD1IyIMh5FmJHWJEIZD+ZHUJkwYDuVHUh+e5wKh/Ej6wPNkOJQfSR9CbolE+ZF0gqL8SDpDUX4knaEoP5LO/D+7cZoYpFDXgAAAAABJRU5ErkJggg=="/>

<script>
/* Single-file PWA bootstrap (manifest + icons are embedded) */
(() => {
  const BUILD = "19.0.6-singlefile";
  const ICON_192 = "data:image/png;base64,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";
  const ICON_512 = "data:image/png;base64,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tKq7q62prfXZA2bOWvqxF/JXVaZ88az1j0cii1OF9uQHent7U3fcccean/70p629vb0F9cSYElUUtYEpSj1T1DpFUeuZotQxxkLEWIgRU4kxjTEWIqJMJpNJUiaTzFAmRZlMkohSmXS6P51J92bSqd5MOt2bSad705lUTyad7jMb97333ut87733Om+55ZZV55133sR//Md/nHHccceNKaQXEGx0OwH6T/5GIH938sdKgFN6enqS//u//9t67733brzhhhtm3H777Qvq6uo0r+vKh4suumjyLbfc8kk6nc6sXP6TY2bOWrKKaGgrwBCllz9jjJoa7/7gkIPvHChOV97yhz/8Yef111+/fPPmzcKWJCcoitqgaKFxqqq1KFqoRVHUBhcvZ4yxMDEWNnyiVZLuUZnJZOLpVHLPyL9UKrknk04ZdkSMx+PpZcuWbV22bNnWww47rPGb3/zm7PPPP3+SpmlYaFQZhlMBD/1VDvm7nc8gf9fyx0fZNYlEIv1f//VfGxYuXPjXV199dY/X9eTD5MmTa44//vgxRERdXa2j21p/v7Dc8n/11eNW/et3bo0Xox8v2bFjx8D555//zllnnfWWW/krqtoYjsYOidU3nVtT37QkUlN3jBaOznYpf9cwxiKqFpoYitQcFInVnxCrbzov1jD6S5Ga+mO1UGQ6Y8yw6f/999/vvPjii9+bO3fui/fdd9/GwcHBdCnrA/5C80T+ruQE+ecn/2CuAZx82sP31ddPG5avsSfh5yAiIiZ574T4of9T6UEtkx7Ukon+0MDAntr+/o763t5tjfs7143dv39dS+e+T8dlMmm2ZcuW/pNOOum1//7v/z7o+uuvn1mqXkvFkiVLJr700ksdRESrVv7sH2bOOndVueT/6ydmrX74gV/21dbWZorWkAe89tpre5YuXfpOe3u74xUZxlhIC0fnaqHILEXVmkpZnxsYU2q0cGSWFo7MIqJMKpXYnUoktqUS8U3pdGo/EVFbW1vftdde+9Edd9zx6fe+9735V1555dRK20kWiGQ3c5ZX/i7mK8jfeW6hpyDCC6c48idGpKmRJKmRZCjUMFATG9fdRGxnbhIzSgx2R3ften/qtq1/nbdt69/m3nDDDSt6enpSN998c6DOW6//XXffvtUt+/ataWlqWrCrHPI//LBDU+cu+aKvd46z4xe/+MXGG2+8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";
  const FAVICON = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMGIwZjE0Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzYzNjZmMSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJ1cmwoI2cpIi8+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS1vcGFjaXR5PSIwLjM1IiBzdHJva2Utd2lkdGg9IjYiLz4KICA8dGV4dCB4PSIxMjgiIHk9IjE0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkludGVyLHN5c3RlbS11aSxTZWdvZSBVSSxBcmlhbCIgZm9udC1zaXplPSI5NiIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iI2ZmZmZmZiI+UEM8L3RleHQ+CiAgPHRleHQgeD0iMTI4IiB5PSIxODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJJbnRlcixzeXN0ZW0tdWksU2Vnb2UgVUksQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSI2MDAiIGZpbGw9IiMyMmM1NWUiPklERTwvdGV4dD4KPC9zdmc+Cg==";

  const manifestInline = {
    name: "ProCode IDE ULTRA+",
    short_name: "ProCode IDE",
    description: "ProCode IDE v19.0  Hyper Ultimate ULTRA+ (single-file)",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0b0f14",
    theme_color: "#0b0f14",
    icons: [
      { src: ICON_192, sizes: "192x192", type: "image/png" },
      { src: ICON_512, sizes: "512x512", type: "image/png" },
      { src: ICON_512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ]
  };

  const manifestFile = {
    name: manifestInline.name,
    short_name: manifestInline.short_name,
    description: "ProCode IDE v19.0  Hyper Ultimate ULTRA+ (offline-capable)",
    start_url: ".",
    scope: ".",
    display: manifestInline.display,
    background_color: manifestInline.background_color,
    theme_color: manifestInline.theme_color,
    icons: [
      { src: "icons/icon-192.png", sizes: "192x192", type: "image/png" },
      { src: "icons/icon-512.png", sizes: "512x512", type: "image/png" },
      { src: "icons/icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ]
  };

  try {
    let link = document.getElementById("pwa-manifest") || document.querySelector('link[rel="manifest"]');
    if (!link) {
      link = document.createElement("link");
      link.rel = "manifest";
      link.id = "pwa-manifest";
      document.head.appendChild(link);
    }
    // Use a blob URL to keep everything in one file.
    const blob = new Blob([JSON.stringify(manifestInline)], { type: "application/manifest+json" });
    link.href = URL.createObjectURL(blob);
  } catch (e) {}

  try {
    const ico = document.getElementById("pwa-favicon") || document.querySelector('link[rel="icon"]');
    if (ico) ico.href = FAVICON;
  } catch (e) {}

  try {
    const apple = document.getElementById("pwa-apple-icon") || document.querySelector('link[rel="apple-touch-icon"]');
    if (apple) apple.href = ICON_192;
  } catch (e) {}

  // Expose embedded assets so the app can export a PWA bundle (sw.js + manifest + icons).
  window.__PWA_ARTIFACTS__ = {
    build: BUILD,
    faviconSvgBase64: "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiB2aWV3Qm94PSIwIDAgMjU2IDI1NiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjMGIwZjE0Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzYzNjZmMSIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJ1cmwoI2cpIi8+CiAgPHJlY3QgeD0iMTYiIHk9IjE2IiB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgcng9IjUyIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS1vcGFjaXR5PSIwLjM1IiBzdHJva2Utd2lkdGg9IjYiLz4KICA8dGV4dCB4PSIxMjgiIHk9IjE0MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkludGVyLHN5c3RlbS11aSxTZWdvZSBVSSxBcmlhbCIgZm9udC1zaXplPSI5NiIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iI2ZmZmZmZiI+UEM8L3RleHQ+CiAgPHRleHQgeD0iMTI4IiB5PSIxODgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJJbnRlcixzeXN0ZW0tdWksU2Vnb2UgVUksQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSI2MDAiIGZpbGw9IiMyMmM1NWUiPklERTwvdGV4dD4KPC9zdmc+Cg==",
    icon192Base64: "iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAbWElEQVR4nO2de3gU1d3Hf+fM7D3ZZHMBSYjccYNRiIqAAcGKF14pCGjBC4oI0tZq61utF2j7WGmt0teK7VuloL5abblpBbWAiFiRm1QUSJBbIAESCFly2Vz3Ou8fySZ7mdmd3Znd2dn9fZ5H9yGzM3Nm9nPmnDnznRliysqzAhAAIEBI8Cfl/TsA5fmuwDxAAEi4eWjId0XNE/Tdrk/+8vqmiZonaFrYeUKmUZ7vdn8KTuP/u/A2CswTobzB3+35LSPNw/f7C80T5vfiK2/I7y80jwgne+YR46Tf3ynKj/Knq/yr1wz5jqL8KH+6yg8AQFF+lD9d5YfuNaL8KH9ayh/UAqD8KH96yQ/Q0wKg/Ch/+skPAEBRfpQ/XeUHCDkHQPlR/vSRH4BnFAjlR/nTRX6AoBYA5Uf500l+AAA22eWvPLYxT8yGIMnL7LsP2pJRfgAAkp03yJpM8p86/jEKn+Lcde8RWzLIDwBAsvOGWJWWv+rEJkHpFyyyY4VQOatWmG1C0+65r9KmlPwAAMSSP9SqhPzVlZ/wih0s/Of/fuAI9vkFtsNve5O5z5+RUWT1/02FKsTcedW2RMoPAEAs+cN4WoDEyu8v/fbP7zvCu5Eovyrl5yuv0XhJT4UIrgz3PXDWlij5AQBITp/h1rArklH+6sqtvOJ/tv2eI7wio/wpJ3+wX3p9rpWvItw//5yI8wRp8ndXgMusiZa/R/zP7j4iKDLKn/Ly+39qtdkhFWHeg3W2eMoPAEBy+1qt8ZT/9MlPQ4762z6760hYkVH+tJLfv8+v0WRYg1uD+Qsv2oKXJYf83RWg2JoI+X1HfZQf5ReS3/fJssaQ1uDBhxptcssPAEDyLrk88BwgTvJv2zbnSMgORflRft5pXX9nGG1Aa7Bgkd0mp/wAwWE4lB/lTxL5CSHg9bqP+I8Qrlphlv2aEEX5Uf5klN/3yXHegErQ2lQ/QdYKgPKj/Mkqv+/vq9cM+We8KgFF+VH+JJf/OwCIWyWgcsjf9Ynyo/zxkd9HcCWQAyrnRS6UH+WPl/w+/CuBHK0Az3OBYpO/B5Qf5Y+T/HxIrQSUr8Diuz2kZ0F4hRflT5T8cnaFqBT5falOlB/lT5T8PuTqClHejY9Cfh8oP8qfKPn5iLUS0Fjk7/rsYsEiex6mOlF+JeSXoytEY5OfBi4F5QeUP7Hyy0VIFEKM/L57eBcssufhzSwov5LySz0XoNHK37VTekH5UX41Hvl90OAdGlF+ElgBUH6UX63yA3RHIaKR3/fcngWL7Hl4AzvKnwzyS+kGiQvDBexIf1B+lF9Z+aVCo5KfBFYAlB/lV7P8AMHDoBHk79pJ/qD8KL965QcIiUKEl9/3oNoFi+x5+MQ2lD+Z5I/1PICKlb9Lyl5QfpQ/WeSXQmgYLoyUgaD8KL+65QcIDsNFFLkXlB/lV7v8AP5hOBEiB4Dyo/wqlx/ANwokRmTeFgDlR/nVKz8ATxRCWP7ACoDyo/xqlx8gKAoRTn4SVAFQfpRf7fIDhLQAYeQPGgZF+VF+tcsPENAChJe/a0f2gvKj/GqXH6CnBRAhPwmsACg/yh8HHxMOFSt/1w71B+VH+dUP5d1IgR/MH5Qf5U8FQsNwYX8wf1B+lF/9BLYAEUXuBeVH+VMBKl7+oBYA5Uf5UwAqVv6uHdILyo/ypwKUhPvBgnZMACh/wHdRfnVCo0p1+oHyo/ypgLgwXI98fqD84uZB+ZMayvcj88nftdN7QflR/lQgfBguZJofKH/4eVB+VSAchuMVoBeUH+VPBfjDcALSBIDyo/wpQGgYLqw0/qD8KL/64YlCCEgT1AKg/Ch/KiDwggwRYTiUH+VPAfyiEBHkDxoFQvlR/lQgZBhUWH6+FgDlR/nVDRWUJkh+ElQBUH6UPxUQF4brEdUPlJ9nHpRfbUQOwwX8mL2g/Ch/KhA+DBcirB8ov98nyq9WhMNwfFL6gfKj/KkAfxhOQMoAUH7+bUf5VUVoGC6clH6g/Ch/KhAYhosgZdCsKD/Kr3rYqFKd/qD8qpI/KyuLG3nlFZ5RI6/0DBo4wFvYv5ArLCjw5ubmcEaDgdMbDKDX6TiXyw1Op4M02+2kvt5Gzp0/TysrT9Ljx0/Qb749wJRXHGZcLpcM6iUHrGj5g1oAJeVf8sz1SydNHDg5njuG4zivy8W5XC6vs73d09bU7GxobHTZamo7q2tqOqqOV7Ydrq3prOI4wiWj/FqtFsquG+eecuvN7ptu/J5r6NAhXhLSioei02lBp9NymZmZXP/CQiiFkR7/6Z2dDtizdy/z6bbtmk1bPtEcPXqMCi1LDbBiRQ7fAiT2yA/BZYkDhBCq1RKdVkt1JhObmZ+vuyT4O812h/3Qodbdu3Y3bTtwsGW3ywUupeUfNmyod8H8ec577prtzM7O5uTeL3q9DiZNvN4zaeL1nqW/+XVnRcVhWL12vf5v7/5da7NdjP8PIzNUvPzRheHi2+1JDrLMOvP4stxbfvH4kBf/tHz4R7Nm5i8wmdhMJeS/8ooSz3tr/9H2zb7dLQ//aJEjHvLzcfnlI+C5Z3/VebTiQPNfX/1z62WXDfcmYr1yQcNK6S9/cPOpmPwkpCjJQI7FmDX7zsIFLy0b+MH3JplmE0pIIuTv27cP98bK19p3fvFZ6y03T3Yrs/UAOp2O3H3XbM++3TtaHv3Jj5qVKke0ULHyBx95FT/hTVKys02mhxYOfuzRh7Wvm82sJZ7yz5p5u2vf7h0tP7hzlktM/z4RUEphQFFhlcvRUaF0WcRAo0l1BoDyh2Xc2KEjFj+VsTo7q32o3PK/9771u7/8eXnHW2+sbM/JyUlIVydavF6PXekyiIEnCsEvf2gLoJD8fPcmJCmXXtov61dLClca9PXD5ZJ/yyfXHN74z3Vt9917t1OxDUsh+MNwIoZBlZI/uCImO5dc0sfws0ezlrvddflyyL/lXxvaJowvU6yvn2qEtgDhrvD6oZj8SdLXjYaSkhGWieOP/c7t7tTEKv9HH488/MF7a9pGFBd7wqwKiZLAFiBCvCEAheRXayVYtGhuSXvb6jtjkX/N2qHf/e3/Xm+/+qpSlF9mWLHyh3Y9lIw3qA9KKbn37pJZf3v32FZLjrVerPyr1wz57qlf/Nxx0+TvydrtaW5udm3evPnCzp07L5aXl9tPnTrV3tDQ4Gxra/NoNBpqNBqZ/Px87aBBg0zDhw/PGDt2rGX8+PG5RUVFBjnLoTSsaPmDjrrKyd89LUYWLlz4zapVq6rDfSczM5O1WCyakpISc1lZWe79999/aWFhoT7mlXYzc+aMghdenHezJefFd8XKP3bstZ6nn3yiU+q6fezdu7dx2bJlxz/88MPzLpeLZVhtAWXZwZSyFkqZDJ0pW0cIYR0eznvmnM19uvZC5+c7drW+tvJ1u9ftPnbllSUdM2fMsMyfP39Av379JO8TpWGjSnX6o5T8RHr0pPSqX2waOPj7B8IF29zuTq3L1aLftKUy/x+rf3PpTZNzZyxduuRqo9HIxLpehmHI+LK8iecu2D4wGPq0RZKfYRh4+X+WdTBMzKvsoba2tvOxxx47tHbt2hrKsHkaneF6o8FcBMGX+HsgDCHAEMLogDJZDEAhaKH46Ilq+O3v/9Dw2+dfPD1t6hT7kiVLBpWUlJglF1AhBIZBZQrDxUF+WTpAvhNRAfkBKGg0JqfR2M9eUDihckTJw9trzs/+6Q9//NZLra2tkroikyff2Kfq1MZiMfGGBQ8+4Cy5fITkfv/27dtto0aN2r5u/fpGnTFzoiEj+zZWoxsAgvKHhzJsDmW1oz7avG3C6LFlnnvuvfdwTU2NbK1UIuEZBhW+whuAYvJL6wJ1Fz6s/Hxj9oSwnNM98b3/fbXiz1LWXFZWlnuu9ouBkeTX6bTw5OP/LVmqDRs2nLv11lt3NTQ2WQwZ2d9nNbqBUpfpB2FY7cANH20ZN/Kqazr++PLL1V6vNykvzAkhKgzXc8Lrh1Lyy3LJn4BAGSJHmg8czFpzorL+bKyrtlgsGo6rGhop1XnX7B84+/TJlyTTl19+efHOO+/c5+GgUG/KuokQGrc+e6fDPXDJr5eOuPmWKWerqqra47UeuYkYhvMf7QlAMflJSFGiJVb5u1sf7sBBulnK+ov65+Z0dNhM4fL8D/94kaQrvRcuXHDMmjXrKy8HeXqjeRLE2N2JBkIIu2ff/pKX//TqYEqZjHivTw7ChuFChjr9UPxOLknEJr9vWmWlQ1LQKycnR9vaUp0tJP8VJZd7iq1WSX3/Rx555GB9vY3ojJk3QALk94dhNX01OsMViVxnrAiG4fjG+QNQrfw9GxCT/IRQaLZ7G6Ss2WQyMQ5Hk17oNsbbp0+TdM/h3r17G9euXVujNZjGxLPbkwrwjgIJXuTyQzH5ZQnDxS4/APE9U14SHk+HRuge3u9PnSJppGnp0qVHKcPmyXzCm5KEjAKFu8IbgELyB1fEWOjalNjv4TWbGYuU9be1tXl27nrkj3zTsrKyOCndn5qams5NmzbVafXGkbGXMH2gYuXnDcMpIb/0gy9IvYF92DC9pP5tQ0ODkxDC8k0bfc1VHikNzPr162u8HGdgWG1hzAtJI2ivVJGzPYEoI78clYB0/z8W+SkldPTVpklS1n/y5Mk2QqiOb9pVpaMknfxu3rz5QvdFLjmOFCkPFSt/SNdDQfll6ATFJD8hBMaXZU4pLNQMjnXNDQ0Nzrq6OgehlHeYcNCgQZJuKt+zZ08Dw2rw6C8SGk2q0x/l5O+eJgUCEIv8Q4foS+bdl/OElFXv3LmzgRCiI4TypioHXFoUcwWoqqpqb2pqclFGkx97CdMLnucC8csf2gIoJb8cQ9rRyc+ylLnxhsyZs39g+YlWS3i7LmLZunXrBcpq+ghNL+rfP+YKcOrUqXZCmQxCiDbWZaQbrHj5w7UAiZNfjmsBkeTX6xlDhokx9++vHXzZcMPICeMzbrNYGMlHVY/Hw61du7aGYTWCIzRmsznm+ENNTU0HFehaIfyIezJct5QBqFT+lStXlgLACkkLiZH333+/tq6uzmk05wwU+o7BGPv9Js3NzS5CqDHmBaQhkcNwAcL2opT8soThFMDr9XLPPffcUVajGyDU/wcAMOj1MbcAnZ2dXuz+REf4MFyQlAEoJr86K8Err7xy8tChQy0aneHKeK2D4zgAQqTfPZNGCIfheI/wvaD84ikvL7cvXrz4sEZnKKYMawn33Y7Ozpg30GAwqPpJzUrAH4YTkDIAxeRXz4OxAADq6uocU6dO3dPpcGRqdcbSSN/vaO+IeV1ms1kDHIdPjoiC0DBcWCl7UUx+FbUAp0+f7pgwYcKO06fPcHpj1o0gEH/wx263x7yBhYWFeo7jUuftFQmAipY/5GZ0ZeQProjJyrZt2+rHjBnz7xOVlZw+I+tWoSu/wZytqYm5GzNo0CATx3lVczdWMkDFyh/SAiglvwxDofGksbHR9eijjx68+eabd9XbLloMGdm3UcqIfmpC9ekzUiqAMTMzM/Y+VBrCipY/pOuhjPzJ2gLU19c7Xnvttarly5dXNjQ0gEZvHK3RGqwQZW09deqUpBPZMdeO1u7Y/R8nDoeKgxUrf4h4islPkuY04OLFi86tW7deWLduXe3HH3983ul0aVmtvtiQmVNMSGyRif3ffCtpGHPKlCl9//3lbhvDagukLCddYKNJdfqjnPyJ6QJxHAdOp9PrcDi8zc3Nrrq6OkdtbW3nsWPHWg8fPmzft29fU0VFhR0AdAyrLWA0uuuN5oz+ANLG4b/a9zXDcVzMw7133HFH4ZNPL64GAKwAIhAIwwld5PJDMfmlDXWLeTSi30YCw2g9lNG6tRqzw2Ds097YVDGaUsZMKVOkN2XnUYbJllSgIJqbm8mRI0dpcbE1plBcYWGh/qYbb2jfvmMPB8l8spQk8IThwlzh9UMp+eVoAcZd98KmocPvPsBX3khPbNMb4/8UwA8/3qQpLrY6Yp1/8eLFAz6dfEsNw2r7y1muVISKlj9SGE4l8ncXnre8yfIG9g82bNRImX/s2LE506b+V61c5UllqFj5CW8LkHj55YlCJK/8AAAHD5Uz3x05KmkZryx/eWB2VqbIrl76QkXLH3IOoJT8MlQCApCs8vv4y6srJD2Hv2/fvrp/vPMWx7JMQh9aW3bdOPfPH/tpzN23REOjSnX6oVr5faVPYvkBAP6+eo22vr5e0v3BEyZMsLz1+l/PaTSauL+82mQycc//9jedmz76oK2of2Gby9FxKN7rlIOQKEQ4kQNRSn7pYTjS0wIkp/wAAA6HE174w0uS38Yyffq0nPfX/r02Ly83LiE5QgjMmnm7a/++Xa2PPPwjB6UUPG7nGa/X0xqP9ckNFSt/SAuglPyytQDJK7+Plave1JdXVEgOt91ww6TMXV9sb7h92lTZckIMw8D0aVNdu7/8vPWtN1a2FxYUxL2ViQdUtPyxhOHiIH9wRYwN/u5bMskPAODxeOCxnz+Z7fVKd6ugoJ/2nbffdH32yb8uTp821aXVxpaUGFFc7HnmqScchw/tb3n37Tfb5XiBh5KwYuUXagESL7/vPykkv/w+du/Zyy793e/dv1ryTMQotRiuvXY0++7bb7Y3NTdzn376mWbPV19pyssP09Onz9CGxkbS0dFBWJYBg8HI5eXlcgMuvdQ7bNgQ7zVXXeUeN26sR8pjW5IRVrz8oecASsgvx0lw7zlAcsvv4w8vLc8dN+ba8zfdNFm2NzRmZ2WRO2bNcN8xa0Zav3SbipU/NAqhlPxyVAL1yA8A4PV6Ye4DC/t8/fXXbUqXJdUIHQYVlD+oC6SY/NJve+1dZvLL76O1tZVOnzUnr7yiAiuBjIQPw4U76iomvxwnwSBJ/unTdlUbDH17ug7ffLM07+ixN7OEpgMAcJyHeDwO4nK10I6OOsZur9Ser9tpOHPmXxkej0Nwo4KX9fIrAAB23pteBg9i2GeeMmXHsk3pinAYLkTKMC1AAuXnK0vUEJLwIz8hDMeyRo5ljV6Doa87J+dKx8CBM1pKRy2+eODgizknT65V7bt21Qx/GI5PfqEwnNrkB4B9+555TvJCZEKns3iuHf18/dVXP2tTuizpCCtWfsLXAiggvzxRiMTi6yIxjIEzmQrc/fpNbLNetrDJYOjTM4Y+bOi9za0tVRr/rlS4Zfn+nZdrqX5+6bMdc+bM6ZcM+4bjOKisrGwDufqqcYaKlj9k5yolvzorAQCAx9NB7PZKzdGjb2Rv+WRqkd1+IuBqVEnJzxq02uyoxtltFxsHLPjhTwZcO2bcsc2bN9fJW2LxOJ1O7zvvvHOmpKRk27Jly45TymQqVZZooFGlOv1A+aXR2XmR2bP38YDHpGs0Gd4BA6a1RLssQqjhu2OVo2feeVfeFVeMLF++fHllY2NjQp4PVFFR0fL0008fLioq2jJ37txvjh2vzDdkWqZrdIaSRKxfKqxo+UPEU0p+dT0ZLhwNDYd0zc3HtFlZw3teit2373Udx4+/LdgNKi1dYistXcJ7vrBr90/7njr9UdnTv3y2efEvf32sbNyYpttuuy13ypQpfYcNGybLY9OdTqd3z549jVu2bKnbuHHj+fLycjtlmGxWo7/caM4ZprbXsrJi5Q/fAiRW/r+81rhkzpw5+6pObSyOZaN1hoykeYVQY9NhnX8FMJkKJV+ZpZTJAmBG79y73/vFzr3nH3/iqbPmTFPdqFEjmdLS0qwhQ4aYioqKDP379zfk5eXpDAYDNRgMjF6vZ9xut+9BAO4LFy44amtrO06cONF29OjR1v379zd9++23zQ6HAxhWk8+wmqGGDEuR3PdFJxJWvPxCYbjEyu/728QbVmyYeMNfN6gh1RkOl7MlYMdqNZlyZm0ow2oKGFZT0OkG2L3vW+fOPf+56PW4G7xeTyPn9Z7lOG87x3k7geM8HIC7+9milBBCgRAtIVRPCDVShskklLmM0RhyTfoMC0h8+kWyIC4M1yNyL0rKH3kedcgPAKDVmgPSlE5XS/CRJoDgUaBoIIRoGVbTj2E1/WKZPxWh4uUPHQVC+aVjsVzu9P93W1uNLKlPRBzhw3DhbkZH+SWTm1vaaTYPDagAdXW7ZEt8IpERDsPxiOwPyi8NvT7PM3bMixf8/+ZytdLq6o2qGD9PFfjDcGJuRkf5o4ZhdJzRWOguKJjUVmx9qEmvzw/o/5eXv5zjdDbhW14SSGgYLuzN6L2g/OIJN3bv4/iJd7LEnNxGWta69SMGh0uXIoGwouUPbgFQfllwOBqZAwdeyD15ah12fRSAFSs/CT4HQPmjguM84PU6idNpZzo6LjD2lkrt+fNfRrwfAIkvrGj5Q1qA9JV/w8brBkiZLue6EGnQ6FKdvaSr/EhqQcXLL3QOgPIj6oWKlT94GBTlR1IBKl5+EWE4lB9RGVSs/PwtAMqPqBsqXv7QUSCUH1E7NJpU5+y7D9oAAFatMNsyMoqsKD+SLMyZXTlj1QqzDQAgIzt/h9j5qFj5+U6EUX5E7Qi8IENkHgjlR1QOzwsyos0DofyIeqHRyE+AwF33Huk5DzAaL7Gi/IjSxNr/BwgaBo14VZjnPADlR9QMjV7+cCfCKD+iLsSF4YKEvee+yp5ukF6fa0X5EaWQ0v0BEBOGExS5F5QfUSvhw3BhRPaxaoXZptVmC5wMo/xI/PA/+seKcBgugshz51UHrBjlR5Qklu4PgFAYTpTIBO574GzPuYBGk2FF+ZFEIbXv7yM0DCdS/uCnNK9aYbaxrNGK8iPxRo6ujw8qRX5CCNw//1xQQVB+JHFIOfoD8EYhxMvv+5z3YF1PV4hhtFaUH4kXcnV9fFCp8vfO08WqFWYbpawV5UfkRs6ujw8qj/wE5i+82FOwVSvMNkKoFeVH5CJYfjmO/gABw6DSU50PPtQYUAnmzK6cIUchkfQmXvID9LQA8kWaFyyyYyVAZCOe8gMA0Hjk+f0LiZUAiZV4yw8g8JI8ObI9Gdn5O1qb6icAdFUCgK5KsHrNkH/KvRFIauE7YMZbfgCel+TJGWwLrQQAAJUzsBIgQvCN9MRLfgDeFkDeVKev8NgaIOFI5FHfHzae8vsj1BoAYEVIZ/jEB0iM/AABLUD88/z8rQGAryIAYGVIB/wHRZQS3werxM0s/q0BQPBOCBwxwgqhfoJHAYWu5iZafgAAVqk7ufw3VrgyAARXCER9hIsvKCG9P2TuvLPWRMsfDv/KgKQmSkvvD88wqLJ5/uCdgxVC/SST8MGwySQ/H8m88xD1IyIMh5FmJHWJEIZD+ZHUJkwYDuVHUh+e5wKh/Ej6wPNkOJQfSR9CbolE+ZF0gqL8SDpDUX4knaEoP5LO/D+7cZoYpFDXgAAAAABJRU5ErkJggg==",
    icon512Base64: "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAB0lklEQVR4nO29d5wc1ZW3f25VdZieoBlpNMo5C5DICxhMxmADRiBMjsZ4TVh7f16TbK/3BfziZb3etddrY7DJCGOT7NcYG2xjcg6SEBIKM8rSSCNpNLmn0++PmemuuvdW6lRV3d/n81Fruvv0uedUV9dTXV2B1Y5qnk9ZWPZ/xvT3c38zxrhYWXzuOTF+JI/kMWLDf3K5cy/IO3euRu4xQ26rWljuVjJuLtSspwL6NK1FzG3WU7Z6btyRZ/hx5fFO+iwwtzSe6e7y8SbTl8tTutyyeK5PaS3iuEw3vn5cN++d/ll5bqtaJLkd9GTIrYvPu08HPRlipbUYxzXGM93TfLyTPouYW+jJatxcvJA7+3jhuc2mr5A7+xKzWrjc0jwWPbnp05Dbqhb7ntz4Yyi+wD7d5s7Gi8+58TNjjJRSJZfHm09gyN+kT9NaxNxmPWWr58aF/AvNLYvn+pTWIo4L+ctqgfwhfwd9GnJb1WLfUzXJ/9dPzFqtlCK5PN58AkP+Jn2a1iLmNuspWz03LuRfaG5ZPNentBZxXMhfVgvkD/k76NOQ26oW+56qTf5EREqxk8vjzScw5G/Sp2ktYm6znrLVc+NC/oXmlsVzfUprEceF/GW1QP6Qv4M+DbmtarHvqRrlT0SkyIPzSy6PN5/AkL9Jn6a1iLnNespWz40L+ReaWxbP9SmtRRwX8pfVAvlD/g76NOS2qsW+p2qVP9HwFgDIn69F91ZC/ha1FJhbGs90d/l4k+nL5Sldblk816e0FnFcyF9WC+QP+Tvo05Dbqhb7nqpZ/kRECuTP16J7KyF/i1oKzC2NZ7q7fLzJ9OXylC63LJ7rU1qLOC7kL6sF8of8HfRpyG1Vi31P1S5/IsM+APkll8ebT2DI36RP01rE3GY9ZavnxoX8C80ti+f6lNYijgv5y2qB/CF/B30aclvVYt8T5D+EcBgg5C+rBfKH/MWe9LeQv4s+HfRkiJXWYhzXGM90T/PxTvosYm6hJ6txc/GQv6wWyL+Y8ifS7QToNrk83nwCQ/4mfZrWIuY26ylbPTcu5F9oblk816e0FnFcyF9WC+QP+Tvo05Dbqhb7niB/I0o+yeXx5hMY8jfp07QWMbdZT9nquXEh/0Jzy+K5PqW1iONC/rJaIH/I30GfhtxWtdj3BPmLKG6Ty+PNJzDkb9KnaS1ibrOestVz40L+heaWxXN9SmsRx4X8ZbVA/pC/gz4Nua1qse8J8pejQP6yWiB/yF/sSX8L+bvo00FPhlhpLcZxjfFM9zQf76TPIuYWerIaNxcP+ctqgfxLKX8ibh8Aq+TyYswnMORv0qdpLWJus56y1XPjQv6F5pbFc31KaxHHhfxltUD+kL+DPg25rWqx7wnyt0Y4DBDyJ5N4pis5zz5NaxFzm/WUrZ4bF/IvNLcsnutTWos4LuQvqwXyh/wd9GnIbVWLfU+Qvz2GwwAhfzKJZ7qS8+zTtBYxt1lP2eq5cSH/QnPL4rk+pbWI40L+slogf8jfQZ+G3Fa12PcE+TvD5FoAurcA8teVnGefprWIuc16ylbPjQv5F5pbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nyN85kmsB6N4CyF9Xcp59mtYi5jbrKVs9Ny7kX2huWTzXp7QWcVzIX1YL5A/5O+jTkNuqFvueIH93KPIJJivGfAJD/iZ9mtYi5jbrKVs9Ny7kX2huWTzXp7QWcVzIX1YL5A/5O+jTkNuqFvueIH/3KOIEkxVjPoEhf5M+TWsRc5v1lK2eGxfyLzS3LJ7rU1qLOC7kL6sF8of8HfRpyG1Vi31PkH9+CIcBQv5MV3KefZrWIuY26ylbPTcu5F9oblk816e0FnFcyF9WC+QP+Tvo05Dbqhb7niD//DEcBgj5M13JefZpWouY26ynbPXcuJB/obll8Vyf0lrEcSF/WS2QP+TvoE9Dbqta7HuC/Asjexgg5M90JefZp2ktYm6znrLVc+NC/oXmlsVzfUprEceF/GW1QP6Qv4M+DbmtarHvCfIvHJNrAZhPYMjfpE/TWsTcZj1lq+fGhfwLzS2L5/qU1iKOC/nLaoH8IX8HfRpyW9Vi3xPkXxwk1wIwn8CQv0mfprWIuc16ylbPjQv5F5pbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nyL94cDsBmk9gyN+kT9NaxNxmPWWr58aF/AvNLYvn+pTWIo4L+ctqgfwhfwd9GnJb1WLfE+RfXITDACF/F32a1iLmNuspWz03LuRfaG5ZPNentBZxXMhfVgvkD/k76NOQ26oW+54g/+Jj2AIA+bvo07QWMbdZT9nquXEh/0Jzy+K5PqW1iONC/rJaIH/I30GfhtxWtdj3BPmXBsVqAkP+Jn2a1iLmNuspWz03LuRfaG5ZPNentBZxXMhfVgvkD/k76NOQ26oW+54g/9IxfBSApBjdzJcD8of8me4uH28yfbk8pcsti+f6lNYijgv5y2qB/CF/B30aclvVYt8T5F9aNMjfRZ+mtYi5zXrKVs+NW4j81695upkAAKDMfOmiDzog/2DKn4iINTbPmG8oBvL3pfw3fPo7SB4AEBguuHhFx9BfkL8f5U+UXQGA/P0k/9a1v3cl+2u+2oWVAwBA2fnlLxo63MRfeMmqXDzk76n8iYhYY/PM+UMlQf5eyb913R9sBQ7JAwCChJOVg4suXZ3bSkCQf7lhjc0z50P+Jn2WUP5t654zFTpkDwCoRKxWCi6+bI24PwHkX1JYU/Os+ZB/eeQP6QMAwBDWKwNrOyD/0sOaxs6aLxROBPkXUf5t6/4oyB3CBwCAHLIVgksuXydsFYD8iwdrGjt7vu4u5F8k+betf14q+FKI3+2OOAAAUAzKuTy75PINHZB/cdGtAED+xZD/Ron4i/UhgegBAEGglMu8S69ozW0VgPwLYngFAPIvVP4b1/+pqOKH7AEAlUSxl4eXXrmxA/IvDNY0ds58yD9/+fPiz3cmL0T4cxdeYDyUZuSW6ynXiqTP7F0+3mT6cnlKl1sWz/UprUUc17BQ0I0rn142fQq16Oo1rUWS20FPhty6+Lz7dNCTIVZai3FcYzzTPc3HO+mziLmFnqzGzcXLBJIburDcZtNXyJ19iVktXG5pHoue3PRpyJ177Illi/KWerGWlZdducnmhEOQvxls9Ng58yF/Z7n1eYohfrfSn7Pg/Gy8TE6GW66nXCuSPrN3+XiT6cvlKV1uWTzXp7QWcVzIX1YL5A/5O+jTkNuqllzErx87oOQnMxNWBK7a3AH5u4ONbplrOBUwkazRkabEx8wmMMu9wJhD90EwPq6P5/PI4o0LOHluWS3M+IzD3CN5Nm74c0Hidyr92fPP65DXqPvAQf6SWsRxIX9ZLZA/5O+gT0Nuq1rse3r80fmOlpWFLlMvv2prdosA5G/N8AqA7u2F/IXcI3n08i+F+GfPP5fblC/2BPnrckL+zvt00JMhVlqLcVxjPNM9zcc76bOIuYWerMbNxUP+slqKI3/eH8semVv0s5/ql7GXX7WtA/K3h41umZc9DBDyF3MTMdqU57d+R9Kft6TDuhaubiKhp+wtlyfXiiR39i4fbzJ9uTylyy2L5/qU1iKOC/nLaoH8IX8HfRpyW9Vi35OdPx57eE7RVgb4Ze4VV2/nTjUsmYbZWsTnKln+RJRbAYD8xdybNrxQEvHPmndOh7M+ubolPWVvuTy5ViS5JeMa88jiy5FbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nN/4gInrs4VmWy9j8VwR2yM8hkK1FfK7S5U9EQysAkL+YOx/5W4l/1rwvdrjrk6tb0lP2lsuTa0WSWzKuMY8svhy5ZfFcn9JaxHEhf1ktkD/k76BPQ26rWux7cit/XtCPPjSjoFOn88vjK7+807A1IFeLOH2rQf5ERGzMuPncToDu3zyWe4Exh+6DYHxcH8/nkcUz3ftglltWCzM+4zC3Xv4Fi3/uF4VN/PZ9cnVLesreynJL45nuLh9vMn25PKXLLYvn+pTWIo4L+ctqgfwhfwd9GnJb1WLfU6Hy1+d+5MHpRVsRuPLL7dwOguK41SJ/IhpZAcj/zWO5Fxhz6D4Ixsf18XweWTzTvQ9muWW1MOMzDnIX81v/rLlnd5BkXPs+ubolPWVvZbml8Ux3l483mb5cntLllsVzfUprEceF/GW1QP6Qv4M+DbmtarHvqZjy14/3yIPT8j69Or+cvuqaXR3CNDTUYnyuEuVPRMTGjFtg2AIA+Rcm/plzz86dnYob175Prm5JT5a5pfFMd5ePN5m+XJ7S5ZbFc31KaxHHhfxltUD+kL+DPg25rWqx76lU8tfX8vADU4qyInDVNbtNdhA0jlup8ieikRUA928ey73A8Fyly99K/PoR+HHt++TqlvRkmVsaz3R3+XiT6cvlKV1uWTzXp7QWcVzIX1YL5A/5O+jTkNuqFvueyiF/fezDD0zOa0XAuBLQ0WGsxThuJcufiIiNGbdw+CgAIqdvHsu9wPBc0OS/acOLrjb5y+Q/c+5ZHYY+JePa98nVLenJMrc0nunu8vEm05fLU7rcsniuT2kt4riQv6wWyB/yd9CnIbdVLfY9lVv++twP3T/J9XVY+GX51V/ZI/wkUOnyJ6KhFYBql3/+3/ohf/e5ZfFcn9JaxHEhf1ktkD/k76BPQ26rWux78lL+I489dP/EgrcGXP2VvSY7CObqriT5ExGx5vELhZ0Azd68oWkivnnVJv8h8XN9Ssa175OrW9KTZW5pPNPd5eNNpi+Xp3S5ZfFcn9JaxHEhf1ktkD/k76BPQ26rWux78oP89bkf/NX4grYGXP2VfR3VIn8iIsXpmzc0TcQ3D/IfvuXGte+Tq1vSk2VuaTzT3eXjTaYvl6d0uWXxXJ/SWsRxIX9ZLZA/5O+gT0Nuq1rse/Kb/In0x/rnsDsxm94D99/X1CzLXYnyJyJizeMPmG83gYfeZ/HNq1T5S8U/58wOV4K2rIWrW9KTZW5pPNPd5eNNpi+Xp3S5ZfFcn9JaxHEhf1ktkD/k76BPQ26rWux78qP8+ece/FWLq60B+uX+l6/dn905sFLlT8RtAYD8IX/I36oWSW4HPUH+BeQWerIaNxcP+ctqqR75M6Y/zC+H1dYAvRd+de+o5kqXPxGRMvQf5E8E+UP+VrVIcjvoCfIvILfQk9W4uXjIX1ZLdcl/5H4hKwG//EWDq6sRBhHWPP6g+ZC/OFPMnHPm0H3IP8/csniuT2kt4riQv6wWyB/yd9CnIbdVLfY9BU3+fPz9941xfNi33gd1jWNfNYsLOgrkD/lD/la1SHI76AnyLyC30JPVuLl4yF9WC+Q/Ep87zG8Ip1sCejp3H2cWF3TY2AkHGXcCJCJ+QZ59RjITGOP5PLJ4pnuPzHLLamHGZ2xyO5G/6SZ/ybjZW25c+z65ut3mlsYz3V0+3mT6cnlKl1sWz/UprUUcF/KX1QL5Q/4O+jTktqrFvqdKkL/+ufvvG+1458BK3xJg3AmQiPgFefYZyUxgjOfzyOKZ7n0wyy2rhRmfsckN+cviy5FbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb6nSpM/EaMvX7vP8X4Blb4lILcTIBHxC/LsM5KZwBjPLaCk8Uz3PpjlltXCjM/Y5Ib8ZfHlyC2L5/qU1iKOC/nLaoH8IX8HfRpyW9Vi31Mlyn8k/svXdmIlgIa3AAxNE8lE1H0QjI/r47kFlDSe6d4Hs9z6HOKbB/kz3V0+3mT6cnlKl1sWz/UprUUcF/KX1QL5Q/4O+jTktqrFvqdKlv/I/ZFj/fVU20qAMjRNJBNR90EwPq6P5xZQ0nimex/McutziG+eE/nr451cFnIEyL/Q3LJ4rk9pLeK4kL+sFsgf8nfQpyG3VS32PVWD/Edi3fyu78YrQUGpFPmPXNIXe/uL45Yutyye61Naizgu5C+rBfKH/B30achtVYt9T9Uk/5GT/PArAU6ODqiUrQBK7k/dh0I2wYiIF0j27ZTGM937YJZbn0N889zK3wrIv9i5ZfFcn9JaxHEhf1ktkD/k76BPQ26rWux7qkb5j+BmJWCESlgJyO4EOHSb+yAYHyfiBZJ9O6XxTPc+mOXW5xDfvHzk7/R3f8i/0NyyeK5PaS3iuJC/rBbIH/J30Kcht1Ut9j1Vs/xHcLoSUEn7A2QPAwyi/PVA/sY8pcsti+f6lNYijgv5y2qB/CF/B30aclvVYt8T5J8jn5WAIKMQDb9BsglGRLxAsm+nNJ7p3gf+Me4Nkua2qkXMbfe7P+Rf7NyyeK5PaS3iuJC/rBbIH/J30Kcht1Ut9j1B/iJuVwKCvBVACbr8nQL5F5pbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nyN8ct2f9C+pKgEKyCUZEvECyb6c0nuneB/4x7g2S5pbFm+fO53d/koybveXGte+Tq9ttbmk8093l402mL5endLll8Vyf0lrEcSF/WS2QP+TvoE9Dbqta7HuC/N1RqfsDKMIEIyJeINm3UzaBdQsD8THuDZLmlsWb59a/ztWmf8g/z9yyeK5PaS3iuJC/rBbIH/J30Kcht1Ut9j1B/s6ohv0BuKMAiHiBZN9O2QTWLQzEx7g3SJpbFm+em4jRpg1/tpzYkH8xc8viuT6ltYjjQv6yWiB/yN9Bn4bcVrXY9wT5u8Pt4YFB2wqgOwqAiBdI9u2UTWDdwkB8jHuDpLll8ea5+Y+ck7UuyL+Q3LJ4rk9pLeK4kL+sFsgf8nfQpyG3VS32PUH++eFkf4CgbgUYPgqAiBdI9u2UTWDdwkB8jHuDpLll8ea5R/JsHP727/h3f8g/z9yyeK5PaS3iuJC/rBbIH/J30Kcht1Ut9j1B/sWjko4K4K4FwC2gZBNYtzAQH+PeIGluWbx57pE8G91u+p97Vocx9/AtN659n1zdkp4sc0vjme4uH28yfbk8pcsti+f6lNYijgv5y2qB/CF/B30aclvVYt8T5F84lfpTgCIK2n/y1y/IHW36h/zzzC2L5/qU1iKOC/nLaoH8IX8HfRpyW9Vi3xPkXzwq8acAw06A2bdTNoF1CwPxMe4NIiJeTvJ489z6PBvX/8ndpn9D7uFbblz7Prm6JT1Z5pbGM91dPt5k+nJ5SpdbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nyL+0VMJPAYbDAHPTlpvAuoWB+Bj3BhERLyd5vHluMY9zhr79cwsoblz7Prm6JT1Z5pbGM91dPt5k+nJ5SpdbFs/1Ka1FHBfyl9UC+UP+Dvo05Laqxb4nyL80uD1BkN/JbgHITVtuAusWBuJj3BtERLyc5PHmufk8br79Q/755JbFc31KaxHHhfxltUD+kL+DPg25rWqx7wnyLy36lYCgbwVQsm+nbALrFgbiY9wbRES8nOTx5rnFPNaIE59bQHHj2vfJ1S3pyTK3NJ7p7vLxJtOXy1O63LJ4rk9pLeK4kL+sFsgf8nfQpyG3VS32PUH+5cfJpYP9ipKbttwE1i0MxMe4N4iIeDnJ481zi3nsv/3rmTn37A79CPy49n1ydUt6sswtjWe6u3y8yfTl8pQutyye61Naizgu5C+rBfKH/B30achtVYt9T5B/+XCzQ6CftwKYXAvAuIAzPsa9QUTEy0keb55bzMOPIyJb68rOuNy4ubtmtXB1S3qyzC2NZ7q7fLzJ9OXylC63LJ7rU1qLOC7kL6sF8of8HfRpyG1Vi31PkL+3BHUrgORaAMYFnPEx7g0iIl5O8njz3GKeocc2rn/e1bf/7IzLjZu7a1YLV7ekJ8vc0nimu8vHm0xfLk/pcsviuT6ltYjjQv6yWiB/yN9Bn4bcVrXY9wT5e0MlbAXgrgVgXMAZH+PeICLi5SSPN88t5tE9ZgG/tpWdcblxc3fNauHqlvRkmVsaz3R3+XiT6cvlKV1uWTzXp7QWcVzIX1YL5A/5O+jTkNuqFvueIH//EMStALprARgXcMbHuDeIiHg5yePNc4t5co+1DX/7d8KsuWd3kGTc3F2zWri6JT1lb2W5pfFMd5ePN5m+XJ7S5ZbFc31KaxHHhfxltUD+kL+DPg25rWqx7wny9x43hwX6cSvA8LUAjAs442PcG0REvJzk8Xwe43PGPLrHdDllm/+le/5z4+bumtXC1S3pKXsryy2NZ7q7fLzJ9OXylC63LJ7rU1qLOC7kL6sF8of8HfRpyG1Vi31PkL8/kW0F8PPZARXfyV//sA2z5n6xgx83d9esFq5uSU/GWhgfLYlnurt8vMn05fKULrcsnutTWos4LuQvqwXyh/wd9GnIbVWLfU+Qv78I8smBFOLeWK/l37buj453/uPHZZLHzHqC/HU5IX/nfTroyRArrcU4rjGe6Z7m4530WcTcQk9W4+biIX9ZLZB/JcrfKX7dGdBkJ0DuDSIiXk7yeD6P8TljHt1j0nFF9JtXZs37YoeY26oWrm5JT/JaIH/IX1YL5A/5O+jTkNuqFvueIH//4uTsgH5EshMg9wYRES8neTyfx/icMY/uMV2etnXPufithM9tVQtXt6QnvhYuWhLPdHf5eHEaQP6yWowLPXktktwOeoL8C8gt9GQ1bi4e8pfVAvlXuvzd4qetANxOgNwbRES8nOTxjHvc+Jwxj+4x6bhOd/7T57aqhfHRQk/yWiB/yF9WC+QP+Tvo05Dbqhb7niD/4BGUnQF1OwFybxAR8XLKPiN783QLGsOMYcije0w6rjNmzTunI5fbqhaubklP8logf8hfVgvkD/k76NOQ26oW+54g/+AQxJ0BuVMBD/099JD45pVS/iOb/52tJUH+kL8YD/kXkFvoyWrcXDzkL6sF8q82+TvFbzsDKsIbRES8nLLPyN483YLGMGMY8ugeE/LwH1AR6Zn/LGuR5Ib8JbWI40L+slogf8jfQZ+G3Fa12PcE+QefIOwMqOT+9Kf8eWbPWyIc+y+vUZcb8pfUIo4L+ctqgfwhfwd9GnJb1WLfE+QfXIL2M0D2MMCh90d888oh/9Z1f3C+c4RlLWJuyF9Wizgu5C+rBfKH/B30achtVYt9T5B/9eCHnwGU7Czh1Td/XbzjU/9Ka7HKzS38uJ5yrUhyZ+/y8eI0gPxltRgXevJaJLkd9AT5F5Bb6Mlq3Fw85C+rBfKH/OX4/WgAZej9Ed+8csvfCbPnn9shr8UqN7fw43rKtSLpM3uXjxenAeQvq8W40JPXIsntoCfIv4DcQk9W4+biIX9ZLZA/5G8kSD8DKN7LX/86J/C12OeW1wL5Q/6yWiB/yN9Bn4bcVrXY9wT5A68wnAp46K/ch1L/XKnk37r2964O/5PXKM9tuOV6yrUi6TN7l48XpwHkL6vFuNCT1yLJ7aAnyL+A3EJPVuPm4iF/WS2QP+SfP345HNBwGKDfvvnrfz+ZPf+8DnmN5rnltUD+kL+sFsgf8nfQpyG3VS32PUH+lUtQrg2QPQzQC/nrX+0EyF/syTAlIX/nfTroSZhLIX/d0IXlNpu+Qu7sS8xq4XJL81j05KZPQ26rWux7gvyBHzC5FoDugyuZaYZCuTd/JIabaWwF7RDIX+zJMA0hf+d9OuhJmD8hf93QheU2m75C7uxLzGrhckvzWPTkpk9Dbqta7HuC/IFfkFwLQPfBlcw0Q6Hcmz8Sw800zgTtkLxyMz5aEm9c2Mp7ksWXI7csnutTWos4LuQvqwXyh/wd9GnIbVWLfU+QP/AT3LUAdB9cyUwzFMq9+SMx3EzjRNAbPv2d6x0AneYW6pbGGxe28p5k8eXILYvn+pTWIo4L+ctqgfwhfwd9GnJb1WLfE+QP9PhhR0BFePN0CxrDjEFETuSkf8aZoOXod5yYs+D87N+Qvy4n5O+8Twc9CQtWyF83dGG5zaavkDv7ErNauNzSPBY9uenTkNuqFvueIP/qIwg7AhoOA/SL/M2A/HU5IX/nfTroSViwQv66oQvLbTZ9hdzZl5jVwuWW5rHoyU2fhtxWtdj3BPkDv5LdAlB++etz2gP563JC/s77dNCTsGCF/HVDF5bbbPoKubMvMauFyy3NY9GTmz4Nua1qse8J8gd+hjsKYOjeyP9D7zP35o/EcDNN3oJ2AOSvywn5O+/TQU/CghXy1w1dWG6z6Svkzr7ErBYutzSPRU9u+jTktqrFvifIH/gd3VEARIYZg4icyEn/jCtB61M7AfKX1CKOC/nLaoH8IX8HfRpyW9Vi3xPkD4KAQpKZZuh95t78kRhupslf/vr8NkD+klrEcSF/WS2QP+TvoE9Dbqta7HuC/EFQ4K4FUD75r1/ztOkhgPo9JucuvIC7AqBFbmktxoWtvCdZfDlyy+K5PqW1iONC/rJaIH/I30GfhtxWtdj3BPkDPXZHAnh9KKDhMMCh95l784f/J26mKcs3f91otrmltRgXtvKeZPHlyC2L5/qU1iKOC/nLaoH8IX8HfRpyW9Vi3xPkD4JGdgvA0PvMvfnD/xM30xQuf/04djjILa3FuLCV9ySLL0duWTzXp7QWcVzIX1YL5A/5O+jTkNuqFvueIH8QRJTsrOVL+XMjyHJLazEubOU9yeLLkVsWz01DaS3iuJC/rBbIH/J30Kcht1Ut9j1B/iCoKEPvM/fmD/9P3ExTLPkbP+jWWOaW1mJc2Mp7ksWXI7csnpuG0lrEcSF/WS2QP+TvoE9Dbqta7HuC/EGQUTyRv35IW0xyS2sxLmzlPcniy5FbFs9NQ2kt4riQv6wWyB/yd9CnIbdVLfY9Qf4g6Ci5P8spf/1MZ4Mst7QWZhHPdEPy8eXILYvnpqG0FnFcyF9WC+QP+Tvo05Dbqhb7niB/UAkYdwLUfbhH8FT+utcbFhWQv2FcN++dYeEnzW1ViyS3g54g/wJyCz1ZjZuLh/xltUD+kD/Qk9sJUPfhHsF7+QuVSGoxLmyN8Uw3JB/Px5Yityyem4bSWsRxIX9ZLZA/5O+gT0Nuq1rse4L8QSWhZGdEbqYppfyNH347IH/IX1YL5A/5O+jTkNuqFvueIH9QaSj6D/cI/pG/7pWQv2Fc+Xth06dQi3GhJ69F9t7Z9wT5F5Bb6Mlq3Fw85C+rBfKH/IEZCnEzTVnkb5iBHQD5G8aVvxc2fQq1GBd68lokuR30BPkXkFvoyWrcXDzkL6sF8of8gRWKfsaA/AvNLYvnpqG0FnFcyF9WC+QP+Tvo05Dbqhb7niB/UMlkDwMsr/z1M6QTuAWUrBbdwlaM52PFWiB/WY2yWsx7gvwLyC30ZDVuLh7yl9UC+UP+wAkKkW5GhPzzzC2L56ahtBZxXMhfVgvkD/k76NOQ26oW+54gf1ANKF7IXz9bOgHyF3Pb9inUYlzoyWuR5HbQE+RfQG6hJ6txc/GQv6wWyB/yB24Y+gmg7PLXz5zWQP5ibts+hVqMCz15LZLcDnqC/AvILfRkNW4uHvKX1QL5Q/7ALYon8tfPn06Q1WLIwy3QIH9JbqtaJLkd9AT5F5Bb6Mlq3Fw85C+rBfKH/EE+ZE8FbLjlZprcXW5GEmJ1M7mjFQsHyGrRLWwNtXDj5kIkdReUWxbP9SmtRRwX8pfVAvlD/g76NOS2qsW+J8gfVCPZwwCzt9xMk7vLzUhCrG4mL5b8da82LKC4Dw7kL6vFuNCT1yLJ7aAnyL+A3EJPVuPm4iF/WS2QP+QPCmH4KIDhW26myd3lZiQhVjeTO/xJwR2QP+Qv9gT5F57bbPoKubMvMauFyy3NY9GTmz4Nua1qse8J8gfVjMm1AEorf/3sag/kD/mLPUH+hec2m75C7uxLzGrhckvzWPTkpk9Dbqta7HuC/EG1I7kWgJ/kz+fhauHGzYVI6pb05Dy3LF6ykIf8nffpoCdhwQr564YuLLfZ9BVyZ19iVguXW5rHoic3fRpyW9Vi3xPkD4BwLYAyyd8ww9vBdENyCzTIX5LbqhZJbgc9Qf4F5BZ6sho3Fw/5y2qB/CF/UEwUw0w39B8JM5JuwUHGaCqt/PVDcgs0yF+S26oWSW4HPUH+BeQWerIaNxcP+ctqgfwhf1BssocB5uYhbkbSLTiIDNGUv/z1M7ATuAUa5C/JbVWLJLeDniD/AnILPVmNm4uH/GW1QP6QPygFSna2lc1IugUHZZ8RF+SGWy5Pbv6XzcBO4BZokL8kt1UtktwOeoL8C8gt9GQ1bi4e8pfVAvlD/qBUKLl5iJuRdAsOyj4jLsgNt1ye3Pwvye0CyF9Wi3GhJ69FkttBT5B/AbmFnqzGzcVD/rJaIH/IH5QSYSfAodvcgoOyz4gLcsMtlyc3/0tyuwDyl9ViXOjJa5HkdtAT5F9AbqEnq3Fz8ZC/rBbIH/IHpUYRZiTdgoOyz4gLcsMtN0Pm5n9JbmNqZ0D+ktxWtUhyO+gJ8i8gt9CT1bi5eMhfVgvkD/mDcsBdCyC34BihNPLXz9Q2QP6S3Fa1SHI76AnyLyC30JPVuLl4yF9WC+QP+YNyobsWQG7BMYLn8hcrcZgb8of8rfosYm6hJ6txc/GQv6wWyB/yB+Vk+FoAuQXHCKWVv37mtgPyh/z18Uz3NB/vpM8i5hZ6sho3Fw/5y2qB/CF/UG4UL+Svn73tyC8307/QpCdZvGQhD/k779NBT8KCFfLXDV1YbrPpK+TOvsSsFi63NI9FT276NOS2qsW+J8gfAHdwRwHoZvKSyl8/kzsA8reoRZLbQU+QfwG5hZ6sxs3FQ/6yWiB/yB94haKf6comf/18bgfkb1GLJLeDniD/AnILPVmNm4uH/GW1QP6QP/ASZeQPX8o/i9vcfDz34ZL0ZPjwQ/7O+3TQk7Bghfx1QxeW22z6CrmzLzGrhcstzWPRk5s+DbmtarHvCfIHIH9yOwESUfnkr5/h7cgvN+QvxkP+BeQWerIaNxcP+ctqgfwhf+AHFH/LnxvVYW7IX4yH/AvILfRkNW4uHvKX1QL5Q/7ALwz9BFBm+RsXOtZA/rIaZbWY9wT5F5Bb6Mlq3Fw85C+rBfKH/IGfUPws/yxuc0P+7gTipk8HPQkLVshfN3Rhuc2mr5A7+xKzWrjc0jwWPbnp05Dbqhb7niB/AIoHdyrg4VtuhszN/9xMyi1sjfFMN5/z8foPgA0F5Yb8dcnlAnHTp4OehAUr5K8burDcZtNXyJ19iVktXG5pHoue3PRpyG1Vi31PkD8AxUV3KuDhW26GzM3/3EzKLWyN8Uw3n/Px+g+AE/LNDfnrkssF4qZPBz0JC1bIXzd0YbnNpq+QO/sSs1q43NI8Fj256dOQ26oW+54gfwCKz/BRAMO33AyZm/+5mZRb2BrjmW4+5+NlHwQnQP6Qv1WfRcwt9GQ1bi4e8pfVAvlD/sDPKNkPBTdD5uZ/biblFrbGeKabz/l4SW5HQP6Qv1WfRcwt9GQ1bi4e8pfVAvlD/sDvKPoFzRB+kj+5yC2rxVwgwoLVEC8KxCy3vBbIH/IvPLfZ9BVyZ19iVguXW5rHoic3fRpyW9Vi3xPkD0Bp4a4FUCb5u9oPwEluWS3mAhEWrIZ4USBmueW1QP6Qf+G5zaavkDv7ErNauNzSPBY9uenTkNuqFvueIH8ASo9imKFHHvWN/MlBblkt5gIRFqyGeFEgZrnltUD+kH/huc2mr5A7+xKzWrjc0jwWPbnp05Dbqhb7niB/AMpD9jDA3PzPzaTcwtYYbxSIMV4iEOmHwwlmuWW1mAtEWLAa4kWBmOWW1wL5Q/6F5zabvkLu7EvMauFyS/NY9OSmT0Nuq1rse4L8ASgfimFRAfkbepLlltcC+UP+hec2m75C7uxLzGrhckvzWPTkpk9Dbqta7HuC/AEoL0pu/udmUm5hS4ZHjQIxxksEYpbbIZC/GA/5F5Bb6Mlq3Fw85C+rBfKH/EFQMbkWgCgQwwKK++BA/rJajAs9eS2S3A56gvwLyC30ZDVuLh7yl9UC+UP+IMhIrgUgCsSwgOI+OHnJX/9ZcQLk704gbvp00JOwYIX8dUMXltts+gq5sy8xq4XLLc1j0ZObPg25rWqx7wnyB8A7uGsBiAIxLKC4D07+8td/YGyA/N0JxE2fDnoSFqyQv27ownKbTV8hd/YlZrVwuaV5LHpy06cht1Ut9j1B/gB4i+5aAKJADAso7oNTFvkbgPx1yeUCcdOng56EBSvkrxu6sNxm01fInX2JWS1cbmkei57c9GnIbVWLfU+QPwDeM3wtAFEghgUU98EpXP76D44TIH9dcrlA3PTpoCdhwQr564YuLLfZ9BVyZ19iVguXW5rHoic3fRpyW9Vi3xPkD4A/ULyQv/6jYw/kr0suF4ibPh30JCxYIX/d0IXlNpu+Qu7sS8xq4XJL81j05KZPQ26rWux7gvwB8A/DRwFkb8iwgOI+OMWTv/4DZI2xFnOBCLkN8aJAxD71izeLPoVajAs9eS2S3A56gvwLyC30ZDVuLh7yl9UC+UP+oBIxuRaAUSD6Z4oif/1nyBZmyCMTiLBgNcSLAhFr0S/eLPoUajEu9OS1SHI76AnyLyC30JPVuLl4yF9WC+QP+YNKRXItAKNA9M+UX/7GPDKBCAtWQ7woELEW/eLNok8uHvLXxzPd06JA7PssYm6hJ6txc/GQv6wWyB/yB5UMdy0Ao0D0zxRX/voPkx3mAhEWrEwfKQpErEW/eLPok4uH/PXxTPe0KBD7PouYW+jJatxcPOQvqwXyh/xBpaO7FoBRIEO3FgIpi/yNI8hrEceF/GW1QP6Qv4M+DbmtarHvCfIHwN8o2Q8X98EppfyNCzRrZAIRFqxMHykKRKxFv3iz6JOLh/z18Uz3tCgQ+z6LmFvoyWrcXDzkL6sF8of8QbWg8AIZurUQSBnlr38d5O+iTwc9yeQk5NaNKyzks0+LArHvs4i5hZ6sxs3FQ/6yWiB/yB9UEwpxH5yyyN/woXQA5O+8Twc9yeQk5NaNKyzks0+LArHvs4i5hZ6sxs3FQ/6yWiB/yB9UGybXApAIBPK3qEWSW8gjxkP+BeQWerIaNxcP+ctqgfwhf1CNSK4FIBGIV/LPAvlD/rJ4yB/yd5g7Gy8+B/mDaoW7FoBEICWRv/5vOyB/yF8WD/lD/g5zZ+PF5yB/UM3orgUgEUiJ5K+/Z4dRLJLc3LjGWvSLN4s+uXjIXx/PdE+LArHvs4i5hZ6sxs3FQ/6yWiB/yB9UO8PXApAIpKTy1z9mhzgu5C+rBfKH/B30achtVYt9T5A/AMFG8UT++oedoBsX8pfVAvlD/g76NOS2qsW+J8gfgODDnQqYqDzy1z9ngy4e8pfVAvlD/g76NOS2qsW+J8gfgMpA0X/cfCd/WW5uXLPckL/YE+RfeG6z6Svkzr7ErBaJuCB/aU+QPwClQcl9trgPALcgJ8OjRjkZ47kPlyFe/Ng7AfKX1QL5Q/4O+jTktqrFvifIH4DKQtgJcOhWlJNh4cd9KN3LXx9nDeQvqwXyh/wd9GnIbVWLfU+QPwCVh+Jn+evz6ceV5ZbXAvlD/oXnNpu+Qu7sS8xqkYgL8pf2BPkDUHpMTgWce8yw8OM+lHnL3xBvh3FcWW55LZA/5F94brPpK+TOvsSsFom4IH9pT5A/AOVBcirg7I3uUaOcjPHch8sQby4Qx+jGleWW1wL5Q/6F5zabvkLu7EvMapGIC/KX9gT5A1A+uFMBZ290jxrlZIznPlyGeHOBGD+UToD8ZT3J5CTk1o0rLOSzT4sCse+ziLmFnqzGzcVD/rJaIH/IHwBn6E4FnL0hw8KP+1AWQ/76V9oD+ct6kslJyK0bV1jIZ58WBWLfZxFzCz1ZjZuLh/xltUD+kD8Azhk+CiB7Q4aFH/ehLJ789a+3RpZbXgvkD/kXntts+gq5sy8xq0UiLshf2hPkD4A3KMR9OLIfXO5D6YX8s+NzH3jIX+wJ8i88t9n0FXJnX2JWi0RckL+0J8gfAO9QDB+u4f+J+1AWXf76NHZwH3jIX+wJ8i88t9n0FXJnX2JWi0RckL+0J8gfAG/hrgVglJP+meLKX5/LDv3izSy3rBbjQk9eiyS3g54g/wJyCz1ZjZuLh/xltUD+kD8A+aO7FoBRTkO3vJz0j+YWnvxt8eQvjgr5y2oxjiss5LNPiwKx77OIuYWerMbNxUP+slogf8gfgMJQsh9c7kNZSvkbF5b2QP5iT5B/4bnNpq+QO/sSs1ok4oL8pT1B/gD4B42X09AtLyf9o7mFJ38L+ctqMU5f6+llkVtai3FcYSGffVoUiH2fRcwt9GQ1bi4e8pfVAvn7Sf5jxzZnpk+blp4wfny6ZVxLZlxLS3rcuJZM85jRmfr6+kx9fX2mob4+U99QT5FwOBMKhUjVNAppWkbTNEokEjQ4OMgGBuIUH4yzwfggxeNx6u7pYbs7OpSOjj1s9+7dbPfuDra7o0Npb9/F2tralC1btynpdLpUbYEqQSPuQ1ke+etzOwDyl9RiHFcuRVm8kz6LmFvoyWrcXDzkL6sF8vdC/pqm0ZzZs1MHHLAgfeABC1Pz5s1Nz5g+PT1j+rR0bW1tppDc4XCYwuFwpq6ujoiIz5Uye108PkhtbW3Kug0b1A0bWpX16zcoy1esVD9e9YmaSCQKKQlUEdrQf9zCstTy16e3A/KX1GIcVy5FWbyTPouYW+jJatxcPOQvqwXyL5f8p02dkj7yyCNSRx15RPLII49ILVywIBWJhPNJVTIikTDNnz8vPX/+PMNmgHh8kFasXKl+8MGH6vsffKS+/+GH2tq165RMpqD1FFChaIK4/CR/oQ5ZLcaFnrwW/atFgZj1FGT5H3bopCP+4wef+x8CRESUSmWSiUQ6kUikBwcT6cFEIj2YTKQTg4nMYH9fsrdz/+Dezs7E3n2dg3s6Owf3du5P7N2/P7F3587+rT09qa6hLJB/Jcq/uXlM5qQTT0iefNIJyRNPOD45ccKEwG5bj0TCdMThh6WOOPyw7NaD9vZd7KW/v6z99aW/h/720t+19vZdeS2FQeWhEXkhfzfzH+Sf/7dzMIKqMk1VVS0aVWvcvnb//sS+rdv6Nm7Z2te2dWt/29at/Rs3bupd19WV7CQiyD+A8p8zZ3b6nLPPTJx91pmJgxcvShlrqizGjWvJXHjB+YkLLzg/QUT08apP1L/+7SXt9394LvTOO++p2DpQvWheyN+d/nV/Qf4u5F+5C7RyM2pUqGnUqFFNBywcdYj+8W3b+zet+qTrw9Wruz785JPujzr2DLYPPQP5+1H+06ZOSV980QWJJeecnVi4YIHp7+uVzoEHLEwdeMDC1NdvvD6+dds25Zlnfx96+pnfhd59733V69pAeRnaB6Ds8ncrJ8hfPy7k7w8mTayZNmlizbTTThl3DhHRrt3xHctX7H/nzbf2/vXjj7vfS6czacjfJneJ5R+NRujss85MXH7pxYPHf/a4ZCV/08+HyZMmpW+8/mvxG6//WnzT5i3K0888G3rokcfC69dvULyuDZQezRP5u/oMQv76cSF//9IyNjLh1JNbvnjqyS1f7OpKdr79zr6XXn9j719Wre76kDJs+HdlyL8c8h8/flzm2mu+HL/m6isGR48ejW3cDpg2dUr6n79+Y/wb/3RD/JVXX9N+ef+D4T8893wIRxVULlruz3LK34WkIH/38se3HM9paNAaTz1l7JJTTxm7pLMzsefFv+x+5s8v7H5qf1dyH+Svjy+u/OfPn5f+5jf+aWDpeUsSoVCIgHsYY3T8Z49LHv/Z45Lt7bvYw48uC9//wEPhLVu3YqtAhWFyLQCfyN9QBeTvRv5YBfAPjY2hMecvnXjNz//3oN997avTb5s8JToD8pfkNsS7k//cuXPSD/7q3r533nil+6ILvwT5F4lx41oy3/rmN+IrP3q3+957fto/b97cwB4hAUQk1wLwk/yNWaxrgfyN8scqgN8IhZTwSSeOOftHdy9cduvNs/9rxvSauZC/LN65/CdNnJi+757/7Xvvrde6l563JKEo+JJaCjRNo4svvGDwvbde6172yAN9hxy8uGp3oqwkuGsBlEf+RulaA/nr4yH/SoAxYocc3HD0D/7v/Ae/eu2U20aNCjVB/u7k//vfH/jJbbd8K/7h+2/1XHThlyD+MsEYo7PPOjPx6t//0vPsU7/pVVUcOBBkdNcC8J/8DUD+7uSP/QB8D2OknHzimLOPOarx5Keeab//j8/veSKVyiQhf1l8Lran+4YVH7z3Zs/kSZOwOdpDTjn5xGQopFEqhY0BQUXxRP5u5QT5Q/4VTE2NWnvpxRNvvPsHcx6ZMqVmFuQvl39Dg9L0+dNfev/Xyx7ug/wBKBwF8pfl1r86mPLPe0sL8IzJk6Iz7rpz9gOnnTzm3KFHIP+R/488InzKd29L/OncJV/EMWk+It7f83o6ndrvdR0gP4ZPBZy7LY/83coJ8of8q4NQiIW/fPXEmw48sO7we+/bfldvX6q7muUfibCaSy6q+eZnjgmdSVSD4/l9RnIw3jYwMLBeC4WnhSKxgxRVG+N1TcA5mhfyd6cnyB/yrz7+4ciGk2ZMj877v/+++evt7YNbq1H+Uyarc/7xq7E7x49TphHwNcnE4KZkYnCTqoUnRmsbTiHCgigIKMQJxF/yl0tOXgvkL/3dGASWlpbwpP/zr9PvnTa1Zs7QI9Uj/yOPCJ162611v4T8g0UqObidKIP9MwLC0LEzZZe/G0FB/nnJH+sAFcGoUdro73578j3z5sYWEVW+/BljytJzo9d/9SuxO8IhihAAoGQonsjfrZwg/zzkjzWASqG2NlR7y00Tf7p4Ue1RlSz/cEiJ3Hhd7O4zTo9cRgCAkiOeCjj7Xynl70JOkH9e8of+K4toNBT+pxvG/sekicmDKlH+sZhS/83/r/anixeHjiUAQFkwngo4+59P5K8D8rfq0yo3qBRisWjon78+5seh0M7ZlST/pkZ17K031907e5Z6kKxvAEBpUIxiyf1dSvm7/X4K+Vv1CflXExMnjo9948ZRP+nvXzdl6JGAy79Jbbn5W7X3TJygzJB3DAAoFQovkKFbyB/yB37lkEMWj77s4sEf7d71weShRwIq/0Z17E3frP3Z2LHKJIt2AQAlYvgogOyNr+SfA/LPNzeoTM4995wpE8b9+Vs7tr82gyh48h81Smn+1r/U/qylRZls1ysAoDRw1wIok/wNCxQ7IH/IH8j40Y/+45C1a/7t4s59q8flHvW//KNRJfbPX6/9r3EtyhQHbQIASoTuWgB+lD9xeXQ1QP6WubEWUPmMGTMm/OMf/+dhf//bNUv7+9rrgiB/VWXa9V+L/fuUyeocF60CAEqAQuSF/N3ICfLPPzeodM4777yJZ5xx7Ly/v3Tt0mSyP+Rn+RMxuvLymtsWLtCOcNUkAKAkKF7I362eIP8CcoOK56677lq4v3P1hDdf/5cv+Fn+p50aueiYo8Ofd9UcAKBkaEP/lVv+zuUE+ReQG1QFc+bMqbv44osnP/LII5m21t8dMGPmOauGnvGP/OfN0w49/7zoDXk1GGB2794dX7t2bU9ra2tfa2trb2tra+/GjRv79u/fn+zt7U329fWlent7U729vUlFUVgsFlNjsZhaU1OT/X/8+PGRqVOnxqZOnVozZcqUmpG/J0+eXON1fyDYaH6Wfza3Lg/k7zA3VgKqiu985zvzli1btvW9d/7PKRMmHLsxWjO21y/yb2pUxn7t2tj3FYXUvBsMCGvXru157bXX9gz/27tu3boeFy/PDA4Opjs7OxNOgkePHh0+7LDDGg877LDGww8/vPGwww5rnD59eizP0kEVonkif9c7AkL++eQG1cPcuXPrLrzwwsmPPfbYlnfe/u5pnz3xnmf8IH/GiF1zdc336utZU97N+ZxVq1Z1P/7441sff/zxra2trb3lGnfv3r2DL7744q4XX3xx18hj48aNi5x++unjzjjjjHGnnXZaS1NTU6hc9YDgkf0JAPK3yS2txb/yD8IqwIIFC/66Zs2a7lLkjkajajQaVerq6rTx48dHJk6cGJ05c2btokWLRi1atKjh4IMPHqWqahAmk2NuuummOY899tiWzZuen7dl0/Pzpk77/Kdeyp+I6HOnRS6eP187vIC2fEl3d3fyF7/4xcaHH35488qVK7u8rmeE9vb2+EMPPbT5oYce2qyqKjvqqKNGn3HGGS1Lly6dNG/evDqv6wP+QvO1/CWjQv6VIf9SMzAwkBoYGEh1dnYmtm7d2s8/39jYGDrhhBOazzvvvIlLliyZWFtbG/jN04sWLWpYtGhRw4oVK7o+eP/fT5gy9fS1jKkZr+Q/ZYo2++wzlRsL7ctP7NmzZ/AnP/lJ609+8pMNTjfVe0Uqlcq8/vrre15//fU93/nOd1YffvjhjZdccsmUyy67bMqYMWPCXtcHvEfzQv5ujgOA/AvIDUzp7OxMPPvsszueffbZHXV1dcuvuOKKqTfffPOcKVOmBHrHqksvvXTKTTfdtKq7q62prfXZA2bOWvqxF/JXVaZ88az1j0cii1OF9uQHent7U3fcccean/70p629vb0F9cSYElUUtYEpSj1T1DpFUeuZotQxxkLEWIgRU4kxjTEWIqJMJpNJUiaTzFAmRZlMkohSmXS6P51J92bSqd5MOt2bSad705lUTyad7jMb97333ut87733Om+55ZZV55133sR//Md/nHHccceNKaQXEGx0OwH6T/5GIH938sdKgFN6enqS//u//9t67733brzhhhtm3H777Qvq6uo0r+vKh4suumjyLbfc8kk6nc6sXP6TY2bOWrKKaGgrwBCllz9jjJoa7/7gkIPvHChOV97yhz/8Yef111+/fPPmzcKWJCcoitqgaKFxqqq1KFqoRVHUBhcvZ4yxMDEWNnyiVZLuUZnJZOLpVHLPyL9UKrknk04ZdkSMx+PpZcuWbV22bNnWww47rPGb3/zm7PPPP3+SpmlYaFQZhlMBD/1VDvm7nc8gf9fyx0fZNYlEIv1f//VfGxYuXPjXV199dY/X9eTD5MmTa44//vgxRERdXa2j21p/v7Dc8n/11eNW/et3bo0Xox8v2bFjx8D555//zllnnfWWW/krqtoYjsYOidU3nVtT37QkUlN3jBaOznYpf9cwxiKqFpoYitQcFInVnxCrbzov1jD6S5Ga+mO1UGQ6Y8yw6f/999/vvPjii9+bO3fui/fdd9/GwcHBdCnrA/5C80T+ruQE+ecn/2CuAZx82sP31ddPG5avsSfh5yAiIiZ574T4of9T6UEtkx7Ukon+0MDAntr+/o763t5tjfs7143dv39dS+e+T8dlMmm2ZcuW/pNOOum1//7v/z7o+uuvn1mqXkvFkiVLJr700ksdRESrVv7sH2bOOndVueT/6ydmrX74gV/21dbWZorWkAe89tpre5YuXfpOe3u74xUZxlhIC0fnaqHILEXVmkpZnxsYU2q0cGSWFo7MIqJMKpXYnUoktqUS8U3pdGo/EVFbW1vftdde+9Edd9zx6fe+9735V1555dRK20kWiGQ3c5ZX/i7mK8jfeW6hpyDCC6c48idGpKmRJKmRZCjUMFATG9fdRGxnbhIzSgx2R3ften/qtq1/nbdt69/m3nDDDSt6enpSN998c6DOW6//XXffvtUt+/ataWlqWrCrHPI//LBDU+cu+aKvd46z4xe/+MXGG2+8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",
    manifestInline,
    manifestFile
  };
})();
</script>

<title>ProCode IDE v19.0 - Hyper Ultimate ULTRA Edition</title>
<!-- FONTS -->
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&amp;family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
<!-- CORE ENGINE -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- COMPILERS & RUNTIMES -->
<script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.4.5/typescript.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<!-- FORMATTERS -->
<script src="https://unpkg.com/prettier@3.2.5/standalone.js"></script>
<script src="https://unpkg.com/prettier@3.2.5/plugins/html.js"></script>
<script src="https://unpkg.com/prettier@3.2.5/plugins/babel.js"></script>
<script src="https://unpkg.com/prettier@3.2.5/plugins/postcss.js"></script>
<script src="https://unpkg.com/prettier@3.2.5/plugins/typescript.js"></script>
<!-- TERMINAL -->
<link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
<!-- NOTIFICATIONS -->
<link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<!-- COMPRESSION -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
<!-- CHART.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<!-- LOTTIE ANIMATIONS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<!-- PRISM.JS FOR SYNTAX HIGHLIGHTING -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<!-- MONACO EDITOR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
<script>
/* Monaco bootstrap (CDN + worker fix) */
(function () {
  const CDN_VS = "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs";
  const CDN_BASE = "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min";
  function boot() {
    if (!window.require) return;
    // Ensure workers can load from CDN even when running from file:// or Live Server
    window.MonacoEnvironment = window.MonacoEnvironment || {};
    window.MonacoEnvironment.getWorkerUrl = function (_moduleId, _label) {
      const proxy = [
        "self.MonacoEnvironment = { baseUrl: '" + CDN_BASE + "/' };",
        "importScripts('" + CDN_BASE + "/vs/base/worker/workerMain.js');"
      ].join("\n");
      return "data:text/javascript;charset=utf-8," + encodeURIComponent(proxy);
    };

    try {
      window.require.config({ paths: { vs: CDN_VS } });
    } catch (e) {
      console.warn("Monaco require.config failed:", e);
    }

    window.require(
      ["vs/editor/editor.main"],
      function () { window.__MONACO_READY__ = true; },
      function (err) {
        console.error(" Monaco failed to load:", err);
        window.__MONACO_READY__ = false;
      }
    );
  }

  // loader.js is in <head>, so this is usually immediate; still guard for safety.
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>
<style>
        :root {
            --bg-dark: #09090b; --bg-panel: #18181b; --bg-side: #121215;
            --border: #27272a; --text: #e4e4e7; --text-dim: #71717a;
            --primary: #6366f1; --primary-hover: #4f46e5;
            --accent: #a855f7; --error: #ef4444; --success: #22c55e; --warn: #f59e0b;
            --header-h: 48px; --footer-h: 28px; --act-bar-w: 52px; --side-w: 280px;
            --editor-font-size: 14px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* CORE */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        body { 
            margin:0; background:var(--bg-dark); color:var(--text); 
            font-family:'Inter', sans-serif; height:100vh; overflow:hidden; 
            display:flex; flex-direction:column; user-select: none;
            font-size: 14px; -webkit-font-smoothing: antialiased;
        }
        
        ::-webkit-scrollbar { width:10px; height:10px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-corner { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius:5px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* UTILITY CLASSES */
        .flex { display:flex; } .col { flex-direction:column; } .row { flex-direction:row; }
        .ac { align-items:center; } .jc { justify-content:center; } .jb { justify-content:space-between; }
        .hidden { display:none !important; } .visually-hidden { opacity:0; pointer-events:none; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .gap-6 { gap: 24px; }
        .p-2 { padding: 8px; } .p-4 { padding: 16px; } .p-6 { padding: 24px; }
        .m-2 { margin: 8px; } .m-4 { margin: 16px; }
        .rounded-sm { border-radius: 4px; } .rounded { border-radius: 8px; } .rounded-lg { border-radius: 12px; }
        .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .shadow-lg { box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .w-full { width: 100%; } .h-full { height: 100%; }
        .transition { transition: var(--transition); }
        
        /* HEADER */
        header { 
            height:var(--header-h); background:var(--bg-panel); border-bottom:1px solid var(--border);
            padding:0 16px; display:flex; align-items:center; gap: 12px; z-index: 50; flex-shrink: 0;
        }
        
        .logo { font-weight:800; font-size:15px; letter-spacing:-0.5px; display:flex; align-items:center; gap:8px; color: #fff; }
        .logo span { background:linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip:text; color:transparent; font-size:17px; }
        .logo .version { font-size:10px; background:linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding:2px 6px; border-radius:12px; font-weight:600; }

        /* BUTTONS */
        .btn {
            background: transparent; color: #a1a1aa; border:1px solid transparent; padding:0 12px; border-radius:6px; 
            cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px; transition:var(--transition); height: 34px;
            font-family: 'Inter', sans-serif; font-weight:500; white-space: nowrap;
        }
        .btn:hover { background: rgba(255,255,255,0.08); color:white; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color:white; font-weight:600; border:none; }
        .btn.primary:hover { background: linear-gradient(135deg, var(--primary-hover), #9333ea); box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
        .btn.secondary { background: var(--bg-side); border:1px solid var(--border); }
        .btn.danger { background: var(--error); color:white; }
        .btn.success { background: var(--success); color:white; }
        .btn.small { height: 28px; padding: 0 10px; font-size: 12px; }
        .btn.large { height: 40px; padding: 0 20px; font-size: 14px; }
        .btn.icon { width:34px; padding:0; justify-content:center; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; pointer-events:none; }
        
        .input {
            background: #27272a; border: 1px solid #3f3f46; border-radius:6px; padding: 10px 12px;
            color: white; font-size: 13px; font-family: 'Inter', sans-serif;
            transition: var(--transition); width:100%;
        }
        .input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .input::placeholder { color: #71717a; }
        
        /* WORKSPACE */
        #workspace { flex:1; display:flex; overflow:hidden; position:relative; }
        
        /* ACTIVITY BAR */
        .act-bar { width:var(--act-bar-w); background:linear-gradient(180deg, var(--bg-side), #0f0f11); border-right:1px solid var(--border); 
                  display:flex; flex-direction:column; align-items:center; padding-top:16px; z-index:10; flex-shrink: 0; gap:4px;}
        .act-btn { width:44px; height:44px; display:flex; align-items:center; justify-content:center; color:#52525b; font-size:20px; cursor:pointer; 
                   transition:var(--transition); position:relative; border-radius:10px; background:transparent;}
        .act-btn:hover { color:#a1a1aa; background: rgba(255,255,255,0.05); transform: scale(1.05); }
        .act-btn.active { color:#e4e4e7; background: rgba(255,255,255,0.08); }
        .act-btn.active::before { content:''; position:absolute; left:0; top:12px; bottom:12px; width:3px; background:var(--primary); border-radius:0 4px 4px 0; }
        .act-btn.badge::after { content: ''; position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
        .act-btn .tooltip { position:absolute; left:calc(100% + 10px); background:#27272a; color:white; padding:6px 10px; border-radius:6px; 
                            font-size:12px; white-space:nowrap; display:none; z-index:1000; border:1px solid var(--border); }
        .act-btn:hover .tooltip { display:block; }

        /* SIDEBARS */
        .sidebar { width:var(--side-w); background:var(--bg-side); border-right:1px solid var(--border); display:none; flex-direction:column; flex-shrink: 0; }
        .sidebar.active { display:flex; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity:0.8; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
        .sb-head { height:40px; padding:0 16px; display:flex; align-items:center; justify-content:space-between; font-size:11px; font-weight:700; 
                   color:#a1a1aa; text-transform:uppercase; letter-spacing:0.5px; background: linear-gradient(180deg, #161619, #141417);}
        
        /* FILE TREE */
        .tree { flex:1; overflow-y:auto; padding:8px 0; }
        .t-item { padding:6px 0; cursor:pointer; color:#a1a1aa; font-size:13px; display:flex; align-items:center; transition:0.1s; user-select: none; position: relative; }
        .t-item:hover { background:#2a2a2d; color:#e4e4e7; }
        .t-item.active { background:#37373d !important; color:#fff; }
        .t-item.active::before { content:''; position:absolute; left:0; top:0; bottom:0; width:2px; background:var(--primary); }
        .t-indent { width:100%; display: flex; align-items: center; padding: 4px 0; }
        .t-sub { display: block; }
        .t-sub.hidden { display: none; }
        
        /* EDITOR TABS */
        .tabs { display:flex; background:var(--bg-panel); height:38px; overflow-x:auto; border-bottom:1px solid var(--border); scrollbar-width:none; flex-shrink: 0; 
                padding:0 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { display:flex; align-items:center; padding:0 16px; height:100%; border-right:1px solid #27272a; font-size:12px; color:#71717a; 
               cursor:pointer; background: #18181b; min-width:140px; max-width:220px; gap: 8px; border-top: 2px solid transparent; transition: var(--transition);
               position:relative; }
        .tab.active { background:var(--bg-dark); color:#e4e4e7; border-top-color:var(--primary); }
        .tab .close { width:18px; height:18px; display:flex; align-items:center; justify-content:center; border-radius:4px; opacity:0; transition:0.2s; font-size: 14px;}
        .tab:hover .close { opacity:0.8; }
        .tab .close:hover { background:#ef4444; color: white; opacity: 1;}
        .tab.dirty::after { content:'*'; position:absolute; right:6px; top:50%; transform:translateY(-50%); color:var(--primary); font-size:20px; }
        
        /* EDITOR AREA */
        #main { flex:1; display:flex; flex-direction:column; min-width:0; background:var(--bg-dark); position:relative; overflow: hidden; }
        #editor-container { flex:1; position:relative; display:flex; }
        .editor-pane { flex:1; position: relative; overflow: hidden; border-right:1px solid var(--border); }
        .editor-pane:last-child { border-right: none; }
        .pane-header { height:32px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; 
                      font-size:11px; color:var(--text-dim); justify-content:space-between; }
        
        /* BOTTOM PANEL */
        #panel-btm { height:240px; border-top:1px solid var(--border); background:var(--bg-panel); display:flex; flex-direction:column; 
                     position:absolute; bottom:0; left:0; right:0; z-index: 20; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); }
        .panel-tabs { display:flex; height:36px; background:var(--bg-panel); border-bottom:1px solid var(--border); padding:0 8px; gap:1px; }
        .panel-tab { padding:0 16px; height:100%; display:flex; align-items:center; cursor:pointer; border-bottom:2px solid transparent; 
                     color: #71717a; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; transition: var(--transition); gap:6px; }
        .panel-tab:hover { color: #e4e4e7; background:rgba(255,255,255,0.03); }
        .panel-tab.active { color:#e4e4e7; border-bottom-color:var(--primary); background:rgba(255,255,255,0.05); }
        .panel-tab .badge { background:var(--primary); color:white; font-size:9px; padding:1px 4px; border-radius:10px; min-width:16px; text-align:center; }

        /* CONSOLE OUTPUT */
        .console-line { padding: 2px 0; white-space: pre-wrap; }
        .console-log { color: #e4e4e7; }
        .console-info { color: #60a5fa; }
        .console-warn { color: #fbbf24; }
        .console-error { color: #fb7185; }
        .console-success { color: #4ade80; }
        
        /* PREVIEW PANEL */
        #preview-wrap { width:0; background:white; display:flex; flex-direction:column; border-left:1px solid var(--border); transition: width 0.3s; position:relative; z-index: 15; flex-shrink: 0; }
        #preview-wrap.visible { width: 50%; min-width:400px; }
        .preview-toolbar { height:40px; background:#f4f4f5; border-bottom:1px solid #ddd; display:flex; align-items:center; padding:0 12px; gap:8px; }
        .preview-url { flex:1; background:white; border:1px solid #ddd; border-radius:6px; padding:6px 12px; font-size:12px; color:#444; font-family:'JetBrains Mono'; }
        
        /* RESIZERS */
        .resizer { position:absolute; z-index:99; background:transparent; transition: background 0.2s; }
        .resizer:hover, .resizer.dragging { background:var(--primary); transition-delay: 0.2s; }
        .r-w { width:6px; height:100%; cursor:col-resize; top:0; }
        .r-h { width:100%; height:6px; cursor:row-resize; top:0; left:0; }
        
        /* FOOTER */
        footer { height:var(--footer-h); background:var(--bg-panel); color:var(--text); display:flex; align-items:center; padding:0 16px; 
                font-size:11px; justify-content:space-between; flex-shrink: 0; z-index: 55; border-top: 1px solid var(--border); }
        .f-stat { display:flex; gap:16px; font-weight:500; align-items:center; }
        .f-stat span { cursor: pointer; opacity: 0.9; display:flex; align-items:center; gap:4px; } 
        .f-stat span:hover { opacity: 1; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; }
        .status-dot.offline { background: var(--error); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
        
        /* MODALS & OVERLAYS */
        .modal-overlay { position:fixed; inset:0; background: rgba(9,9,11,0.9); backdrop-filter:blur(4px); z-index:9998; display:none; align-items:center; justify-content:center; }
        .modal { background:var(--bg-panel); border-radius:16px; border:1px solid var(--border); min-width:500px; max-width:800px; max-height:85vh; 
                 display:flex; flex-direction:column; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.5); animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
        .modal-header { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:24px; overflow-y:auto; flex:1; }
        .modal-footer { padding:20px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px; }
        
        /* LOADER */
        #loader-overlay { position:fixed; inset:0; background:linear-gradient(135deg, #09090b, #0a0a0f); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* AI ASSISTANT */
        #ai-float { position:absolute; right:24px; bottom:24px; width:460px; height:560px; background:var(--bg-panel); border:1px solid var(--border); 
                    z-index:100; border-radius:16px; display:none; flex-direction:column; box-shadow:0 25px 50px rgba(0,0,0,0.5); animation: floatIn 0.3s ease-out; }
        @keyframes floatIn { from { opacity:0; transform:translateY(20px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }
        .ai-header { padding:16px 20px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, #1f1f22, #18181b); border-radius:16px 16px 0 0; }
        .ai-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
        .msg-bubble { background: #27272a; padding:12px 16px; border-radius:12px; font-size:13px; max-width:85%; line-height:1.5; word-break:break-word; animation: bubbleIn 0.2s ease-out; }
        @keyframes bubbleIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .msg-user { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; align-self: flex-end; margin-left:auto; }
        .msg-sys { color: #e4e4e7; border: 1px solid var(--border); margin-right:auto; }
        .code-block { background: #111; padding:12px; border-radius:8px; font-family:'JetBrains Mono', monospace; margin-top:8px; white-space:pre-wrap; 
                     font-size:12px; overflow-x:auto; border:1px solid #333; line-height:1.4; position:relative; }
        .code-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #333; }
        .code-lang { font-size:10px; color:#a1a1aa; text-transform:uppercase; font-weight:600; }
        .copy-btn { background:#27272a; border:none; color:#a1a1aa; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; }
        .ai-typing { display:flex; gap:6px; padding:16px; justify-content:center; }
        .ai-typing span { width:10px; height:10px; background:var(--primary); border-radius:50%; animation:bounce 1.4s infinite ease-in-out; }
        .ai-typing span:nth-child(1) { animation-delay:-0.32s; }
        .ai-typing span:nth-child(2) { animation-delay:-0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform:scale(0); } 40% { transform:scale(1); } }
        
        /* CONTEXT MENU */
        .context-menu { position:fixed; background:#27272a; border:1px solid var(--border); border-radius:8px; padding:6px; z-index:9999; min-width:180px; 
                       box-shadow:0 10px 30px rgba(0,0,0,0.5); backdrop-filter:blur(10px); }
        .context-item { padding:10px 12px; font-size:12px; color:#e4e4e7; cursor:pointer; border-radius:6px; display:flex; align-items:center; gap:10px; }
        .context-item:hover { background:#3f3f46; }
        .context-item.disabled { color:#71717a; cursor:not-allowed; }
        .context-divider { height:1px; background:#3f3f46; margin:6px 0; }
        
        /* TOOLTIPS */
        .tooltip { position:absolute; background:#27272a; color:white; padding:6px 10px; border-radius:6px; font-size:11px; white-space:nowrap; 
                   z-index:10000; border:1px solid var(--border); pointer-events:none; opacity:0; transition:opacity 0.2s; }
        .tooltip.show { opacity:1; }
        
        /* NOTIFICATIONS */
        .notification { position:fixed; bottom:20px; right:20px; background:#27272a; border:1px solid var(--border); border-radius:8px; padding:12px 16px; 
                       max-width:400px; z-index:999; animation:slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        
        /* EMPTY STATE */
        #empty-state { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:var(--bg-dark); z-index:5; }
        .empty-icon { font-size:72px; color:#27272a; margin-bottom:24px; opacity:0.5; }
        .empty-title { font-size:18px; font-weight:600; color:#52525b; margin-bottom:8px; }
        .empty-subtitle { font-size:13px; color:#71717a; text-align:center; max-width:400px; line-height:1.5; }
        
        /* STATUS BAR ITEMS */
        .status-item { display:flex; align-items:center; gap:6px; padding:4px 8px; border-radius:4px; transition:var(--transition); }
        .status-item:hover { background:rgba(255,255,255,0.05); }
        
        /* COMMAND PALETTE */
        #command-palette { position:fixed; top:20%; left:50%; transform:translateX(-50%); width:600px; background:var(--bg-panel); border:1px solid var(--border); 
                          border-radius:12px; z-index:9997; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.5); }
        .command-input { padding:20px; border-bottom:1px solid var(--border); }
        .command-list { max-height:400px; overflow-y:auto; }
        .command-item { padding:12px 20px; cursor:pointer; display:flex; align-items:center; gap:12px; transition:var(--transition); }
        .command-item:hover, .command-item.selected { background:#27272a; }
        .command-icon { width:20px; color:#a1a1aa; text-align:center; }
        .command-text { flex:1; font-size:13px; }
        .command-shortcut { font-size:11px; color:#71717a; font-family:'JetBrains Mono'; }

.command-section { padding:8px 20px; font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.08em;
                  background:rgba(255,255,255,0.02); border-top:1px solid var(--border); }
.command-item.file-item .command-text { display:flex; flex-direction:column; gap:2px; }
.command-item.file-item .cp-title { font-size:13px; font-weight:500; }
.command-item.file-item .cp-desc { font-size:11px; color:var(--text-dim); font-family:'JetBrains Mono'; opacity:0.9; }
        
        /* DASHBOARD */
        .dashboard { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; padding:20px; }
        .dashboard-card { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:20px; }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .card-title { font-size:14px; font-weight:600; color:var(--text); }
        
        /* PROGRESS BARS */
        .progress-bar { height:6px; background:#27272a; border-radius:3px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); border-radius:3px; transition:width 0.3s; }
        
        /* TOGGLE SWITCH */
        .switch { position:relative; display:inline-block; width:44px; height:24px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#3f3f46; transition:.4s; border-radius:24px; }
        .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.4s; border-radius:50%; }
        input:checked + .slider { background:var(--primary); }
        input:checked + .slider:before { transform:translateX(20px); }
        
        /* COLLAPSIBLE */
        .collapsible-header { padding:12px 16px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .collapsible-content { padding:0 16px 16px; display:none; }
        .collapsible.open .collapsible-content { display:block; }
        
        /* BADGES */
        .badge { display:inline-flex; align-items:center; justify-content:center; padding:2px 8px; border-radius:12px; font-size:10px; font-weight:600; }
        .badge.primary { background:var(--primary); color:white; }
        .badge.secondary { background:#3f3f46; color:#a1a1aa; }
        .badge.success { background:var(--success); color:white; }
        .badge.error { background:var(--error); color:white; }
        
        /* GRADIENTS */
        .gradient-primary { background:linear-gradient(135deg, var(--primary), var(--accent)); }
        .gradient-dark { background:linear-gradient(135deg, #09090b, #1a1a1f); }
        
        /* CUSTOM SCROLLBAR FOR MONACO */
        .monaco-scrollable-element > .scrollbar > .slider { background: #3f3f46 !important; }
    

/* v19.0 ULTRA */
/* ULTRA+ UX MODES (v19.0) */
body.no-anim *, body.reduce-motion *{
  transition: none !important;
  animation: none !important;
  scroll-behavior: auto !important;
}
body.compact{
  --header-h: 44px;
  --tab-h: 30px;
  --btn-pad-y: 6px;
  --btn-pad-x: 10px;
}
body.compact .toolbar{ height: var(--header-h); }
body.compact .tab{ height: var(--tab-h); }
body.compact .file-item{ padding: 6px 10px; }
body.compact .btn{ padding: var(--btn-pad-y) var(--btn-pad-x); }
body.compact .panel-header{ height: 34px; }
body.compact .statusbar{ height: 26px; font-size: 11px; }

#drag-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
}
#drag-overlay.visible{ display:flex; }
#drag-overlay .dropbox{
  width: min(720px, calc(100vw - 48px));
  border: 2px dashed var(--primary);
  border-radius: 18px;
  background: rgba(24,24,27,0.9);
  color: var(--text);
  padding: 18px 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}
#drag-overlay .dropbox h3{ margin: 0 0 6px; font-size: 16px; }
#drag-overlay .dropbox p{ margin: 0; color: var(--text-dim); font-size: 13px; line-height: 1.4; }
#drag-overlay .dropbox code{
  background: rgba(0,0,0,0.35);
  border: 1px solid var(--border);
  padding: 2px 6px;
  border-radius: 8px;
}
#command-palette.hidden{display:none !important;}
#command-palette{display:flex;flex-direction:column;}
#command-list{max-height:420px;overflow:auto;}

/* INSPECTOR (v19.0) */
#preview-wrap{ position:relative; }
#inspector-hint{
  position:absolute; left:12px; top:52px; z-index:35;
  background: rgba(24,24,27,0.92); color:#e4e4e7; border:1px solid var(--border);
  padding:8px 10px; border-radius:10px; font-size:12px;
  display:none; align-items:center; gap:8px;
  backdrop-filter: blur(8px);
}
#inspector-hint.visible{ display:flex; }
#inspector-hint .pill{ background:#111114; border:1px solid #1f1f22; color:#a1a1aa; border-radius:999px; padding:3px 8px; font-size:11px; }
#inspector-panel{
  position:absolute; top:40px; right:0; bottom:0; width:360px;
  background:#0b0b0d; border-left:1px solid var(--border); z-index:34;
  display:none; flex-direction:column;
}
#inspector-panel.visible{ display:flex; }
#inspector-panel .inspector-header{
  height:44px; display:flex; align-items:center; justify-content:space-between;
  padding:0 14px; border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, #141417, #0f0f11);
}
#inspector-panel .inspector-title{ font-weight:700; font-size:12px; letter-spacing:0.5px; color:#e4e4e7; text-transform:uppercase; }
#inspector-panel .inspector-body{ flex:1; overflow:auto; padding:12px 14px; font-family:'JetBrains Mono', monospace; font-size:12px; color:#e4e4e7; }
#inspector-panel .kv{ margin:10px 0; }
#inspector-panel .kv .k{ color:#a1a1aa; font-size:11px; }
#inspector-panel .kv .v{ color:#e4e4e7; margin-top:3px; word-break:break-word; }
#inspector-panel pre{
  white-space:pre-wrap; word-break:break-word;
  background:#111114; border:1px solid #1f1f22; border-radius:10px;
  padding:10px; margin-top:8px;
}
#inspector-panel .actions{ display:flex; gap:8px; align-items:center; }
#inspector-panel .mini{ height:28px; padding:0 10px; font-size:12px; border-radius:8px; }
#inspector-panel .pill{ background:#111114; border:1px solid #1f1f22; color:#a1a1aa; border-radius:999px; padding:3px 8px; font-size:11px; }

</style>
</head>
<body>
<div id="drag-overlay" aria-hidden="true">
  <div class="dropbox" role="dialog" aria-label="Import files">
    <h3> Th file / folder / ZIP vo y  import</h3>
    <p>
      H tr: <code>.zip</code>, file n l, hoc folder (Chrome/Edge). 
      Tip: <code>Ctrl</code>+<code>Shift</code>+<code>S</code>  Export ZIP.
    </p>
  </div>
</div>

<!-- BOOT SCREEN -->
<div id="loader-overlay">
<div class="logo" style="margin-bottom:24px; font-size: 28px;"><i class="fas fa-code"></i> PRO CODE <span>IDE</span> <span class="version">v19.0</span></div>
<div class="spinner"></div>
<div id="boot-status" style="margin-top:20px; font-family:'JetBrains Mono'; font-size:13px; color:#71717a">Initializing Pro Code IDE v19.0...</div>
<div id="boot-progress" style="width:300px; height:4px; background:#27272a; border-radius:2px; margin-top:20px; overflow:hidden;">
<div id="boot-progress-fill" style="width:0%; height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); transition:width 0.5s;"></div>
</div>
</div>
<!-- COMMAND PALETTE -->
<div class="hidden" id="command-palette">
<div class="command-input">
<input autocomplete="off" class="input" id="command-input" placeholder="Type a command or search..." type="text"/>
</div>
<div class="command-list" id="command-list"></div>
</div>
<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
<div class="modal" style="width:700px;">
<div class="modal-header">
<h3 style="font-weight:600; font-size:16px;"><i class="fas fa-cog"></i> IDE Settings</h3>
<button class="btn icon small" onclick="Settings.hide()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-body">
<div class="tabs" style="height:auto; border-bottom:1px solid var(--border); margin-bottom:20px;">
<div class="tab active" data-tab="editor">Editor</div>
<div class="tab" data-tab="appearance">Appearance</div>
<div class="tab" data-tab="features">Features</div>
<div class="tab" data-tab="terminal">Terminal</div>
<div class="tab" data-tab="ai">AI Assistant</div>
</div>
<div class="settings-tab" id="settings-editor">
<div class="setting-row">
<div>
<div style="font-weight:500;">Font Size</div>
<div style="font-size:12px; color:var(--text-dim);">Size of text in editor</div>
</div>
<div class="flex ac gap-2">
<button class="btn icon small" onclick="Settings.changeFontSize(-1)"><i class="fas fa-minus"></i></button>
<input class="input" id="font-size-input" max="32" min="8" style="width:80px; text-align:center;" type="number" value="14"/>
<button class="btn icon small" onclick="Settings.changeFontSize(1)"><i class="fas fa-plus"></i></button>
</div>
</div>
<div class="setting-row">
<div>
<div style="font-weight:500;">Tab Size</div>
<div style="font-size:12px; color:var(--text-dim);">Number of spaces for a tab</div>
</div>
<div class="flex ac gap-2">
<button class="btn small" onclick="Settings.changeTabSize(-1)">-</button>
<span id="tab-size-value" style="min-width:30px; text-align:center;">4</span>
<button class="btn small" onclick="Settings.changeTabSize(1)">+</button>
</div>
</div>
<div class="setting-row">
<div>
<div style="font-weight:500;">Word Wrap</div>
<div style="font-size:12px; color:var(--text-dim);">Wrap long lines</div>
</div>
<label class="switch">
<input id="word-wrap-toggle" type="checkbox"/>
<span class="slider"></span>
</label>
</div>
<div class="setting-row">
<div>
<div style="font-weight:500;">Minimap</div>
<div style="font-size:12px; color:var(--text-dim);">Show minimap in editor</div>
</div>
<label class="switch">
<input checked="" id="minimap-toggle" type="checkbox"/>
<span class="slider"></span>
</label>
</div>
</div>
<div class="settings-tab hidden" id="settings-appearance">
<div class="setting-row">
<div>
<div style="font-weight:500;">Theme</div>
<div style="font-size:12px; color:var(--text-dim);">Color theme of the IDE</div>
</div>
<div class="flex gap-3">
<div class="theme-option active" data-theme="dark">
<div style="width:60px; height:40px; background:#09090b; border-radius:6px;"></div>
<div style="font-size:11px; text-align:center; margin-top:4px;">Dark</div>
</div>
<div class="theme-option" data-theme="light">
<div style="width:60px; height:40px; background:#ffffff; border-radius:6px; border:1px solid #ddd;"></div>
<div style="font-size:11px; text-align:center; margin-top:4px;">Light</div>
</div>
<div class="theme-option" data-theme="night">
<div style="width:60px; height:40px; background:#0a0a12; border-radius:6px;"></div>
<div style="font-size:11px; text-align:center; margin-top:4px;">Night</div>
</div>
</div>
</div>
<div class="setting-row">
<div>
<div style="font-weight:500;">Animation</div>
<div style="font-size:12px; color:var(--text-dim);">Enable UI animations</div>
</div>
<label class="switch">
<input checked="" id="animation-toggle" type="checkbox"/>
<span class="slider"></span>
</label>
<div class="setting-row">
  <div>
    <div style="font-weight:500;">Reduce motion</div>
    <div style="font-size:12px; color:var(--text-dim);">Disable transitions/animations for better focus & performance</div>
  </div>
  <label class="switch">
    <input id="reduce-motion-toggle" type="checkbox"/>
    <span class="slider"></span>
  </label>
</div>

<div class="setting-row">
  <div>
    <div style="font-weight:500;">Compact mode</div>
    <div style="font-size:12px; color:var(--text-dim);">Tighter spacing (more lines, more files visible)</div>
  </div>
  <label class="switch">
    <input id="compact-mode-toggle" type="checkbox"/>
    <span class="slider"></span>
  </label>
</div>
</div>
</div>
</div>
<div class="settings-tab hidden" id="settings-features">
  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Restore last session</div>
      <div style="font-size:12px; color:var(--text-dim);">Reopen tabs and layout from previous session</div>
    </div>
    <label class="switch">
      <input id="restore-session-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Persist cursor & scroll</div>
      <div style="font-size:12px; color:var(--text-dim);">Remember cursor position and scroll per file</div>
    </div>
    <label class="switch">
      <input id="persist-cursor-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">CodeLens</div>
      <div style="font-size:12px; color:var(--text-dim);">Inline references and actions in the editor</div>
    </div>
    <label class="switch">
      <input id="codelens-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Breadcrumbs</div>
      <div style="font-size:12px; color:var(--text-dim);">Show navigation breadcrumbs</div>
    </div>
    <label class="switch">
      <input id="breadcrumbs-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Snippets & suggestions</div>
      <div style="font-size:12px; color:var(--text-dim);">Snippet completions and suggestion hints</div>
    </div>
    <label class="switch">
      <input id="snippets-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Live preview</div>
      <div style="font-size:12px; color:var(--text-dim);">Auto reload preview when code changes</div>
    </div>
    <label class="switch">
      <input id="live-preview-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Git integration</div>
      <div style="font-size:12px; color:var(--text-dim);">Show git status and enable diff helpers (local)</div>
    </div>
    <label class="switch">
      <input id="git-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>
</div>

<div class="settings-tab hidden" id="settings-terminal">
  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Font size</div>
      <div style="font-size:12px; color:var(--text-dim);">Terminal text size</div>
    </div>
    <div class="flex gap-2 items-center">
      <button class="btn small" onclick="Settings.changeTerminalFontSize(-1)">-</button>
      <input id="terminal-font-size-input" type="number" min="8" max="32" style="width:72px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:var(--bg-side); color:var(--text);"/>
      <button class="btn small" onclick="Settings.changeTerminalFontSize(1)">+</button>
    </div>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Cursor blink</div>
      <div style="font-size:12px; color:var(--text-dim);">Blinking caret in terminal</div>
    </div>
    <label class="switch">
      <input id="terminal-cursor-blink-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Cursor style</div>
      <div style="font-size:12px; color:var(--text-dim);">Block / underline / bar</div>
    </div>
    <select id="terminal-cursor-style-select" style="padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg-side); color:var(--text);">
      <option value="block">block</option>
      <option value="underline">underline</option>
      <option value="bar">bar</option>
    </select>
  </div>
</div>

<div class="settings-tab hidden" id="settings-ai">
  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Enable assistant</div>
      <div style="font-size:12px; color:var(--text-dim);">Turn AI features on/off</div>
    </div>
    <label class="switch">
      <input id="ai-enabled-toggle" type="checkbox"/>
      <span class="slider"></span>
    </label>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Model</div>
      <div style="font-size:12px; color:var(--text-dim);">Provider / model id</div>
    </div>
    <input id="ai-model-input" type="text" placeholder="local" style="width:220px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--bg-side); color:var(--text);"/>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Temperature</div>
      <div style="font-size:12px; color:var(--text-dim);">Creativity (0.01.0)</div>
    </div>
    <input id="ai-temperature-input" type="number" step="0.1" min="0" max="1" style="width:90px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:var(--bg-side); color:var(--text);"/>
  </div>

  <div class="setting-row">
    <div>
      <div style="font-weight:500;">Max tokens</div>
      <div style="font-size:12px; color:var(--text-dim);">Response length cap</div>
    </div>
    <input id="ai-maxTokens-input" type="number" min="64" max="32000" style="width:110px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:var(--bg-side); color:var(--text);"/>
  </div>
</div>
<div class="modal-footer">
<button class="btn" onclick="Settings.hide()">Cancel</button>
<button class="btn primary" onclick="Settings.save()"><i class="fas fa-save"></i> Save Settings</button>
</div>
</div>
</div>
<!-- PROJECT TEMPLATES MODAL -->
<div class="modal-overlay" id="templates-modal">
<div class="modal" style="width:800px;">
<div class="modal-header">
<h3 style="font-weight:600; font-size:16px;"><i class="fas fa-layer-group"></i> New Project</h3>
<button class="btn icon small" onclick="ProjectTemplates.hide()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-body">
<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;">
<div class="template-card" data-template="vanilla">
<div style="background:linear-gradient(135deg, #667eea, #764ba2); height:120px; border-radius:8px 8px 0 0;"></div>
<div style="padding:16px;">
<div style="font-weight:600; margin-bottom:4px;">Vanilla Web</div>
<div style="font-size:12px; color:var(--text-dim); line-height:1.4;">HTML, CSS, JavaScript starter</div>
</div>
</div>
<div class="template-card" data-template="react-ts">
<div style="background:linear-gradient(135deg, #61dafb, #3178c6); height:120px; border-radius:8px 8px 0 0;"></div>
<div style="padding:16px;">
<div style="font-weight:600; margin-bottom:4px;">React + TypeScript</div>
<div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Modern React with TypeScript</div>
</div>
</div>
<div class="template-card" data-template="react-umd">
<div style="background:linear-gradient(135deg, #38bdf8, #0ea5e9); height:120px; border-radius:8px 8px 0 0;"></div>
<div style="padding:16px;">
<div style="font-weight:600; margin-bottom:4px;">React UMD (No Bundler)</div>
<div style="font-size:12px; color:var(--text-dim); line-height:1.4;">UMD globals with inline app.js</div>
</div>
</div>
<div class="template-card" data-template="vue-umd">
<div style="background:linear-gradient(135deg, #34d399, #10b981); height:120px; border-radius:8px 8px 0 0;"></div>
<div style="padding:16px;">
<div style="font-weight:600; margin-bottom:4px;">Vue 3 UMD (No Bundler)</div>
<div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Vue global build + inline app</div>
</div>
</div>
<div class="template-card" data-template="python-data">
<div style="background:linear-gradient(135deg, #3776ab, #ffd43b); height:120px; border-radius:8px 8px 0 0;"></div>
<div style="padding:16px;">
<div style="font-weight:600; margin-bottom:4px;">Python Data Science</div>
<div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Data analysis with Python</div>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn" onclick="ProjectTemplates.hide()">Cancel</button>
<button class="btn primary" onclick="ProjectTemplates.create()"><i class="fas fa-plus"></i> Create Project</button>
</div>
</div>
</div>
<header>
<div class="logo">
<i class="fas fa-cube" style="color:var(--primary)"></i>
<span>PRO CODE</span>
<span class="version">v19.0</span>
</div>
<div style="width:1px; height:20px; background:#333; margin:0 12px;"></div>
<!-- LEFT CONTROLS -->
<div class="flex ac gap-2">
<button class="btn icon" onclick="FS.createFilePrompt()" title="New File (Ctrl+N)">
<i class="fas fa-file-plus"></i>
</button>
<button class="btn icon" onclick="FS.createFolderPrompt()" title="New Folder">
<i class="fas fa-folder-plus"></i>
</button>
<button class="btn icon" onclick="FS.save()" title="Save (Ctrl+S)">
<i class="fas fa-save"></i>
</button>
<div style="width:1px; height:20px; background:#333; margin:0 8px;"></div>
<button class="btn icon" onclick="FS.importPrompt()" title="Import Files / Folder / ZIP">
<i class="fas fa-folder-open"></i>
</button>
<button class="btn icon" onclick="FS.exportZip()" title="Export Project">
<i class="fas fa-download"></i>
</button>
</div>
<div style="flex:1"></div>
<!-- CENTER CONTROLS -->
<div class="flex ac gap-3" style="background:#27272a; border-radius:8px; padding:4px; border:1px solid #3f3f46;">
<button class="btn icon small" onclick="CommandPalette.show()" title="Command Palette (Ctrl+P)">
<i class="fas fa-search"></i>
</button>
<input class="input" id="spotlight" placeholder="Search files, commands..." style="border:none; background:transparent; width:300px;"/>
<div class="flex ac gap-1">
<button class="btn icon small" onclick="Search.findInProject()" title="Find in Files">
<i class="fas fa-search-plus"></i>
</button>
<button class="btn icon small" onclick="Search.replace()" title="Replace">
<i class="fas fa-exchange-alt"></i>
</button>
</div>
</div>
<div style="flex:1"></div>
<!-- RIGHT CONTROLS -->
<div class="flex ac gap-2">
<button class="btn icon" onclick="Layout.toggleLayout('terminal')" title="Terminal (Ctrl+`)">
<i class="fas fa-terminal"></i>
</button>
<button class="btn icon" onclick="Layout.toggleLayout('preview')" title="Preview (Ctrl+B)">
<i class="fas fa-columns"></i>
</button>
<button class="btn icon" onclick="Layout.splitEditor()" title="Split Editor (Ctrl+\)">
<i class="fas fa-columns"></i>
</button>
<div style="width:1px; height:20px; background:#333; margin:0 8px;"></div>
<button class="btn primary" id="run-btn" onclick="Runner.exec()" title="Run (F5)">
<i class="fas fa-play"></i> RUN
        </button>
<button class="btn icon" onclick="Debugger.toggle()" title="Debug (F9)">
<i class="fas fa-bug"></i>
</button>
</div>
</header>
<div id="workspace">
<!-- ACTIVITY BAR -->
<div class="act-bar">
<div class="act-btn active" data-id="expl" onclick="Layout.setSide('expl')" title="Explorer">
<i class="far fa-copy"></i>
<div class="tooltip">Explorer</div>
</div>
<div class="act-btn" data-id="search" onclick="Layout.setSide('search')" title="Search">
<i class="fas fa-search"></i>
<div class="tooltip">Search</div>
</div>
<div class="act-btn" data-id="git" onclick="Layout.setSide('git')" title="Git">
<i class="fas fa-code-branch"></i>
<div class="tooltip">Git</div>
</div>
<div class="act-btn" data-id="ext" onclick="Layout.setSide('ext')" title="Extensions">
<i class="fas fa-cubes"></i>
<div class="tooltip">Extensions</div>
</div>
<div class="act-btn" data-id="debug" onclick="Layout.setSide('debug')" title="Debug">
<i class="fas fa-bug"></i>
<div class="tooltip">Debug</div>
</div>
<div style="flex:1"></div>
<div class="act-btn" onclick="Settings.show()" title="Settings">
<i class="fas fa-cog"></i>
<div class="tooltip">Settings</div>
</div>
<div class="act-btn" onclick="AI.toggle()" style="color: var(--accent)" title="AI Assistant">
<i class="fas fa-robot"></i>
<div class="tooltip">AI Assistant</div>
</div>
</div>
<!-- EXPLORER SIDEBAR -->
<div class="sidebar active" id="side-expl">
<div class="sb-head">
<span>Explorer</span>
<div class="flex gap-2">
<i class="fas fa-file-medical" onclick="FS.createFilePrompt()" style="cursor:pointer" title="New File"></i>
<i class="fas fa-folder-plus" onclick="FS.createFolderPrompt()" style="cursor:pointer" title="New Folder"></i>
<i class="fas fa-sync-alt" onclick="FS.refreshTree()" style="cursor:pointer" title="Refresh"></i>
</div>
</div>
<div class="tree" id="file-tree"></div>
<div class="sb-head" style="margin-top:8px;">
<span>Outline</span>
</div>
<div class="tree" id="outline-tree" style="height:200px;"></div>
</div>
<!-- SEARCH SIDEBAR -->
<div class="sidebar" id="side-search">
<div class="sb-head"><span>Search</span></div>
<div style="padding:16px;">
<div class="flex col gap-3">
<input class="input" id="search-input" placeholder="Search in files..." type="text"/>
<div class="flex gap-2">
<input class="input" id="replace-input" placeholder="Replace with..." type="text"/>
<button class="btn small" onclick="Search.replaceAll()">Replace All</button>
</div>
<div class="flex ac jb">
<label style="font-size:12px;">
<input id="case-sensitive" type="checkbox"/> Case sensitive
                    </label>
<label style="font-size:12px;">
<input id="whole-word" type="checkbox"/> Whole word
                    </label>
</div>
<button class="btn primary" onclick="Search.execute()"><i class="fas fa-search"></i> Search</button>
</div>
<div id="search-results" style="margin-top:16px; max-height:400px; overflow-y:auto;"></div>
</div>
</div>
<!-- GIT SIDEBAR -->
<div class="sidebar" id="side-git">
<div class="sb-head"><span>Source Control</span></div>
<div style="padding:16px;">
<div class="flex col gap-3">
<div style="font-size:12px; color:var(--text-dim);">Branch: <span style="color:var(--primary); font-weight:600;">main</span></div>
<div id="git-status" style="font-size:12px; color:var(--success);">
<i class="fas fa-check-circle"></i> No changes
                </div>
<button class="btn small" onclick="Git.commit()"><i class="fas fa-code-commit"></i> Commit Changes</button>
<button class="btn small secondary" onclick="Git.push()"><i class="fas fa-cloud-upload-alt"></i> Push to Remote</button>
</div>
</div>
</div>
<!-- RESIZER -->
<div class="resizer r-w" id="rs-side" style="right:0"></div>
<!-- MAIN EDITOR AREA -->
<div id="main">
<div class="tabs" id="tab-list"></div>
<!-- EDITOR CONTAINER -->
<div id="editor-container">
<div class="editor-pane" id="editor-pane-1">
<div id="monaco-root-1" style="width:100%; height:100%;"></div>
</div>
</div>
<!-- EMPTY STATE -->
<div id="empty-state">
<div class="empty-icon">
<i class="fas fa-code-branch"></i>
</div>
<div class="empty-title">Welcome to Pro Code IDE</div>
<div class="empty-subtitle">Open a file or create a new project to start coding</div>
<div class="flex gap-3" style="margin-top:32px;">
<button class="btn primary" onclick="ProjectTemplates.show()">
<i class="fas fa-layer-group"></i> New Project
                </button>
<button class="btn secondary" onclick="FS.importPrompt()">
<i class="fas fa-folder-open"></i> Open Folder
                </button>
<button class="btn secondary" onclick="Tutorial.start()">
<i class="fas fa-graduation-cap"></i> Take Tutorial
                </button>
</div>
<div style="margin-top:48px; display:grid; grid-template-columns:repeat(3, 1fr); gap:24px; max-width:600px;">
<div style="text-align:center;">
<div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">Multi-Language</div>
<div style="font-size:11px; color:#71717a;">JavaScript, TypeScript, Python, HTML, CSS</div>
</div>
<div style="text-align:center;">
<div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">Live Preview</div>
<div style="font-size:11px; color:#71717a;">Real-time web preview with hot reload</div>
</div>
<div style="text-align:center;">
<div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">AI Assistant</div>
<div style="font-size:11px; color:#71717a;">Smart code completion and debugging</div>
</div>
</div>
</div>
<!-- BOTTOM PANEL -->
<div class="hidden" id="panel-btm">
<div class="resizer r-h" id="rs-panel"></div>
<div class="panel-tabs">
<div class="panel-tab active" data-panel="term" onclick="Panel.show('term')">
<i class="fas fa-terminal"></i> TERMINAL
                    <span class="badge" id="term-badge">1</span>
</div>
<div class="panel-tab" data-panel="console" onclick="Panel.show('console')">
<i class="fas fa-code"></i> CONSOLE
                    <span class="badge" id="console-badge">0</span>
</div>
<div class="panel-tab" data-panel="problems" onclick="Panel.show('problems')">
<i class="fas fa-exclamation-triangle"></i> PROBLEMS
                    <span class="badge" id="problems-badge">0</span>
</div>
<div class="panel-tab" data-panel="output" onclick="Panel.show('output')">
<i class="fas fa-stream"></i> OUTPUT
                </div>
<div style="flex:1"></div>
<div class="panel-tab" onclick="TerminalManager.clear()" title="Clear">
<i class="fas fa-trash"></i>
</div>
<div class="panel-tab" onclick="Layout.toggleLayout('terminal')" title="Close Panel">
<i class="fas fa-times"></i>
</div>
</div>
<div id="panel-body" style="flex:1; background:#09090b; position:relative; overflow:hidden;">
<div id="term-host" style="width:100%; height:100%; padding:4px;"></div>
<div class="hidden" id="console-host" style="width:100%; height:100%; padding:12px; overflow:auto; font-family:'JetBrains Mono'; font-size:12px;"></div>
<div class="hidden" id="problems-host" style="width:100%; height:100%; padding:12px; overflow:auto;"></div>
<div class="hidden" id="output-host" style="width:100%; height:100%; padding:12px; overflow:auto; font-family:'JetBrains Mono'; font-size:12px;">
<div id="output-content"></div>
</div>
</div>
</div>
</div>
<!-- PREVIEW PANEL -->
<div class="resizer r-w hidden" id="rs-preview" style="left:0;"></div>
<div id="preview-wrap">
<div class="preview-toolbar">
<div class="flex ac gap-2">
<i class="fas fa-globe" style="color:#666;"></i>
<input class="preview-url" id="preview-url" type="text" value="http://localhost:3000"/>
</div>
<div class="flex ac gap-2">
<button class="btn icon small" onclick="Runner.popout()" title="Open in new window">
<i class="fas fa-external-link-alt"></i>
</button>
<button class="btn icon small" onclick="Runner.reload()" title="Reload">
<i class="fas fa-sync-alt"></i>
</button>
<button class="btn icon small" onclick="Runner.toggleMobile()" title="Toggle mobile view">
<i class="fas fa-mobile-alt"></i>
</button>
<button class="btn icon small" onclick="Inspector.toggle()" title="Toggle inspector">
<i class="fas fa-code"></i>
</button>
</div>
</div>
<iframe id="preview-frame" sandbox="allow-scripts" style="flex:1; border:none; background:white;"></iframe>
        <div id="inspector-hint"><i class="fas fa-crosshairs" style="color:var(--primary)"></i><span>Inspector ON  click an element in preview</span><span class="pill" id="inspector-status">Waiting</span></div>
        <div id="inspector-panel">
          <div class="inspector-header">
            <div class="inspector-title"><i class="fas fa-code" style="color:var(--primary); margin-right:8px;"></i>Inspector</div>
            <div class="actions">
              <button class="btn small mini" id="inspector-copy-selector" title="Copy selector"><i class="fas fa-copy"></i></button>
              <button class="btn small mini" id="inspector-copy-html" title="Copy outerHTML"><i class="fas fa-file-code"></i></button>
              <button class="btn icon small mini" id="inspector-close" title="Close"><i class="fas fa-times"></i></button>
            </div>
          </div>
          <div class="inspector-body">
            <div class="kv"><div class="k">Selector</div><div class="v" id="inspector-selector"></div></div>
            <div class="kv"><div class="k">Tag</div><div class="v" id="inspector-tag"></div></div>
            <div class="kv"><div class="k">Text</div><div class="v" id="inspector-text"></div></div>
            <div class="kv"><div class="k">Box</div><div class="v" id="inspector-rect"></div></div>
            <div class="kv"><div class="k">Styles (subset)</div><pre id="inspector-styles"></pre></div>
            <div class="kv"><div class="k">outerHTML (truncated)</div><pre id="inspector-html"></pre></div>
          </div>
        </div>

</div>
</div>
<footer>
<div class="f-stat">
<span onclick="Git.branch()" title="Current branch">
<i class="fas fa-code-branch"></i> main
        </span>
<span onclick="Git.status()" title="Git status">
<i class="fas fa-cloud"></i> <span id="git-status-text">Local clean</span>
</span>
</div>
<div class="f-stat">
<span id="error-count" style="color:var(--error)" title="Errors">
<i class="fas fa-times-circle"></i> 0
        </span>
<span id="warning-count" style="color:var(--warn)" title="Warnings">
<i class="fas fa-exclamation-triangle"></i> 0
        </span>
<span id="info-count" style="color:var(--primary)" title="Info">
<i class="fas fa-info-circle"></i> 0
        </span>
</div>
<div style="flex:1"></div>
<div class="f-stat">
<span id="cursor-pos" title="Cursor position">Ln 1, Col 1</span>
<span id="file-lang" title="File language">Plain Text</span>
<span id="file-enc" title="File encoding">UTF-8</span>
<span id="file-size" title="File size">0 B</span>
<span id="line-endings" title="Line endings">LF</span>
</div>
<div class="status-dot" id="status-indicator" style="margin:0 16px;" title="IDE Status"></div>
<div class="f-stat">
<span onclick="Settings.show()" title="Settings">
<i class="fas fa-cog"></i>
</span>
<span onclick="AI.toggle()" title="AI Assistant">
<i class="fas fa-robot"></i>
</span>
<span onclick="Notifications.toggle()" title="Notifications">
<i class="fas fa-bell"></i>
</span>
</div>
</footer>
<!-- AI ASSISTANT -->
<div class="col" id="ai-float">
<div class="ai-header">
<div class="flex ac jb">
<div class="flex ac gap-2">
<i class="fas fa-robot" style="color:var(--accent);"></i>
<span style="font-weight:600; font-size:14px;">AI Coding Assistant</span>
<span class="badge primary">PRO</span>
</div>
<div class="flex ac gap-2">
<button class="btn icon small" onclick="AI.clear()" title="Clear chat">
<i class="fas fa-trash"></i>
</button>
<button class="btn icon small" onclick="AI.toggle()" title="Close">
<i class="fas fa-times"></i>
</button>
</div>
</div>
</div>
<div class="ai-messages" id="ai-messages">
<div class="msg-bubble msg-sys">
<div style="font-weight:600; margin-bottom:8px;"> Hello! I'm your AI coding assistant.</div>
<div style="margin-bottom:8px;">I can help you with:</div>
<ul style="margin-left:20px; margin-bottom:8px;">
<li>Writing and explaining code</li>
<li>Debugging and fixing errors</li>
<li>Generating components and functions</li>
<li>Optimizing and refactoring</li>
<li>Answering programming questions</li>
</ul>
<div>What would you like to work on?</div>
</div>
</div>
<div class="ai-typing hidden" id="ai-typing">
<span></span><span></span><span></span>
</div>
<div style="padding:16px; border-top:1px solid var(--border); background:linear-gradient(180deg, #1a1a1f, #18181b);">
<div class="flex gap-2">
<input class="input" id="ai-input" onkeydown="if(event.key==='Enter' &amp;&amp; !event.shiftKey) { event.preventDefault(); AI.send(); }" placeholder="Ask me anything about your code..." type="text"/>
<button class="btn primary" id="ai-send-btn" onclick="AI.send()">
<i class="fas fa-paper-plane"></i>
</button>
</div>
<div class="flex ac jb" style="margin-top:12px;">
<div style="font-size:11px; color:#71717a;">
<i class="fas fa-lightbulb"></i> Try: "Fix this bug", "Create a React component", "Explain this code"
            </div>
<div style="font-size:10px; color:#71717a;">
                AI Assistant v2.0  Local Mode
            </div>
</div>
</div>
</div>
<script>
/**
 * PRO CODE IDE v19.0 - ULTIMATE EDITION
 * Full-stack web development environment
 * Enhanced with: Multi-language support, Advanced debugging, AI-powered features
 */

// ============================================
// GLOBAL STATE & CONFIGURATION
// ============================================
const IDE = {
    version: '19.0',
    build: '2025.12.30-ultra+ / v6-patched-assets-zip-binary',
    state: {
        // File system
        files: {},
        tabs: [],
        activeTab: null,
        dirtyTabs: new Set(),
        
        // Editor
        editors: {},
        activeEditor: 'monaco-root-1',
        splitView: false,
        editorLayout: 'single',
        
        // Runtime
        pyodide: null,
        terminal: null,
        aiAssistant: null,
        
        // UI State
        sidebar: 'expl',
        panel: 'term',
        previewVisible: false,
        terminalVisible: false,
        
        // Project
        currentProject: null,
        projectType: 'vanilla',
        
        // Settings
        settings: {
            editor: {
                fontSize: 14,
                tabSize: 4,
                wordWrap: false,
                minimap: true,
                lineNumbers: true,
                fontFamily: "'JetBrains Mono', monospace",
                theme: 'procode-dark',
                formatOnSave: true,
                autoSave: true,
                autoSaveDelay: 1000,
                bracketPairColorization: true,
                autoCloseBrackets: true,
                autoIndent: true,
                suggestOnTriggerCharacters: true
            },
            appearance: {
                theme: 'dark',
                animation: true,
                reduceMotion: false,
                compactMode: false
            },
            terminal: {
                fontSize: 13,
                fontFamily: "'JetBrains Mono', monospace",
                cursorBlink: true,
                cursorStyle: 'block'
            },
            ai: {
                enabled: true,
                model: 'local',
                temperature: 0.7,
                maxTokens: 1000
            },
            features: {
                restoreSession: true,
                persistCursor: true,
                gitIntegration: true,
                livePreview: true,
                codeLens: true,
                breadcrumbs: true,
                snippetSuggestions: true
            }
        },
        
        // Templates (Enhanced with more options)
        templates: {
            'vanilla': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProCode App</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer><\/script>
</head>
<body>
    <div class="app">
        <header>
            <h1> Welcome to ProCode IDE v19.0</h1>
            <p>Start building amazing web applications</p>
        </header>
        
        <main>
            <section class="features">
                <div class="feature">
                    <h3> Fast Development</h3>
                    <p>Real-time preview and instant feedback</p>
                </div>
                <div class="feature">
                    <h3> Modern Design</h3>
                    <p>Built with latest web technologies</p>
                </div>
                <div class="feature">
                    <h3> AI Powered</h3>
                    <p>Smart code completion and assistance</p>
                </div>
            </section>
            
            <section class="demo">
                <h2>Interactive Demo</h2>
                <div class="counter">
                    <button id="decrement">-</button>
                    <span id="count">0</span>
                    <button id="increment">+</button>
                </div>
                <button id="theme-toggle">Toggle Theme</button>
            </section>
        </main>
        
        <footer>
            <p>Built with  using ProCode IDE v19.0</p>
        </footer>
    </div>
</body>
</html>`,
                'style.css': `/* Modern CSS Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --bg: #f8fafc;
    --text: #1e293b;
    --card: #ffffff;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.dark {
    --bg: #0f172a;
    --text: #e2e8f0;
    --card: #1e293b;
    --border: #334155;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
    min-height: 100vh;
}

.app {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

header {
    text-align: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, var(--primary), #8b5cf6);
    color: white;
    border-radius: var(--radius);
    margin-bottom: 3rem;
}

header h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    font-weight: 800;
}

header p {
    font-size: 1.25rem;
    opacity: 0.9;
}

.features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.feature {
    background: var(--card);
    padding: 2rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: transform 0.3s;
}

.feature:hover {
    transform: translateY(-5px);
}

.feature h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--primary);
}

.demo {
    background: var(--card);
    padding: 3rem;
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--border);
    margin-bottom: 3rem;
}

.counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    font-size: 2rem;
}

.counter button, #theme-toggle {
    background: var(--primary);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: var(--radius);
    font-size: 1.25rem;
    cursor: pointer;
    transition: background 0.3s;
}

.counter button:hover, #theme-toggle:hover {
    background: var(--primary-dark);
}

footer {
    text-align: center;
    padding: 2rem;
    color: var(--text);
    opacity: 0.7;
}

@media (max-width: 768px) {
    .app {
        padding: 1rem;
    }
    
    header h1 {
        font-size: 2.5rem;
    }
    
    .features {
        grid-template-columns: 1fr;
    }
}`,
                'app.js': `// Main Application Logic
console.log(' App initialized - ProCode IDE v19.0');

// DOM Elements
const countElement = document.getElementById('count');
const incrementBtn = document.getElementById('increment');
const decrementBtn = document.getElementById('decrement');
const themeToggle = document.getElementById('theme-toggle');

// State
let count = 0;
let isDark = false;

// Update counter display
function updateCounter() {
    countElement.textContent = count;
    countElement.style.transform = 'scale(1.2)';
    setTimeout(() => {
        countElement.style.transform = 'scale(1)';
    }, 200);
}

// Increment counter
incrementBtn.addEventListener('click', () => {
    count++;
    updateCounter();
    
    // Visual feedback
    incrementBtn.style.animation = 'none';
    setTimeout(() => {
        incrementBtn.style.animation = 'pulse 0.3s';
    }, 10);
});

// Decrement counter
decrementBtn.addEventListener('click', () => {
    if (count > 0) {
        count--;
        updateCounter();
    }
});

// Toggle theme
themeToggle.addEventListener('click', () => {
    isDark = !isDark;
    document.body.classList.toggle('dark', isDark);
    themeToggle.textContent = isDark ? ' Light Mode' : ' Dark Mode';
    
    // Save preference
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
    isDark = true;
    document.body.classList.add('dark');
    themeToggle.textContent = ' Light Mode';
}

// Add animation
const style = document.createElement('style');
style.textContent = \`
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.feature {
    animation: fadeIn 0.6s ease-out;
}

.feature:nth-child(2) {
    animation-delay: 0.2s;
}

.feature:nth-child(3) {
    animation-delay: 0.4s;
}
\`;
document.head.appendChild(style);

// Initialize
updateCounter();
console.log(' App ready!');`,
                'README.md': `# ProCode IDE Project

Welcome to your new ProCode IDE project!

## Project Structure
\`\`\`
project/
 index.html      # Main HTML file
 style.css       # Stylesheet
 app.js          # JavaScript logic
 README.md       # Project documentation
\`\`\`

## Features
-  Modern web development setup
-  Responsive design with CSS variables
-  Interactive JavaScript components
-  Dark/light theme toggle
-  Mobile-friendly layout

## Getting Started
1. Edit \`index.html\` to change the page structure
2. Modify \`style.css\` for custom styling
3. Update \`app.js\` for interactive features
4. Press **F5** to run the application

## Tips
- Use **Ctrl+S** to save files
- Press **Ctrl+B** to toggle preview
- Use **Ctrl+\\** to split editor
- Ask the AI Assistant for help with \`Ctrl+Shift+A\`

                Happy coding! `
            },
            
            'react-umd': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React UMD Starter</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="app.js"><\/script>
</body>
</html>`,
                'style.css': `:root {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e2e8f0;
    --accent: #38bdf8;
    --accent-dark: #0ea5e9;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.app {
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
}

.app h1 {
    font-size: 28px;
    margin-bottom: 8px;
}

.app p {
    color: #cbd5f5;
    margin-bottom: 20px;
}

.counter {
    display: flex;
    align-items: center;
    gap: 16px;
}

.counter button {
    background: var(--accent);
    border: none;
    color: #0f172a;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
}

.counter button:hover {
    background: var(--accent-dark);
}

.count {
    font-size: 24px;
    min-width: 48px;
    text-align: center;
}`,
                'app.js': `const rootEl = document.getElementById('root');

function App() {
    const [count, setCount] = React.useState(0);

    return React.createElement(
        'div',
        { className: 'app' },
        React.createElement('h1', null, 'React UMD Starter'),
        React.createElement('p', null, 'No bundler, no imports, runs in preview.'),
        React.createElement(
            'div',
            { className: 'counter' },
            React.createElement(
                'button',
                { onClick: () => setCount(Math.max(0, count - 1)) },
                '-'
            ),
            React.createElement('span', { className: 'count' }, count),
            React.createElement(
                'button',
                { onClick: () => setCount(count + 1) },
                '+'
            )
        )
    );
}

if (rootEl && window.React && window.ReactDOM) {
    const root = ReactDOM.createRoot(rootEl);
    root.render(React.createElement(App));
} else {
    console.error('React UMD globals not found.');
}`,
                'README.md': `# React UMD Starter

This template runs without a bundler.

Files:
- index.html
- style.css
- app.js

Notes:
- Uses React UMD globals from CDN.
- No import/export in app.js.
- Press F5 to preview.`
            },
            
            'vue-umd': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 3 UMD Starter</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app">
        <h1>Vue 3 UMD Starter</h1>
        <p>{{ message }}</p>
        <div class="counter">
            <button @click="decrement">-</button>
            <span class="count">{{ count }}</span>
            <button @click="increment">+</button>
        </div>
        <p class="hint">Doubled: {{ doubled }}</p>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"><\/script>
    <script src="app.js"><\/script>
</body>
</html>`,
                'style.css': `:root {
    --bg: #0f172a;
    --card: #112a2f;
    --text: #ecfeff;
    --accent: #34d399;
    --accent-dark: #10b981;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.app {
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
}

.app h1 {
    font-size: 28px;
    margin-bottom: 8px;
}

.app p {
    color: #a7f3d0;
    margin-bottom: 16px;
}

.counter {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
}

.counter button {
    background: var(--accent);
    border: none;
    color: #042f2e;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
}

.counter button:hover {
    background: var(--accent-dark);
}

.count {
    font-size: 24px;
    min-width: 48px;
    text-align: center;
}

.hint {
    font-size: 13px;
    opacity: 0.8;
}`,
                'app.js': `const rootEl = document.getElementById('app');

if (!rootEl || !window.Vue) {
    console.error('Vue global not found.');
} else {
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const count = ref(0);
            const message = ref('No bundler, no imports, runs in preview.');
            const doubled = computed(() => count.value * 2);

            const increment = () => {
                count.value += 1;
            };

            const decrement = () => {
                count.value = Math.max(0, count.value - 1);
            };

            return { count, message, doubled, increment, decrement };
        }
    }).mount('#app');
}`,
                'README.md': `# Vue 3 UMD Starter

This template runs without a bundler.

Files:
- index.html
- style.css
- app.js

Notes:
- Uses Vue global build from CDN.
- No import/export in app.js.
- Press F5 to preview.`
            },
            
            'react-ts': {
                'package.json': `{
  "name": "procode-react-app",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.0.0",
    "vite": "^4.4.0"
  }
}`,
                'vite.config.ts': `import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    open: true
  }
})`,
                'tsconfig.json': `{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}`,
                'tsconfig.node.json': `{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}`,
                'index.html': `<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React + TypeScript + Vite</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"><\/script>
  </body>
</html>`,
                'src/main.tsx': `import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)`,
                'src/App.tsx': `import React, { useState, useEffect } from 'react'
import './App.css'

interface Todo {
  id: number
  text: string
  completed: boolean
}

function App() {
  const [todos, setTodos] = useState<Todo[]>([
    { id: 1, text: 'Learn React', completed: true },
    { id: 2, text: 'Build a project', completed: false },
    { id: 3, text: 'Deploy to production', completed: false }
  ])
  
  const [input, setInput] = useState('')
  const [filter, setFilter] = useState<'all' | 'active' | 'completed'>('all')

  const addTodo = (e: React.FormEvent) => {
    e.preventDefault()
    if (!input.trim()) return
    
    setTodos([...todos, {
      id: Date.now(),
      text: input,
      completed: false
    }])
    setInput('')
  }

  const toggleTodo = (id: number) => {
    setTodos(todos.map(todo =>
      todo.id === id ? { ...todo, completed: !todo.completed } : todo
    ))
  }

  const deleteTodo = (id: number) => {
    setTodos(todos.filter(todo => todo.id !== id))
  }

  const filteredTodos = todos.filter(todo => {
    if (filter === 'active') return !todo.completed
    if (filter === 'completed') return todo.completed
    return true
  })

  const activeCount = todos.filter(todo => !todo.completed).length

  return (
    <div className="app">
      <header>
        <h1> React Todo App</h1>
        <p>Built with TypeScript + Vite</p>
      </header>

      <main>
        <form onSubmit={addTodo} className="todo-form">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="What needs to be done?"
            className="todo-input"
          />
          <button type="submit" className="add-btn">
            Add Todo
          </button>
        </form>

        <div className="filters">
          <button
            className={filter === 'all' ? 'active' : ''}
            onClick={() => setFilter('all')}
          >
            All ({todos.length})
          </button>
          <button
            className={filter === 'active' ? 'active' : ''}
            onClick={() => setFilter('active')}
          >
            Active ({activeCount})
          </button>
          <button
            className={filter === 'completed' ? 'active' : ''}
            onClick={() => setFilter('completed')}
          >
            Completed ({todos.length - activeCount})
          </button>
        </div>

        <div className="todo-list">
          {filteredTodos.map(todo => (
            <div key={todo.id} className={\`todo-item \${todo.completed ? 'completed' : ''}\`}>
              <input
                type="checkbox"
                checked={todo.completed}
                onChange={() => toggleTodo(todo.id)}
                className="todo-checkbox"
              />
              <span className="todo-text">{todo.text}</span>
              <button
                onClick={() => deleteTodo(todo.id)}
                className="delete-btn"
              >
                
              </button>
            </div>
          ))}
          
          {filteredTodos.length === 0 && (
            <div className="empty-state">
              {filter === 'all' ? 'No todos yet. Add one above!' :
               filter === 'active' ? 'No active todos!' :
               'No completed todos!'}
            </div>
          )}
        </div>

        <div className="stats">
          <div className="stat">
            <div className="stat-value">{todos.length}</div>
            <div className="stat-label">Total</div>
          </div>
          <div className="stat">
            <div className="stat-value">{activeCount}</div>
            <div className="stat-label">Active</div>
          </div>
          <div className="stat">
            <div className="stat-value">{todos.length - activeCount}</div>
            <div className="stat-label">Completed</div>
          </div>
        </div>
      </main>

      <footer>
        <p>Built with  using ProCode IDE</p>
        <p className="hint">Double-click to edit  Press Enter to save</p>
      </footer>
    </div>
  )
}

export default App`,
                'src/App.css': `.app {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

header {
  text-align: center;
  margin-bottom: 3rem;
}

header h1 {
  font-size: 2.5rem;
  color: #333;
  margin-bottom: 0.5rem;
}

header p {
  color: #666;
  font-size: 1.1rem;
}

.todo-form {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
}

.todo-input {
  flex: 1;
  padding: 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border 0.2s;
}

.todo-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.add-btn {
  background: #6366f1;
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.add-btn:hover {
  background: #4f46e5;
}

.filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
}

.filters button {
  padding: 0.75rem 1.5rem;
  border: 2px solid #e2e8f0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
}

.filters button:hover {
  border-color: #6366f1;
}

.filters button.active {
  background: #6366f1;
  color: white;
  border-color: #6366f1;
}

.todo-list {
  background: white;
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  overflow: hidden;
  margin-bottom: 2rem;
}

.todo-item {
  display: flex;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e2e8f0;
  transition: background 0.2s;
}

.todo-item:hover {
  background: #f8fafc;
}

.todo-item:last-child {
  border-bottom: none;
}

.todo-item.completed .todo-text {
  text-decoration: line-through;
  color: #94a3b8;
}

.todo-checkbox {
  width: 24px;
  height: 24px;
  margin-right: 1rem;
  cursor: pointer;
}

.todo-text {
  flex: 1;
  font-size: 1.1rem;
}

.delete-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: #f1f5f9;
  color: #64748b;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.delete-btn:hover {
  background: #ef4444;
  color: white;
}

.empty-state {
  padding: 3rem;
  text-align: center;
  color: #94a3b8;
  font-size: 1.1rem;
}

.stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 3rem;
}

.stat {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: #6366f1;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

footer {
  text-align: center;
  padding: 2rem;
  color: #64748b;
  border-top: 2px solid #e2e8f0;
}

.hint {
  font-size: 0.9rem;
  margin-top: 0.5rem;
  color: #94a3b8;
}

@media (max-width: 768px) {
  .app {
    padding: 1rem;
  }
  
  .todo-form {
    flex-direction: column;
  }
  
  .filters {
    flex-wrap: wrap;
  }
  
  .stats {
    grid-template-columns: 1fr;
  }
}`,
                'src/index.css': `/* Modern CSS Reset */
*, *::before, *::after {
  box-sizing: border-box;
}

* {
  margin: 0;
}

body {
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f8fafc;
  color: #1e293b;
}

img, picture, video, canvas, svg {
  display: block;
  max-width: 100%;
}

input, button, textarea, select {
  font: inherit;
}

p, h1, h2, h3, h4, h5, h6 {
  overflow-wrap: break-word;
}

#root {
  isolation: isolate;
  min-height: 100vh;
}`
            },
            
            'python-data': {
                'main.py': `#!/usr/bin/env python3
"""
Data Analysis Dashboard
ProCode IDE - Python Data Science Template
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import json
import warnings
warnings.filterwarnings('ignore')

print("=" * 60)
print(" DATA ANALYSIS DASHBOARD")
print("=" * 60)

# Set style
plt.style.use('seaborn-v0_8-darkgrid')
sns.set_palette("husl")

# Generate sample data
def generate_sample_data():
    """Generate realistic sample data for analysis"""
    np.random.seed(42)
    
    dates = pd.date_range('2023-01-01', periods=100, freq='D')
    
    data = {
        'date': dates,
        'sales': np.random.normal(1000, 200, 100).cumsum() + 5000,
        'customers': np.random.poisson(50, 100),
        'revenue': np.random.exponential(1000, 100).cumsum(),
        'expenses': np.random.normal(300, 50, 100).cumsum(),
        'temperature': np.random.normal(20, 5, 100),
        'promotion': np.random.choice([0, 1], 100, p=[0.7, 0.3])
    }
    
    # Add weekly seasonality
    data['sales'] += np.sin(np.arange(100) * 2 * np.pi / 7) * 100
    
    # Add trend
    data['sales'] += np.arange(100) * 10
    
    return pd.DataFrame(data)

# Load data
print(" Generating sample data...")
df = generate_sample_data()

print(f" Data loaded successfully")
print(f" Shape: {df.shape}")
print(f" Date range: {df['date'].min().date()} to {df['date'].max().date()}")
print()

# Basic statistics
print(" BASIC STATISTICS")
print("-" * 40)
print(df.describe().round(2))
print()

# Calculate metrics
total_sales = df['sales'].iloc[-1] - df['sales'].iloc[0]
avg_daily_customers = df['customers'].mean()
total_revenue = df['revenue'].iloc[-1]
profit_margin = ((df['revenue'] - df['expenses']).iloc[-1] / df['revenue'].iloc[-1]) * 100

print(" KEY METRICS")
print("-" * 40)
print(f"Total Sales: \${total_sales:,.2f}")
print(f"Average Daily Customers: {avg_daily_customers:.0f}")
print(f"Total Revenue: \${total_revenue:,.2f}")
print(f"Profit Margin: {profit_margin:.1f}%")
print()

# Time series analysis
print(" TIME SERIES ANALYSIS")
print("-" * 40)

# Calculate rolling averages
df['sales_7d_avg'] = df['sales'].rolling(window=7).mean()
df['revenue_7d_avg'] = df['revenue'].rolling(window=7).mean()

# Growth rate
sales_growth = ((df['sales'].iloc[-1] - df['sales'].iloc[0]) / df['sales'].iloc[0]) * 100
revenue_growth = ((df['revenue'].iloc[-1] - df['revenue'].iloc[0]) / df['revenue'].iloc[0]) * 100

print(f"Sales Growth: {sales_growth:.1f}%")
print(f"Revenue Growth: {revenue_growth:.1f}%")

# Promotion impact
promo_days = df[df['promotion'] == 1]
non_promo_days = df[df['promotion'] == 0]

if len(promo_days) > 0 and len(non_promo_days) > 0:
    promo_avg_sales = promo_days['sales'].mean()
    non_promo_avg_sales = non_promo_days['sales'].mean()
    promo_impact = ((promo_avg_sales - non_promo_avg_sales) / non_promo_avg_sales) * 100
    print(f"Promotion Impact: +{promo_impact:.1f}% increase in sales")
print()

# Correlation analysis
print(" CORRELATION ANALYSIS")
print("-" * 40)
correlation_matrix = df[['sales', 'customers', 'revenue', 'expenses', 'temperature']].corr()
print(correlation_matrix.round(2))
print()

# Generate visualizations
print(" GENERATING VISUALIZATIONS...")

fig, axes = plt.subplots(2, 2, figsize=(15, 10))

# 1. Sales trend
axes[0, 0].plot(df['date'], df['sales'], label='Daily Sales', linewidth=2)
axes[0, 0].plot(df['date'], df['sales_7d_avg'], label='7-Day Avg', linewidth=2, linestyle='--')
axes[0, 0].set_title('Sales Trend Over Time', fontsize=14, fontweight='bold')
axes[0, 0].set_xlabel('Date')
axes[0, 0].set_ylabel('Sales ($)')
axes[0, 0].legend()
axes[0, 0].grid(True, alpha=0.3)

# 2. Revenue vs Expenses
axes[0, 1].fill_between(df['date'], df['revenue'], df['expenses'], 
                         where=(df['revenue'] > df['expenses']), 
                         color='green', alpha=0.3, label='Profit')
axes[0, 1].fill_between(df['date'], df['revenue'], df['expenses'], 
                         where=(df['revenue'] <= df['expenses']), 
                         color='red', alpha=0.3, label='Loss')
axes[0, 1].plot(df['date'], df['revenue'], label='Revenue', linewidth=2)
axes[0, 1].plot(df['date'], df['expenses'], label='Expenses', linewidth=2)
axes[0, 1].set_title('Revenue vs Expenses', fontsize=14, fontweight='bold')
axes[0, 1].set_xlabel('Date')
axes[0, 1].set_ylabel('Amount ($)')
axes[0, 1].legend()
axes[0, 1].grid(True, alpha=0.3)

# 3. Customer distribution
axes[1, 0].hist(df['customers'], bins=15, edgecolor='black', alpha=0.7)
axes[1, 0].axvline(df['customers'].mean(), color='red', linestyle='--', 
                   linewidth=2, label=f'Mean: {df["customers"].mean():.1f}')
axes[1, 0].set_title('Customer Distribution', fontsize=14, fontweight='bold')
axes[1, 0].set_xlabel('Number of Customers')
axes[1, 0].set_ylabel('Frequency')
axes[1, 0].legend()
axes[1, 0].grid(True, alpha=0.3)

# 4. Correlation heatmap
im = axes[1, 1].imshow(correlation_matrix.values, cmap='coolwarm', vmin=-1, vmax=1)
axes[1, 1].set_title('Feature Correlation', fontsize=14, fontweight='bold')
axes[1, 1].set_xticks(np.arange(len(correlation_matrix.columns)))
axes[1, 1].set_yticks(np.arange(len(correlation_matrix.columns)))
axes[1, 1].set_xticklabels(correlation_matrix.columns, rotation=45)
axes[1, 1].set_yticklabels(correlation_matrix.columns)
plt.colorbar(im, ax=axes[1, 1])

# Add correlation values
for i in range(len(correlation_matrix.columns)):
    for j in range(len(correlation_matrix.columns)):
        text = axes[1, 1].text(j, i, f'{correlation_matrix.iloc[i, j]:.2f}',
                               ha="center", va="center", 
                               color="white" if abs(correlation_matrix.iloc[i, j]) > 0.5 else "black")

plt.tight_layout()
plt.savefig('analysis_dashboard.png', dpi=300, bbox_inches='tight')
print(" Dashboard saved as 'analysis_dashboard.png'")
print()

# Export results
results = {
    'total_sales': float(total_sales),
    'avg_daily_customers': float(avg_daily_customers),
    'total_revenue': float(total_revenue),
    'profit_margin': float(profit_margin),
    'sales_growth': float(sales_growth),
    'revenue_growth': float(revenue_growth),
    'analysis_date': datetime.now().isoformat()
}

with open('analysis_results.json', 'w') as f:
    json.dump(results, f, indent=2)

print(" RESULTS EXPORTED")
print("-" * 40)
print(json.dumps(results, indent=2))
print()

# Future prediction (simple linear projection)
print(" FUTURE PREDICTION (Next 30 Days)")
print("-" * 40)

# Simple linear regression for prediction
from sklearn.linear_model import LinearRegression

# Prepare data for prediction
X = np.arange(len(df)).reshape(-1, 1)
y_sales = df['sales'].values

model = LinearRegression()
model.fit(X, y_sales)

# Predict next 30 days
future_days = np.arange(len(df), len(df) + 30).reshape(-1, 1)
future_sales = model.predict(future_days)

predicted_growth = ((future_sales[-1] - future_sales[0]) / future_sales[0]) * 100
print(f"Predicted sales growth in next 30 days: {predicted_growth:.1f}%")
print(f"Estimated sales on day 30: \${future_sales[-1]:,.2f}")

print()
print("=" * 60)
print(" ANALYSIS COMPLETE!")
print("=" * 60)
print()
print(" Generated Files:")
print("   analysis_dashboard.png - Visualization dashboard")
print("   analysis_results.json - Analysis results")
print()
print(" Next Steps:")
print("  1. Review the visualizations")
print("  2. Adjust parameters in the code")
print("  3. Add more data sources")
print("  4. Implement machine learning models")
print()

# Interactive exploration
print(" INTERACTIVE EXPLORATION")
print("-" * 40)
print("Try modifying the code to:")
print("   Change the sample data generation")
print("   Add more visualization types")
print("   Implement statistical tests")
print("   Connect to real data sources")
print()

print(" Happy Data Science!")`,
                'analysis_results.json': `{}`,
                'requirements.txt': `pandas>=2.0.0
numpy>=1.24.0
matplotlib>=3.7.0
seaborn>=0.12.0
scikit-learn>=1.2.0
jupyter>=1.0.0`,
                'README.md': `# Python Data Science Project

A comprehensive data analysis dashboard built with Python.

## Features
-  Data generation and simulation
-  Time series analysis
-  Correlation analysis
-  Interactive visualizations
-  Future predictions
-  Results export

## Setup
\`\`\`bash
# Install dependencies
pip install -r requirements.txt

# Run analysis
python main.py
\`\`\`

## Project Structure
\`\`\`
project/
 main.py              # Main analysis script
 requirements.txt     # Python dependencies
 analysis_results.json # Analysis results
 analysis_dashboard.png # Generated dashboard
\`\`\`

## Technologies Used
- **Pandas**: Data manipulation
- **NumPy**: Numerical computing
- **Matplotlib**: Visualization
- **Seaborn**: Statistical graphics
- **Scikit-learn**: Machine learning

## Customization
1. Modify data generation in \`generate_sample_data()\`
2. Add new analysis functions
3. Customize visualizations
4. Connect to real databases

## Tips
- Use **F5** to run the analysis
- Check the terminal for results
- View generated visualizations
- Export results for reporting`
            },
            
            // NEW TEMPLATES ADDED
            'vue-ts': {
                'package.json': `{
  "name": "procode-vue-app",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.3.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.2.0",
    "typescript": "^5.0.0",
    "vite": "^4.4.0",
    "vue-tsc": "^1.8.0"
  }
}`,
                'vite.config.ts': `import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    port: 3000,
    open: true
  }
})`,
                'src/main.ts': `import { createApp } from 'vue'
import App from './App.vue'
import './style.css'

createApp(App).mount('#app')`,
                'src/App.vue': `<template>
  <div class="app">
    <header>
      <h1> Vue 3 + TypeScript App</h1>
      <p>Built with ProCode IDE v19.0</p>
    </header>
    
    <main>
      <div class="counter">
        <button @click="decrement">-</button>
        <span class="count">{{ count }}</span>
        <button @click="increment">+</button>
      </div>
      
      <div class="controls">
        <input v-model="message" placeholder="Type a message..." />
        <button @click="addMessage">Add Message</button>
      </div>
      
      <div class="messages">
        <div v-for="(msg, index) in messages" :key="index" class="message">
          {{ msg }}
        </div>
      </div>
    </main>
    
    <footer>
      <p>Count: {{ count }} | Messages: {{ messages.length }}</p>
    </footer>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'

const count = ref(0)
const message = ref('')
const messages = ref<string[]>([])

const increment = () => count.value++
const decrement = () => count.value > 0 && count.value--
const addMessage = () => {
  if (message.value.trim()) {
    messages.value.push(message.value)
    message.value = ''
  }
}
<\/script>

<style scoped>
.app {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

header {
  margin-bottom: 3rem;
}

header h1 {
  font-size: 2.5rem;
  color: #42b883;
  margin-bottom: 0.5rem;
}

header p {
  color: #64748b;
}

.counter {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  margin: 2rem 0;
  font-size: 2rem;
}

.counter button {
  width: 60px;
  height: 60px;
  border: none;
  background: #42b883;
  color: white;
  border-radius: 50%;
  font-size: 2rem;
  cursor: pointer;
  transition: transform 0.2s;
}

.counter button:hover {
  transform: scale(1.1);
}

.count {
  font-size: 3rem;
  font-weight: bold;
  color: #35495e;
  min-width: 100px;
}

.controls {
  margin: 2rem 0;
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.controls input {
  padding: 0.75rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  width: 300px;
  font-size: 1rem;
}

.controls button {
  padding: 0.75rem 1.5rem;
  background: #35495e;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.messages {
  margin-top: 2rem;
  max-height: 300px;
  overflow-y: auto;
}

.message {
  background: white;
  padding: 1rem;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

footer {
  margin-top: 3rem;
  padding-top: 1rem;
  border-top: 2px solid #e2e8f0;
  color: #64748b;
}

</style>`,
                'src/style.css': `/* Global Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f8fafc;
  color: #1e293b;
  line-height: 1.5;
}

#app {
  min-height: 100vh;
}`
            },
            
            'nextjs-ts': {
                'package.json': `{
  "name": "procode-next-app",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "next": "14.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "typescript": "^5.0.0"
  }
}`,
                'next.config.js': `/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig`,
                'tsconfig.json': `{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}`,
                'src/app/page.tsx': `import Counter from '@/components/Counter'
import Header from '@/components/Header'

export default function Home() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
      <Header />
      
      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto">
          <div className="text-center mb-12">
            <h1 className="text-5xl font-bold text-gray-900 mb-4">
              Next.js 14 + TypeScript
            </h1>
            <p className="text-xl text-gray-600">
              Modern full-stack application template
            </p>
          </div>
          
          <div className="grid md:grid-cols-2 gap-8">
            <div className="bg-white rounded-2xl p-8 shadow-xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">
                Interactive Counter
              </h2>
              <Counter />
            </div>
            
            <div className="bg-white rounded-2xl p-8 shadow-xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">
                Features
              </h2>
              <ul className="space-y-4">
                {[
                  ' App Router (Next.js 14)',
                  ' TypeScript ready',
                  ' Fast Refresh',
                  ' ESLint configured',
                  ' Tailwind CSS',
                  ' Responsive design'
                ].map((feature, i) => (
                  <li key={i} className="flex items-center gap-3 text-gray-700">
                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                    {feature}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </main>
      
      <footer className="text-center py-8 text-gray-500 border-t">
        <p>Built with  using ProCode IDE v19.0</p>
      </footer>
    </div>
  )
}`,
                'src/components/Counter.tsx': `'use client'

import { useState } from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)
  const [history, setHistory] = useState<number[]>([])

  const increment = () => {
    setCount(prev => {
      const newCount = prev + 1
      setHistory(prevHistory => [...prevHistory.slice(-4), newCount])
      return newCount
    })
  }

  const decrement = () => {
    if (count > 0) {
      setCount(prev => {
        const newCount = prev - 1
        setHistory(prevHistory => [...prevHistory.slice(-4), newCount])
        return newCount
      })
    }
  }

  const reset = () => {
    setCount(0)
    setHistory([])
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <div className="text-6xl font-bold text-blue-600 mb-4">{count}</div>
        <p className="text-gray-600">Current Count</p>
      </div>

      <div className="flex gap-4 justify-center">
        <button
          onClick={decrement}
          className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
        >
          Decrement
        </button>
        <button
          onClick={reset}
          className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
        >
          Reset
        </button>
        <button
          onClick={increment}
          className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
        >
          Increment
        </button>
      </div>

      {history.length > 0 && (
        <div className="mt-8">
          <h3 className="text-lg font-semibold text-gray-700 mb-2">Recent History</h3>
          <div className="flex gap-2">
            {history.map((value, index) => (
              <div
                key={index}
                className="flex-1 bg-gray-100 rounded-lg p-3 text-center"
              >
                <div className="text-2xl font-bold text-gray-800">{value}</div>
                <div className="text-sm text-gray-500">Step {history.length - index}</div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}`,
                'src/components/Header.tsx': `export default function Header() {
  return (
    <header className="bg-white shadow-sm">
      <div className="container mx-auto px-4 py-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg"></div>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">NextApp</h1>
              <p className="text-sm text-gray-500">v1.0.0</p>
            </div>
          </div>
          
          <nav className="flex gap-6">
            {['Home', 'Features', 'Docs', 'About'].map((item) => (
              <a
                key={item}
                href="#"
                className="text-gray-700 hover:text-blue-600 transition-colors"
              >
                {item}
              </a>
            ))}
          </nav>
        </div>
      </div>
    </header>
  )
}`
            }
        }
    }
};

// THM VO IndexedDBManager object
class IndexedDBBatcher {
    constructor(db) {
        this.db = db;
        this.writeQueue = new Map();
        this.deleteQueue = new Set();
        this.flushTimer = null;
        this.isProcessing = false;
        this.BATCH_DELAY = 500; // ms
        this.MAX_BATCH_SIZE = 100;
    }
    
    queueWrite(key, value) {
        this.deleteQueue.delete(key);
        this.writeQueue.set(key, value);
        this.scheduleFlush();
    }
    
    queueDelete(key) {
        this.writeQueue.delete(key);
        this.deleteQueue.add(key);
        this.scheduleFlush();
    }
    
    scheduleFlush() {
        if (this.flushTimer) clearTimeout(this.flushTimer);
        
        const shouldFlushImmediately = 
            this.writeQueue.size >= this.MAX_BATCH_SIZE || 
            this.deleteQueue.size >= this.MAX_BATCH_SIZE;
        
        if (shouldFlushImmediately) {
            this.flush();
        } else {
            this.flushTimer = setTimeout(() => this.flush(), this.BATCH_DELAY);
        }
    }
    
    async flush() {
        if (this.isProcessing) return;
        if (this.writeQueue.size === 0 && this.deleteQueue.size === 0) return;
        
        this.isProcessing = true;
        const writes = Array.from(this.writeQueue.entries());
        const deletes = Array.from(this.deleteQueue);
        
        this.writeQueue.clear();
        this.deleteQueue.clear();
        
        try {
            //  S dng transaction duy nht cho tt c operations
            const transaction = this.db.transaction(['files', 'settings'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            // Batch writes
            const writePromises = writes.map(([path, content]) => 
                new Promise((resolve, reject) => {
                    const request = fileStore.put({
                        path,
                        content,
                        size: new Blob([content]).size,
                        modified: Date.now()
                    });
                    request.onsuccess = resolve;
                    request.onerror = reject;
                })
            );
            
            // Batch deletes
            const deletePromises = deletes.map(path =>
                new Promise((resolve, reject) => {
                    const request = fileStore.delete(path);
                    request.onsuccess = resolve;
                    request.onerror = reject;
                })
            );
            
            await Promise.all([...writePromises, ...deletePromises]);
            
            //  Ch transaction complete
            await new Promise((resolve, reject) => {
                transaction.oncomplete = resolve;
                transaction.onerror = reject;
            });
            
            console.log(` Flushed ${writes.length} writes, ${deletes.length} deletes`);
        } catch (error) {
            console.error(' Batch flush failed:', error);
            //  Re-queue failed operations
            writes.forEach(([k, v]) => this.writeQueue.set(k, v));
            deletes.forEach(k => this.deleteQueue.add(k));
            
            // Retry after delay
            setTimeout(() => this.flush(), 5000);
        } finally {
            this.isProcessing = false;
        }
    }
}

const IndexedDBManager = {
    db: null,
    dbName: 'ProCodeIDE',
    version: 1,
    batcher: null,
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                this.batcher = new IndexedDBBatcher(this.db);
                resolve(this.db);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Create object stores
                if (!db.objectStoreNames.contains('files')) {
                    db.createObjectStore('files', { keyPath: 'path' });
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    db.createObjectStore('settings', { keyPath: 'key' });
                }
                
                if (!db.objectStoreNames.contains('history')) {
                    const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
                    historyStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('cache')) {
                    const cacheStore = db.createObjectStore('cache', { keyPath: 'key' });
                    cacheStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        });
    },
    
    async setFile(path, content) {
        if (!this.db) await this.init();
        
        if (this.batcher) { this.batcher.queueWrite(path, content); return true; }
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.put({
                path: path,
                content: content,
                size: new Blob([content]).size,
                modified: new Date().toISOString()
            });
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async getFile(path) {
        if (!this.db) await this.init();
        
        if (this.batcher) {
            if (this.batcher.deleteQueue?.has?.(path)) return null;
            if (this.batcher.writeQueue?.has?.(path)) {
                const content = this.batcher.writeQueue.get(path);
                return { path, content, size: new Blob([content]).size, modified: new Date().toISOString() };
            }
        }
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(path);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async getAllFiles() {
        if (!this.db) await this.init();
        
        if (this.batcher) await this.batcher.flush();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async deleteFile(path) {
        if (!this.db) await this.init();
        
        if (this.batcher) { this.batcher.queueDelete(path); return true; }
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            const request = store.delete(path);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async setSetting(key, value) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');
            const request = store.put({ key: key, value: value });
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async getSetting(key) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.get(key);
            
            request.onsuccess = () => resolve(request.result?.value);
            request.onerror = () => reject(request.error);
        });
    },
    
    async addHistory(action, details) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['history'], 'readwrite');
            const store = transaction.objectStore('history');
            const request = store.add({
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },
    
    async getRecentHistory(limit = 50) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['history'], 'readonly');
            const store = transaction.objectStore('history');
            const index = store.index('timestamp');
            const request = index.openCursor(null, 'prev');
            
            const results = [];
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && results.length < limit) {
                    results.push(cursor.value);
                    cursor.continue();
                } else {
                    resolve(results);
                }
            };
            request.onerror = () => reject(request.error);
        });
    },
    
    async setCache(key, value, ttl = 3600000) { // 1 hour default
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['cache'], 'readwrite');
            const store = transaction.objectStore('cache');
            const request = store.put({
                key: key,
                value: value,
                timestamp: Date.now(),
                expires: Date.now() + ttl
            });
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async getCache(key) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['cache'], 'readonly');
            const store = transaction.objectStore('cache');
            const request = store.get(key);
            
            request.onsuccess = () => {
                const result = request.result;
                if (result && result.expires > Date.now()) {
                    resolve(result.value);
                } else {
                    if (result) {
                        // Delete expired cache
                        this.deleteCache(key);
                    }
                    resolve(null);
                }
            };
            request.onerror = () => reject(request.error);
        });
    },
    
    async deleteCache(key) {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['cache'], 'readwrite');
            const store = transaction.objectStore('cache');
            const request = store.delete(key);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },
    
    async clearExpiredCache() {
        if (!this.db) await this.init();
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['cache'], 'readwrite');
            const store = transaction.objectStore('cache');
            const request = store.openCursor();
            
            let deleted = 0;
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    if (cursor.value.expires < Date.now()) {
                        cursor.delete();
                        deleted++;
                    }
                    cursor.continue();
                } else {
                    resolve(deleted);
                }
            };
            request.onerror = () => reject(request.error);
        });
    },
    
    async getStorageStats() {
        if (!this.db) await this.init();
        
        const files = await this.getAllFiles();
        const totalSize = files.reduce((sum, file) => sum + (file.size || 0), 0);
        
        return {
            fileCount: files.length,
            totalSize: totalSize,
            formattedSize: Utils.formatBytes(totalSize)
        };
    }
};

// ============================================
// ENHANCED UTILITY FUNCTIONS
// ============================================
const Utils = {
    // Enhanced toast notifications with icons
    toast: function(message, type = 'info', duration = 4000) {
        const icons = {
            'info': 'fas fa-info-circle',
            'success': 'fas fa-check-circle',
            'warning': 'fas fa-exclamation-triangle',
            'error': 'fas fa-times-circle'
        };
        
        const colors = {
            'info': '#3b82f6',
            'success': '#22c55e',
            'warning': '#f59e0b',
            'error': '#ef4444'
        };
        
        Toastify({
            text: `<i class="${icons[type]}" style="margin-right:8px;"></i> ${message}`,
            duration: duration,
            gravity: "bottom",
            position: "right",
            escapeMarkup: false,
            style: {
                background: colors[type],
                borderRadius: '8px',
                fontFamily: "'Inter', sans-serif",
                fontSize: '13px',
                padding: '12px 16px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
            }
        }).showToast();
    },
    
    // Enhanced UUID with prefix support
    uuid: function(prefix = '') {
        const id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        return prefix ? `${prefix}-${id}` : id;
    },
    
    // Enhanced debounce with immediate option
    debounce: function(func, wait, immediate = false) {
        let timeout;
        return function executedFunction(...args) {
            const context = this;
            const later = () => {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    },
    
    // Enhanced file extension detection
    getExtension: function(path) {
        const parts = path.split('.');
        if (parts.length === 1) return '';
        return parts.pop().toLowerCase();
    },
    
    // Enhanced file icon mapping with more file types
    getFileIcon: function(path) {
        const ext = this.getExtension(path);
        const fileName = path.split('/').pop().toLowerCase();
        
        // Enhanced icon map
        const iconMap = {
            // Programming Languages
            'js': ['fab fa-js-square', '#facc15'],
            'jsx': ['fab fa-react', '#61dafb'],
            'ts': ['fas fa-code', '#3178c6'],
            'tsx': ['fab fa-react', '#3178c6'],
            'html': ['fab fa-html5', '#e34c26'],
            'css': ['fab fa-css3-alt', '#264de4'],
            'scss': ['fab fa-sass', '#cc6699'],
            'sass': ['fab fa-sass', '#cc6699'],
            'less': ['fab fa-less', '#2b4c80'],
            'json': ['fas fa-brackets-curly', '#f5de19'],
            'xml': ['fas fa-code', '#f16529'],
            'py': ['fab fa-python', '#3776ab'],
            'java': ['fab fa-java', '#007396'],
            'cpp': ['fas fa-code', '#00599c'],
            'c': ['fas fa-code', '#a8b9cc'],
            'cs': ['fas fa-code', '#239120'],
            'php': ['fab fa-php', '#777bb4'],
            'rb': ['fas fa-gem', '#cc342d'],
            'go': ['fas fa-code', '#00add8'],
            'rs': ['fas fa-code', '#dea584'],
            'swift': ['fab fa-swift', '#fa7343'],
            'kt': ['fas fa-code', '#f18e33'],
            'scala': ['fas fa-code', '#dc322f'],
            
            // Web
            'vue': ['fab fa-vuejs', '#42b883'],
            'vuejs': ['fab fa-vuejs', '#42b883'],
            'tsx': ['fab fa-react', '#61dafb'],
            
            // Config Files
            'config': ['fas fa-cog', '#a1a1aa'],
            'yml': ['fas fa-file-code', '#cb171e'],
            'yaml': ['fas fa-file-code', '#cb171e'],
            'toml': ['fas fa-file-code', '#9c4221'],
            'ini': ['fas fa-cog', '#a1a1aa'],
            'env': ['fas fa-key', '#8257e5'],
            
            // Documentation
            'md': ['fab fa-markdown', '#ffffff'],
            'markdown': ['fab fa-markdown', '#ffffff'],
            'txt': ['fas fa-file-alt', '#a1a1aa'],
            'pdf': ['fas fa-file-pdf', '#f40f02'],
            'doc': ['fas fa-file-word', '#2b579a'],
            'docx': ['fas fa-file-word', '#2b579a'],
            
            // Images
            'jpg': ['fas fa-file-image', '#dc2626'],
            'jpeg': ['fas fa-file-image', '#dc2626'],
            'png': ['fas fa-file-image', '#2563eb'],
            'gif': ['fas fa-file-image', '#f59e0b'],
            'svg': ['fas fa-file-image', '#f59e0b'],
            'ico': ['fas fa-file-image', '#7c3aed'],
            'webp': ['fas fa-file-image', '#0891b2'],
            
            // Data
            'csv': ['fas fa-file-csv', '#059669'],
            'xlsx': ['fas fa-file-excel', '#217346'],
            'sql': ['fas fa-database', '#00758f'],
            'db': ['fas fa-database', '#00758f'],
            'sqlite': ['fas fa-database', '#003b57'],
            
            // Audio/Video
            'mp3': ['fas fa-file-audio', '#3b82f6'],
            'wav': ['fas fa-file-audio', '#3b82f6'],
            'mp4': ['fas fa-file-video', '#ef4444'],
            'avi': ['fas fa-file-video', '#ef4444'],
            'mov': ['fas fa-file-video', '#ef4444']
        };
        
        // Check for specific file names first
        if (fileName === 'package.json') return ['fas fa-box', '#f97316'];
        if (fileName === 'package-lock.json') return ['fas fa-box', '#ea580c'];
        if (fileName.includes('tsconfig')) return ['fas fa-cog', '#3178c6'];
        if (fileName.includes('vite.config')) return ['fas fa-bolt', '#646cff'];
        if (fileName.includes('webpack.config')) return ['fas fa-cube', '#8dd6f9'];
        if (fileName === 'dockerfile') return ['fab fa-docker', '#2496ed'];
        if (fileName === 'docker-compose.yml') return ['fab fa-docker', '#2496ed'];
        if (fileName === '.gitignore') return ['fas fa-eye-slash', '#71717a'];
        if (fileName === '.env') return ['fas fa-key', '#8257e5'];
        if (fileName === '.env.example') return ['fas fa-key', '#a855f7'];
        if (fileName === 'requirements.txt') return ['fas fa-list', '#059669'];
        if (fileName === 'readme.md' || fileName === 'readme') return ['fab fa-readme', '#3b82f6'];
        if (fileName === 'license') return ['fas fa-scale-balanced', '#6b7280'];
        if (fileName === 'changelog.md') return ['fas fa-history', '#8b5cf6'];
        if (fileName === 'contributing.md') return ['fas fa-handshake', '#10b981'];
        
        // Check for folder
        if (path.endsWith('/')) return ['fas fa-folder', '#d97706'];
        
        return iconMap[ext] || ['fas fa-file', '#71717a'];
    },
    
    // Enhanced language detection
    detectLanguage: function(path) {
        const ext = this.getExtension(path);
        const langMap = {
            'js': 'javascript',
            'jsx': 'javascript',
            'ts': 'typescript',
            'tsx': 'typescript',
            'html': 'html',
            'css': 'css',
            'scss': 'scss',
            'sass': 'sass',
            'less': 'less',
            'json': 'json',
            'py': 'python',
            'md': 'markdown',
            'txt': 'plaintext',
            'xml': 'xml',
            'yml': 'yaml',
            'yaml': 'yaml',
            'sh': 'shell',
            'bash': 'shell',
            'ps1': 'powershell',
            'sql': 'sql',
            'java': 'java',
            'cpp': 'cpp',
            'c': 'c',
            'cs': 'csharp',
            'php': 'php',
            'rb': 'ruby',
            'go': 'go',
            'rs': 'rust',
            'swift': 'swift',
            'kt': 'kotlin',
            'scala': 'scala',
            'lua': 'lua',
            'perl': 'perl',
            'r': 'r',
            'dart': 'dart',
            'elixir': 'elixir',
            'haskell': 'haskell',
            'clojure': 'clojure',
            'vue': 'vue',
            'svelte': 'svelte'
        };
        return langMap[ext] || 'plaintext';
    },
    
    // Enhanced file size formatting
    formatBytes: function(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    },

    // Thm vo Utils object (sau function formatBytes)
    getCompressionStats: function() {
        try {
            const stats = JSON.parse(localStorage.getItem('procode_compression_stats') || '{}');
            if (stats.originalSize) {
                return {
                    original: this.formatBytes(stats.originalSize),
                    compressed: this.formatBytes(stats.compressedSize),
                    saved: stats.ratio + '%',
                    timestamp: this.formatDate(stats.timestamp)
                };
            }
        } catch (e) {
            console.error('Failed to get compression stats:', e);
        }
        return null;
    },
    
    // Enhanced date formatting with relative time
    formatDate: function(date, format = 'relative') {
        const d = new Date(date);
        
        if (format === 'relative') {
            const now = new Date();
            const diffMs = now - d;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffSec < 60) return 'just now';
            if (diffMin < 60) return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
            if (diffHour < 24) return `${diffHour} hour${diffHour === 1 ? '' : 's'} ago`;
            if (diffDay < 7) return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
        }
        
        return d.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },
    
    // Enhanced HTML escaping
    escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    // Enhanced clipboard with fallback
    copyToClipboard: async function(text) {
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
            } else {
                // Fallback for insecure contexts
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                textArea.remove();
            }
            this.toast('Copied to clipboard', 'success');
            return true;
        } catch (err) {
            this.toast('Failed to copy to clipboard', 'error');
            return false;
        }
    },
    
    // Enhanced download with progress tracking
    downloadFile: function(filename, content, type = 'text/plain') {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    },
    
    // Enhanced file reading with progress
    readFile: function(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    // Could update UI with progress
                }
            };
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    },
    

    // Smart file reader: text for code, DataURL for binary assets (images/fonts/media)
    readFileSmart: function(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            const name = (file && (file.name || file.webkitRelativePath)) ? String(file.name || file.webkitRelativePath) : '';
            if (Utils.isBinaryExt(name)) {
                reader.readAsDataURL(file);
            } else {
                reader.readAsText(file);
            }
        });
    },

    // Binary extension detector (used for preview asset inlining)
    isBinaryExt: function(pathOrName) {
        const name = String(pathOrName || '').split('?')[0].split('#')[0];
        const ext = (name.includes('.') ? name.split('.').pop() : '').toLowerCase();
        return ['png','jpg','jpeg','gif','webp','svg','ico','bmp','avif','mp3','wav','ogg','mp4','webm','m4a','flac','woff','woff2','ttf','otf','eot','pdf'].includes(ext);
    },

    // Basic MIME map (best-effort; used for ZIP import/export + data URLs)
    mimeFromPath: function(pathOrName) {
        const name = String(pathOrName || '').split('?')[0].split('#')[0];
        const ext = (name.includes('.') ? name.split('.').pop() : '').toLowerCase();
        const map = {
            png: 'image/png',
            jpg: 'image/jpeg',
            jpeg: 'image/jpeg',
            gif: 'image/gif',
            webp: 'image/webp',
            svg: 'image/svg+xml',
            ico: 'image/x-icon',
            bmp: 'image/bmp',
            avif: 'image/avif',
            mp3: 'audio/mpeg',
            wav: 'audio/wav',
            ogg: 'audio/ogg',
            m4a: 'audio/mp4',
            flac: 'audio/flac',
            mp4: 'video/mp4',
            webm: 'video/webm',
            woff: 'font/woff',
            woff2: 'font/woff2',
            ttf: 'font/ttf',
            otf: 'font/otf',
            eot: 'application/vnd.ms-fontobject',
            pdf: 'application/pdf',
            json: 'application/json',
            txt: 'text/plain',
            md: 'text/markdown',
            html: 'text/html',
            css: 'text/css',
            js: 'application/javascript',
            ts: 'application/typescript'
        };
        return map[ext] || 'application/octet-stream';
    },

    // Enhanced file name validation
    isValidFileName: function(name) {
        if (!name || name.trim() === '') return false;
        
        // Check for invalid characters
        const invalidChars = /[<>:"/\\|?*\x00-\x1F]/g;
        if (invalidChars.test(name)) return false;
        
        // Check for reserved names (Windows)
        const reservedNames = /^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i;
        if (reservedNames.test(name)) return false;
        
        // Check for trailing dots or spaces
        if (name.endsWith('.') || name.endsWith(' ')) return false;
        
        // Check length (255 max for most systems)
        if (name.length > 255) return false;
        
        return true;
    },
    
    // Color utility functions
    lightenColor: function(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (
            0x1000000 +
            (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)
        ).toString(16).slice(1);
    },
    
    // Generate random color
    randomColor: function() {
        return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    },
    
    // Get contrast color (black or white)
    getContrastColor: function(hexcolor) {
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0,2),16);
        const g = parseInt(hexcolor.substr(2,2),16);
        const b = parseInt(hexcolor.substr(4,2),16);
        const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return brightness > 125 ? '#000000' : '#ffffff';
    },
    
    // Deep clone object
    deepClone: function(obj) {
        return JSON.parse(JSON.stringify(obj));
    },
    
    // Merge objects deeply
    deepMerge: function(target, ...sources) {
        if (!sources.length) return target;
        const source = sources.shift();
        
        if (this.isObject(target) && this.isObject(source)) {
            for (const key in source) {
                if (this.isObject(source[key])) {
                    if (!target[key]) Object.assign(target, { [key]: {} });
                    this.deepMerge(target[key], source[key]);
                } else {
                    Object.assign(target, { [key]: source[key] });
                }
            }
        }
        
        return this.deepMerge(target, ...sources);
    },
    
    // Check if value is object
    isObject: function(item) {
        return (item && typeof item === 'object' && !Array.isArray(item));
    },
    
    // Generate hash from string
    hashString: function(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash;
    },
    
    // Truncate text with ellipsis
    truncateText: function(text, maxLength = 100) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    },
    
    // Capitalize first letter
    capitalize: function(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    },
    
    // Generate unique array
    uniqueArray: function(arr) {
        return [...new Set(arr)];
    },
    
    // Sleep function
    sleep: function(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },
    
    // Retry function with exponential backoff
    retry: async function(fn, retries = 3, delay = 1000) {
        try {
            return await fn();
        } catch (error) {
            if (retries === 0) throw error;
            await this.sleep(delay);
            return this.retry(fn, retries - 1, delay * 2);
        }
    },
    
    // Parse query string
    parseQueryString: function(query) {
        return query.substr(1).split('&').reduce((params, param) => {
            const [key, value] = param.split('=');
            params[key] = value ? decodeURIComponent(value.replace(/\+/g, ' ')) : '';
            return params;
        }, {});
    },
    
    // Stringify query object
    stringifyQuery: function(params) {
        return Object.keys(params).map(key => 
            `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`
        ).join('&');
    },
    
    // Get CSS variable value
    getCssVariable: function(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    },
    
    // Set CSS variable
    setCssVariable: function(name, value) {
        document.documentElement.style.setProperty(name, value);
    },
    
    // Generate gradient
    generateGradient: function(color1, color2, angle = 135) {
        return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
    },
    
    // Format number with commas
    formatNumber: function(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    
    // Get file type category
    getFileTypeCategory: function(path) {
        const ext = this.getExtension(path);
        const categories = {
            'code': ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'cs', 'php', 'rb', 'go', 'rs', 'swift', 'kt', 'scala'],
            'web': ['html', 'css', 'scss', 'sass', 'less', 'vue', 'svelte'],
            'data': ['json', 'xml', 'yml', 'yaml', 'csv', 'sql'],
            'document': ['md', 'txt', 'pdf', 'doc', 'docx'],
            'image': ['jpg', 'jpeg', 'png', 'gif', 'svg', 'ico', 'webp'],
            'media': ['mp3', 'wav', 'mp4', 'avi', 'mov'],
            'config': ['config', 'env', 'ini', 'toml']
        };
        
        for (const [category, exts] of Object.entries(categories)) {
            if (exts.includes(ext)) return category;
        }
        
        return 'other';
    }
};


// Safe DOM helpers (avoid hard crashes on missing transient modals)
window.__pc_removeEl = function(id){ try{ const el = document.getElementById(id); if(el && typeof el.remove==='function') el.remove(); }catch(_){} };


// THM VO FileSystem object
class SmartAutoSave {
    constructor() {
        this.pendingChanges = new Map();
        this.saveTimer = null;
        this.MIN_INTERVAL = 1000; // 1s
        this.MAX_INTERVAL = 5000; // 5s
        this.lastSaveTime = 0;
        this.changeCount = 0;
    }
    
    queueChange(path, content) {
        this.pendingChanges.set(path, content);
        this.changeCount++;
        
        // Clear existing timer
        if (this.saveTimer) {
            clearTimeout(this.saveTimer);
        }
        
        const now = Date.now();
        const timeSinceLastSave = now - this.lastSaveTime;
        
        //  Adaptive delay based on activity
        let delay = this.MIN_INTERVAL;
        if (this.changeCount > 10) {
            // Rapid changes - wait longer
            delay = this.MAX_INTERVAL;
        } else if (timeSinceLastSave < this.MIN_INTERVAL * 2) {
            // Recent save - wait a bit
            delay = this.MIN_INTERVAL * 1.5;
        }
        
        this.saveTimer = setTimeout(() => this.flush(), delay);
    }
    
    async flush() {
        if (this.pendingChanges.size === 0) return;
        
        const changes = Array.from(this.pendingChanges.entries());
        this.pendingChanges.clear();
        this.changeCount = 0;
        this.lastSaveTime = Date.now();
        
        try {
            // Batch save
            for (const [path, content] of changes) {
                IDE.state.files[path] = content;
                await IndexedDBManager.setFile(path, content);
            }
            
            console.log(` Auto-saved ${changes.length} file(s)`);
        } catch (error) {
            console.error('Auto-save failed:', error);
            // Re-queue failed changes
            changes.forEach(([path, content]) => {
                this.pendingChanges.set(path, content);
            });
        }
    }
    
    forceFlush() {
        if (this.saveTimer) {
            clearTimeout(this.saveTimer);
        }
        return this.flush();
    }
}

const FileSystem = {
    autoSave: null,
    saveTimeout: null,
    // Initialize file system with versioning
    init: async function() {
        console.log(' Initializing Enhanced File System v19.0');
        
        this.autoSave = new SmartAutoSave();
        // Load from localStorage with version check
        const saved = localStorage.getItem(`procode_fs_v${IDE.version}`);
        const settings = localStorage.getItem(`procode_settings_v${IDE.version}`);
        const version = localStorage.getItem('procode_version');
        
        // Migration from older versions
        if (version && version !== IDE.version) {
            this.migrateFromOldVersion(version);
        }
        
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                IDE.state.files = this.validateFileSystem(parsed);
                Utils.toast('Project loaded from storage', 'success');
            } catch (e) {
                console.error('Failed to parse saved files:', e);
                IDE.state.files = { ...IDE.state.templates.vanilla };
                Utils.toast('Created new project', 'info');
            }
        } else {
            // Try IndexedDB fallback first
            try {
                if (window.indexedDB) {
                    await IndexedDBManager.init();
                    const dbFiles = await IndexedDBManager.getAllFiles();
                    if (Array.isArray(dbFiles) && dbFiles.length > 0) {
                        IDE.state.files = {};
                        dbFiles.forEach(f => {
                            IDE.state.files[f.path] = f.content;
                        });
                        Utils.toast(` Loaded ${dbFiles.length} files from IndexedDB`, 'success');
                    } else {
                        IDE.state.files = { ...IDE.state.templates.vanilla };
                        Utils.toast('Welcome to ProCode IDE v19.0!', 'info');
                    }
                } else {
                    IDE.state.files = { ...IDE.state.templates.vanilla };
                    Utils.toast('Welcome to ProCode IDE v19.0!', 'info');
                }
            } catch (e) {
                console.warn(' IndexedDB load failed, using defaults:', e);
                IDE.state.files = { ...IDE.state.templates.vanilla };
                Utils.toast('Welcome to ProCode IDE v19.0!', 'info');
            }
        }
        
        if (settings) {
            try {
                const savedSettings = JSON.parse(settings);
                IDE.state.settings = Utils.deepMerge(IDE.state.settings, savedSettings);
            } catch (e) {
                console.error('Failed to parse settings:', e);
            }
        } else {
            // Fallback: load settings from IndexedDB if available
            try {
                if (window.indexedDB) {
                    await IndexedDBManager.init();
                    const dbSettings = await IndexedDBManager.getSetting('ide_settings');
                    if (dbSettings) {
                        IDE.state.settings = Utils.deepMerge(IDE.state.settings, dbSettings);
                    }
                }
            } catch (e) {
                console.warn(' IndexedDB settings load failed:', e);
            }
        }

        // Prepare IndexedDB persistence queue (non-blocking)
        this._pendingDBWrites = this._pendingDBWrites || new Map();
        this._pendingDBDeletes = this._pendingDBDeletes || new Set();
        this._flushIndexedDBDebounced = this._flushIndexedDBDebounced || Utils.debounce(() => this.flushIndexedDB(), 300);

        // Save current version
        localStorage.setItem('procode_version', IDE.version);
        
        this.refreshTree();
        this.setupAutoSave();
        this.setupFileWatchers();
        
        // Initialize file system metrics
        this.updateFileSystemMetrics();
        
        console.log(' File system initialized');
    },

    // Queue write for IndexedDB persistence (non-blocking)
    _queueIndexedDBWrite: function(path, content) {
        try {
            if (!window.indexedDB) return;
            if (!this._pendingDBWrites) this._pendingDBWrites = new Map();
            if (!this._pendingDBDeletes) this._pendingDBDeletes = new Set();
            this._pendingDBDeletes.delete(path);
            this._pendingDBWrites.set(path, content);
            if (!this._flushIndexedDBDebounced) {
                this._flushIndexedDBDebounced = Utils.debounce(() => this.flushIndexedDB(), 300);
            }
            this._flushIndexedDBDebounced();
        } catch (e) {
            // Ignore persistence errors
        }
    },

    // Thm vo FileSystem object
    _writeQueue: new Map(),
    _writeTimer: null,

    writeDebounced: function(path, content, delay = 100) {
        // Queue write operation
        this._writeQueue.set(path, content);
        
        // Clear existing timer
        if (this._writeTimer) {
            clearTimeout(this._writeTimer);
        }
        
        // Set new timer
        this._writeTimer = setTimeout(() => {
            this.flushWriteQueue();
        }, delay);
    },

    flushWriteQueue: function() {
        if (this._writeQueue.size === 0) return;
        
        const batch = Array.from(this._writeQueue.entries());
        this._writeQueue.clear();
        
        // Batch write
        batch.forEach(([path, content]) => {
            this.write(path, content, { skipAutoSave: true });
        });
        
        // Single save after batch
        if (IDE.state.settings.editor.autoSave) {
            this.save();
        }
    },

    // Queue delete for IndexedDB persistence (non-blocking)
    _queueIndexedDBDelete: function(path) {
        try {
            if (!window.indexedDB) return;
            if (!this._pendingDBWrites) this._pendingDBWrites = new Map();
            if (!this._pendingDBDeletes) this._pendingDBDeletes = new Set();
            this._pendingDBWrites.delete(path);
            this._pendingDBDeletes.add(path);
            if (!this._flushIndexedDBDebounced) {
                this._flushIndexedDBDebounced = Utils.debounce(() => this.flushIndexedDB(), 300);
            }
            this._flushIndexedDBDebounced();
        } catch (e) {
            // Ignore persistence errors
        }
    },

    // Thay th trong FileSystem object
    flushIndexedDB: async function() {
        if (this._isFlushingDB) {
            // i flush hin ti hon thnh
            return this._flushPromise;
        }
        
        this._isFlushingDB = true;
        this._flushPromise = (async () => {
            try {
                if (!window.indexedDB) return;
                await IndexedDBManager.init();

                const writes = this._pendingDBWrites ? Array.from(this._pendingDBWrites.entries()) : [];
                const deletes = this._pendingDBDeletes ? Array.from(this._pendingDBDeletes.values()) : [];
                
                // Clear queues immediately  trnh duplicate
                this._pendingDBWrites = new Map();
                this._pendingDBDeletes = new Set();

                // Batch operations vi transaction
                const db = IndexedDBManager.db;
                if (!db) return;
                
                const transaction = db.transaction(['files', 'settings'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                const settingsStore = transaction.objectStore('settings');
                
                // Batch writes
                for (const [path, content] of writes) {
                    fileStore.put({
                        path: path,
                        content: content,
                        size: new Blob([content]).size,
                        modified: new Date().toISOString()
                    });
                }
                
                // Batch deletes
                for (const path of deletes) {
                    fileStore.delete(path);
                }
                
                // Settings
                settingsStore.put({ key: 'ide_settings', value: IDE.state.settings });
                settingsStore.put({ key: 'last_save', value: new Date().toISOString() });
                settingsStore.put({ key: 'ide_version', value: IDE.version });
                
                // Wait for transaction
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = () => reject(transaction.error);
                });
                
            } catch (e) {
                console.warn(' IndexedDB flush failed:', e);
                // Retry logic
                if (!this._flushRetries) this._flushRetries = 0;
                if (this._flushRetries < 3) {
                    this._flushRetries++;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return this.flushIndexedDB();
                }
            } finally {
                this._isFlushingDB = false;
                this._flushRetries = 0;
            }
        })();
        
        return this._flushPromise;
    },

    // Validate file system structure
    validateFileSystem: function(files) {
        const validated = {};
        for (const [path, content] of Object.entries(files)) {
            if (typeof content === 'string' && Utils.isValidFileName(path.split('/').pop())) {
                validated[path] = content;
            }
        }
        return validated;
    },
    
    // Migrate from older versions
    migrateFromOldVersion: function(oldVersion) {
        console.log(` Migrating storage from version ${oldVersion} to ${IDE.version}`);

        const now = Date.now();
        const fsKeys = [
            `procode_fs_v${oldVersion}`,
            `procode_fs_v${String(oldVersion).replace(/\./g, '_')}`,
        ];
        const settingsKeys = [
            `procode_settings_v${oldVersion}`,
            `procode_settings_v${String(oldVersion).replace(/\./g, '_')}`,
        ];

        const pickFirst = (keys) => {
            for (const k of keys) {
                const v = localStorage.getItem(k);
                if (v) return { key: k, value: v };
            }
            return null;
        };

        const oldFS = pickFirst(fsKeys);
        const oldSettings = pickFirst(settingsKeys);

        // Backup whatever we find (timestamped)
        if (oldFS?.value) {
            localStorage.setItem(`procode_fs_backup_v${oldVersion}_${now}`, oldFS.value);
        }
        if (oldSettings?.value) {
            localStorage.setItem(`procode_settings_backup_v${oldVersion}_${now}`, oldSettings.value);
        }

        // Only copy forward if the new version key doesn't exist yet
        const newFSKey = `procode_fs_v${IDE.version}`;
        const newSettingsKey = `procode_settings_v${IDE.version}`;

        if (!localStorage.getItem(newFSKey) && oldFS?.value) {
            localStorage.setItem(newFSKey, oldFS.value);
        }
        if (!localStorage.getItem(newSettingsKey) && oldSettings?.value) {
            localStorage.setItem(newSettingsKey, oldSettings.value);
        }

        // Version marker
        localStorage.setItem('procode_version', IDE.version);

        Utils.toast(` Migrated storage to v${IDE.version}`, 'success');
    },

    // Enhanced save with versioning
    save: function(immediate = false) {
        if (!immediate && !IDE.state.settings.editor.autoSave) {
            return;
        }
        
        const saveKey = `procode_fs_v${IDE.version}`;
        const settingsKey = `procode_settings_v${IDE.version}`;
        
        try {
            localStorage.setItem(saveKey, JSON.stringify(IDE.state.files));
            localStorage.setItem(settingsKey, JSON.stringify(IDE.state.settings));
            localStorage.setItem('procode_last_save', new Date().toISOString());
            
            // Best-effort persist to IndexedDB (non-blocking)
            this.flushIndexedDB().catch(() => {});
            
            // Update file system metrics
            this.updateFileSystemMetrics();
            
            // Visual feedback
            const saveBtn = document.querySelector('[title*="Save"]');
            if (saveBtn) {
                const originalColor = saveBtn.style.color;
                saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                saveBtn.style.color = '#22c55e';
                
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i>';
                    saveBtn.style.color = originalColor;
                }, 1000);
            }
            
            if (immediate) {
                Utils.toast('Project saved successfully', 'success');
            }
            
            // Update save indicator
            this.updateSaveIndicator();
            
            return true;
        } catch (e) {
            console.error('Save failed:', e);
            Utils.toast('Save failed: ' + e.message, 'error');
            return false;
        }
    },
    
    // Update save indicator in footer
    updateSaveIndicator: function() {
        const lastSave = localStorage.getItem('procode_last_save');
        if (lastSave) {
            const timeAgo = Utils.formatDate(lastSave, 'relative');
            // Could add to footer or status bar
        }
    },
    
    // Setup auto-save with enhanced logic
    setupAutoSave: function() {
        if (IDE.state.settings.editor.autoSave) {
            this.autoSaveInterval = setInterval(() => {
                if (IDE.state.dirtyTabs.size > 0) {
                    this.save();
                    IDE.state.dirtyTabs.clear();
                    this.updateTabDirtyState();
                }
            }, IDE.state.settings.editor.autoSaveDelay);
            
            // Enhanced beforeunload handler
            window.addEventListener('beforeunload', (e) => {
                if (IDE.state.dirtyTabs.size > 0 && IDE.state.settings.editor.autoSave) {
                    this.save(true);
                }
                
                // Clear interval
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }
            });
        }
    },
    
    // Setup file watchers for external changes
    setupFileWatchers: function() {
        // This would integrate with File System Access API when available
        if ('showOpenFilePicker' in window) {
            console.log(' File System Access API available');
        }
    },
    
    // Update file system metrics
    updateFileSystemMetrics: function() {
        const metrics = {
            totalFiles: Object.keys(IDE.state.files).length,
            totalSize: 0,
            byType: {}
        };
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            const size = new Blob([content]).size;
            metrics.totalSize += size;
            
            const type = Utils.getFileTypeCategory(path);
            metrics.byType[type] = (metrics.byType[type] || 0) + 1;
        }
        
        IDE.state.fileSystemMetrics = metrics;
        
        // Update UI if needed
        const fileCountEl = document.getElementById('file-count');
        if (fileCountEl) {
            fileCountEl.textContent = `${metrics.totalFiles} files`;
        }
    },

    exists: function(path) {
        if (!path) return false;
        if (IDE.state.files && Object.prototype.hasOwnProperty.call(IDE.state.files, path)) {
            return true;
        }
        if (path.endsWith('/')) {
            return Object.keys(IDE.state.files).some((p) => p.startsWith(path));
        }
        return false;
    },
    
    // Enhanced file operations with transactions
    write: function(path, content, options = {}) {
        const oldContent = IDE.state.files[path];
        const isNewFile = !this.exists(path);
        
        // Create backup for undo
        if (!options.skipHistory && oldContent !== content) {
            this.addToHistory('write', path, oldContent, content);
        }
        
        IDE.state.files[path] = content;
        
        // Queue persistence
        this._queueIndexedDBWrite(path, content);
        
        // Mark tab as dirty
        if (IDE.state.tabs.includes(path)) {
            IDE.state.dirtyTabs.add(path);
            this.updateTabDirtyState();
        }
        
        // Update outline if this is the active file
        if (IDE.state.activeTab === path) {
            this.updateOutline();
        }
        
        // Auto-save if enabled
        if (IDE.state.settings.editor.autoSave && !options.skipAutoSave) {
            if (this.autoSave) {
                this.autoSave.queueChange(path, content);
            } else {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => this.save(), 1000);
            }
        }
        
        // Update metrics
        this.updateFileSystemMetrics();
        
        // Event for external listeners
        this.emitFileChange(path, isNewFile ? 'created' : 'modified');
        
        return true;
    },
    
    // Enhanced read with caching
    read: function(path, useCache = true) {
        if (!this.exists(path)) {
            throw new Error(`File not found: ${path}`);
        }
        
        if (useCache && this.fileCache && this.fileCache[path]) {
            return this.fileCache[path];
        }
        
        const content = IDE.state.files[path] || '';
        
        // Cache for performance
        if (!this.fileCache) this.fileCache = {};
        this.fileCache[path] = content;
        
        return content;
    },
    
    // Enhanced delete with recycle bin
    delete: function(path, permanent = false) {
        if (!this.exists(path)) return false;
        
        if (!permanent && !confirm(`Move "${path}" to recycle bin?`)) {
            return false;
        }
        
        if (permanent && !confirm(`Permanently delete "${path}"? This cannot be undone.`)) {
            return false;
        }
        
        const content = this.read(path);
        
        // Add to recycle bin if not permanent
        if (!permanent) {
            this.addToRecycleBin(path, content);
        }
        
        // Add to history for undo
        this.addToHistory('delete', path, content, null);
        
        delete IDE.state.files[path];
        
        // Queue persistence
        this._queueIndexedDBDelete(path);
        
        TabManager.close(path, true);
        IDE.state.dirtyTabs.delete(path);
        
        this.save();
        this.refreshTree();
        
        Utils.toast(`${permanent ? 'Permanently deleted' : 'Moved to recycle bin'}: ${path}`, 'warning');
        
        return true;
    },
    
    // Enhanced rename with conflict resolution
    rename: function(oldPath, newPath, options = {}) {
        if (oldPath === newPath) return true;
        
        const fileName = newPath.split('/').pop();
        if (!Utils.isValidFileName(fileName)) {
            Utils.toast('Invalid file name', 'error');
            return false;
        }
        
        if (this.exists(newPath)) {
            if (options.overwrite) {
                // Backup the overwritten file
                const overwrittenContent = this.read(newPath);
                this.addToHistory('overwrite', newPath, overwrittenContent, null);
                delete IDE.state.files[newPath];
            } else {
                Utils.toast('File already exists', 'error');
                return false;
            }
        }
        
        const content = this.read(oldPath);
        
        // Add to history
        this.addToHistory('rename', oldPath, content, newPath);
        
        delete IDE.state.files[oldPath];
        this.write(newPath, content, { skipHistory: true });
        
        // Update tabs
        const tabIndex = IDE.state.tabs.indexOf(oldPath);
        if (tabIndex > -1) {
            IDE.state.tabs[tabIndex] = newPath;
        }
        
        if (IDE.state.activeTab === oldPath) {
            IDE.state.activeTab = newPath;
        }
        
        // Update dirty tabs
        if (IDE.state.dirtyTabs.has(oldPath)) {
            IDE.state.dirtyTabs.delete(oldPath);
            IDE.state.dirtyTabs.add(newPath);
        }
        
        this.save();
        this.refreshTree();
        TabManager.render();
        
        Utils.toast(`Renamed to: ${newPath}`, 'success');
        return true;
    },
    
refreshTree: function() {
    const tree = document.getElementById('file-tree');
    if (!tree) return;
    
    // Clear existing content
    if (tree._cleanupVirtualScroll) {
        tree._cleanupVirtualScroll();
    }
    tree.innerHTML = '';
    
    const totalFiles = Object.keys(IDE.state.files).length;
    
    // Show loading for large file systems
    if (totalFiles > 100) {
        tree.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);"><i class="fas fa-spinner fa-spin"></i> Loading file tree...</div>';
        
        // Use requestIdleCallback for better performance
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                tree.innerHTML = '';
                this.renderFileTreeVirtual(tree);
            }, { timeout: 1000 });
        } else {
            setTimeout(() => {
                tree.innerHTML = '';
                this.renderFileTreeVirtual(tree);
            }, 50);
        }
    } else {
        // Use regular rendering for small projects
        this.renderFileTree(tree);
    }
},
renderFileTreeVirtual: function(container) {
    const allFiles = this.buildFileStructure();
    const flattenedItems = this.flattenFileStructure(allFiles);
    
    //  FIX: Gim buffer size, tng hiu sut
    const itemHeight = 28;
    const containerHeight = container.clientHeight;
    const visibleCount = Math.ceil(containerHeight / itemHeight);
    const bufferSize = 5; // Gim t 10 xung 5
    
    let scrollTop = 0;
    let startIndex = 0;
    let endIndex = visibleCount + bufferSize;
    let animationFrameId = null;
    let renderCache = new Map();
    let lastStartIndex = -1;
    
    //  NEW: Pooling pattern  ti s dng DOM nodes
    const nodePool = [];
    const getNodeFromPool = () => {
        return nodePool.pop() || this.createFileTreeItem({ type: 'placeholder' }, 0);
    };
    const returnNodeToPool = (node) => {
        if (nodePool.length < 50) nodePool.push(node);
    };
    
    const scrollContainer = document.createElement('div');
    scrollContainer.style.height = `${flattenedItems.length * itemHeight}px`;
    scrollContainer.style.position = 'relative';
    
    const visibleContainer = document.createElement('div');
    visibleContainer.style.position = 'absolute';
    visibleContainer.style.top = '0';
    visibleContainer.style.left = '0';
    visibleContainer.style.right = '0';
    visibleContainer.style.willChange = 'transform';
    visibleContainer.style.contain = 'layout style paint'; //  NEW: CSS containment
    
    const renderVisibleItems = () => {
        if (startIndex === lastStartIndex && renderCache.size > 0) return;
        
        //  FIX: Batch DOM operations
        const fragment = document.createDocumentFragment();
        const existingNodes = Array.from(visibleContainer.children);
        const nodesToKeep = new Set();
        
        for (let i = startIndex; i < Math.min(endIndex, flattenedItems.length); i++) {
            const item = flattenedItems[i];
            const cacheKey = `${item.path}-${i}`;
            
            let element = renderCache.get(cacheKey);
            if (!element) {
                element = this.createFileTreeItem(item, i * itemHeight);
                renderCache.set(cacheKey, element);
            } else {
                element.style.top = `${i * itemHeight}px`;
            }
            
            nodesToKeep.add(element);
            fragment.appendChild(element.cloneNode(true));
        }
        
        //  FIX: Cleanup unused nodes
        existingNodes.forEach(node => {
            if (!nodesToKeep.has(node)) {
                returnNodeToPool(node);
            }
        });
        
        visibleContainer.innerHTML = '';
        visibleContainer.appendChild(fragment);
        lastStartIndex = startIndex;
        
        //  FIX: Smart cache cleanup
        if (renderCache.size > visibleCount * 3) {
            const keysToKeep = new Set();
            const rangeStart = Math.max(0, startIndex - bufferSize * 2);
            const rangeEnd = Math.min(flattenedItems.length, endIndex + bufferSize * 2);
            
            for (let i = rangeStart; i < rangeEnd; i++) {
                keysToKeep.add(`${flattenedItems[i].path}-${i}`);
            }
            
            for (const key of renderCache.keys()) {
                if (!keysToKeep.has(key)) renderCache.delete(key);
            }
        }
    };
    
    //  FIX: Throttled scroll vi RAF
    let lastScrollTime = 0;
    const handleScroll = () => {
        const now = performance.now();
        if (now - lastScrollTime < 16) return; // Throttle to ~60fps
        lastScrollTime = now;
        
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        
        animationFrameId = requestAnimationFrame(() => {
            scrollTop = container.scrollTop;
            const newStartIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - bufferSize);
            const newEndIndex = Math.min(flattenedItems.length, newStartIndex + visibleCount + (bufferSize * 2));
            
            if (newStartIndex !== startIndex || newEndIndex !== endIndex) {
                startIndex = newStartIndex;
                endIndex = newEndIndex;
                visibleContainer.style.transform = `translate3d(0, ${startIndex * itemHeight}px, 0)`; //  Use translate3d
                renderVisibleItems();
            }
        });
    };
    
    //  FIX: Passive listener
    container.addEventListener('scroll', handleScroll, { passive: true });
    
    scrollContainer.appendChild(visibleContainer);
    container.appendChild(scrollContainer);
    renderVisibleItems();
    
    //  NEW: Cleanup function
    container._cleanupVirtualScroll = () => {
        container.removeEventListener('scroll', handleScroll);
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        renderCache.clear();
        nodePool.length = 0;
    };
},

    flattenFileStructure: function(structure, level = 0, parentPath = '') {
        const items = [];
        
        for (const [name, data] of Object.entries(structure)) {
            if (name === '__file' || name === '__folder' || name === 'path') continue;
            
            const currentPath = parentPath ? `${parentPath}/${name}` : name;
            
            if (data.__file) {
                items.push({
                    type: 'file',
                    name: name,
                    path: data.path,
                    level: level
                });
            } else if (data.__folder) {
                items.push({
                    type: 'folder',
                    name: name,
                    path: currentPath,
                    level: level,
                    expanded: localStorage.getItem(`folder_${currentPath}`) === 'expanded'
                });
                
                // Add children if expanded
                if (localStorage.getItem(`folder_${currentPath}`) === 'expanded') {
                    items.push(...this.flattenFileStructure(data, level + 1, currentPath));
                }
            }
        }
        
        return items;
    },

    createFileTreeItem: function(item, top) {
        const element = document.createElement('div');
        element.className = 't-item';
        element.style.position = 'absolute';
        element.style.top = `${top}px`;
        element.style.left = '0';
        element.style.right = '0';
        element.style.height = '28px';
        element.dataset.path = item.path;
        
        const padding = 16 + (item.level * 20);
        
        if (item.type === 'file') {
            const [iconClass, iconColor] = Utils.getFileIcon(item.name);
            const isDirty = IDE.state.dirtyTabs.has(item.path);
            const isActive = IDE.state.activeTab === item.path;
            
            element.innerHTML = `
                <div class="t-indent" style="padding-left:${padding}px">
                    <i class="${iconClass}" style="color:${iconColor}"></i>
                    <span style="margin-left:8px; flex:1;">${item.name}</span>
                    ${isDirty ? '<span style="color:var(--primary); font-size:20px; margin-right:8px;"></span>' : ''}
                </div>
            `;
            
            element.onclick = (e) => {
                e.stopPropagation();
                TabManager.open(item.path);
            };
            
            if (isActive) {
                element.classList.add('active');
            }
        } else {
            const folderIcon = item.expanded ? 'fa-folder-open' : 'fa-folder';
            
            element.innerHTML = `
                <div class="t-indent" style="padding-left:${padding}px">
                    <i class="fas ${folderIcon}" style="color:#d97706"></i>
                    <span style="margin-left:8px; flex:1;">${item.name}</span>
                    <i class="fas fa-chevron-right" 
                       style="font-size:10px; transform: ${item.expanded ? 'rotate(90deg)' : 'rotate(0deg)'};
                              transition: transform 0.2s;"></i>
                </div>
            `;
            
            element.onclick = (e) => {
                e.stopPropagation();
                this.toggleFolderVirtual(item.path);
            };
        }
        
        return element;
    },

    toggleFolderVirtual: function(path) {
        const currentState = localStorage.getItem(`folder_${path}`);
        const newState = currentState === 'expanded' ? 'collapsed' : 'expanded';
        localStorage.setItem(`folder_${path}`, newState);
        
        // Re-render the tree
        this.refreshTree();
    },

    // Render file tree with virtualization
    renderFileTree: function(container) {
        const structure = this.buildFileStructure();
        this.renderNode(structure, container, 0, '');
        
        // Update outline if active tab exists
        if (IDE.state.activeTab) {
            this.updateOutline();
        }
    },
    
    // Build hierarchical file structure
    buildFileStructure: function() {
        const structure = {};
        
        Object.keys(IDE.state.files)
            .sort((a, b) => {
                // Sort directories first, then files
                const aIsDir = a.includes('/');
                const bIsDir = b.includes('/');
                if (aIsDir && !bIsDir) return -1;
                if (!aIsDir && bIsDir) return 1;
                return a.localeCompare(b);
            })
            .forEach(path => {
                const parts = path.split('/');
                let current = structure;
                
                parts.forEach((part, i) => {
                    if (!current[part]) {
                        current[part] = (i === parts.length - 1) 
                            ? { __file: true, path: path } 
                            : { __folder: true };
                    }
                    current = current[part];
                });
            });
        
        return structure;
    },
    
    // Render tree node recursively
    renderNode: function(node, container, level = 0, parentPath = '') {
        if (!node || typeof node !== 'object') return;
        
        const entries = Object.entries(node);
        if (entries.length === 0) return;
        
        // Sort: folders first, then files
        entries.sort(([aKey, aVal], [bKey, bVal]) => {
            const aIsFolder = aVal.__folder;
            const bIsFolder = bVal.__folder;
            
            if (aIsFolder && !bIsFolder) return -1;
            if (!aIsFolder && bIsFolder) return 1;
            return aKey.localeCompare(bKey);
        });
        
        for (const [name, data] of entries) {
            if (name === '__file' || name === '__folder' || name === 'path') continue;
            
            const currentPath = parentPath ? `${parentPath}/${name}` : name;
            const padding = 16 + (level * 20);
            
            if (data.__file) {
                // File item
                this.renderFileItem(name, data.path, padding, container);
            } else if (data.__folder) {
                // Folder item
                this.renderFolderItem(name, currentPath, padding, container, level, data);
            }
        }
    },
    
    // Render file item
    renderFileItem: function(name, path, padding, container) {
        const item = document.createElement('div');
        item.className = 't-item';
        item.dataset.path = path;
        
        const [iconClass, iconColor] = Utils.getFileIcon(name);
        const isDirty = IDE.state.dirtyTabs.has(path);
        const isActive = IDE.state.activeTab === path;
        
        item.innerHTML = `
            <div class="t-indent" style="padding-left:${padding}px">
                <i class="${iconClass}" style="color:${iconColor}"></i>
                <span style="margin-left:8px; flex:1;">${name}</span>
                ${isDirty ? '<span style="color:var(--primary); font-size:20px; margin-right:8px;"></span>' : ''}
                ${isActive ? '<span style="color:var(--primary); font-size:10px; margin-right:8px;"></span>' : ''}
            </div>
        `;
        
        item.onclick = (e) => {
            e.stopPropagation();
            if (e.ctrlKey || e.metaKey) {
                LayoutManager.openInSplit(path);
            } else {
                TabManager.open(path);
            }
        };
        
        item.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showContextMenu(e, path, 'file');
        };
        
        // Drag and drop support
        item.draggable = true;
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', path);
            e.dataTransfer.effectAllowed = 'move';
            item.style.opacity = '0.5';
        });
        
        item.addEventListener('dragend', () => {
            item.style.opacity = '1';
        });
        
        if (isActive) {
            item.classList.add('active');
        }
        
        container.appendChild(item);
    },
    
    // Render folder item
    renderFolderItem: function(name, path, padding, container, level, data) {
        const item = document.createElement('div');
        item.className = 't-item';
        item.dataset.folder = path;
        
        // Check if folder contains active file
        const hasActiveChild = IDE.state.activeTab && 
            IDE.state.activeTab.startsWith(path + '/');
        
        const isExpanded = hasActiveChild || 
            (localStorage.getItem(`folder_${path}`) === 'expanded');
        
        const folderIcon = isExpanded ? 'fa-folder-open' : 'fa-folder';
        
        item.innerHTML = `
            <div class="t-indent" style="padding-left:${padding}px">
                <i class="fas ${folderIcon}" style="color:#d97706"></i>
                <span style="margin-left:8px; flex:1;">${name}</span>
                <i class="fas fa-chevron-right" 
                   style="font-size:10px; transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'};
                          transition: transform 0.2s;"></i>
            </div>
        `;
        
        const subContainer = document.createElement('div');
        subContainer.className = `t-sub ${isExpanded ? '' : 'hidden'}`;
        
        item.onclick = (e) => {
            e.stopPropagation();
            this.toggleFolder(item, subContainer, path);
        };
        
        item.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showContextMenu(e, path + '/', 'folder');
        };
        
        // Drag and drop for folders
        item.draggable = true;
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            item.style.background = 'var(--primary)20';
        });
        
        item.addEventListener('dragleave', () => {
            item.style.background = '';
        });
        
        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.style.background = '';
            const draggedPath = e.dataTransfer.getData('text/plain');
            if (draggedPath) {
                this.moveFile(draggedPath, path + '/' + draggedPath.split('/').pop());
            }
        });
        
        container.appendChild(item);
        container.appendChild(subContainer);
        
        // Recursively render children
        this.renderNode(data, subContainer, level + 1, path);
    },
    
    // Toggle folder expansion
    toggleFolder: function(folderElement, subContainer, path) {
        const wasHidden = subContainer.classList.contains('hidden');
        subContainer.classList.toggle('hidden');
        
        const folderIcon = folderElement.querySelector('.fa-folder, .fa-folder-open');
        const chevron = folderElement.querySelector('.fa-chevron-right');
        
        if (wasHidden) {
            folderIcon.className = 'fas fa-folder-open';
            chevron.style.transform = 'rotate(90deg)';
            localStorage.setItem(`folder_${path}`, 'expanded');
        } else {
            folderIcon.className = 'fas fa-folder';
            chevron.style.transform = 'rotate(0deg)';
            localStorage.setItem(`folder_${path}`, 'collapsed');
        }
    },
    
    // Enhanced context menu
    showContextMenu: function(event, path, type) {
        // Remove existing context menus
        document.querySelectorAll('.context-menu').forEach(el => el.remove());
        
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        if (type === 'file') {
            this.renderFileContextMenu(menu, path);
        } else {
            this.renderFolderContextMenu(menu, path);
        }
        
        document.body.appendChild(menu);
        
        // Close menu when clicking outside
        setTimeout(() => {
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    },
    
    // Render file context menu
    renderFileContextMenu: function(menu, path) {
        const fileName = path.split('/').pop();
        const previewToken = this._previewToken || '';
        const previewTokenJson = JSON.stringify(previewToken);
        const ext = Utils.getExtension(path);
        
        this.addContextMenuItem(menu, 'fa-edit', 'Rename', () => {
            const newName = prompt('Enter new name:', fileName);
            if (newName && newName !== fileName) {
                const newPath = path.split('/').slice(0, -1).concat(newName).join('/');
                this.rename(path, newPath);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-copy', 'Duplicate', () => {
            this.duplicateFile(path);
        });
        
        this.addContextMenuItem(menu, 'fa-clone', 'Clone to...', () => {
            const targetFolder = prompt('Enter target folder path (leave empty for current):', '');
            if (targetFolder !== null) {
                this.duplicateFile(path, targetFolder);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-trash', 'Move to Recycle Bin', () => {
            this.delete(path, false);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        this.addContextMenuItem(menu, 'fa-download', 'Download', () => {
            const content = this.read(path);
            Utils.downloadFile(fileName, content);
        });
        
        this.addContextMenuItem(menu, 'fa-external-link-alt', 'Open in New Tab', () => {
            const content = this.read(path);
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        });
        
        this.addContextMenuItem(menu, 'fa-share', 'Share...', () => {
            this.shareFile(path);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        // File-specific actions
        if (ext === 'html' || ext === 'js' || ext === 'css') {
            this.addContextMenuItem(menu, 'fa-play', 'Run File', () => Runner.execute(path));
        }
        
        if (ext === 'md') {
            this.addContextMenuItem(menu, 'fa-eye', 'Preview Markdown', () => {
                this.previewMarkdown(path);
            });
        }
        
        this.addContextMenuItem(menu, 'fa-info-circle', 'Properties', () => {
            this.showFileProperties(path);
        });
    },
    
    // Render folder context menu
    renderFolderContextMenu: function(menu, path) {
        const folderName = path.split('/').filter(Boolean).pop() || 'Project';
        
        this.addContextMenuItem(menu, 'fa-folder-plus', 'New Folder', () => {
            const name = prompt('Enter folder name:');
            if (name) {
                this.createFolder(path + name);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-file-medical', 'New File', () => {
            this.createFilePrompt(path);
        });
        
        this.addContextMenuItem(menu, 'fa-file-import', 'Import Files...', () => {
            this.importPrompt(path);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        this.addContextMenuItem(menu, 'fa-trash', `Delete "${folderName}"`, () => {
            if (confirm(`Delete folder "${folderName}" and all contents?`)) {
                this.deleteFolder(path);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-compress', 'Compress to ZIP', () => {
            this.compressFolder(path);
        });
        
        this.addContextMenuItem(menu, 'fa-search', 'Find in Folder...', () => {
            Search.findInFolder(path);
        });
    },
    
    // Add context menu item
    addContextMenuItem: function(menu, icon, text, action, disabled = false) {
        const item = document.createElement('div');
        item.className = `context-item ${disabled ? 'disabled' : ''}`;
        item.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        
        if (!disabled) {
            item.onclick = () => {
                try {
                    action();
                } catch (error) {
                    Utils.toast(`Action failed: ${error.message}`, 'error');
                }
                menu.remove();
            };
        }
        
        menu.appendChild(item);
    },
    
    // Enhanced duplicate file
    duplicateFile: function(path, targetFolder = null) {
        const fileName = path.split('/').pop();
        const ext = Utils.getExtension(fileName);
        const baseName = fileName.substring(0, fileName.length - (ext ? ext.length + 1 : 0));
        
        let newPath = targetFolder ? 
            `${targetFolder}/${fileName}` : 
            path.split('/').slice(0, -1).concat(fileName).join('/');
        
        // Ensure unique name
        let counter = 1;
        while (this.exists(newPath)) {
            const newName = `${baseName}-copy${counter > 1 ? `-${counter}` : ''}.${ext}`;
            newPath = targetFolder ? 
                `${targetFolder}/${newName}` : 
                path.split('/').slice(0, -1).concat(newName).join('/');
            counter++;
        }
        
        this.write(newPath, this.read(path));
        this.refreshTree();
        TabManager.open(newPath);
        
        Utils.toast(`Duplicated to: ${newPath}`, 'success');
    },
    
    // Create folder
    createFolder: function(path) {
        if (!path.endsWith('/')) path += '/';
        
        // Create a .keep file to mark folder
        const keepPath = path + '.keep';
        this.write(keepPath, '# Folder placeholder\n# This file ensures the folder is visible in the file tree');
        
        this.refreshTree();
        Utils.toast(`Created folder: ${path}`, 'success');
    },
    
    // Delete folder
    deleteFolder: function(path) {
        if (!path.endsWith('/')) path += '/';
        
        // Get all files in folder
        const filesToDelete = Object.keys(IDE.state.files).filter(f => f.startsWith(path));
        
        // Move to recycle bin
        filesToDelete.forEach(filePath => {
            this.addToRecycleBin(filePath, this.read(filePath));
            delete IDE.state.files[filePath];
        });
        
        this.save();
        this.refreshTree();
        Utils.toast(`Deleted folder: ${path} (${filesToDelete.length} files)`, 'warning');
    },
    
    // Compress folder to ZIP
    compressFolder: async function(path) {
        try {
            const zip = new JSZip();
            const folderName = path.split('/').filter(Boolean).pop() || 'archive';
            
            // Add all files in folder
            const folderFiles = Object.keys(IDE.state.files).filter(f => f.startsWith(path));
            
            for (const filePath of folderFiles) {
                const relativePath = filePath.substring(path.length).replace(/^\/+/, '');
                const content = this.read(filePath);
                if (typeof content === 'string' && content.startsWith('data:')) {
                const m = content.match(/^data:([^;]+);base64,(.*)$/);
                if (m) {
                    zip.file(relativePath, m[2], { base64: true });
                } else {
                    zip.file(relativePath, content);
                }
            } else {
                zip.file(relativePath, content);
            }
            }
            
            // Generate and download
            const blob = await zip.generateAsync({ type: "blob" });
            saveAs(blob, `${folderName}-${new Date().toISOString().split('T')[0]}.zip`);
            
            Utils.toast("Folder compressed successfully!", "success");
        } catch (error) {
            Utils.toast("Compression failed: " + error.message, "error");
        }
    },
    
    // Share file
    shareFile: function(path) {
        if (navigator.share) {
            const content = this.read(path);
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], path.split('/').pop(), { type: 'text/plain' });
            
            navigator.share({
                title: `Share ${path}`,
                text: 'Check out this file from ProCode IDE',
                files: [file]
            }).catch(error => {
                if (error.name !== 'AbortError') {
                    Utils.toast('Share failed: ' + error.message, 'error');
                }
            });
        } else {
            Utils.toast('Web Share API not supported in this browser', 'info');
        }
    },
    
    // Preview markdown
    previewMarkdown: function(path) {
        const content = this.read(path);
        const html = marked.parse(content);
        
        const preview = window.open('', '_blank');
        preview.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${path} - Markdown Preview</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
                <style>
                    .markdown-body { box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; padding: 45px; }
                    @media (max-width: 767px) { .markdown-body { padding: 15px; } }
                
</style>
            </head>
            <body class="markdown-body">
                ${html}
            </body>
            </html>
        `);
        preview.document.close();
    },
    
    // Show file properties
    showFileProperties: function(path) {
        const content = this.read(path);
        const stats = {
            path: path,
            name: path.split('/').pop(),
            size: Utils.formatBytes(new Blob([content]).size),
            lines: content.split('\n').length,
            words: content.split(/\s+/).filter(w => w.length > 0).length,
            characters: content.length,
            created: localStorage.getItem(`file_created_${path}`) || 'Unknown',
            modified: localStorage.getItem(`file_modified_${path}`) || 'Unknown',
            type: Utils.getFileTypeCategory(path),
            encoding: 'UTF-8'
        };
        
        const modal = `
            <div class="modal-overlay" id="properties-modal">
                <div class="modal" style="width:500px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-info-circle"></i> Properties: ${stats.name}</h3>
                        <button class="btn icon small" onclick="__pc_removeEl('properties-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table style="width:100%; font-size:13px;">
                            ${Object.entries(stats).map(([key, value]) => `
                                <tr>
                                    <td style="padding:8px; color:var(--text-dim); font-weight:500;">${Utils.capitalize(key)}</td>
                                    <td style="padding:8px;">${value}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="__pc_removeEl('properties-modal')">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    },
    
    // Enhanced import with folder selection
    importPrompt: function(targetFolder = '') {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.zip,.js,.jsx,.ts,.tsx,.html,.css,.py,.md,.json,.txt,.vue,.svelte,.png,.jpg,.jpeg,.gif,.svg,.webp,.ico,.woff,.woff2,.ttf,.otf,.mp3,.wav,.ogg,.mp4,.webm,.m4a,.flac,.pdf';
        input.multiple = true;
        // Choose between folder import and file/ZIP import (so ZIP picking works reliably)
        let folderMode = false;
        try {
            folderMode = confirm('Import mode:\n\nOK = Import a folder (keeps subfolders)\nCancel = Import files / ZIP');
        } catch (_) {}
        if (folderMode) {
            input.webkitdirectory = true;
            input.directory = true;
        }
        
        input.onchange = async (event) => {
            const files = Array.from(event.target.files);
            let importedCount = 0;
            let skippedCount = 0;
            
            for (const file of files) {
                const filePath = targetFolder ? 
                    `${targetFolder}/${file.webkitRelativePath || file.name}` : 
                    file.name;
                
                if (this.exists(filePath) && !confirm(`Overwrite "${filePath}"?`)) {
                    skippedCount++;
                    continue;
                }
                
                if (file.name.endsWith('.zip')) {
                    try {
                        const zip = await JSZip.loadAsync(file);
                        
                        for (const [path, entry] of Object.entries(zip.files)) {
                            if (!entry.dir) {
                                const content = Utils.isBinaryExt(path)
                                    ? `data:${Utils.mimeFromPath(path)};base64,${await entry.async("base64")}`
                                    : await entry.async("string");
                                const fullPath = targetFolder ? `${targetFolder}/${path}` : path;
                                IDE.state.files[fullPath] = content;
                                importedCount++;
                            }
                        }
                        
                        Utils.toast(`Imported ZIP: ${file.name}`, 'success');
                    } catch (error) {
                        Utils.toast(`Failed to import ZIP: ${error.message}`, 'error');
                    }
                } else {
                    try {
                        const content = await Utils.readFileSmart(file);
                        IDE.state.files[filePath] = content;
                        importedCount++;
                        
                        // Record creation time
                        localStorage.setItem(`file_created_${filePath}`, new Date().toISOString());
                    } catch (error) {
                        Utils.toast(`Failed to import ${file.name}: ${error.message}`, 'error');
                    }
                }
            }
            
            if (importedCount > 0) {
                this.save();
                this.refreshTree();
                Utils.toast(`Imported ${importedCount} file(s)${skippedCount > 0 ? `, skipped ${skippedCount}` : ''}`, 'success');
            }
        };
        
        input.click();
    },
    
    // Enhanced export with options
    exportZip: async function(options = {}) {
        try {
            const zip = new JSZip();
            const date = new Date().toISOString().split('T')[0];
            const projectName = options.name || `procode-project-${date}`;
            
            // Add all files (excluding .keep files)
            for (const [path, content] of Object.entries(IDE.state.files)) {
                if (!path.endsWith('.keep')) {
                    if (typeof content === 'string' && content.startsWith('data:')) {
                        const m = content.match(/^data:([^;]+);base64,(.*)$/);
                        if (m) {
                            zip.file(path, m[2], { base64: true });
                        } else {
                            // Non-base64 data URLs: keep as-is
                            zip.file(path, content);
                        }
                    } else {
                        zip.file(path, content);
                    }
                }
            }
            
            // Add project metadata
            const metadata = {
                name: projectName,
                version: '1.0.0',
                created: date,
                ideVersion: IDE.version,
                fileCount: Object.keys(IDE.state.files).length,
                settings: IDE.state.settings
            };
            
            zip.file('PROJECT.json', JSON.stringify(metadata, null, 2));
            
            // Generate and download
            const blob = await zip.generateAsync({ 
                type: "blob",
                compression: options.compression ? "DEFLATE" : "STORE"
            });
            
            saveAs(blob, `${projectName}.zip`);
            Utils.toast("Project exported successfully!", "success");
        } catch (error) {
            Utils.toast("Export failed: " + error.message, "error");
        }
    },
    
    // Move file
    moveFile: function(oldPath, newPath) {
        if (oldPath === newPath) return true;
        
        if (this.exists(newPath)) {
            if (!confirm(`Overwrite "${newPath}"?`)) {
                return false;
            }
        }
        
        const content = this.read(oldPath);
        delete IDE.state.files[oldPath];
        this.write(newPath, content);
        
        // Update tabs
        const tabIndex = IDE.state.tabs.indexOf(oldPath);
        if (tabIndex > -1) {
            IDE.state.tabs[tabIndex] = newPath;
        }
        
        if (IDE.state.activeTab === oldPath) {
            IDE.state.activeTab = newPath;
        }
        
        this.save();
        this.refreshTree();
        TabManager.render();
        
        Utils.toast(`Moved to: ${newPath}`, 'success');
        return true;
    },
    
    // Find in folder
    findInFolder: function(folderPath, query, options = {}) {
        const results = [];
        const regex = new RegExp(
            options.wholeWord ? `\\b${query}\\b` : query,
            options.caseSensitive ? 'g' : 'gi'
        );
        
        const files = Object.keys(IDE.state.files).filter(f => 
            f.startsWith(folderPath) && 
            (!options.fileTypes || options.fileTypes.includes(Utils.getExtension(f)))
        );
        
        for (const path of files) {
            const content = this.read(path);
            const lines = content.split('\n');
            
            lines.forEach((line, index) => {
                const matches = line.match(regex);
                if (matches) {
                    results.push({
                        path: path,
                        line: index + 1,
                        content: line.trim(),
                        matches: matches.length
                    });
                }
            });
        }
        
        return results;
    },
    
    // Enhanced search in files
    findInFiles: function(query, options = {}) {
        const results = [];
        const regex = new RegExp(
            options.regex ? query : (options.wholeWord ? `\\b${query}\\b` : query),
            options.caseSensitive ? 'g' : 'gi'
        );
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            // Skip if file type filter is set and doesn't match
            if (options.fileTypes && !options.fileTypes.includes(Utils.getExtension(path))) {
                continue;
            }
            
            // Skip if path filter is set and doesn't match
            if (options.pathFilter && !path.includes(options.pathFilter)) {
                continue;
            }
            
            const lines = content.split('\n');
            
            lines.forEach((line, index) => {
                const matches = line.match(regex);
                if (matches) {
                    results.push({
                        path: path,
                        line: index + 1,
                        content: line.trim(),
                        matches: matches.length,
                        context: lines.slice(Math.max(0, index - 2), Math.min(lines.length, index + 3))
                    });
                }
            });
        }
        
        // Sort results
        if (options.sortBy === 'path') {
            results.sort((a, b) => a.path.localeCompare(b.path));
        } else if (options.sortBy === 'line') {
            results.sort((a, b) => a.line - b.line);
        }
        
        return results;
    },
    
    // Replace in files
    replaceInFiles: function(find, replace, options = {}) {
        let replacedCount = 0;
        let fileCount = 0;
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            // Apply filters
            if (options.fileTypes && !options.fileTypes.includes(Utils.getExtension(path))) {
                continue;
            }
            
            if (options.pathFilter && !path.includes(options.pathFilter)) {
                continue;
            }
            
            const regex = new RegExp(
                options.regex ? find : (options.wholeWord ? `\\b${find}\\b` : find),
                options.caseSensitive ? 'g' : 'gi'
            );
            
            if (regex.test(content)) {
                const newContent = content.replace(regex, replace);
                this.write(path, newContent);
                
                const matches = (content.match(regex) || []).length;
                replacedCount += matches;
                fileCount++;
            }
        }
        
        return { replacedCount, fileCount };
    },
    
    // File history for undo/redo
    fileHistory: {
        past: [],
        future: [],
        maxSize: 100
    },
    
    // Add to history
    addToHistory: function(action, path, oldValue, newValue) {
        const historyItem = {
            action,
            path,
            oldValue,
            newValue,
            timestamp: new Date().toISOString()
        };
        
        this.fileHistory.past.push(historyItem);
        
        // Trim history if too large
        if (this.fileHistory.past.length > this.fileHistory.maxSize) {
            this.fileHistory.past.shift();
        }
        
        // Clear future when new action is performed
        this.fileHistory.future = [];
    },
    
    // Undo last action
    undo: function() {
        if (this.fileHistory.past.length === 0) {
            Utils.toast('Nothing to undo', 'info');
            return false;
        }
        
        const historyItem = this.fileHistory.past.pop();
        this.fileHistory.future.push(historyItem);
        
        switch (historyItem.action) {
            case 'write':
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
            case 'delete':
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
            case 'rename':
                // Swap old and new paths
                delete IDE.state.files[historyItem.newValue];
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
        }
        
        this.refreshTree();
        this.save();
        
        Utils.toast('Undo: ' + historyItem.action, 'success');
        return true;
    },
    
    // Redo last undone action
    redo: function() {
        if (this.fileHistory.future.length === 0) {
            Utils.toast('Nothing to redo', 'info');
            return false;
        }
        
        const historyItem = this.fileHistory.future.pop();
        this.fileHistory.past.push(historyItem);
        
        switch (historyItem.action) {
            case 'write':
                IDE.state.files[historyItem.path] = historyItem.newValue;
                break;
            case 'delete':
                delete IDE.state.files[historyItem.path];
                break;
            case 'rename':
                delete IDE.state.files[historyItem.path];
                IDE.state.files[historyItem.newValue] = historyItem.oldValue;
                break;
        }
        
        this.refreshTree();
        this.save();
        
        Utils.toast('Redo: ' + historyItem.action, 'success');
        return true;
    },
    
    // Recycle bin functionality
    recycleBin: [],
    
    // Add to recycle bin
    addToRecycleBin: function(path, content) {
        this.recycleBin.push({
            path,
            content,
            deletedAt: new Date().toISOString(),
            originalPath: path
        });
        
        // Keep only last 100 items
        if (this.recycleBin.length > 100) {
            this.recycleBin.shift();
        }
        
        localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
    },
    
    // Show recycle bin
    showRecycleBin: function() {
        const modal = `
            <div class="modal-overlay" id="recycle-bin-modal">
                <div class="modal" style="width:700px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-trash-restore"></i> Recycle Bin</h3>
                        <button class="btn icon small" onclick="__pc_removeEl('recycle-bin-modal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${this.recycleBin.length === 0 ? 
                            '<p style="text-align:center; color:var(--text-dim); padding:40px;">Recycle bin is empty</p>' :
                            `<div style="max-height:400px; overflow-y:auto;">
                                ${this.recycleBin.map((item, index) => `
                                    <div class="flex ac jb" style="padding:12px; border-bottom:1px solid var(--border);">
                                        <div>
                                            <div style="font-weight:500;">${item.path}</div>
                                            <div style="font-size:11px; color:var(--text-dim);">
                                                Deleted ${Utils.formatDate(item.deletedAt)}
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="btn small" onclick="FileSystem.restoreFromRecycleBin(${index})">
                                                <i class="fas fa-undo"></i> Restore
                                            </button>
                                            <button class="btn small danger" onclick="FileSystem.emptyRecycleBinItem(${index})">
                                                <i class="fas fa-times"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="__pc_removeEl('recycle-bin-modal')">Close</button>
                        ${this.recycleBin.length > 0 ? `
                            <button class="btn danger" onclick="FileSystem.emptyRecycleBin()">
                                <i class="fas fa-trash"></i> Empty Recycle Bin
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    },
    
    // Restore from recycle bin
    restoreFromRecycleBin: function(index) {
        const item = this.recycleBin[index];
        if (!item) return;
        
        // Check if file already exists
        if (this.exists(item.path)) {
            const newName = prompt('File already exists. Enter new name:', item.path);
            if (!newName) return;
            item.path = newName;
        }
        
        this.write(item.path, item.content);
        this.recycleBin.splice(index, 1);
        localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
        
        // Refresh modal
        __pc_removeEl('recycle-bin-modal');
        this.showRecycleBin();
        
        Utils.toast(`Restored: ${item.path}`, 'success');
    },
    
    // Empty recycle bin item
    emptyRecycleBinItem: function(index) {
        if (confirm('Permanently delete this file?')) {
            this.recycleBin.splice(index, 1);
            localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
            
            __pc_removeEl('recycle-bin-modal');
            this.showRecycleBin();
            
            Utils.toast('Permanently deleted', 'warning');
        }
    },
    
    // Empty entire recycle bin
    emptyRecycleBin: function() {
        if (confirm('Permanently delete all files in recycle bin?')) {
            this.recycleBin = [];
            localStorage.removeItem('procode_recycle_bin');
            
            __pc_removeEl('recycle-bin-modal');
            this.showRecycleBin();
            
            Utils.toast('Recycle bin emptied', 'warning');
        }
    },
    
    // Enhanced outline extraction with caching
    updateOutline: function() {
        const outline = document.getElementById('outline-tree');
        if (!outline || !IDE.state.activeTab) {
            outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">No outline available</div>';
            return;
        }
        
        const path = IDE.state.activeTab;
        const content = this.read(path);
        const ext = Utils.getExtension(path);
        
        // Use cached outline if available and content hasn't changed
        const cacheKey = `outline_${path}_${Utils.hashString(content)}`;
        const cachedOutline = localStorage.getItem(cacheKey);
        
        if (cachedOutline) {
            outline.innerHTML = cachedOutline;
            return;
        }
        
        outline.innerHTML = '';
        
        // Extract outline based on file type
        let outlineItems = [];
        
        switch (ext) {
            case 'js':
            case 'jsx':
            case 'ts':
            case 'tsx':
                outlineItems = this.extractJsOutline(content);
                break;
            case 'html':
                outlineItems = this.extractHtmlOutline(content);
                break;
            case 'css':
            case 'scss':
            case 'sass':
            case 'less':
                outlineItems = this.extractCssOutline(content);
                break;
            case 'py':
                outlineItems = this.extractPythonOutline(content);
                break;
            case 'vue':
                outlineItems = this.extractVueOutline(content);
                break;
            default:
                outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">Outline not supported for this file type</div>';
                return;
        }
        
        if (outlineItems.length === 0) {
            outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">No symbols found</div>';
            return;
        }
        
        // Render outline items
        outlineItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 't-item';
            div.style.padding = '4px 8px';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; padding:4px 8px;">
                    <i class="${item.icon}" style="color:${item.color || 'var(--primary)'}; font-size:11px;"></i>
                    <span style="font-size:11px; flex:1;">${item.name}</span>
                    <span style="font-size:10px; color:var(--text-dim);">${item.line}</span>
                </div>
            `;
            
            div.onclick = () => {
                const editor = EditorManager.getCurrentEditor();
                if (editor) {
                    editor.revealLineInCenter(item.line);
                    editor.setPosition({ lineNumber: item.line, column: 1 });
                    editor.focus();
                }
            };
            
            outline.appendChild(div);
        });
        
        // Cache the outline
        localStorage.setItem(cacheKey, outline.innerHTML);
    },
    
    // Extract Vue component outline
    extractVueOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        // Extract template tags
        let inTemplate = false;
        lines.forEach((line, index) => {
            if (line.includes('<template>')) inTemplate = true;
            if (line.includes('</template>')) inTemplate = false;
            
            if (inTemplate) {
                const tagMatch = line.match(/<(\w+)[^>]*>/);
                if (tagMatch) {
                    items.push({
                        type: 'tag',
                        name: tagMatch[1],
                        line: index + 1,
                        icon: 'fab fa-vuejs',
                        color: '#42b883'
                    });
                }
            }
        });
        
        // Extract script components
        lines.forEach((line, index) => {
            // Look for component definitions
            const componentMatch = line.match(/export\s+default\s+{\s*name:\s*['"]([^'"]+)['"]/);
            if (componentMatch) {
                items.push({
                    type: 'component',
                    name: componentMatch[1],
                    line: index + 1,
                    icon: 'fas fa-cube',
                    color: '#35495e'
                });
            }
            
            // Look for methods
            const methodMatch = line.match(/(\w+)\s*\([^)]*\)\s*{/);
            if (methodMatch && line.includes('methods:')) {
                items.push({
                    type: 'method',
                    name: methodMatch[1],
                    line: index + 1,
                    icon: 'fas fa-function',
                    color: '#61dafb'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced JavaScript/TypeScript outline
    extractJsOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Function declarations
            const funcMatch = trimmed.match(/^(export\s+)?(async\s+)?(function\s+(\w+)|(const|let|var)\s+(\w+)\s*=\s*(async\s+)?\([^)]*\)\s*=>|class\s+(\w+))/);
            if (funcMatch) {
                const name = funcMatch[4] || funcMatch[6] || funcMatch[8];
                const isClass = !!funcMatch[7];
                const isAsync = trimmed.includes('async');
                
                items.push({
                    type: isClass ? 'class' : 'function',
                    name: name,
                    line: index + 1,
                    icon: isClass ? 'fas fa-cube' : (isAsync ? 'fas fa-bolt' : 'fas fa-function'),
                    color: isClass ? '#f59e0b' : (isAsync ? '#8b5cf6' : '#61dafb')
                });
            }
            
            // React components
            const reactMatch = trimmed.match(/export\s+default\s+(function\s+(\w+)|(const|let|var)\s+(\w+)\s*=|class\s+(\w+))/);
            if (reactMatch) {
                const name = reactMatch[2] || reactMatch[4] || reactMatch[5];
                items.push({
                    type: 'component',
                    name: name,
                    line: index + 1,
                    icon: 'fab fa-react',
                    color: '#61dafb'
                });
            }
            
            // Imports
            const importMatch = trimmed.match(/^import\s+(.*?)\s+from/);
            if (importMatch) {
                items.push({
                    type: 'import',
                    name: importMatch[1],
                    line: index + 1,
                    icon: 'fas fa-download',
                    color: '#10b981'
                });
            }
            
            // Exports
            const exportMatch = trimmed.match(/^export\s+(const|let|var|function|class|default)\s+(\w+)/);
            if (exportMatch) {
                items.push({
                    type: 'export',
                    name: exportMatch[2],
                    line: index + 1,
                    icon: 'fas fa-upload',
                    color: '#f59e0b'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced HTML outline
    extractHtmlOutline: function(content) {
        const items = [];
        const tagRegex = /<(\w+)[^>]*>/g;
        let match;
        
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            while ((match = tagRegex.exec(line)) !== null) {
                const tag = match[1];
                const idMatch = match[0].match(/id="([^"]*)"/);
                const classMatch = match[0].match(/class="([^"]*)"/);
                
                let name = tag;
                if (idMatch) name = `#${idMatch[1]}`;
                else if (classMatch) name = `.${classMatch[1].split(' ')[0]}`;
                
                items.push({
                    type: 'element',
                    name: name,
                    line: index + 1,
                    icon: 'fab fa-html5',
                    color: '#e34c26'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced CSS outline
    extractCssOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Selectors
            if (trimmed.endsWith('{') && !trimmed.startsWith('@')) {
                const selector = trimmed.slice(0, -1).trim();
                items.push({
                    type: 'selector',
                    name: selector,
                    line: index + 1,
                    icon: 'fab fa-css3',
                    color: '#264de4'
                });
            }
            
            // At-rules
            const atRuleMatch = trimmed.match(/^@(\w+)/);
            if (atRuleMatch) {
                items.push({
                    type: 'at-rule',
                    name: trimmed,
                    line: index + 1,
                    icon: 'fas fa-at',
                    color: '#8b5cf6'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced Python outline
    extractPythonOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Function definitions
            const funcMatch = trimmed.match(/^def\s+(\w+)\s*\(/);
            if (funcMatch) {
                items.push({
                    type: 'function',
                    name: funcMatch[1],
                    line: index + 1,
                    icon: 'fas fa-function',
                    color: '#3776ab'
                });
            }
            
            // Class definitions
            const classMatch = trimmed.match(/^class\s+(\w+)/);
            if (classMatch) {
                items.push({
                    type: 'class',
                    name: classMatch[1],
                    line: index + 1,
                    icon: 'fas fa-cube',
                    color: '#f59e0b'
                });
            }
            
            // Imports
            const importMatch = trimmed.match(/^import\s+(\w+)|^from\s+(\w+)\s+import/);
            if (importMatch) {
                items.push({
                    type: 'import',
                    name: importMatch[1] || importMatch[2],
                    line: index + 1,
                    icon: 'fas fa-download',
                    color: '#10b981'
                });
            }
        });
        
        return items;
    },
    
    // Update tab dirty state
    updateTabDirtyState: function() {
        document.querySelectorAll('.tab[data-path]').forEach(tab => {
            const path = tab.dataset.path;
            if (IDE.state.dirtyTabs.has(path)) {
                tab.classList.add('dirty');
            } else {
                tab.classList.remove('dirty');
            }
        });
    },
    
    // Enhanced create file prompt
    createFilePrompt: function(basePath = '') {
        const defaultPath = basePath || (IDE.state.activeTab ? 
            IDE.state.activeTab.split('/').slice(0, -1).join('/') + '/' : '');
        
        const fileName = prompt('Enter file name (with extension):', defaultPath + 'new-file.js');
        if (!fileName) return;
        
        if (!Utils.isValidFileName(fileName.split('/').pop())) {
            Utils.toast('Invalid file name', 'error');
            return;
        }
        
        const ext = Utils.getExtension(fileName);
        let content = '';
        
        // Enhanced default content based on file type
        const templates = {
            'js': `// ${fileName}
console.log(' Hello from ProCode IDE v19.0!');

// Your JavaScript code here
function greet(name) {
  return \`Hello, \${name}!\`;
}

// Example usage
console.log(greet('World'));

// Export if needed
export { greet };`,
            
            'ts': `// ${fileName}
console.log(' Hello from ProCode IDE v19.0!');

// TypeScript interface
interface User {
  id: number;
  name: string;
  email: string;
}

// Your TypeScript code here
function greet(user: User): string {
  return \`Hello, \${user.name}!\`;
}

// Example usage
const user: User = { id: 1, name: 'World', email: 'world@example.com' };
console.log(greet(user));

// Export if needed
export { greet, User };`,
            
            'jsx': `import React from 'react';

export default function ${fileName.replace('.jsx', '').split('/').pop()}() {
  return (
    <div>
      <h1>${fileName.replace('.jsx', '').split('/').pop()}</h1>
      <p>Your React component here</p>
    </div>
  );
}`,
            
            'tsx': `import React from 'react';

interface Props {
  // Define your props here
}

export default function ${fileName.replace('.tsx', '').split('/').pop()}({}: Props) {
  return (
    <div>
      <h1>${fileName.replace('.tsx', '').split('/').pop()}</h1>
      <p>Your React component with TypeScript here</p>
    </div>
  );
}`,
            
            'html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName.replace('.html', '')}</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer><\/script>
</head>
<body>
    <h1>Welcome to ${fileName.replace('.html', '')}</h1>
    <p>Start building your amazing web application!</p>
</body>
</html>`,
            
            'css': `/* ${fileName} */
:root {
  --primary: #6366f1;
  --secondary: #8b5cf6;
  --background: #f8fafc;
  --text: #1e293b;
  --radius: 12px;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--background);
  color: var(--text);
  line-height: 1.6;
}

/* Your styles here */`,
            
            'py': `#!/usr/bin/env python3
"""
${fileName}
ProCode IDE - Python File
"""

import sys
import os

def main() -> int:
    """
    Main function
    """
    print(" Hello from Python!")
    print(f"File: {os.path.basename(__file__)}")
    return 0

if __name__ == "__main__":
    sys.exit(main())`,
            
            'vue': `<template>
  <div>
    <h1>${fileName.replace('.vue', '')}</h1>
    <p>Your Vue component here</p>
  </div>
</template>

<script setup>
// Your Vue 3 composition API code here
const message = 'Hello from Vue 3!'
<\/script>

<style scoped>
/* Your component styles here */

</style>`
        };
        
        content = templates[ext] || `// ${fileName}
// Created with ProCode IDE v19.0
// Start writing your code here...`;
        
        this.write(fileName, content);
        this.refreshTree();
        TabManager.open(fileName);
        
        Utils.toast(`Created: ${fileName}`, 'success');
    },
    
    // Enhanced create folder prompt
    createFolderPrompt: function(basePath = '') {
        const folderName = prompt('Enter folder name:', basePath);
        if (!folderName) return;
        
        if (!Utils.isValidFileName(folderName)) {
            Utils.toast('Invalid folder name', 'error');
            return;
        }
        
        this.createFolder(folderName);
    },
    
    // Emit file change event
    emitFileChange: function(path, type) {
        const event = new CustomEvent('filechange', {
            detail: { path, type, timestamp: new Date().toISOString() }
        });
        window.dispatchEvent(event);
    },
    
    // Initialize file system event listeners
    initEventListeners: function() {
        window.addEventListener('filechange', (e) => {
            // Update UI or trigger actions based on file changes
            console.log('File changed:', e.detail);
        });
    }
};

// Initialize event listeners
FileSystem.initEventListeners();// ============================================
// ULTRA+ Import helpers (drag & drop / programmatic)
// ============================================
FileSystem.importFromFiles = async function(files, targetFolder = '') {
    const list = Array.from(files || []);
    if (!list.length) return { imported: 0, skipped: 0 };

    // Check conflicts once
    const conflicts = list
        .filter(f => f && f.name && this.exists((targetFolder ? (targetFolder + '/') : '') + (f.webkitRelativePath || f.name)));
    const overwriteAll = conflicts.length ? confirm(`Overwrite ${conflicts.length} existing file(s)?`) : false;

    let imported = 0, skipped = 0;

    for (const file of list) {
        if (!file) continue;
        const rel = file.webkitRelativePath || file.name;
        const filePath = targetFolder ? `${targetFolder}/${rel}` : rel;

        if (this.exists(filePath) && !overwriteAll) { skipped++; continue; }

        if (file.name && file.name.toLowerCase().endsWith('.zip')) {
            try {
                const zip = await JSZip.loadAsync(file);
                for (const [p, entry] of Object.entries(zip.files)) {
                    if (!entry.dir) {
                        // size cap guard (rough)
                        const content = await entry.async('string');
                        const fullPath = targetFolder ? `${targetFolder}/${p}` : p;
                        IDE.state.files[fullPath] = content;
                        imported++;
                    }
                }
            } catch (e) {
                Utils.toast(`ZIP import failed: ${file.name}`, 'error');
            }
            continue;
        }

        try {
            const content = await Utils.readFileSmart(file);
            IDE.state.files[filePath] = content;
            imported++;
            try { localStorage.setItem(`file_created_${filePath}`, new Date().toISOString()); } catch {}
        } catch (e) {
            skipped++;
        }
    }

    if (imported > 0) {
        this.save(true);
        this.refreshTree();
        Utils.toast(`Imported ${imported} file(s)${skipped ? `, skipped ${skipped}` : ''}`, 'success');
    } else {
        Utils.toast('No files imported', 'info');
    }

    return { imported, skipped };
};

// Drag & drop import that supports folders in Chromium (best-effort)
FileSystem.importFromDataTransfer = async function(dt, targetFolder = '') {
    if (!dt) return { imported: 0, skipped: 0 };

    // If modern FileSystemHandle API exists via items
    const items = Array.from(dt.items || []);
    const supportsHandles = items.some(i => i && typeof i.getAsFileSystemHandle === 'function');

    const collected = [];

    const readEntry = (entry, basePath) => new Promise((resolve) => {
        try {
            if (!entry) return resolve();
            if (entry.isFile) {
                entry.file((file) => {
                    file.__dropPath = basePath + file.name;
                    collected.push(file);
                    resolve();
                }, () => resolve());
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const readBatch = () => {
                    reader.readEntries(async (entries) => {
                        if (!entries || !entries.length) return resolve();
                        for (const e of entries) {
                            await readEntry(e, basePath + entry.name + '/');
                        }
                        readBatch();
                    }, () => resolve());
                };
                readBatch();
            } else {
                resolve();
            }
        } catch {
            resolve();
        }
    });

    if (supportsHandles) {
        // Currently, traversing handles recursively needs manual implementation; fallback to files list
        const files = Array.from(dt.files || []);
        return this.importFromFiles(files, targetFolder);
    }

    // Chromium legacy: webkitGetAsEntry for folder drops
    for (const it of items) {
        if (!it) continue;
        const entry = it.webkitGetAsEntry && it.webkitGetAsEntry();
        if (entry) await readEntry(entry, '');
    }

    if (collected.length) {
        // Map to paths if available
        const normalized = collected.map(f => {
            if (f.__dropPath) f.webkitRelativePath = f.__dropPath;
            return f;
        });
        return this.importFromFiles(normalized, targetFolder);
    }

    // Fallback
    return this.importFromFiles(Array.from(dt.files || []), targetFolder);
};

// ============================================
// ENHANCED EDITOR MANAGER
// ============================================
const EditorManager = {
    instances: {},
    currentEditorId: 'monaco-root-1',
    diagnostics: new Map(),
    codeLenses: new Map(),

    init: async function() {
        console.log(' Initializing editor engine...');
        
        //  FIX: Better Monaco loading vi timeout v retry
        const loadMonaco = async (retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Monaco load timeout'));
                        }, 15000);
                        
                        const check = () => {
                            if (window.monaco && monaco.editor) {
                                clearTimeout(timeout);
                                resolve();
                            } else if (window.__MONACO_READY__ === false) {
                                clearTimeout(timeout);
                                reject(new Error('Monaco failed to load'));
                            } else {
                                requestAnimationFrame(check);
                            }
                        };
                        check();
                    });
                    return; // Success
                } catch (error) {
                    console.warn(`Monaco load attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait before retry
                }
            }
        };
        
        await loadMonaco();
        
        try {
            this.defineEnhancedThemes();
        } catch (e) {
            console.warn('Theme definition failed:', e);
        }
        
        //  FIX: Ensure container exists
        const container = document.getElementById(this.currentEditorId);
        if (!container) {
            throw new Error(`Editor container ${this.currentEditorId} not found`);
        }
        
        this.createEditor(this.currentEditorId);
        
        try {
            /* Commands are added per-editor during createEditor() */
            this.setupEnhancedEventListeners();
            if (this.setupCodeLens) this.setupCodeLens();
        } catch (e) {
            console.warn('Enhanced features setup failed:', e);
        }
        
        try {
            if (this.initWebWorker) this.initWebWorker();
        } catch (e) {
            console.warn('Worker init failed:', e);
        }
        
        //  FIX: Load initial file vi error handling
        try {
            const initial = IDE.state.activeTab || 
                           (IDE.state.tabs && IDE.state.tabs[0]) || 
                           Object.keys(IDE.state.files || {})[0];
            if (initial && FileSystem.exists(initial)) {
                this.setFile(initial, this.currentEditorId);
            }
        } catch (e) {
            console.warn('Failed to set initial file:', e);
        }
        
        console.log(' Editor engine ready');
    },


// ============================================
// WEB WORKER FOR HEAVY PROCESSING
// ============================================
// Initialize Web Worker for background tasks
    initWebWorker: function() {
    // If the worker repeatedly crashes, disable to keep the app responsive
    if (this.workerDisabled) {
        console.warn(' Web Worker is disabled due to repeated crashes.');
        return;
    }
    this._workerRestartCount = this._workerRestartCount || 0;
    this._workerRestartTimer = this._workerRestartTimer || null;

    if (this.worker) {
        console.log(' Worker already initialized');
        return;
    }
    
    console.log(' Initializing Web Worker...');
    
    const workerCode = String.raw`
        // Web Worker with enhanced error handling
        console.log(' Worker thread started');
        
        let taskTimeout = null;
        
        self.addEventListener('message', function(e) {
            const { type, id, data } = e.data;
            
            // Clear any existing timeout
            if (taskTimeout) {
                clearTimeout(taskTimeout);
            }
            
            // Set timeout for task (30 seconds)
            taskTimeout = setTimeout(() => {
                postError(id, 'Task timeout after 30 seconds');
            }, 30000);
            
            try {
                switch(type) {
                    case 'search':
                        searchInFiles(id, data);
                        break;
                    case 'parse':
                        parseCode(id, data);
                        break;
                    case 'format':
                        formatCode(id, data);
                        break;
                    case 'analyze':
                        analyzeCode(id, data);
                        break;
                    default:
                        postError(id, 'Unknown task type: ' + type);
                }
            } catch (error) {
                postError(id, error.message + '\\n' + error.stack);
            } finally {
                if (taskTimeout) {
                    clearTimeout(taskTimeout);
                    taskTimeout = null;
                }
            }
        });
        
        function postResult(id, type, result) {
            self.postMessage({ id, type, status: 'success', result });
        }
        
        function postError(id, message) {
            self.postMessage({ id, status: 'error', error: message });
        }
        
        function postProgress(id, progress) {
            self.postMessage({ id, status: 'progress', progress });
        }
        
        // === Worker task implementations (v16 ultra) ===
function _splitLines(text) {
      const s = String(text || '');
      // Safer than regex literals containing \r/\n in generated worker code.
      const normalized = s.indexOf('\r') !== -1 ? s.split('\r').join('') : s;
      return normalized.split('\n');
    }

function _escapeRegExp(s) {
  // Important: avoid the interpolation sequence in template literals by ordering chars as ^{}$
  return String(s).replace(/[.*+?^{}$()|[\]\\]/g, '\\$&');
}

function _buildSearchRegex(query, opts) {
  const flags = opts.caseSensitive ? 'g' : 'gi';
  if (opts.regex) return new RegExp(query, flags);
  const q = _escapeRegExp(query);
  const pattern = opts.wholeWord ? ('\\b' + q + '\\b') : q;
  return new RegExp(pattern, flags);
}

function _safeIssue(line, col, message, severity = 'warning', rule = 'generic') {
  return { line, column: col, message: String(message), severity, rule };
}

function searchInFiles(taskId, data) {
  const start = Date.now();
  const query = (data && data.query != null) ? String(data.query) : '';
  const files = (data && data.files) ? data.files : {};
  const options = Object.assign({ caseSensitive:false, wholeWord:false, regex:false, maxResults: 2000 }, (data && data.options) || {});
  if (!query) return { duration: 0, totalFiles: Object.keys(files).length, matchCount: 0, results: [] };

  let re;
  try { re = _buildSearchRegex(query, options); }
  catch (e) { throw new Error('Invalid regex: ' + (e && e.message ? e.message : String(e))); }

  const paths = Object.keys(files || {});
  const totalFiles = paths.length;
  const results = [];
  let matchCount = 0;
  const maxResults = Math.max(1, options.maxResults | 0);

  for (let i = 0; i < paths.length; i++) {
    const path = paths[i];
    const file = files[path] || {};
    const content = file.content != null ? String(file.content) : '';
    const lines = _splitLines(content);

    for (let ln = 0; ln < lines.length; ln++) {
      const lineText = lines[ln];
      re.lastIndex = 0;
      if (!re.test(lineText)) continue;

      re.lastIndex = 0;
      let m;
      while ((m = re.exec(lineText)) !== null) {
        matchCount++;
        results.push({ path, line: ln + 1, column: (m.index || 0) + 1, content: lineText });

        if (m[0] === '') re.lastIndex = (re.lastIndex || 0) + 1;
        if (results.length >= maxResults) break;
      }
      if (results.length >= maxResults) break;
    }

    if (i % 10 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, totalFiles)) * 100));
    if (results.length >= maxResults) break;
  }

  return { duration: Date.now() - start, totalFiles, matchCount, results };
}

function parseCode(taskId, data) {
  const start = Date.now();
  const code = (data && data.code != null) ? String(data.code) : '';
  const language = (data && data.language) ? String(data.language) : 'plaintext';
  const symbols = [];
  const lines = _splitLines(code);

  function pushSymbol(kind, name, line) {
    if (!name) return;
    symbols.push({ kind, name: String(name), line });
  }

  if (language === 'javascript' || language === 'typescript' || language === 'json') {
    const reFn = /^\s*function\s+([A-Za-z_$][\w$]*)\s*\(/;
    const reClass = /^\s*class\s+([A-Za-z_$][\w$]*)\b/;
    const reVar = /^\s*(?:const|let|var)\s+([A-Za-z_$][\w$]*)\s*=/;
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i];
      let m;
      if ((m = reFn.exec(l))) pushSymbol('function', m[1], i + 1);
      else if ((m = reClass.exec(l))) pushSymbol('class', m[1], i + 1);
      else if ((m = reVar.exec(l))) pushSymbol('variable', m[1], i + 1);
      if (i % 200 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, lines.length)) * 100));
    }
  } else if (language === 'python') {
    const reDef = /^\s*def\s+([A-Za-z_][\w]*)\s*\(/;
    const reClass = /^\s*class\s+([A-Za-z_][\w]*)\b/;
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i];
      let m;
      if ((m = reDef.exec(l))) pushSymbol('function', m[1], i + 1);
      else if ((m = reClass.exec(l))) pushSymbol('class', m[1], i + 1);
      if (i % 200 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, lines.length)) * 100));
    }
  } else if (language === 'html') {
    const reId = /id\s*=\s*["']([^"']+)["']/i;
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i];
      const m = reId.exec(l);
      if (m) pushSymbol('id', m[1], i + 1);
      if (i % 200 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, lines.length)) * 100));
    }
  } else {
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i];
      const m = /^\s*#\s+(.+)$/.exec(l);
      if (m) pushSymbol('heading', m[1], i + 1);
      if (i % 200 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, lines.length)) * 100));
    }
  }

  return { duration: Date.now() - start, symbols };
}

function formatCode(taskId, data) {
  const code = (data && data.code != null) ? String(data.code) : '';
  return { code, formatted: false, engine: 'worker-noop' };
}

function analyzeCode(taskId, data) {
  const start = Date.now();
  const code = (data && data.code != null) ? String(data.code) : '';
  const language = (data && data.language) ? String(data.language) : 'plaintext';
  const lines = _splitLines(code);
  const issues = [];

  for (let i = 0; i < lines.length; i++) {
    const l = lines[i];
    if (l.length > 140) issues.push(_safeIssue(i + 1, 141, 'Line is very long (' + l.length + ' chars).', 'info', 'line-length'));
    if (/\s+$/.test(l)) issues.push(_safeIssue(i + 1, l.length, 'Trailing whitespace.', 'info', 'trailing-ws'));
    if (/\bTODO\b|\bFIXME\b|\bHACK\b/.test(l)) issues.push(_safeIssue(i + 1, 1, 'Reminder tag found (TODO/FIXME/HACK).', 'info', 'todo'));
    if (i % 400 === 0) postProgress(taskId, Math.round(((i + 1) / Math.max(1, lines.length)) * 100));
  }

  if (language === 'javascript' || language === 'typescript') {
    try { new Function('"use strict";\n' + code + '\n//# sourceURL=procode-analyze.js'); }
    catch (e) { issues.push(_safeIssue(1, 1, 'Possible syntax error: ' + (e && e.message ? e.message : String(e)), 'error', 'syntax')); }
  } else if (language === 'json') {
    try { JSON.parse(code || 'null'); }
    catch (e) { issues.push(_safeIssue(1, 1, 'Invalid JSON: ' + (e && e.message ? e.message : String(e)), 'error', 'json')); }
  } else if (language === 'html') {
    const tagRe = /<\/?([a-zA-Z][a-zA-Z0-9-]*)\b[^>]*>/g;
    const stack = [];
    let m;
    while ((m = tagRe.exec(code)) !== null) {
      const full = m[0];
      const name = m[1].toLowerCase();
      if (full.startsWith('</')) {
        const top = stack[stack.length - 1];
        if (top === name) stack.pop();
      } else if (!full.endsWith('/>') && !['br','hr','img','input','meta','link','source','area','base','col','embed','param','track','wbr'].includes(name)) {
        stack.push(name);
      }
      if (stack.length > 2000) break;
    }
    if (stack.length) issues.push(_safeIssue(1, 1, 'HTML may have unclosed tags (example: ' + stack[stack.length - 1] + ').', 'info', 'html-tags'));
  }

  const metrics = { lines: lines.length, chars: code.length, issues: issues.length };
  return { duration: Date.now() - start, metrics, issues };
}
// === End worker task implementations ===
        
        // Error handler
        self.addEventListener('error', function(e) {
            console.error('Worker error:', e);
            postError(-1, 'Worker error: ' + e.message);
        });
        
        self.addEventListener('unhandledrejection', function(e) {
            console.error('Worker unhandled rejection:', e);
            postError(-1, 'Unhandled rejection: ' + e.reason);
        });
        
        console.log(' Worker ready');
    `;
    
    try {
        // Preflight syntax check to prevent infinite restart loops on parse errors.
        try { new Function(workerCode); } catch (syntaxErr) {
            console.error(' Worker code syntax check failed:', syntaxErr);
            throw syntaxErr;
        }
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);
        this.worker = new Worker(workerUrl);
        URL.revokeObjectURL(workerUrl);
        
        this.workerTasks = new Map();
        this.workerTaskId = 0;
        
        // Enhanced message handler
        this.worker.addEventListener('message', (e) => {
            const { id, type, status, result, error, progress } = e.data;
            
            const task = this.workerTasks.get(id);
            if (!task) {
                console.warn('Received message for unknown task:', id);
                return;
            }
            
            if (status === 'success') {
                task.resolve(result);
                this.workerTasks.delete(id);
            } else if (status === 'error') {
                task.reject(new Error(error));
                this.workerTasks.delete(id);
            } else if (status === 'progress' && task.onProgress) {
                task.onProgress(progress);
            }
        });
        
        // Enhanced error handler
        this.worker.addEventListener('error', (e) => {
            console.error(' Worker error:', e);

            // Reject all pending tasks so the UI can recover cleanly
            this.workerTasks.forEach((task) => {
                try { task.reject(new Error('Worker crashed: ' + (e && e.message ? e.message : 'unknown error'))); } catch (_) {}
            });
            this.workerTasks.clear();

            try { this.worker && this.worker.terminate(); } catch (_) {}
            this.worker = null;

            // Controlled restart with exponential backoff (prevents restart storms)
            if (this.workerDisabled) return;

            this._workerRestartCount = (this._workerRestartCount || 0) + 1;
            const maxRestarts = 5;
            if (this._workerRestartCount > maxRestarts) {
                this.workerDisabled = true;
                console.error(' Worker disabled after repeated crashes. Some background features may be unavailable.');
                return;
            }

            const delay = Math.min(30000, 1000 * (2 ** (this._workerRestartCount - 1))); // 1s,2s,4s,8s,16s,30s
            console.log(` Attempting to restart worker... (try ${this._workerRestartCount}/${maxRestarts} in ${delay}ms)`);

            if (this._workerRestartTimer) clearTimeout(this._workerRestartTimer);
            this._workerRestartTimer = setTimeout(() => {
                this._workerRestartTimer = null;
                this.initWebWorker();
            }, delay);
        });
        
        console.log(' Web Worker initialized');
        this._workerRestartCount = 0;
        
    } catch (error) {
        console.error(' Failed to create worker:', error);
        this.worker = null;
    }
},

// Helper to run tasks in worker
runWorkerTask: function(type, data, onProgress = null) {
    if (this.workerDisabled) {
        return Promise.reject(new Error('Web Worker disabled after repeated crashes'));
    }
    if (!this.worker) {
        this.initWebWorker();
    }
    
    if (!this.worker) {
        return Promise.reject(new Error('Worker not available'));
    }
    
    const id = this.workerTaskId++;
    
    return new Promise((resolve, reject) => {
        this.workerTasks.set(id, { resolve, reject, onProgress });
        
        this.worker.postMessage({
            type: type,
            id: id,
            data: data
        });
        
        // Timeout after 30 seconds
        setTimeout(() => {
            if (this.workerTasks.has(id)) {
                this.workerTasks.delete(id);
                reject(new Error('Worker task timeout'));
            }
        }, 30000);
    });
},

// Public API for searching in files using worker
searchInFilesAsync: function(query, options = {}) {
    console.log(' Searching in worker thread...');
    
    return this.runWorkerTask('search', {
        query: query,
        files: IDE.state.files,
        options: options
    }, (progress) => {
        console.log(`Search progress: ${progress}%`);
    });
},

// Public API for parsing code using worker
parseCodeAsync: function(code, language, path) {
    return this.runWorkerTask('parse', {
        code: code,
        language: language,
        path: path
    });
},

// Public API for formatting code using worker
formatCodeAsync: function(code, language) {
    return this.runWorkerTask('format', {
        code: code,
        language: language
    });
},

// Public API for analyzing code using worker
analyzeCodeAsync: function(code, language) {
    return this.runWorkerTask('analyze', {
        code: code,
        language: language
    });
},

// Cleanup worker
terminateWorker: function() {
        if (this.worker) {
            this.worker.terminate();
            this.worker = null;
            this.workerTasks.clear();
            console.log(' Worker terminated');
        }
    },

save: async function(immediate = false) {
        if (!immediate && !IDE.state.settings.editor.autoSave) {
            return;
        }
        
        try {
            // Save to IndexedDB (uncompressed for fast access)
            const savePromises = [];
            for (const [path, content] of Object.entries(IDE.state.files)) {
                savePromises.push(IndexedDBManager.setFile(path, content));
            }
            
            await Promise.all(savePromises);
            
            // Save settings
            await IndexedDBManager.setSetting('ide_settings', IDE.state.settings);
            await IndexedDBManager.setSetting('last_save', new Date().toISOString());
            
            // Compression backup
            try {
                const filesJson = JSON.stringify(IDE.state.files);
                const compressed = LZString.compressToUTF16(filesJson);
                
                const originalSize = new Blob([filesJson]).size;
                const compressedSize = new Blob([compressed]).size;
                const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                localStorage.setItem(`procode_fs_compressed_v${IDE.version}`, compressed);
                localStorage.setItem(`procode_compression_stats`, JSON.stringify({
                    originalSize: originalSize,
                    compressedSize: compressedSize,
                    ratio: ratio,
                    timestamp: new Date().toISOString()
                }));
                
                console.log(` Compressed: ${Utils.formatBytes(originalSize)}  ${Utils.formatBytes(compressedSize)} (${ratio}% saved)`);
                
            } catch (compressionError) {
                console.warn(' Compression failed, using uncompressed backup:', compressionError);
                try {
                    localStorage.setItem(`procode_fs_backup_v${IDE.version}`, JSON.stringify(IDE.state.files));
                } catch (e) {
                    console.error(' Backup save failed:', e);
                }
            }
            
            this.updateFileSystemMetrics();
            
            if (immediate) {
                Utils.toast(' Project saved successfully', 'success');
            }
            
            this.updateSaveIndicator();
            return true;
            
        } catch (error) {
            console.error(' Save failed:', error);
            Utils.toast('Save failed: ' + error.message, 'error');
            return false;
        }
    },

    write: async function(path, content, options = {}) {
        const oldContent = IDE.state.files[path];
        const isNewFile = !this.exists(path);
        
        if (!options.skipHistory && oldContent !== content) {
            this.addToHistory('write', path, oldContent, content);
        }
        
        IDE.state.files[path] = content;
        
        if (!options.skipDB) {
            IndexedDBManager.setFile(path, content).catch(err => {
                console.error('Failed to save to IndexedDB:', err);
            });
        }
        
        if (IDE.state.tabs.includes(path)) {
            IDE.state.dirtyTabs.add(path);
            this.updateTabDirtyState();
        }
        
        if (IDE.state.activeTab === path) {
            this.updateOutline();
        }
        
        if (IDE.state.settings.editor.autoSave && !options.skipAutoSave) {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => this.save(), 1000);
        }
        
        this.updateFileSystemMetrics();
        this.emitFileChange(path, isNewFile ? 'created' : 'modified');
        
        return true;
    },

    read: async function(path, useCache = true) {
        if (!this.exists(path)) {
            throw new Error(`File not found: ${path}`);
        }
        
        if (IDE.state.files[path] !== undefined) {
            return IDE.state.files[path];
        }
        
        if (useCache && this.fileCache && this.fileCache[path]) {
            return this.fileCache[path];
        }
        
        try {
            const file = await IndexedDBManager.getFile(path);
            if (file && file.content !== undefined) {
                IDE.state.files[path] = file.content;
                
                if (!this.fileCache) this.fileCache = {};
                this.fileCache[path] = file.content;
                
                return file.content;
            }
        } catch (error) {
            console.error('Failed to read from IndexedDB:', error);
        }
        
        return IDE.state.files[path] || '';
    },

write: async function(path, content, options = {}) {
    const oldContent = IDE.state.files[path];
    const isNewFile = !this.exists(path);
    
    // Create backup for undo
    if (!options.skipHistory && oldContent !== content) {
        this.addToHistory('write', path, oldContent, content);
    }
    
    IDE.state.files[path] = content;
    
    // Save to IndexedDB (async, non-blocking)
    if (!options.skipDB) {
        IndexedDBManager.setFile(path, content).catch(err => {
            console.error('Failed to save to IndexedDB:', err);
        });
    }
    
    // Mark tab as dirty
    if (IDE.state.tabs.includes(path)) {
        IDE.state.dirtyTabs.add(path);
        this.updateTabDirtyState();
    }
    
    // Update outline if this is the active file
    if (IDE.state.activeTab === path) {
        this.updateOutline();
    }
    
    // Auto-save if enabled
    if (IDE.state.settings.editor.autoSave && !options.skipAutoSave) {
        clearTimeout(this.saveTimeout);
        this.saveTimeout = setTimeout(() => this.save(), 1000);
    }
    
    // Update metrics
    this.updateFileSystemMetrics();
    
    // Event for external listeners
    this.emitFileChange(path, isNewFile ? 'created' : 'modified');
    
    return true;
},

read: async function(path, useCache = true) {
    if (!this.exists(path)) {
        throw new Error(`File not found: ${path}`);
    }
    
    // Try memory first
    if (IDE.state.files[path] !== undefined) {
        return IDE.state.files[path];
    }
    
    // Try cache
    if (useCache && this.fileCache && this.fileCache[path]) {
        return this.fileCache[path];
    }
    
    // Load from IndexedDB
    try {
        const file = await IndexedDBManager.getFile(path);
        if (file && file.content !== undefined) {
            // Update memory
            IDE.state.files[path] = file.content;
            
            // Cache it
            if (!this.fileCache) this.fileCache = {};
            this.fileCache[path] = file.content;
            
            return file.content;
        }
    } catch (error) {
        console.error('Failed to read from IndexedDB:', error);
    }
    
    // Fallback
    return IDE.state.files[path] || '';
},


    defineEnhancedThemes: function() {
        // ProCode Dark Pro Theme
        monaco.editor.defineTheme('procode-dark-pro', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#c586c0', fontStyle: 'bold' },
                { token: 'string', foreground: '#ce9178' },
                { token: 'number', foreground: '#b5cea8' },
                { token: 'comment', foreground: '#6a9955' },
                { token: 'type', foreground: '#4ec9b0' },
                { token: 'function', foreground: '#dcdcaa' },
                { token: 'variable', foreground: '#9cdcfe' },
                { token: 'parameter', foreground: '#9cdcfe', fontStyle: 'italic' },
                { token: 'property', foreground: '#9cdcfe' },
                { token: 'namespace', foreground: '#4ec9b0' },
                { token: 'tag', foreground: '#569cd6' },
                { token: 'attribute', foreground: '#9cdcfe' },
                { token: 'operator', foreground: '#d4d4d4' },
                { token: 'meta', foreground: '#d16969' },
                { token: 'regexp', foreground: '#d16969' }
            ],
            colors: {
                'editor.background': '#09090b',
                'editor.foreground': '#e4e4e7',
                'editorCursor.foreground': '#6366f1',
                'editor.lineHighlightBackground': '#18181b',
                'editorLineNumber.foreground': '#71717a',
                'editorLineNumber.activeForeground': '#a1a1aa',
                'editor.selectionBackground': '#3f3f4680',
                'editor.inactiveSelectionBackground': '#3f3f4640',
                'editor.wordHighlightBackground': '#3f3f4680',
                'editor.wordHighlightStrongBackground': '#3f3f4660',
                'editor.findMatchBackground': '#f59e0b40',
                'editor.findMatchHighlightBackground': '#f59e0b20',
                'editorBracketMatch.background': '#3f3f46',
                'editorBracketMatch.border': '#71717a',
                'editorIndentGuide.background': '#27272a',
                'editorIndentGuide.activeBackground': '#3f3f46',
                'editorRuler.foreground': '#27272a',
                'editorOverviewRuler.border': '#27272a',
                'editorOverviewRuler.findMatchForeground': '#f59e0b',
                'editorOverviewRuler.errorForeground': '#ef4444',
                'editorOverviewRuler.warningForeground': '#f59e0b',
                'editorOverviewRuler.infoForeground': '#3b82f6',
                'editorError.foreground': '#ef4444',
                'editorWarning.foreground': '#f59e0b',
                'editorInfo.foreground': '#3b82f6',
                'editorGutter.background': '#09090b',
                'editorGutter.modifiedBackground': '#3b82f6',
                'editorGutter.addedBackground': '#22c55e',
                'editorGutter.deletedBackground': '#ef4444'
            }
        });
        
        // ProCode Light Pro Theme
        monaco.editor.defineTheme('procode-light-pro', {
            base: 'vs',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#0000ff', fontStyle: 'bold' },
                { token: 'string', foreground: '#a31515' },
                { token: 'number', foreground: '#098658' },
                { token: 'comment', foreground: '#008000' },
                { token: 'type', foreground: '#267f99' },
                { token: 'function', foreground: '#795e26' },
                { token: 'variable', foreground: '#001080' }
            ],
            colors: {
                'editor.background': '#ffffff',
                'editor.foreground': '#1e293b',
                'editorCursor.foreground': '#6366f1',
                'editor.lineHighlightBackground': '#f8fafc',
                'editorLineNumber.foreground': '#94a3b8',
                'editor.selectionBackground': '#e2e8f080',
                'editor.findMatchBackground': '#f59e0b40',
                'editorBracketMatch.background': '#e2e8f0'
            }
        });
        
        // ProCode Night Theme
        monaco.editor.defineTheme('procode-night', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#ff79c6' },
                { token: 'string', foreground: '#f1fa8c' },
                { token: 'number', foreground: '#bd93f9' },
                { token: 'comment', foreground: '#6272a4' },
                { token: 'type', foreground: '#8be9fd' }
            ],
            colors: {
                'editor.background': '#0a0a12',
                'editor.foreground': '#f8f8f2',
                'editorCursor.foreground': '#ff79c6'
            }
        });
    },
    
createEditor: function(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container ${containerId} not found`);
        return null;
    }
    
    if (this.instances[containerId]) {
        return this.instances[containerId];
    }
    
    const editor = monaco.editor.create(container, {
        value: "",
        language: 'javascript',
        theme: IDE.state.settings.editor.theme,
        fontSize: IDE.state.settings.editor.fontSize,
        fontFamily: IDE.state.settings.editor.fontFamily,
        fontLigatures: true, // Enable font ligatures
        
        // Minimap
        minimap: {
            enabled: IDE.state.settings.editor.minimap,
            scale: 2,
            renderCharacters: false,
            showSlider: 'always',
            side: 'right'
        },
        
        // Scrolling
        scrollBeyondLastLine: false,
        smoothScrolling: true,
        mouseWheelZoom: true,
        fastScrollSensitivity: 5,
        
        // Word wrap
        wordWrap: IDE.state.settings.editor.wordWrap ? 'on' : 'off',
        wordWrapColumn: 80,
        wrappingIndent: 'indent',
        
        // Indentation
        tabSize: IDE.state.settings.editor.tabSize,
        insertSpaces: true,
        detectIndentation: true,
        autoIndent: 'full',
        
        // Layout
        automaticLayout: false, // We'll handle it manually for better performance
        glyphMargin: true,
        lineNumbers: IDE.state.settings.editor.lineNumbers ? 'on' : 'off',
        lineNumbersMinChars: 3,
        lineDecorationsWidth: 10,
        folding: true,
        foldingStrategy: 'indentation',
        showFoldingControls: 'always',
        
        // Rendering
        renderLineHighlight: 'all',
        renderWhitespace: 'selection',
        renderControlCharacters: false,
        renderIndentGuides: true,
        renderFinalNewline: 'dimmed',
        renderValidationDecorations: 'editable',
        
        // Scrollbar
        scrollbar: {
            vertical: 'visible',
            horizontal: 'visible',
            useShadows: true,
            verticalScrollbarSize: 12,
            horizontalScrollbarSize: 12,
            arrowSize: 14
        },
        
        // Bracket matching
        bracketPairColorization: {
            enabled: IDE.state.settings.editor.bracketPairColorization,
            independentColorPoolPerBracketType: true
        },
        matchBrackets: 'always',
        guides: {
            bracketPairs: true,
            bracketPairsHorizontal: true,
            highlightActiveBracketPair: true,
            indentation: true,
            highlightActiveIndentation: true
        },
        
        // Suggestions
        suggest: {
            showWords: true,
            showMethods: true,
            showFunctions: true,
            showConstructors: true,
            showFields: true,
            showVariables: true,
            showClasses: true,
            showStructs: true,
            showInterfaces: true,
            showModules: true,
            showProperties: true,
            showEvents: true,
            showOperators: true,
            showUnits: true,
            showValues: true,
            showConstants: true,
            showEnums: true,
            showEnumMembers: true,
            showKeywords: true,
            showText: true,
            showColors: true,
            showFiles: true,
            showReferences: true,
            showFolders: true,
            showTypeParameters: true,
            showSnippets: IDE.state.settings.features.snippetSuggestions,
            showUsers: false,
            showIssues: false,
            insertMode: 'insert',
            filterGraceful: true,
            snippetsPreventQuickSuggestions: false,
            localityBonus: true,
            shareSuggestSelections: true,
            showInlineDetails: true,
            showStatusBar: true
        },
        quickSuggestions: {
            other: true,
            comments: false,
            strings: true
        },
        quickSuggestionsDelay: 100,
        acceptSuggestionOnEnter: 'on',
        acceptSuggestionOnCommitCharacter: true,
        snippetSuggestions: 'top',
        suggestOnTriggerCharacters: true,
        
        // Code actions
        lightbulb: {
            enabled: true
        },
        codeActionsOnSave: {
            'source.fixAll': true,
            'source.organizeImports': true
        },
        
        // Auto closing
        autoClosingBrackets: IDE.state.settings.editor.autoCloseBrackets ? 'always' : 'never',
        autoClosingQuotes: IDE.state.settings.editor.autoCloseBrackets ? 'always' : 'never',
        autoClosingOvertype: 'always',
        autoSurround: 'languageDefined',
        
        // Formatting
        formatOnPaste: true,
        formatOnType: true,
        
        // Links
        links: true,
        
        // Hover
        hover: {
            enabled: true,
            delay: 300,
            sticky: true
        },
        
        // Find
        find: {
            seedSearchStringFromSelection: 'selection',
            autoFindInSelection: 'never',
            addExtraSpaceOnTop: true,
            loop: true
        },
        
        // Parameter hints
        parameterHints: {
            enabled: true,
            cycle: true
        },
        
        // Code lens
        codeLens: IDE.state.settings.features.codeLens,
        
        // Context menu
        contextmenu: true,
        
        // Accessibility
        accessibilitySupport: 'auto',
        accessibilityPageSize: 10,
        
        // Diff editor
        diffWordWrap: 'inherit',
        
        // Performance
        'semanticHighlighting.enabled': true,
        
        // Selection
        selectionHighlight: true,
        occurrencesHighlight: true,
        selectionClipboard: true,
        copyWithSyntaxHighlighting: true,
        
        // Multi cursor
        multiCursorModifier: 'alt',
        multiCursorMergeOverlapping: true,
        multiCursorPaste: 'spread',
        
        // Drag and drop
        dragAndDrop: true,
        dropIntoEditor: {
            enabled: true
        },
        
        // Overview ruler
        overviewRulerLanes: 3,
        overviewRulerBorder: false,
        
        // Rulers
        rulers: [80, 120],
        
        // Sticky scroll
        stickyScroll: {
            enabled: true
        },
        
        // Inline suggestions
        inlineSuggest: {
            enabled: true
        },
        
        // Unicode highlighting
        unicodeHighlight: {
            ambiguousCharacters: true,
            invisibleCharacters: true
        }
    });
    
    this.instances[containerId] = editor;
    
    // Enhanced resize observer with RAF
    let resizeRAF = null;
    const resizeObserver = new ResizeObserver(() => {
        if (resizeRAF) {
            cancelAnimationFrame(resizeRAF);
        }
        resizeRAF = requestAnimationFrame(() => {
            editor.layout();
        });
    });
    resizeObserver.observe(container);
    
    editor.resizeObserver = resizeObserver;
    
    // Add custom commands
    this.addCustomCommands(editor);
    
    return editor;
},

addCustomCommands: function(editor) {
            // Accept optional editor; fall back to current instance if available.
            editor = editor || (this.instances && this.instances[this.currentEditorId]);
            if (!editor || typeof editor.addCommand !== 'function') {
                console.warn(' addCustomCommands skipped: editor not ready');
                return;
            }
    // Add custom keybindings
    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyD, () => {
        editor.trigger('', 'editor.action.copyLinesDownAction');
    });
    
    editor.addCommand(monaco.KeyMod.Shift | monaco.KeyCode.Delete, () => {
        editor.trigger('', 'editor.action.deleteLines');
    });
    
    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Slash, () => {
        editor.trigger('', 'editor.action.commentLine');
    });
    
    // Add custom actions
    editor.addAction({
        id: 'duplicate-selection',
        label: 'Duplicate Selection',
        keybindings: [
            monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KeyD
        ],
        run: (ed) => {
            const selection = ed.getSelection();
            const text = ed.getModel().getValueInRange(selection);
            ed.executeEdits('', [{
                range: new monaco.Range(
                    selection.endLineNumber,
                    selection.endColumn,
                    selection.endLineNumber,
                    selection.endColumn
                ),
                text: '\n' + text
            }]);
        }
    });
    
    editor.addAction({
        id: 'sort-lines',
        label: 'Sort Lines',
        contextMenuGroupId: 'modification',
        run: (ed) => {
            const selection = ed.getSelection();
            const model = ed.getModel();
            const lines = [];
            
            for (let i = selection.startLineNumber; i <= selection.endLineNumber; i++) {
                lines.push(model.getLineContent(i));
            }
            
            lines.sort();
            
            ed.executeEdits('', [{
                range: new monaco.Range(
                    selection.startLineNumber, 1,
                    selection.endLineNumber, model.getLineMaxColumn(selection.endLineNumber)
                ),
                text: lines.join('\n')
            }]);
        }
    });
},

    setupEnhancedEventListeners: function() {
        Object.values(this.instances).forEach(editor => {
            // Content change with enhanced debouncing
            editor.onDidChangeModelContent(Utils.debounce((event) => {
                const model = editor.getModel();
                if (!model) return;
                
                const path = model.uri.path.substring(1);
                const value = editor.getValue();
                
                FileSystem.write(path, value);
                
                // Update diagnostics
                this.updateDiagnostics(path, value);
                
                // Update code lens
                this.updateCodeLens(path, value);
                
                // Update file size
                const size = new Blob([value]).size;
                document.getElementById('file-size').textContent = Utils.formatBytes(size);
                
                // Update outline
                FileSystem.updateOutline();
            }, 300));
            
            // Cursor position change
            editor.onDidChangeCursorPosition((event) => {
                document.getElementById('cursor-pos').textContent = 
                    `Ln ${event.position.lineNumber}, Col ${event.position.column}`;
                
                // Update active editor
                this.currentEditorId = Object.keys(this.instances).find(
                    key => this.instances[key] === editor
                ) || 'monaco-root-1';
                
                // Show hover information
                this.showHoverInfo(editor, event.position);
            });
            
            // Model change
            editor.onDidChangeModel((event) => {
                if (event.newModelUrl) {
                    const path = event.newModelUrl.path.substring(1);
                    const lang = Utils.detectLanguage(path);
                    
                    monaco.editor.setModelLanguage(editor.getModel(), lang);
                    
                    document.getElementById('file-lang').textContent = 
                        lang.charAt(0).toUpperCase() + lang.slice(1);
                    
                    // Apply model-specific settings
                    this.applyModelSettings(editor, lang);
                }
            });
            
            // Selection change
            editor.onDidChangeCursorSelection((event) => {
                // Could add selection info or multi-cursor support
            });
            
            // Mouse events
            editor.onMouseDown((event) => {
                // Toggle breakpoint when clicking gutter (glyph margin / line numbers)
                try {
                    if (!event || !event.target) return;
                    const t = event.target;
                    const mt = monaco?.editor?.MouseTargetType;
                    const isGutter = mt && (
                        t.type === mt.GUTTER_GLYPH_MARGIN ||
                        t.type === mt.GUTTER_LINE_NUMBERS ||
                        t.type === mt.GUTTER_LINE_DECORATIONS
                    );
                    if (!isGutter) return;
                    const line = t.position && t.position.lineNumber;
                    if (!line) return;
                    if (window.Debugger && typeof Debugger.toggleBreakpoint === 'function') {
                        Debugger.toggleBreakpoint(line);
                    }
                } catch (e) {
                    console.warn('Gutter click handler failed', e);
                }
            });
            
            // Key events
            editor.onKeyDown((event) => {
                // Custom keyboard shortcuts
                this.handleCustomKeybindings(editor, event);
            });
            
            // Context menu
            editor.onContextMenu((event) => {
                // Custom context menu items
            });
        });
    },
    
    setupCodeLens: function() {
        // Code lens provider for references, implementations, etc.
        // This would require registering a provider with Monaco
    },
    
    setupDiagnostics: function() {
        // Diagnostic collection for errors, warnings, info
        // This would require setting up language-specific diagnostics
    },
    
    updateDiagnostics: function(path, content) {
        // Update diagnostics based on content
        const diagnostics = [];
        const lines = content.split('\n');
        
        // Simple diagnostics for demonstration
        lines.forEach((line, index) => {
            // Check for TODO comments
            if (line.includes('TODO') || line.includes('FIXME')) {
                diagnostics.push({
                    severity: monaco.MarkerSeverity.Info,
                    message: 'TODO comment found',
                    startLineNumber: index + 1,
                    startColumn: line.indexOf('TODO') + 1,
                    endLineNumber: index + 1,
                    endColumn: line.indexOf('TODO') + 5
                });
            }
            
            // Check for console.log in production code
            if (line.includes('console.log') && !line.includes('//')) {
                diagnostics.push({
                    severity: monaco.MarkerSeverity.Warning,
                    message: 'Consider removing console.log for production',
                    startLineNumber: index + 1,
                    startColumn: line.indexOf('console.log') + 1,
                    endLineNumber: index + 1,
                    endColumn: line.indexOf('console.log') + 11
                });
            }
        });
        
        this.diagnostics.set(path, diagnostics);
        
        // Update problems panel
        this.updateProblemsPanel();
    },
    
    updateCodeLens: function(path, content) {
        // Update code lens information
        // This would extract references, implementations, etc.
    },
    
    updateProblemsPanel: function() {
        const problemsHost = document.getElementById('problems-host');
        if (!problemsHost) return;
        
        let totalErrors = 0;
        let totalWarnings = 0;
        let totalInfos = 0;
        
        problemsHost.innerHTML = '';
        
        this.diagnostics.forEach((diagnostics, path) => {
            diagnostics.forEach(diagnostic => {
                const div = document.createElement('div');
                div.className = 'problem-item';
                div.style.padding = '8px 12px';
                div.style.borderBottom = '1px solid var(--border)';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '12px';
                
                const icon = diagnostic.severity === monaco.MarkerSeverity.Error ? 
                    '<i class="fas fa-times-circle" style="color:var(--error)"></i>' :
                    diagnostic.severity === monaco.MarkerSeverity.Warning ?
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warn)"></i>' :
                    '<i class="fas fa-info-circle" style="color:var(--primary)"></i>';
                
                div.innerHTML = `
                    ${icon}
                    <div style="flex:1">
                        <div style="font-size:12px;">${diagnostic.message}</div>
                        <div style="font-size:11px; color:var(--text-dim);">
                            ${path}:${diagnostic.startLineNumber}:${diagnostic.startColumn}
                        </div>
                    </div>
                    <button class="btn icon small" onclick="EditorManager.goToProblem('${path}', ${diagnostic.startLineNumber}, ${diagnostic.startColumn})">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
                
                problemsHost.appendChild(div);
                
                // Update counts
                if (diagnostic.severity === monaco.MarkerSeverity.Error) totalErrors++;
                if (diagnostic.severity === monaco.MarkerSeverity.Warning) totalWarnings++;
                if (diagnostic.severity === monaco.MarkerSeverity.Info) totalInfos++;
            });
        });
        
        // Update footer counters
        document.getElementById('error-count').innerHTML = `<i class="fas fa-times-circle"></i> ${totalErrors}`;
        document.getElementById('warning-count').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${totalWarnings}`;
        document.getElementById('info-count').innerHTML = `<i class="fas fa-info-circle"></i> ${totalInfos}`;
        
        // Update panel badge
        const problemsBadge = document.getElementById('problems-badge');
        if (problemsBadge) {
            const total = totalErrors + totalWarnings + totalInfos;
            problemsBadge.textContent = total;
            problemsBadge.style.display = total > 0 ? 'inline-flex' : 'none';
        }
    },
    
    goToProblem: function(path, line, column) {
        TabManager.open(path);
        const editor = this.getCurrentEditor();
        if (editor) {
            editor.revealLineInCenter(line);
            editor.setPosition({ lineNumber: line, column: column });
            editor.focus();
        }
    },
    
    showHoverInfo: function(editor, position) {
        // Show hover information for the current position
        // This would integrate with language server for type information
    },
    
    applyModelSettings: function(editor, language) {
        // Apply language-specific settings
        switch (language) {
            case 'typescript':
            case 'javascript':
                editor.updateOptions({
                    suggest: {
                        showSnippets: true
                    }
                });
                break;
            case 'html':
                editor.updateOptions({
                    autoClosingTags: true,
                    autoClosingQuotes: true
                });
                break;
            case 'css':
            case 'scss':
            case 'less':
                editor.updateOptions({
                    colorDecorators: true
                });
                break;
        }
    },
    
    handleCustomKeybindings: function(editor, event) {
        // Handle custom keybindings
        const { ctrlKey, shiftKey, altKey, keyCode } = event;
        
        // Ctrl/Cmd + S - Save
        if ((ctrlKey || event.metaKey) && keyCode === 83) {
            event.preventDefault();
            FileSystem.save(true);
        }
        
        // Ctrl/Cmd + F - Find
        if ((ctrlKey || event.metaKey) && keyCode === 70) {
            event.preventDefault();
            this.findText('');
        }
        
        // Ctrl/Cmd + Shift + F - Replace
        if ((ctrlKey || event.metaKey) && shiftKey && keyCode === 70) {
            event.preventDefault();
            this.replaceText('', '');
        }
        
        // Ctrl/Cmd + / - Toggle comment
        if ((ctrlKey || event.metaKey) && keyCode === 191) {
            event.preventDefault();
            this.toggleComment();
        }
        
        // Alt + Up/Down - Move line
        if (altKey && (keyCode === 38 || keyCode === 40)) {
            event.preventDefault();
            if (keyCode === 38) this.moveLineUp();
            else this.moveLineDown();
        }
        
        // Ctrl/Cmd + D - Duplicate line
        if ((ctrlKey || event.metaKey) && keyCode === 68) {
            event.preventDefault();
            this.duplicateLine();
        }
        
        // Ctrl/Cmd + Shift + K - Delete line
        if ((ctrlKey || event.metaKey) && shiftKey && keyCode === 75) {
            event.preventDefault();
            this.deleteLine();
        }
    },
    
    moveLineUp: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.moveLinesUpAction').run();
    },
    
    moveLineDown: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.moveLinesDownAction').run();
    },
    
    setFile: function(path, editorId = 'monaco-root-1') {
        const editor = this.instances[editorId];
        if (!editor) {
            console.error(`Editor ${editorId} not found`);
            return;
        }
        
        // ULTRA: persist cursor/scroll per-file
        try { if (window.SessionManager) SessionManager.captureViewStateFromEditor(editor); } catch (e) {}

        const content = FileSystem.read(path);
        const lang = Utils.detectLanguage(path);
        
        // Get or create model
        let model = monaco.editor.getModel(monaco.Uri.parse(`file:///${path}`));
        
        if (!model) {
            model = monaco.editor.createModel(
                content,
                lang,
                monaco.Uri.parse(`file:///${path}`)
            );
        } else {
            model.setValue(content);
        }
        
        // Set model
        editor.setModel(model);
        monaco.editor.setModelLanguage(model, lang);
        
        // Apply model settings
        this.applyModelSettings(editor, lang);
        // ULTRA: restore cursor/scroll if available
        try { if (window.SessionManager) SessionManager.restoreViewStateToEditor(path, editor); } catch (e) {}

        // Update UI
        const emptyState = document.getElementById('empty-state');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Update footer
        document.getElementById('file-lang').textContent = 
            lang.charAt(0).toUpperCase() + lang.slice(1);
            
        const size = new Blob([content]).size;
        document.getElementById('file-size').textContent = Utils.formatBytes(size);
        
        // Update active editor
        this.currentEditorId = editorId;
        
        // Update diagnostics and code lens
        this.updateDiagnostics(path, content);
        this.updateCodeLens(path, content);
        
        // Trigger content change event to update outline
        FileSystem.updateOutline();
    },
    
    getCurrentEditor: function() {
        return this.instances[this.currentEditorId];
    },
    
        applySettings: function() {
        const s = IDE.state.settings.editor || {};
        const fontSize = s.fontSize || 14;
        const wordWrap = s.wordWrap ? 'on' : 'off';
        const minimapEnabled = !!s.minimap;

        // Monaco theme is global
        try {
            if (window.monaco && monaco.editor && monaco.editor.setTheme) {
                monaco.editor.setTheme(s.theme || 'vs-dark');
            }
        } catch (e) {}

        Object.values(this.instances).forEach(editor => {
            try {
                if (!editor || !editor.updateOptions) return;

                editor.updateOptions({
                    fontSize: fontSize,
                    fontFamily: s.fontFamily || 'JetBrains Mono, Consolas, Monaco, monospace',
                    wordWrap: wordWrap,
                    minimap: { enabled: minimapEnabled },
                    lineNumbers: s.lineNumbers ? 'on' : 'off',
                    renderWhitespace: s.showWhitespace ? 'all' : 'none',
                    bracketPairColorization: { enabled: !!s.bracketPairColorization },
                    autoClosingBrackets: s.autoClosingBrackets ? 'always' : 'never',
                    autoIndent: s.autoIndent ? 'full' : 'none',
                    suggest: { showSnippets: !!IDE.state.settings.features.snippetSuggestions }
                });

                // Model-level options
                const model = editor.getModel && editor.getModel();
                if (model && model.updateOptions) {
                    model.updateOptions({
                        tabSize: Math.max(1, Math.min(8, s.tabSize || 4)),
                        insertSpaces: true
                    });
                }
            } catch (e) {
                console.warn('Failed to apply editor settings', e);
            }
        });

        Utils.setCssVariable('--editor-font-size', fontSize + 'px');
    },

    formatCode: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const model = editor.getModel();
        if (!model) return;
        
        const range = model.getFullModelRange();
        const text = model.getValue();
        const language = model.getLanguageId();
        
        try {
            let formatted = text;
            let parser = 'babel';
            
            // Determine parser based on language
            switch(language) {
                case 'typescript':
                case 'typescriptreact':
                    parser = 'typescript';
                    break;
                case 'css':
                case 'scss':
                case 'less':
                    parser = 'css';
                    break;
                case 'html':
                    parser = 'html';
                    break;
                case 'json':
                    parser = 'json';
                    break;
                case 'vue':
                    parser = 'vue';
                    break;
            }
            
            const options = {
                parser: parser,
                plugins: [
                    window.prettierPlugins.html, 
                    window.prettierPlugins.babel,
                    window.prettierPlugins.postcss,
                    window.prettierPlugins.typescript
                ],
                tabWidth: IDE.state.settings.editor.tabSize,
                useTabs: false,
                semi: true,
                singleQuote: true,
                trailingComma: 'es5',
                printWidth: 80,
                bracketSpacing: true,
                arrowParens: 'avoid',
                endOfLine: 'lf'
            };
            
            // Try to format
            formatted = prettier.format(text, options);
            
            // Apply formatting
            editor.executeEdits('', [{
                range: range,
                text: formatted,
                forceMoveMarkers: true
            }]);
            
            Utils.toast('Code formatted successfully', 'success');
        } catch (error) {
            console.error('Format error:', error);
            Utils.toast('Format failed: ' + error.message, 'error');
        }
    },
    
    getSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const selection = editor.getSelection();
        const model = editor.getModel();
        
        if (!selection || !model) return '';
        
        return model.getValueInRange(selection);
    },
    
    insertText: function(text, position = null) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const selection = position || editor.getSelection();
        const op = { 
            range: selection, 
            text: text, 
            forceMoveMarkers: true 
        };
        
        editor.executeEdits('', [op]);
        
        // Move cursor to end of inserted text
        const newPosition = editor.getModel().modifyPosition(selection.getEndPosition(), text.length);
        editor.setPosition(newPosition);
    },
    
    findText: function(text, options = {}) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('actions.find').run();
        
        // Set find widget text
        const findWidget = editor.getContribution('editor.contrib.findController');
        if (findWidget && text) {
            findWidget.start({
                searchString: text,
                replaceString: '',
                isRegex: options.regex || false,
                matchCase: options.caseSensitive || false,
                wholeWord: options.wholeWord || false,
                searchScope: null,
                loop: true
            });
        }
    },
    
    replaceText: function(find, replace, options = {}) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.startFindReplaceAction').run();
        
        // Set find and replace values
        const findWidget = editor.getContribution('editor.contrib.findController');
        if (findWidget && find) {
            findWidget.start({
                searchString: find,
                replaceString: replace,
                isRegex: options.regex || false,
                matchCase: options.caseSensitive || false,
                wholeWord: options.wholeWord || false
            });
        }
    },
    
    goToLine: function(lineNumber) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.revealLineInCenter(lineNumber);
        editor.setPosition({ lineNumber: lineNumber, column: 1 });
        editor.focus();
    },
    
    toggleComment: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.commentLine').run();
    },
    
    duplicateLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.copyLinesDownAction').run();
    },
    
    deleteLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.deleteLines').run();
    },
    
    // Enhanced editor utilities
    getWordAtPosition: function(position) {
        const editor = this.getCurrentEditor();
        if (!editor) return null;
        
        const model = editor.getModel();
        if (!model) return null;
        
        return model.getWordAtPosition(position);
    },
    
    getCurrentWord: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const position = editor.getPosition();
        const word = this.getWordAtPosition(position);
        return word ? word.word : '';
    },
    
    getCurrentLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const position = editor.getPosition();
        const model = editor.getModel();
        if (!model) return '';
        
        return model.getLineContent(position.lineNumber);
    },
    
    getLineCount: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return 0;
        
        const model = editor.getModel();
        if (!model) return 0;
        
        return model.getLineCount();
    },
    
    // Folding
    foldAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.foldAll').run();
    },
    
    unfoldAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.unfoldAll').run();
    },
    
    // Selection manipulation
    selectAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.setSelection(editor.getModel().getFullModelRange());
    },
    
    expandSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.smartSelect.expand').run();
    },
    
    shrinkSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.smartSelect.shrink').run();
    },
    
    // Multiple cursors
    addCursorAbove: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorAbove').run();
    },
    
    addCursorBelow: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorBelow').run();
    },
    
    addCursorToLineEnds: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorAtEndOfEachLineSelected').run();
    },
    
    // Code actions
    quickFix: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.quickFix').run();
    },
    
    refactor: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.refactor').run();
    },
    
    renameSymbol: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.rename').run();
    },
    
    // Navigation
    goToDefinition: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.revealDefinition').run();
    },
    
    goToTypeDefinition: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToTypeDefinition').run();
    },
    
    goToImplementation: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToImplementation').run();
    },
    
    goToReferences: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToReferences').run();
    },
    
    // View
    toggleMinimap: function() {
        IDE.state.settings.editor.minimap = !IDE.state.settings.editor.minimap;
        this.applySettings();
    },
    
    toggleWordWrap: function() {
        IDE.state.settings.editor.wordWrap = !IDE.state.settings.editor.wordWrap;
        this.applySettings();
    },
    
    zoomIn: function() {
        IDE.state.settings.editor.fontSize = Math.min(32, IDE.state.settings.editor.fontSize + 1);
        this.applySettings();
    },
    
    zoomOut: function() {
        IDE.state.settings.editor.fontSize = Math.max(8, IDE.state.settings.editor.fontSize - 1);
        this.applySettings();
    },
    
    resetZoom: function() {
        IDE.state.settings.editor.fontSize = 14;
        this.applySettings();
    },
    
    // Advanced features
    showCommandPalette: function() {
        CommandPalette.show();
    },
    
    showColorPicker: function() {
        // This would show a color picker for CSS/HTML colors
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const position = editor.getPosition();
        const word = this.getWordAtPosition(position);
        
        if (word) {
            // Check if it's a color value
            const colorRegex = /^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i;
            const rgbRegex = /^rgb\(/i;
            const rgbaRegex = /^rgba\(/i;
            const hslRegex = /^hsl\(/i;
            const hslaRegex = /^hsla\(/i;
            
            const value = word.word;
            if (colorRegex.test(value) || rgbRegex.test(value) || rgbaRegex.test(value) || 
                hslRegex.test(value) || hslaRegex.test(value)) {
                // Show color picker
                this.showColorPickerDialog(value, position, word);
            }
        }
    },
    
    showColorPickerDialog: function(color, position, word) {
        // Create color picker dialog
        const dialog = document.createElement('div');
        dialog.className = 'modal-overlay';
        dialog.id = 'color-picker-dialog';
        
        // This would be a full color picker implementation
        // For now, just show a simple dialog
        dialog.innerHTML = `
            <div class="modal" style="width:400px;">
                <div class="modal-header">
                    <h3><i class="fas fa-palette"></i> Color Picker</h3>
                    <button class="btn icon small" onclick="document.getElementById('color-picker-dialog').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align:center; padding:20px;">
                        <div style="width:100px; height:100px; background:${color}; margin:0 auto 20px; border-radius:8px; border:2px solid var(--border);"></div>
                        <div style="font-family:'JetBrains Mono'; font-size:14px;">${color}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="document.getElementById('color-picker-dialog').remove()">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
    },
    // Thm vo EditorManager object
    disposeEditor: function(editorId) {
        const editor = this.instances[editorId];
        if (!editor) return;
        
        try {
            // Dispose model
            const model = editor.getModel();
            if (model) {
                model.dispose();
            }
            
            // Remove resize observer
            if (editor.resizeObserver) {
                editor.resizeObserver.disconnect();
            }
            
            // Dispose editor
            editor.dispose();
            
            // Clear diagnostics
            this.diagnostics.delete(editorId);
            this.codeLenses.delete(editorId);
            
            // Remove from instances
            delete this.instances[editorId];
            
            console.log(` Editor ${editorId} disposed`);
        } catch (error) {
            console.error('Failed to dispose editor:', error);
        }
    },

    // Cleanup all editors on page unload
    cleanup: function() {
        Object.keys(this.instances).forEach(id => this.disposeEditor(id));
        
        // Dispose all models
        monaco.editor.getModels().forEach(model => {
            try {
                model.dispose();
            } catch (e) {
                // Ignore
            }
        });
    },
};

// ============================================
// ENHANCED TAB MANAGER
// ============================================
const TabManager = {
    open: function(path) {
        if (!path || !FileSystem.exists(path)) {
            console.error(`File not found: ${path}`);
            return;
        }
        
        // Add to tabs if not already
        if (!IDE.state.tabs.includes(path)) {
            IDE.state.tabs.push(path);
        }
        
        // Set as active
        IDE.state.activeTab = path;
        
        // Render tabs
        this.render();
        
        // Set file in editor
        EditorManager.setFile(path);
        
        // Update tree highlight
        this.highlightTreeItem(path);
        
        // Update outline
        FileSystem.updateOutline();
        
        // Update tab dirty state
        FileSystem.updateTabDirtyState();
    },
    
    close: function(path, force = false) {
        if (!IDE.state.tabs.includes(path)) return;
        
        // Check if file has unsaved changes
        if (IDE.state.dirtyTabs.has(path) && !force) {
            if (!confirm('You have unsaved changes. Close anyway?')) {
                return;
            }
        }
        
        const index = IDE.state.tabs.indexOf(path);
        IDE.state.tabs.splice(index, 1);
        
        // Remove from dirty tabs
        IDE.state.dirtyTabs.delete(path);
        
        // Update active tab
        if (IDE.state.activeTab === path) {
            IDE.state.activeTab = IDE.state.tabs.length > 0 
                ? IDE.state.tabs[IDE.state.tabs.length - 1] 
                : null;
            
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab);
            } else {
                // Show empty state
                document.getElementById('empty-state').style.display = 'flex';
                const editor = EditorManager.getCurrentEditor();
                if (editor) {
                    editor.setModel(null);
                }
            }
        }
        
        this.render();
        this.highlightTreeItem(IDE.state.activeTab);
        FileSystem.updateTabDirtyState();
    },
    
    closeAll: function() {
        if (IDE.state.dirtyTabs.size > 0) {
            if (!confirm('Some files have unsaved changes. Close all tabs?')) {
                return;
            }
        }
        
        IDE.state.tabs = [];
        IDE.state.activeTab = null;
        IDE.state.dirtyTabs.clear();
        
        this.render();
        document.getElementById('empty-state').style.display = 'flex';
        
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            editor.setModel(null);
        }
        
        FileSystem.updateTabDirtyState();
    },
    
    closeOthers: function(path) {
        IDE.state.tabs = [path];
        IDE.state.activeTab = path;
        IDE.state.dirtyTabs.clear();
        
        this.render();
        EditorManager.setFile(path);
        this.highlightTreeItem(path);
        FileSystem.updateTabDirtyState();
    },
    
    render: function() {
        const container = document.getElementById('tab-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        IDE.state.tabs.forEach(path => {
            const fileName = path.split('/').pop();
            const isActive = IDE.state.activeTab === path;
            const [iconClass, iconColor] = Utils.getFileIcon(path);
            const isDirty = IDE.state.dirtyTabs.has(path);
            
            const tab = document.createElement('div');
            tab.className = `tab ${isActive ? 'active' : ''} ${isDirty ? 'dirty' : ''}`;
            tab.dataset.path = path;
            tab.title = path; // Show full path on hover
            
            tab.innerHTML = `
                <i class="${iconClass}" style="color:${iconColor}; font-size:12px;"></i>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${fileName}
                </span>
                <div class="close" onclick="event.stopPropagation(); TabManager.close('${path}')">
                    
                </div>
            `;
            
            tab.onclick = (e) => {
                if (e.target.classList.contains('close')) return;
                this.open(path);
            };
            
            // Tab context menu
            tab.oncontextmenu = (e) => {
                e.preventDefault();
                this.showTabContextMenu(e, path);
            };
            
            // Drag and drop for tab reordering
            tab.draggable = true;
            tab.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', path);
                tab.style.opacity = '0.5';
            });
            
            tab.addEventListener('dragend', () => {
                tab.style.opacity = '1';
            });
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedPath = e.dataTransfer.getData('text/plain');
                this.reorderTab(draggedPath, path);
            });
            
            container.appendChild(tab);
        });
        
        // Ensure active tab is visible
        if (IDE.state.activeTab) {
            const activeTab = container.querySelector('.tab.active');
            if (activeTab) {
                activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
    },
    
    reorderTab: function(draggedPath, targetPath) {
        if (draggedPath === targetPath) return;
        
        const draggedIndex = IDE.state.tabs.indexOf(draggedPath);
        const targetIndex = IDE.state.tabs.indexOf(targetPath);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // Remove dragged tab
        IDE.state.tabs.splice(draggedIndex, 1);
        
        // Insert at new position
        IDE.state.tabs.splice(targetIndex, 0, draggedPath);
        
        this.render();
    },
    
    highlightTreeItem: function(path) {
        if (!path) return;
        
        document.querySelectorAll('.t-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.path === path) {
                item.classList.add('active');
                
                // Ensure parent folders are expanded
                let parent = item.parentElement;
                while (parent && !parent.classList.contains('tree')) {
                    if (parent.classList.contains('t-sub')) {
                        parent.classList.remove('hidden');
                        
                        // Update folder icon and chevron
                        const folderItem = parent.previousElementSibling;
                        if (folderItem) {
                            const folderIcon = folderItem.querySelector('.fa-folder, .fa-folder-open');
                            if (folderIcon) {
                                folderIcon.className = 'fas fa-folder-open';
                            }
                            
                            const chevron = folderItem.querySelector('.fa-chevron-right');
                            if (chevron) {
                                chevron.style.transform = 'rotate(90deg)';
                            }
                            
                            // Save expanded state
                            const folderPath = folderItem.dataset.folder;
                            if (folderPath) {
                                localStorage.setItem(`folder_${folderPath}`, 'expanded');
                            }
                        }
                    }
                    parent = parent.parentElement;
                }
            }
        });
    },
    
    showTabContextMenu: function(event, path) {
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        const addItem = (icon, text, action) => {
            const item = document.createElement('div');
            item.className = 'context-item';
            item.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
            item.onclick = () => {
                action();
                menu.remove();
            };
            menu.appendChild(item);
        };
        
        addItem('fa-times', 'Close', () => this.close(path));
        addItem('fa-times-circle', 'Close Others', () => this.closeOthers(path));
        addItem('fa-window-close', 'Close All', () => this.closeAll());
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        addItem('fa-copy', 'Copy Path', () => {
            Utils.copyToClipboard(path);
        });
        
        addItem('fa-folder-open', 'Reveal in Explorer', () => {
            this.highlightTreeItem(path);
        });
        
        addItem('fa-save', 'Save', () => {
            FileSystem.save(true);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        addItem('fa-arrow-right', 'Open to the Right', () => {
            LayoutManager.openInSplit(path);
        });
        
        addItem('fa-arrow-down', 'Open Below', () => {
            // This would open in a new editor group below
        });
        
        document.body.appendChild(menu);
        
        setTimeout(() => {
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    },
    
    refreshTab: function(path) {
        const tab = document.querySelector(`.tab[data-path="${path}"]`);
        if (tab) {
            // Update dirty indicator if needed
            if (IDE.state.dirtyTabs.has(path)) {
                tab.classList.add('dirty');
            } else {
                tab.classList.remove('dirty');
            }
        }
    }
};

// ============================================
// ENHANCED TERMINAL MANAGER
// ============================================
const TerminalManager = {
    instance: null,
    fitAddon: null,
    webLinksAddon: null,
    currentDir: '/',
    commandHistory: [],
    historyIndex: -1,
    terminals: {},
    activeTerminal: 'default',
    
    init: function() {
        console.log(' Initializing Enhanced Terminal Manager');
        
        this.createTerminal('default');
        this.setActiveTerminal('default');
        
        Utils.toast('Terminal ready', 'success');
    },
    
    createTerminal: function(id = null) {
        const terminalId = id || `terminal-${Date.now()}`;
        
        const terminal = new Terminal({
            theme: {
                background: '#09090b',
                foreground: '#e4e4e7',
                cursor: '#6366f1',
                selection: '#3f3f4680',
                black: '#000000',
                red: '#ef4444',
                green: '#22c55e',
                yellow: '#f59e0b',
                blue: '#3b82f6',
                magenta: '#a855f7',
                cyan: '#06b6d4',
                white: '#ffffff',
                brightBlack: '#52525b',
                brightRed: '#fb7185',
                brightGreen: '#4ade80',
                brightYellow: '#fbbf24',
                brightBlue: '#60a5fa',
                brightMagenta: '#d8b4fe',
                brightCyan: '#22d3ee',
                brightWhite: '#fafafa'
            },
            fontFamily: IDE.state.settings.terminal.fontFamily,
            fontSize: IDE.state.settings.terminal.fontSize,
            cursorBlink: IDE.state.settings.terminal.cursorBlink,
            cursorStyle: IDE.state.settings.terminal.cursorStyle,
            scrollback: 10000,
            convertEol: true,
            allowTransparency: true,
            disableStdin: false,
            windowsMode: false,
            macOptionIsMeta: false,
            rendererType: 'canvas',
            cols: 80,
            rows: 24
        });
        
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        
        terminal.loadAddon(fitAddon);
        terminal.loadAddon(webLinksAddon);
        
        this.terminals[terminalId] = {
            instance: terminal,
            fitAddon: fitAddon,
            webLinksAddon: webLinksAddon,
            currentDir: '/',
            commandHistory: [],
            historyIndex: -1
        };
        
        return terminalId;
    },
    
    setActiveTerminal: function(id) {
        if (!this.terminals[id]) {
            console.error(`Terminal ${id} not found`);
            return;
        }
        
        this.activeTerminal = id;
        const terminal = this.terminals[id];
        
        // Clear current terminal host
        const host = document.getElementById('term-host');
        host.innerHTML = '';
        
        // Open terminal in host
        terminal.instance.open(host);
        
        // Write welcome if first time
        if (terminal.commandHistory.length === 0) {
            this.writeWelcome(id);
        }
        
        // Setup input handling
        this.setupInput(id);
        
        // Fit terminal
        setTimeout(() => terminal.fitAddon.fit(), 50);
        
        // Setup resize observer
        new ResizeObserver(() => terminal.fitAddon.fit()).observe(host);
        
        // Update UI
        this.updateTerminalUI();
    },
    
    writeWelcome: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\x1b[1;36m\r\n');
        terminal.instance.write('\x1b[1;36m  \x1b[1;35mProCode IDE Terminal v19.0\x1b[1;36m                    \r\n');
        terminal.instance.write('\x1b[1;36m  Type \x1b[1;33mhelp\x1b[1;36m for available commands              \r\n');
        terminal.instance.write('\x1b[1;36m  Multiple terminals: \x1b[1;33mCtrl+Shift+`\x1b[1;36m              \r\n');
        terminal.instance.write('\x1b[1;36m\r\n\r\n');
        this.writePrompt(terminalId);
    },
    
    writePrompt: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const path = terminal.currentDir === '/' ? '/' : terminal.currentDir.substring(1);
        terminal.instance.write(`\x1b[1;32muser@procode\x1b[0m:\x1b[1;34m${path}\x1b[0m$ `);
    },
    
    setupInput: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        let currentInput = '';
        let cursorPosition = 0; //  NEW: Track cursor position
        
        //  FIX: Better input handling
        const insertAtCursor = (text) => {
            const before = currentInput.slice(0, cursorPosition);
            const after = currentInput.slice(cursorPosition);
            currentInput = before + text + after;
            cursorPosition += text.length;
        };
        
        const deleteAtCursor = (count = 1) => {
            if (cursorPosition === 0) return;
            const before = currentInput.slice(0, cursorPosition - count);
            const after = currentInput.slice(cursorPosition);
            currentInput = before + after;
            cursorPosition -= count;
        };
        
        const moveCursor = (delta) => {
            cursorPosition = Math.max(0, Math.min(currentInput.length, cursorPosition + delta));
        };
        
        const redrawLine = () => {
            // Clear line and redraw with cursor
            terminal.instance.write('\r\x1b[K');
            this.writePrompt(terminalId);
            terminal.instance.write(currentInput);
            
            // Move cursor to correct position
            const promptLen = terminal.currentDir.length + 15; // Approximate
            const targetCol = promptLen + cursorPosition + 1;
            terminal.instance.write(`\x1b[${targetCol}G`);
        };
        
        terminal.instance.onKey(({ key, domEvent }) => {
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;
            
            //  FIX: Better key handling
            switch (domEvent.keyCode) {
                case 13: // Enter
                    terminal.instance.write('\r\n');
                    this.executeCommand(terminalId, currentInput);
                    terminal.commandHistory.push(currentInput);
                    terminal.historyIndex = terminal.commandHistory.length;
                    currentInput = '';
                    cursorPosition = 0;
                    break;
                    
                case 8: // Backspace
                    if (cursorPosition > 0) {
                        deleteAtCursor(1);
                        redrawLine();
                    }
                    break;
                    
                case 46: // Delete
                    if (cursorPosition < currentInput.length) {
                        const before = currentInput.slice(0, cursorPosition);
                        const after = currentInput.slice(cursorPosition + 1);
                        currentInput = before + after;
                        redrawLine();
                    }
                    break;
                    
                case 37: // Left arrow
                    if (cursorPosition > 0) {
                        moveCursor(-1);
                        terminal.instance.write('\x1b[D');
                    }
                    break;
                    
                case 39: // Right arrow
                    if (cursorPosition < currentInput.length) {
                        moveCursor(1);
                        terminal.instance.write('\x1b[C');
                    }
                    break;
                    
                case 36: // Home
                    cursorPosition = 0;
                    redrawLine();
                    break;
                    
                case 35: // End
                    cursorPosition = currentInput.length;
                    redrawLine();
                    break;
                    
                case 38: // Up arrow
                    if (terminal.historyIndex > 0) {
                        terminal.historyIndex--;
                        currentInput = terminal.commandHistory[terminal.historyIndex];
                        cursorPosition = currentInput.length;
                        redrawLine();
                    }
                    break;
                    
                case 40: // Down arrow
                    if (terminal.historyIndex < terminal.commandHistory.length - 1) {
                        terminal.historyIndex++;
                        currentInput = terminal.commandHistory[terminal.historyIndex];
                        cursorPosition = currentInput.length;
                        redrawLine();
                    } else {
                        terminal.historyIndex = terminal.commandHistory.length;
                        currentInput = '';
                        cursorPosition = 0;
                        redrawLine();
                    }
                    break;
                    
                case 67: // Ctrl+C
                    if (domEvent.ctrlKey) {
                        terminal.instance.write('^C\r\n');
                        this.writePrompt(terminalId);
                        currentInput = '';
                        cursorPosition = 0;
                    }
                    break;
                    
                case 76: // Ctrl+L
                    if (domEvent.ctrlKey) {
                        terminal.instance.clear();
                        this.writeWelcome(terminalId);
                        currentInput = '';
                        cursorPosition = 0;
                    }
                    break;
                    
                case 85: // Ctrl+U
                    if (domEvent.ctrlKey) {
                        currentInput = currentInput.slice(cursorPosition);
                        cursorPosition = 0;
                        redrawLine();
                    }
                    break;
                    
                case 75: // Ctrl+K
                    if (domEvent.ctrlKey) {
                        currentInput = currentInput.slice(0, cursorPosition);
                        redrawLine();
                    }
                    break;
                    
                case 87: // Ctrl+W (delete word)
                    if (domEvent.ctrlKey) {
                        const before = currentInput.slice(0, cursorPosition);
                        const lastSpace = before.trimRight().lastIndexOf(' ');
                        const deleteCount = cursorPosition - (lastSpace + 1);
                        if (deleteCount > 0) {
                            deleteAtCursor(deleteCount);
                            redrawLine();
                        }
                    }
                    break;
                    
                default:
                    if (printable) {
                        insertAtCursor(key);
                        terminal.instance.write(key);
                        
                        //  FIX: Redraw if cursor not at end
                        if (cursorPosition < currentInput.length) {
                            redrawLine();
                        }
                    }
            }
        });
        
        //  FIX: Better paste handling
        terminal.instance.attachCustomKeyEventHandler((event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
                navigator.clipboard.readText().then(text => {
                    //  Sanitize pasted text
                    const sanitized = text.replace(/[\r\n]+/g, ' ').trim();
                    insertAtCursor(sanitized);
                    redrawLine();
                }).catch(err => {
                    console.error('Paste failed:', err);
                });
                return false;
            }
            return true;
        });
    },
    
    clearCurrentLine: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\r\x1b[K');
        this.writePrompt(terminalId);
    },
    
    handleTabCompletion: function(terminalId, input) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const suggestions = this.getCommandSuggestions(input);
        if (suggestions.length === 1) {
            const completion = suggestions[0];
            terminal.instance.write(completion.substring(input.length));
            terminal.currentInput = completion;
        } else if (suggestions.length > 1) {
            terminal.instance.write('\r\n');
            suggestions.forEach(s => terminal.instance.write(`${s}  `));
            terminal.instance.write('\r\n');
            this.writePrompt(terminalId);
            terminal.instance.write(input);
        }
    },
    
    getCommandSuggestions: function(input) {
        const commands = [
            'help', 'ls', 'cd', 'clear', 'pwd', 'cat', 'echo', 
            'python', 'node', 'npm', 'git', 'mkdir', 'touch', 
            'rm', 'cp', 'mv', 'find', 'grep', 'curl', 'wget'
        ];
        
        const fileSuggestions = this.getFileSuggestions(input);
        return [...commands, ...fileSuggestions].filter(item => 
            item.startsWith(input)
        );
    },
    
    getFileSuggestions: function(input) {
        const parts = input.split(' ');
        if (parts.length < 2) return [];
        
        const lastPart = parts[parts.length - 1];
        if (!lastPart || lastPart.includes('/')) return [];
        
        const pathPrefix = this.terminals[this.activeTerminal]?.currentDir || '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix))
            .map(f => f.substring(pathPrefix.length))
            .filter(f => f.startsWith(lastPart))
            .map(f => parts.slice(0, -1).concat(f).join(' '));
        
        return files;
    },
    
    executeCommand: function(terminalId, input) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const trimmed = input.trim();
        if (!trimmed) {
            this.writePrompt(terminalId);
            return;
        }
        
        terminal.isProcessing = true;
        
        const [cmd, ...args] = trimmed.split(' ');
        const command = cmd.toLowerCase();
        
        // Execute command
        switch(command) {
            case 'help':
                this.showHelp(terminalId);
                break;
                
            case 'ls':
                this.listFiles(terminalId, args);
                break;
                
            case 'cd':
                this.changeDirectory(terminalId, args[0]);
                break;
                
            case 'clear':
                terminal.instance.clear();
                this.writeWelcome(terminalId);
                terminal.isProcessing = false;
                return;
                
            case 'pwd':
                terminal.instance.write(terminal.currentDir + '\r\n');
                break;
                
            case 'cat':
                this.showFile(terminalId, args[0]);
                break;
                
            case 'echo':
                terminal.instance.write(args.join(' ') + '\r\n');
                break;
                
            case 'mkdir':
                this.createDirectory(terminalId, args[0]);
                break;
                
            case 'touch':
                this.createFile(terminalId, args[0]);
                break;
                
            case 'rm':
                this.removeFile(terminalId, args);
                break;
                
            case 'cp':
                this.copyFile(terminalId, args[0], args[1]);
                break;
                
            case 'mv':
                this.moveFile(terminalId, args[0], args[1]);
                break;
                
            case 'find':
                this.findFiles(terminalId, args);
                break;
                
            case 'grep':
                this.grepFiles(terminalId, args);
                break;
                
            case 'curl':
            case 'wget':
                terminal.instance.write(`\x1b[33m${command} is not available in this environment. Use an external terminal.\x1b[0m\r\n`);
                break;
                
            case 'python':
                this.runPython(terminalId, args);
                break;
                
            case 'node':
                this.runNode(terminalId, args);
                break;
                
            case 'npm':
                this.runNpm(terminalId, args);
                break;
                
            case 'git':
                this.runGit(terminalId, args);
                break;
                
            default:
                terminal.instance.write(`\x1b[31mCommand not found: ${cmd}\x1b[0m\r\n`);
                terminal.instance.write('Type \x1b[33mhelp\x1b[0m for available commands\r\n');
        }
        
        terminal.isProcessing = false;
        this.writePrompt(terminalId);
    },
    
    showHelp: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\x1b[1;33mAvailable commands:\x1b[0m\r\n');
        terminal.instance.write('  \x1b[32mhelp\x1b[0m     - Show this help message\r\n');
        terminal.instance.write('  \x1b[32mls\x1b[0m       - List files in current directory\r\n');
        terminal.instance.write('  \x1b[32mcd\x1b[0m       - Change directory\r\n');
        terminal.instance.write('  \x1b[32mclear\x1b[0m    - Clear terminal screen\r\n');
        terminal.instance.write('  \x1b[32mpwd\x1b[0m      - Print working directory\r\n');
        terminal.instance.write('  \x1b[32mcat\x1b[0m      - Display file content\r\n');
        terminal.instance.write('  \x1b[32mecho\x1b[0m     - Print text\r\n');
        terminal.instance.write('  \x1b[32mmkdir\x1b[0m    - Create directory\r\n');
        terminal.instance.write('  \x1b[32mtouch\x1b[0m    - Create file\r\n');
        terminal.instance.write('  \x1b[32mrm\x1b[0m       - Remove files/directories\r\n');
        terminal.instance.write('  \x1b[32mcp\x1b[0m       - Copy file\r\n');
        terminal.instance.write('  \x1b[32mmv\x1b[0m       - Move/rename file\r\n');
        terminal.instance.write('  \x1b[32mfind\x1b[0m     - Find files\r\n');
        terminal.instance.write('  \x1b[32mgrep\x1b[0m     - Search in files\r\n');
        terminal.instance.write('  \x1b[32mpython\x1b[0m   - Run Python code\r\n');
        terminal.instance.write('  \x1b[32mnode\x1b[0m     - Run Node.js code\r\n');
        terminal.instance.write('  \x1b[32mnpm\x1b[0m      - NPM package manager (external terminal required)\r\n');
        terminal.instance.write('  \x1b[32mgit\x1b[0m      - Git version control (external terminal required)\r\n');
        terminal.instance.write('\r\n\x1b[1;33mShortcuts:\x1b[0m\r\n');
        terminal.instance.write('  \x1b[32mCtrl+C\x1b[0m    - Cancel current command\r\n');
        terminal.instance.write('  \x1b[32mCtrl+L\x1b[0m    - Clear terminal\r\n');
        terminal.instance.write('  \x1b[32mCtrl+U\x1b[0m    - Clear line\r\n');
        terminal.instance.write('  \x1b[32mCtrl+A\x1b[0m    - Move to beginning of line\r\n');
        terminal.instance.write('  \x1b[32mCtrl+E\x1b[0m    - Move to end of line\r\n');
        terminal.instance.write('  \x1b[32mTab\x1b[0m       - Auto-complete\r\n');
        terminal.instance.write('  \x1b[32m/ arrows\x1b[0m - Navigate command history\r\n');
    },
    
    listFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const showHidden = args.includes('-a') || args.includes('-la');
        const longFormat = args.includes('-l') || args.includes('-la');
        const showAll = args.includes('-la');
        
        const pathPrefix = terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix) && (showAll || !f.includes('/.')))
            .map(f => {
                const relative = f.substring(pathPrefix.length);
                const parts = relative.split('/');
                return parts.length === 1 ? parts[0] : parts[0] + '/';
            })
            .filter((v, i, a) => a.indexOf(v) === i)
            .sort();
        
        if (files.length === 0) {
            terminal.instance.write('(empty directory)\r\n');
            return;
        }
        
        if (longFormat) {
            // Show detailed listing
            terminal.instance.write('Permissions Size Created Name\r\n');
            terminal.instance.write('   \r\n');
            
            files.forEach(file => {
                const isDir = file.endsWith('/');
                const fullPath = pathPrefix + (isDir ? file.slice(0, -1) : file);
                const size = isDir ? '-' : IDE.state.files[fullPath]?.length || 0;
                const perms = isDir ? 'drwxr-xr-x' : '-rw-r--r--';
                
                terminal.instance.write(
                    `${perms} ${size.toString().padStart(5)} B - ${file.padEnd(30)}\r\n`
                );
            });
        } else {
            // Show compact listing with colors
            let output = '';
            files.forEach(file => {
                const isDir = file.endsWith('/');
                const icon = isDir ? '\x1b[1;34m\x1b[0m' : '\x1b[1;33m\x1b[0m';
                output += `${icon} ${file}  `;
                
                // Limit to 4 items per line
                if (output.split('\r\n').pop().length > 60) {
                    output += '\r\n';
                }
            });
            terminal.instance.write(output + '\r\n');
        }
    },
    
    changeDirectory: function(terminalId, path) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (!path || path === '~') {
            terminal.currentDir = '/';
        } else if (path === '..') {
            if (terminal.currentDir !== '/') {
                const parts = terminal.currentDir.split('/').filter(Boolean);
                parts.pop();
                terminal.currentDir = '/' + parts.join('/');
            }
        } else if (path === '.') {
            // Stay in current directory
        } else {
            const newPath = (terminal.currentDir === '/' ? '' : terminal.currentDir) + '/' + path;
            // Check if "directory" exists (has files with this prefix)
            const hasFiles = Object.keys(IDE.state.files).some(f => 
                f.startsWith(newPath + '/')
            );
            
            if (hasFiles) {
                terminal.currentDir = newPath;
            } else {
                terminal.instance.write(`cd: ${path}: No such directory\r\n`);
            }
        }
    },
    
    showFile: function(terminalId, filename) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !filename) {
            terminal?.instance.write('Usage: cat <filename>\r\n');
            return;
        }
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        const content = FileSystem.read(filePath);
        
        if (content !== undefined) {
            // Show with syntax highlighting for known file types
            const ext = Utils.getExtension(filename);
            if (['js', 'ts', 'py', 'json', 'html', 'css'].includes(ext)) {
                // Add some basic syntax highlighting
                const lines = content.split('\n');
                lines.forEach(line => {
                    // Simple keyword highlighting
                    const highlighted = line
                        .replace(/(function|class|import|export|const|let|var|return|if|else|for|while)/g, '\x1b[1;35m$1\x1b[0m')
                        .replace(/(true|false|null|undefined)/g, '\x1b[1;33m$1\x1b[0m')
                        .replace(/("[^"]*"|'[^']*')/g, '\x1b[1;32m$1\x1b[0m')
                        .replace(/(\/\/.*)/g, '\x1b[90m$1\x1b[0m');
                    
                    terminal.instance.write(highlighted + '\r\n');
                });
            } else {
                terminal.instance.write(content + '\r\n');
            }
        } else {
            terminal.instance.write(`cat: ${filename}: No such file\r\n`);
        }
    },
    
    createDirectory: function(terminalId, dirname) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !dirname) {
            terminal?.instance.write('Usage: mkdir <directory>\r\n');
            return;
        }
        
        const dirPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + dirname + '/.keep';
        FileSystem.write(dirPath, '# Directory created from terminal');
        
        terminal.instance.write(`Directory '${dirname}' created\r\n`);
    },
    
    createFile: function(terminalId, filename) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !filename) {
            terminal?.instance.write('Usage: touch <filename>\r\n');
            return;
        }
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        FileSystem.write(filePath, `# Created from terminal\n# ${new Date().toISOString()}`);
        
        terminal.instance.write(`File '${filename}' created\r\n`);
    },
    
    removeFile: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length === 0) {
            terminal?.instance.write('Usage: rm <file> [-r for directories]\r\n');
            return;
        }
        
        const recursive = args.includes('-r') || args.includes('-rf');
        const files = args.filter(arg => !arg.startsWith('-'));
        
        files.forEach(filename => {
            const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
            
            if (FileSystem.exists(filePath)) {
                FileSystem.delete(filePath, true);
                terminal.instance.write(`Removed: ${filename}\r\n`);
            } else {
                terminal.instance.write(`rm: ${filename}: No such file or directory\r\n`);
            }
        });
    },
    
    copyFile: function(terminalId, source, destination) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !source || !destination) {
            terminal?.instance.write('Usage: cp <source> <destination>\r\n');
            return;
        }
        
        const sourcePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + source;
        const destPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + destination;
        
        if (!FileSystem.exists(sourcePath)) {
            terminal.instance.write(`cp: ${source}: No such file or directory\r\n`);
            return;
        }
        
        const content = FileSystem.read(sourcePath);
        FileSystem.write(destPath, content);
        
        terminal.instance.write(`Copied: ${source} -> ${destination}\r\n`);
    },
    
    moveFile: function(terminalId, source, destination) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !source || !destination) {
            terminal?.instance.write('Usage: mv <source> <destination>\r\n');
            return;
        }
        
        const sourcePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + source;
        const destPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + destination;
        
        if (!FileSystem.exists(sourcePath)) {
            terminal.instance.write(`mv: ${source}: No such file or directory\r\n`);
            return;
        }
        
        FileSystem.moveFile(sourcePath, destPath);
        terminal.instance.write(`Moved: ${source} -> ${destination}\r\n`);
    },
    
    findFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length === 0) {
            terminal?.instance.write('Usage: find <pattern> [-name pattern] [-type f|d]\r\n');
            return;
        }
        
        const namePattern = args[args.indexOf('-name') + 1] || args[0];
        const typeFilter = args[args.indexOf('-type') + 1];
        
        const pathPrefix = terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix))
            .map(f => f.substring(pathPrefix.length))
            .filter(f => {
                // Apply name pattern
                if (namePattern && namePattern !== '*') {
                    const regex = new RegExp(namePattern.replace(/\*/g, '.*'));
                    if (!regex.test(f)) return false;
                }
                
                // Apply type filter
                if (typeFilter === 'f' && f.endsWith('/')) return false;
                if (typeFilter === 'd' && !f.endsWith('/')) return false;
                
                return true;
            })
            .sort();
        
        if (files.length === 0) {
            terminal.instance.write('No files found\r\n');
            return;
        }
        
        files.forEach(file => {
            terminal.instance.write(`./${file}\r\n`);
        });
    },
    
    grepFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length < 2) {
            terminal?.instance.write('Usage: grep <pattern> <file> [-i] [-n]\r\n');
            return;
        }
        
        const pattern = args[0];
        const filename = args[1];
        const caseInsensitive = args.includes('-i');
        const showLineNumbers = args.includes('-n');
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        const content = FileSystem.read(filePath);
        
        if (content === undefined) {
            terminal.instance.write(`grep: ${filename}: No such file\r\n`);
            return;
        }
        
        const regex = new RegExp(pattern, caseInsensitive ? 'gi' : 'g');
        const lines = content.split('\n');
        let matchCount = 0;
        
        lines.forEach((line, index) => {
            if (regex.test(line)) {
                matchCount++;
                const lineNum = showLineNumbers ? `${index + 1}:` : '';
                terminal.instance.write(`${lineNum}${line}\r\n`);
            }
        });
        
        if (matchCount === 0) {
            terminal.instance.write('No matches found\r\n');
        }
    },
    
    runPython: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (args.length === 0) {
            terminal.instance.write('Python interactive mode is not available in this environment.\r\n');
            terminal.instance.write('Tip: run a file with "python <file>" or use the Run button.\r\n');
            return;
        }
        
        const filePath = args[0];
        terminal.instance.write('Python runner: executing in-browser (Pyodide)...\r\n');
        Runner.execute(filePath);
    },
    
    runNode: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (args.length === 0) {
            terminal.instance.write('Node.js interactive mode is not available in this environment.\r\n');
            terminal.instance.write('Tip: run a file with "node <file>" or use the Run button.\r\n');
            return;
        }
        
        const filePath = args[0];
        Runner.execute(filePath);
    },
    
    runNpm: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('npm is not available in this environment. Use an external terminal.\r\n');
    },
    
    runGit: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('git is not available in this environment. Use an external terminal.\r\n');
    },
    
    write: function(text, terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (terminal) {
            terminal.instance.write(text);
        }
    },
    
    clear: function(terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (!terminal) return;
        try {
            if (terminal.instance && typeof terminal.instance.clear === 'function') {
                terminal.instance.clear();
            } else if (terminal.outputEl) {
                terminal.outputEl.textContent = '';
            }
        } catch (e) {
            if (terminal.outputEl) terminal.outputEl.textContent = '';
        }
        this.writeWelcome(id);
    },
    
    fit: function(terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (terminal && terminal.fitAddon) {
            terminal.fitAddon.fit();
        }
    },
    
    createNewTerminal: function() {
        const id = this.createTerminal();
        this.setActiveTerminal(id);
        this.updateTerminalUI();
        return id;
    },
    
    closeTerminal: function(terminalId) {
        if (terminalId === 'default') {
            this.clear(terminalId);
            return;
        }
        
        if (this.terminals[terminalId]) {
            delete this.terminals[terminalId];
            
            // Switch to default terminal if closing active
            if (this.activeTerminal === terminalId) {
                this.setActiveTerminal('default');
            }
            
            this.updateTerminalUI();
        }
    },
    
    updateTerminalUI: function() {
        const terminalCount = Object.keys(this.terminals).length;
        const termBadge = document.getElementById('term-badge');
        if (termBadge) {
            termBadge.textContent = terminalCount;
        }
        
        // Update terminal switcher UI if exists
        // This would show tabs for multiple terminals
},

applySettings: function() {
    try {
        const s = IDE.state.settings.terminal;

        Object.values(this.terminals || {}).forEach(t => {
            const term = t.instance;
            if (!term || !term.setOption) return;

            term.setOption('fontSize', s.fontSize);
            term.setOption('fontFamily', s.fontFamily || "'JetBrains Mono', monospace");
            term.setOption('cursorBlink', !!s.cursorBlink);
            term.setOption('cursorStyle', s.cursorStyle || 'block');

            // Re-fit if possible
            if (t.fitAddon && t.fitAddon.fit) {
                try { t.fitAddon.fit(); } catch(e) {}
            }
        });

    } catch (e) {
        console.warn('Terminal applySettings failed:', e);
    }
}
};

// ============================================
// CONSOLE MANAGER
// ============================================
const Console = {
    maxEntries: 500,
    unreadCount: 0,
    
    getHost: function() {
        return document.getElementById('console-host');
    },
    
    getBadge: function() {
        return document.getElementById('console-badge');
    },
    
    init: function() {
        this.clear();
    },
    
    isConsoleVisible: function() {
        const panel = document.getElementById('panel-btm');
        if (!panel || panel.classList.contains('hidden')) {
            return false;
        }
        return IDE.state.panel === 'console';
    },
    
    formatArg: function(arg) {
        if (arg instanceof Error) {
            return `${arg.name}: ${arg.message}`;
        }
        if (typeof arg === 'object') {
            try {
                return JSON.stringify(arg, null, 2);
            } catch (error) {
                return String(arg);
            }
        }
        return String(arg);
    },
    
    append: function(level, args) {
        const host = this.getHost();
        if (!host) {
            return;
        }
        
        const line = document.createElement('div');
        const safeArgs = Array.isArray(args) ? args : [args];
        const safeLevel = ['log', 'info', 'warn', 'error', 'success'].includes(level) ? level : 'log';
        line.className = `console-line console-${safeLevel}`;
        line.textContent = safeArgs.map((arg) => this.formatArg(arg)).join(' ');
        host.appendChild(line);
        
        while (host.children.length > this.maxEntries) {
            host.removeChild(host.firstChild);
        }
        
        host.scrollTop = host.scrollHeight;
        
        if (!this.isConsoleVisible()) {
            this.unreadCount += 1;
            this.updateBadge();
        } else {
            this.resetBadge();
        }
    },
    
    log: function(...args) {
        this.append('log', args);
    },
    
    info: function(...args) {
        this.append('info', args);
    },
    
    warn: function(...args) {
        this.append('warn', args);
    },
    
    error: function(...args) {
        this.append('error', args);
    },
    
    success: function(...args) {
        this.append('success', args);
    },
    
    clear: function() {
        const host = this.getHost();
        if (host) {
            host.innerHTML = '';
        }
        this.resetBadge();
    },
    
    updateBadge: function() {
        const badge = this.getBadge();
        if (!badge) return;
        
        if (this.unreadCount > 0) {
            badge.textContent = this.unreadCount;
            badge.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
        }
    },
    
    resetBadge: function() {
        this.unreadCount = 0;
        this.updateBadge();
    }
};

// ============================================
// ENHANCED RUNNER (Code Execution)
// ============================================
const Runner = {
    currentProcess: null,
    isRunning: false,
    executionHistory: [],
    _iframeListenerAttached: false,
    
    exec: function(filePath = null) {
        this.execute(filePath);
    },
    
    execute: function(filePath = null) {
        // Token per-run to avoid cross-frame message noise
        this._previewToken = (window.crypto && crypto.randomUUID)
            ? crypto.randomUUID()
            : `${Date.now()}-${Math.random().toString(16).slice(2)}`;

        const path = filePath || IDE.state.activeTab;
        if (!path) {
            Utils.toast('No file to run', 'error');
            return;
        }
        
        if (!FileSystem.exists(path)) {
            Utils.toast(`File not found: ${path}`, 'error');
            return;
        }
        
        const ext = Utils.getExtension(path);
        
        // Add to execution history
        this.executionHistory.push({
            path: path,
            timestamp: new Date().toISOString(),
            type: ext
        });
        
        // Keep only last 50 executions
        if (this.executionHistory.length > 50) {
            this.executionHistory.shift();
        }
        
        switch(ext) {
            case 'html':
            case 'css':
            case 'js':
            case 'jsx':
            case 'ts':
            case 'tsx':
            case 'vue':
                this.runWeb(path);
                break;
                
            case 'py':
                this.runPython(path);
                break;
                
            default:
                Utils.toast(`Cannot run .${ext} files`, 'error');
        }
    },
    
    runWeb: function(path) {
        this.isRunning = true;
        this.lastInlineWarnings = [];
        
        // Show preview panel
        LayoutManager.toggleLayout('preview', true);
        
        const frame = document.getElementById('preview-frame');
        const isHtml = path.endsWith('.html');
        
        let html = '';
        
        if (isHtml) {
            html = FileSystem.read(path);
            html = this.inlineHtmlAssets(html, path);
            html = this.inlineHtmlModules(html, path);
            html = this.injectPreviewBridge(html);
        } else {
            html = this.createHtmlWrapper(path);
        }
        
        // Set iframe source
        frame.srcdoc = html;
        frame.onload = () => {
            this.updateRunButton(false);
        };
        
        // Update console
        Console.clear();
        if (this.lastInlineWarnings && this.lastInlineWarnings.length) {
            this.lastInlineWarnings.forEach((message) => Console.warn(message));
        }
        Console.info(` Running ${path.split('/').pop()}...`);
        Console.info(` File: ${path}`);
        Console.info(` Preview opened in panel`);
        Console.info('-'.repeat(50));
        
        // Listen for console messages from iframe
        if (!this._iframeListenerAttached) {
            window.addEventListener('message', this.handleIframeMessage);
            this._iframeListenerAttached = true;
        }
        
        Utils.toast('Running web application', 'success');
        
        // Update run button
        this.updateRunButton(true);
    },
    
    handleIframeMessage: function(event) {
        const frame = document.getElementById('preview-frame');
        if (frame && event.source !== frame.contentWindow) {
            return;
        }
        
        const data = event.data;
        if (!data || typeof data !== 'object') {
            return;
        }
        
        // Ignore messages from old/foreign frames
        if (Runner._previewToken && data.token !== Runner._previewToken) {
            return;
        }
        
        if (data.type === 'console') {
            const level = data.level || 'log';
            const args = Array.isArray(data.args) ? data.args : [data.args];
            Console.append(level, args);
            return;
        }
        
        if (data.type === 'load') {
            if (data.executionTime) {
                Console.info(`Execution time: ${data.executionTime}ms`);
            } else {
                Console.info('Preview loaded');
            }
            Runner.updateRunButton(false);
        }
    },
    
    inlineHtmlAssets: function(html, htmlPath) {
        this.lastInlineWarnings = [];
        const baseDir = htmlPath.includes('/') ? htmlPath.slice(0, htmlPath.lastIndexOf('/')) : '';
        const isRemote = (url) => /^(https?:)?\/\//i.test(url) || url.startsWith('data:') || url.startsWith('blob:') || url.startsWith('mailto:') || url.startsWith('tel:');
        const hasModuleSyntax = (code) => this.hasModuleSyntax(code);
        const normalizePath = (path) => {
            const parts = path.split('/').filter(Boolean);
            const stack = [];
            for (const part of parts) {
                if (part === '.') continue;
                if (part === '..') {
                    stack.pop();
                } else {
                    stack.push(part);
                }
            }
            return stack.join('/');
        };
        const resolvePath = (url) => {
            if (url.startsWith('/')) return normalizePath(url.slice(1));
            if (!baseDir) return normalizePath(url);
            return normalizePath(`${baseDir}/${url}`);
        };
        const readSafe = (filePath) => {
            try {
                return FileSystem.read(filePath);
            } catch (_) {
                return null;
            }
        };
        const warn = (message) => {
            this.lastInlineWarnings.push(message);
        };

        let updated = html;

        // Inline url(...) assets inside CSS when those assets exist as data: URLs in FileSystem
        const resolveFromDir = (dir, url) => {
            if (url.startsWith('/')) return normalizePath(url.slice(1));
            if (!dir) return normalizePath(url);
            return normalizePath(`${dir}/${url}`);
        };

        const dataUrlForUrl = (rawUrl, dirForRel = baseDir) => {
            const href = String(rawUrl || '').trim();
            if (!href || href.startsWith('#') || isRemote(href)) return null;
            const clean = href.split('#')[0].split('?')[0].trim();
            if (!clean) return null;
            const filePath = resolveFromDir(dirForRel, clean);
            const content = readSafe(filePath);
            if (typeof content !== 'string') return null;
            if (content.startsWith('data:')) return content;
            // Allow plain SVG markup stored as text
            if (filePath.toLowerCase().endsWith('.svg')) {
                const t = content.trim();
                if (t.startsWith('<svg')) {
                    return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(t)}`;
                }
            }
            return null;
        };

        const inlineCssUrls = (cssText, cssPath) => {
            const cssDir = cssPath && cssPath.includes('/') ? cssPath.slice(0, cssPath.lastIndexOf('/')) : baseDir;
            return String(cssText || '').replace(/url\(\s*(['"]?)([^'")]+)\1\s*\)/gi, (m, q, u) => {
                const du = dataUrlForUrl(u, cssDir);
                return du ? `url("${du}")` : m;
            });
        };

        const rewriteSrcSet = (srcset, dirForRel) => {
            if (!srcset) return srcset;
            return srcset.split(',')
                .map(part => {
                    const trimmed = part.trim();
                    if (!trimmed) return trimmed;
                    const bits = trimmed.split(/\s+/);
                    const url = bits[0];
                    const du = dataUrlForUrl(url, dirForRel);
                    if (du) bits[0] = du;
                    return bits.join(' ');
                })
                .join(', ');
        };


        updated = updated.replace(/<link\b[^>]*rel=["']?stylesheet["']?[^>]*>/gi, (match) => {
            const hrefMatch = match.match(/href=["']([^"']+)["']/i);
            if (!hrefMatch) return match;
            const href = hrefMatch[1].trim();
            const cleanHref = href.split('#')[0].split('?')[0];
            if (!cleanHref || href.startsWith('#') || isRemote(href)) return match;

            const filePath = resolvePath(cleanHref);
            const css = readSafe(filePath);
            if (css === null) {
                warn(`Missing stylesheet: ${filePath}`);
                return '';
            }

            const inlinedCss = inlineCssUrls(css, filePath);
            const safeCss = inlinedCss.replace(/<\/style>/gi, '<\\/style>');
            return `<style data-inline="${filePath}">\n${safeCss}\n
</style>`;
        });

        updated = updated.replace(/<script\b([^>]*)\bsrc=["']([^"']+)["']([^>]*)>\s*<\/script>/gi, (match, before, src, after) => {
            const href = src.trim();
            const cleanHref = href.split('#')[0].split('?')[0];
            if (!cleanHref || href.startsWith('#') || isRemote(href)) return match;

            const filePath = resolvePath(cleanHref);
            const js = readSafe(filePath);
            if (js === null) {
                warn(`Missing script: ${filePath}`);
                return '';
            }
            const ext = Utils.getExtension(filePath);
            // Allow TS/TSX/JSX in preview (best-effort transpile)
            if (ext && !['js', 'mjs', 'ts', 'tsx', 'jsx'].includes(ext)) {
                warn(`Unsupported script type for preview: ${filePath}. Use a bundler or UMD template.`);
                return '';
            }

            const attrsRaw = `${before} ${after}`;
            const isModule = /\btype=["']module["']/.test(attrsRaw);

            // Transpile for preview when needed
            let scriptBody = js;
            try {
                if (ext === 'ts' && window.ts && ts.transpileModule) {
                    scriptBody = ts.transpileModule(js, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2020,
                            module: ts.ModuleKind.ESNext
                        }
                    }).outputText;
                } else if (ext === 'tsx' && window.ts && ts.transpileModule) {
                    // TS compiler can transpile TSX (React)
                    scriptBody = ts.transpileModule(js, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2020,
                            module: ts.ModuleKind.ESNext,
                            jsx: ts.JsxEmit.ReactJSX
                        }
                    }).outputText;
                } else if ((ext === 'tsx' || ext === 'jsx') && window.Babel && Babel.transform) {
                    const presets = [];
                    if (ext === 'tsx') presets.push('typescript');
                    presets.push('react');
                    scriptBody = Babel.transform(js, { presets }).code;
                }
            } catch (e) {
                warn(`Transpile failed for ${filePath}: ${e && e.message ? e.message : e}`);
                scriptBody = js;
            }

            const needsModule = isModule || hasModuleSyntax(scriptBody);

            //  Keep ESM module syntax; we'll fix relative imports + inject import map later (inlineHtmlModules)
            const safeJs = scriptBody.replace(/<\/script>/gi, '<\\/script>');
            let attrs = attrsRaw.replace(/\bsrc=["'][^"']+["']/i, '');

            if (needsModule) {
                // Ensure module type is present
                if (!/\btype=["']module["']/.test(attrs)) {
                    attrs = (attrs + ' type="module"').trim();
                } else {
                    attrs = attrs.trim();
                }
            } else {
                // Remove accidental module flag for classic scripts
                attrs = attrs.replace(/\btype=["']module["']\b/i, '').trim();
            }

            const attrText = attrs ? ` ${attrs}` : '';
            const pcSrc = needsModule ? ` data-pc-src="${filePath}"` : '';
            return `<script data-inline="${filePath}"${pcSrc}${attrText}>\n${safeJs}\n<\/script>`;
        });

        updated = updated.replace(/<script\b([^>]*)>([\s\S]*?)<\/script>/gi, (match, attrs, body) => {
            if (/\bsrc=["']/.test(attrs) || /\bdata-inline=/.test(attrs)) {
                return match;
            }
            const isModule = /\btype=["']module["']/.test(attrs);
            const code = body.trim();
            if (!code) return match;
            if (!isModule && !hasModuleSyntax(code)) return match;

            const stripped = this.stripModuleSyntax(code);
            stripped.warnings.forEach((message) => warn(message));
            const cleaned = stripped.code.trim();
            if (!cleaned) {
                warn('Removed inline module script from preview');
                return '';
            }
            if (hasModuleSyntax(cleaned)) {
                warn('Inline module script still contains imports/exports');
                return '';
            }

            let newAttrs = attrs;
            if (isModule) {
                newAttrs = newAttrs.replace(/\btype=["']module["']\b/i, '');
            }
            newAttrs = newAttrs.trim();
            const attrText = newAttrs ? ` ${newAttrs}` : '';
            const safeBody = cleaned.replace(/<\/script>/gi, '<\\/script>');
            return `<script${attrText}>\n${safeBody}\n<\/script>`;
        });

        // Inline local asset URLs for images/fonts/media when stored as data URLs in FileSystem
        updated = updated.replace(/<img\b([^>]*)\bsrc=["']([^"']+)["']([^>]*)>/gi, (m, b, src, a) => {
            const du = dataUrlForUrl(src, baseDir);
            return du ? `<img${b}src="${du}"${a}>` : m;
        });
        updated = updated.replace(/<img\b([^>]*)\bsrcset=["']([^"']+)["']([^>]*)>/gi, (m, b, srcset, a) => {
            const next = rewriteSrcSet(srcset, baseDir);
            return next ? `<img${b}srcset="${next}"${a}>` : m;
        });
        updated = updated.replace(/<source\b([^>]*)\bsrc=["']([^"']+)["']([^>]*)>/gi, (m, b, src, a) => {
            const du = dataUrlForUrl(src, baseDir);
            return du ? `<source${b}src="${du}"${a}>` : m;
        });
        updated = updated.replace(/<source\b([^>]*)\bsrcset=["']([^"']+)["']([^>]*)>/gi, (m, b, srcset, a) => {
            const next = rewriteSrcSet(srcset, baseDir);
            return next ? `<source${b}srcset="${next}"${a}>` : m;
        });
        updated = updated.replace(/<(audio|video)\b([^>]*)\bsrc=["']([^"']+)["']([^>]*)>/gi, (m, tag, b, src, a) => {
            const du = dataUrlForUrl(src, baseDir);
            return du ? `<${tag}${b}src="${du}"${a}>` : m;
        });
        updated = updated.replace(/<link\b([^>]*)\bhref=["']([^"']+)["']([^>]*)>/gi, (m, b, href, a) => {
            // Avoid touching stylesheet (already handled above) and remote URLs
            if (/\brel=["']?stylesheet["']?/i.test(m)) return m;
            const relMatch = m.match(/\brel=["']([^"']+)["']/i);
            const rel = (relMatch ? relMatch[1] : '').toLowerCase();
            const isIcon = rel.includes('icon');
            const isPreloadAsset = rel === 'preload' && /\bas=["']?(font|image|audio|video)["']?/i.test(m);
            const isManifest = rel === 'manifest';
            if (!(isIcon || isPreloadAsset || isManifest)) return m;
            const du = dataUrlForUrl(href, baseDir);
            return du ? `<link${b}href="${du}"${a}>` : m;
        });

        return updated;
    },

    inlineHtmlModules: function(html, htmlPath) {
        // Add real ESM support inside srcdoc previews:
        // - Rewrite relative import specifiers to absolute "/path" based on module file location
        // - Inject an import map that maps "/path" -> data:text/javascript URL of that file
        // Works for local project modules (JS/MJS/TS/TSX/JSX) without bundlers (best-effort).
        try {
            const src = String(html || '');
            if (!/\btype=["']module["']/.test(src)) return src;

            const baseDir = htmlPath && htmlPath.includes('/') ? htmlPath.slice(0, htmlPath.lastIndexOf('/')) : '';
            const isRemote = (u) => /^(https?:)?\/\//i.test(String(u||'')) || String(u||'').startsWith('data:') || String(u||'').startsWith('blob:');

            const normalizePath = (p) => {
                const parts = String(p || '').split('/').filter(Boolean);
                const stack = [];
                for (const part of parts) {
                    if (part === '.') continue;
                    if (part === '..') stack.pop();
                    else stack.push(part);
                }
                return stack.join('/');
            };

            const dirOf = (p) => (p && p.includes('/')) ? p.slice(0, p.lastIndexOf('/')) : '';
            const resolveFromDir = (dir, u) => {
                const url = String(u || '').trim();
                if (url.startsWith('/')) return normalizePath(url.slice(1));
                if (!dir) return normalizePath(url);
                return normalizePath(`${dir}/${url}`);
            };

            const readSafe = (filePath) => {
                try { return FileSystem.read(filePath); } catch { return null; }
            };

            const existsSafe = (filePath) => {
                try { return FileSystem.exists(filePath); } catch { return false; }
            };

            const asDataUrlJS = (code) => `data:text/javascript;charset=utf-8,${encodeURIComponent(String(code || ''))}`;

            const compileForModule = (path, content) => {
                const ext = Utils.getExtension(path);
                let js = String(content || '');
                try {
                    if (ext === 'ts' && window.ts && ts.transpileModule) {
                        js = ts.transpileModule(js, {
                            compilerOptions: { target: ts.ScriptTarget.ES2020, module: ts.ModuleKind.ESNext }
                        }).outputText;
                    } else if (ext === 'tsx' && window.ts && ts.transpileModule) {
                        js = ts.transpileModule(js, {
                            compilerOptions: { target: ts.ScriptTarget.ES2020, module: ts.ModuleKind.ESNext, jsx: ts.JsxEmit.ReactJSX }
                        }).outputText;
                    } else if ((ext === 'tsx' || ext === 'jsx') && window.Babel && Babel.transform) {
                        const presets = [];
                        if (ext === 'tsx') presets.push('typescript');
                        presets.push('react');
                        js = Babel.transform(js, { presets }).code;
                    }
                } catch (e) {
                    // keep original
                    try { Runner.lastInlineWarnings.push(`Module transpile failed: ${path}: ${e && e.message ? e.message : e}`); } catch {}
                }
                return js;
            };

            const resolveSpec = (spec, fromPath) => {
                const s = String(spec || '').trim();
                if (!s || s.startsWith('#') || isRemote(s)) return s;

                // Leave bare specifiers alone (react, lodash, etc.)
                const isRelative = s.startsWith('./') || s.startsWith('../');
                const isAbs = s.startsWith('/');
                if (!isRelative && !isAbs) return s;

                const fromDir = dirOf(fromPath || '');
                let candidate = resolveFromDir(isAbs ? '' : fromDir, s);
                // best-effort extension resolution
                const candidates = [candidate, `${candidate}.js`, `${candidate}.mjs`, `${candidate}.ts`, `${candidate}.tsx`, `${candidate}.jsx`, `${candidate}/index.js`, `${candidate}/index.ts`, `${candidate}/index.tsx`];
                for (const c of candidates) {
                    if (existsSafe(c)) {
                        candidate = c;
                        break;
                    }
                }
                return '/' + candidate.replace(/^\/+/, '');
            };

            const rewriteImports = (code, fromPath) => {
                let out = String(code || '');

                // import ... from "x" / export ... from "x"
                out = out.replace(/\b(import|export)\s+([^'"]*?)\sfrom\s*(['"])([^'"]+)\3/g, (m, kw, mid, q, spec) => {
                    const r = resolveSpec(spec, fromPath);
                    return `${kw} ${mid} from ${q}${r}${q}`;
                });

                // import "x"
                out = out.replace(/\bimport\s*(['"])([^'"]+)\1/g, (m, q, spec) => {
                    const r = resolveSpec(spec, fromPath);
                    return `import ${q}${r}${q}`;
                });

                // dynamic import("x")
                out = out.replace(/\bimport\s*\(\s*(['"])([^'"]+)\1\s*\)/g, (m, q, spec) => {
                    const r = resolveSpec(spec, fromPath);
                    return `import(${q}${r}${q})`;
                });

                return out;
            };

            // Build import map for all local module-like files
            const allPaths = Object.keys(IDE.state.files || {});
            const moduleLike = allPaths.filter(p => /\.(mjs|js|ts|tsx|jsx)$/i.test(p));
            const imports = {};

            for (const p of moduleLike) {
                const raw = readSafe(p);
                if (typeof raw !== 'string') continue;
                // Skip binary data URLs that are not JS
                if (raw.startsWith('data:') && !/^data:(text|application)\/(javascript|ecmascript)/i.test(raw)) continue;

                let code = raw;
                if (code.startsWith('data:')) {
                    // Keep as-is; assume it's already a usable JS data URL
                    imports['/' + p.replace(/^\/+/, '')] = code;
                    continue;
                }

                code = compileForModule(p, code);
                code = rewriteImports(code, p);

                imports['/' + p.replace(/^\/+/, '')] = asDataUrlJS(code);
            }

            const importMapJson = JSON.stringify({ imports });

            const injectImportMap = (h) => {
                if (!importMapJson || importMapJson.length < 20) return h;
                // Insert right after <head ...>
                const headOpen = h.match(/<head\b[^>]*>/i);
                if (headOpen) {
                    const idx = headOpen.index + headOpen[0].length;
                    return h.slice(0, idx) + `\n<script type="importmap">${importMapJson}<\/script>\n` + h.slice(idx);
                }
                // If no head tag, prepend
                return `<head><script type="importmap">${importMapJson}<\/script></head>\n` + h;
            };

            let outHtml = src;

            // Inline <script type="module" src="..."> so it doesn't try to fetch in srcdoc
            outHtml = outHtml.replace(/<script\b([^>]*\btype=["']module["'][^>]*)\bsrc=["']([^"']+)["']([^>]*)>\s*<\/script>/gi,
                (m, before, srcUrl, after) => {
                    const href = String(srcUrl || '').trim();
                    if (!href || isRemote(href) || href.startsWith('#')) return m;

                    const filePath = resolveFromDir(baseDir, href.split('#')[0].split('?')[0]);
                    const raw = readSafe(filePath);
                    if (raw === null) {
                        try { Runner.lastInlineWarnings.push(`Missing module script: ${filePath}`); } catch {}
                        return '';
                    }

                    let code = String(raw || '');
                    if (!code.startsWith('data:')) {
                        code = compileForModule(filePath, code);
                        code = rewriteImports(code, filePath);
                    } else {
                        // If it's a JS data URL, just keep as-is by inlining a redirect import
                        return `<script type="module">import("${'/' + filePath.replace(/^\/+/, '')}")<\/script>`;
                    }

                    const safe = code.replace(/<\/script>/gi, '<\\\\/script>');
                    // keep other attrs besides src
                    let attrs = `${before} ${after}`.replace(/\bsrc=["'][^"']+["']/i, '').trim();
                    if (!/\btype=["']module["']/.test(attrs)) attrs = (attrs + ' type="module"').trim();
                    const attrText = attrs ? ` ${attrs}` : '';
                    return `<script data-pc-src="${filePath}"${attrText}>\n${safe}\n<\/script>`;
                });

            // Rewrite inline module blocks (relative imports -> absolute)
            outHtml = outHtml.replace(/<script\b([^>]*\btype=["']module["'][^>]*)>([\s\S]*?)<\/script>/gi,
                (m, attrs, body) => {
                    // Skip the import map itself
                    if (/\btype=["']importmap["']/.test(attrs)) return m;
                    const from = (attrs.match(/\bdata-pc-src=["']([^"']+)["']/i) || [])[1] || htmlPath;
                    let code = String(body || '');
                    // don't touch JS data URL redirect snippets
                    if (code.includes('PROCODE_PREVIEW_BRIDGE')) return m;
                    code = rewriteImports(code, from);
                    const safe = code.replace(/<\/script>/gi, '<\\\\/script>');
                    return `<script${attrs}>\n${safe}\n<\/script>`;
                });

            // Inject import map at the end so it appears before module scripts in DOM order
            outHtml = injectImportMap(outHtml);

            // Warn about common bare imports that won't resolve without bundlers
            try {
                const bare = [];
                for (const p of moduleLike) {
                    const c = readSafe(p);
                    if (!c || typeof c !== 'string' || c.startsWith('data:')) continue;
                    const rx = /\bimport\s*(?:[^'"]*?\sfrom\s*)?['"]([^'"]+)['"]/g;
                    let mm;
                    while ((mm = rx.exec(c))) {
                        const s = mm[1];
                        if (s && !s.startsWith('.') && !s.startsWith('/') && !isRemote(s) && !s.startsWith('#')) bare.push({ p, s });
                        if (bare.length > 20) break;
                    }
                    if (bare.length > 20) break;
                }
                if (bare.length) {
                    Runner.lastInlineWarnings.push(`Bare module imports won't resolve in srcdoc (needs bundler): ` + bare.slice(0, 6).map(x => `${x.s} in ${x.p}`).join(', '));
                }
            } catch {}

            return outHtml;
        } catch (e) {
            try { this.lastInlineWarnings.push(`ESM preview failed: ${e && e.message ? e.message : e}`); } catch {}
            return String(html || '');
        }
    },


    hasModuleSyntax: function(code) {
        return (
            /^\s*(import\s+|export\s+)/m.test(code) ||
            /\brequire\s*\(/.test(code) ||
            /\bmodule\.exports\b/.test(code) ||
            /\bexports\./.test(code)
        );
    },

// Thay th trong Runner object
stripModuleSyntax: function(code) {
    const warnings = [];
    const lines = code.split(/\r?\n/);
    const kept = [];
    let inMultilineImport = false;
    let inMultilineExport = false;
    let multilineBuffer = '';
    let braceCount = 0;

    lines.forEach((line, index) => {
        const trimmed = line.trim();
        
        // Handle multiline imports
        if (inMultilineImport) {
            multilineBuffer += ' ' + trimmed;
            
            // Count braces  detect end
            braceCount += (trimmed.match(/{/g) || []).length;
            braceCount -= (trimmed.match(/}/g) || []).length;
            
            if (braceCount === 0 && (trimmed.includes(';') || trimmed.includes('from'))) {
                inMultilineImport = false;
                warnings.push(`Stripped multiline import: ${multilineBuffer.substring(0, 60)}...`);
                multilineBuffer = '';
            }
            return;
        }
        
        // Handle multiline exports
        if (inMultilineExport) {
            multilineBuffer += ' ' + trimmed;
            braceCount += (trimmed.match(/{/g) || []).length;
            braceCount -= (trimmed.match(/}/g) || []).length;
            
            if (braceCount === 0) {
                inMultilineExport = false;
                warnings.push(`Stripped multiline export: ${multilineBuffer.substring(0, 60)}...`);
                multilineBuffer = '';
            }
            return;
        }
        
        // Import statements - IMPROVED DETECTION
        if (/^\s*import\s/.test(trimmed)) {
            // Check if complete statement
            if (!trimmed.includes(';') && !trimmed.includes('from') && trimmed.includes('{')) {
                inMultilineImport = true;
                multilineBuffer = trimmed;
                braceCount = (trimmed.match(/{/g) || []).length - (trimmed.match(/}/g) || []).length;
            } else {
                warnings.push(`Stripped import: ${trimmed.substring(0, 60)}${trimmed.length > 60 ? '...' : ''}`);
            }
            return;
        }
        
        // Dynamic imports - KEEP THEM (they can work in browser)
        if (/import\s*\(/.test(trimmed)) {
            warnings.push(`Dynamic import detected (kept): ${trimmed.substring(0, 60)}...`);
            kept.push(line);
            return;
        }
        
        // Export default - IMPROVED
        if (/^\s*export\s+default\s+/.test(trimmed)) {
            const match = trimmed.match(/^\s*export\s+default\s+(class|function|const|let|var)\s+(\w+)/);
            if (match) {
                warnings.push(`Converted export default ${match[1]}: ${match[2]}`);
                kept.push(line.replace(/^\s*export\s+default\s+/, ''));
            } else if (/^\s*export\s+default\s+{/.test(trimmed)) {
                // Export default object
                warnings.push(`Stripped export default object`);
                const replaced = line.replace(/^\s*export\s+default\s+/, 'const __default_export__ = ');
                kept.push(replaced);
            } else {
                warnings.push(`Stripped export default: ${trimmed}`);
                kept.push(line.replace(/^\s*export\s+default\s+/, 'const __default_export__ = '));
            }
            return;
        }
        
        // Export lists
        if (/^\s*export\s+{/.test(trimmed)) {
            if (!trimmed.includes('}')) {
                inMultilineExport = true;
                multilineBuffer = trimmed;
                braceCount = 1;
            } else {
                warnings.push(`Stripped export list: ${trimmed}`);
            }
            return;
        }
        
        // Named exports
        if (/^\s*export\s+(const|let|var|function|class|async\s+function)\s+/.test(trimmed)) {
            warnings.push(`Stripped export keyword from: ${trimmed.substring(0, 60)}`);
            kept.push(line.replace(/^\s*export\s+/, ''));
            return;
        }
        
        // Re-exports (export ... from ...)
        if (/^\s*export\s+.*\s+from\s+/.test(trimmed)) {
            warnings.push(`Stripped re-export: ${trimmed}`);
            return;
        }
        
        // CommonJS - IMPROVED DETECTION
        if (/\b(require\s*\(|module\.exports|exports\.)/.test(trimmed)) {
            // Check if it's in a comment
            if (/^\s*(\/\/|\/\*)/.test(trimmed)) {
                kept.push(line);
                return;
            }
            
            if (/module\.exports\s*=/.test(trimmed) || /exports\.\w+\s*=/.test(trimmed)) {
                warnings.push(`Removed module.exports: ${trimmed}`);
                return;
            }
            
            if (/\brequire\s*\(/.test(trimmed)) {
                warnings.push(`Removed require() call: ${trimmed}`);
                return;
            }
        }
        
        kept.push(line);
    });

    return { 
        code: kept.join('\n'), 
        warnings: warnings,
        hasRemainingModuleSyntax: this.hasModuleSyntax(kept.join('\n'))
    };
},

    injectPreviewBridge: function(html) {
        try {
            if (!html || typeof html !== 'string') return html;
            if (html.includes('PROCODE_PREVIEW_BRIDGE')) return html;

            const tokenJson = JSON.stringify(this._previewToken || '');
            const bridge = `
<script>
/* PROCODE_PREVIEW_BRIDGE */
(function(){
  const PREVIEW_TOKEN = ${tokenJson};
  function safe(v){
    try{
      if (typeof v === 'string') return v;
      if (v instanceof Error) return v.name + ': ' + v.message;
      return JSON.stringify(v);
    }catch(e){
      try { return String(v); } catch (_) { return '[Unserializable]'; }
    }
  }
  function send(level, args){
    try{
      window.parent.postMessage({
        token: PREVIEW_TOKEN,
        type: 'console',
        level: level,
        args: (args || []).map(safe)
      }, '*');
    }catch(e){}
  }
  const native = { log: console.log, warn: console.warn, error: console.error, info: console.info };
  ['log','warn','error','info'].forEach(level=>{
    console[level] = function(...args){
      try { native[level].apply(console, args); } catch(e){}
      send(level, args);
    };
  });
  window.addEventListener('error', (e) => {
    send('error', [e.message || 'Error', { filename: e.filename, lineno: e.lineno, colno: e.colno }]);
  });
  window.addEventListener('unhandledrejection', (e) => {
    send('error', ['Unhandled Promise Rejection', e.reason]);
  });
  // --- Inspector support (parent <-> iframe) ---
  let __pc_inspector_on = false;
  let __pc_hl = null;
  function __pc_cssEscape(x){ return String(x||'').replace(/[^a-zA-Z0-9_-]/g,''); }
  function __pc_selector(el){
    try{
      if (!el || el.nodeType !== 1) return '';
      if (el.id) return '#' + __pc_cssEscape(el.id) || ('#' + el.id);
      const parts=[];
      let cur = el;
      while(cur && cur.nodeType===1 && parts.length<7){
        let sel = cur.tagName.toLowerCase();
        const cls = cur.classList ? Array.from(cur.classList).slice(0,3).map(__pc_cssEscape).filter(Boolean) : [];
        if (cls.length) sel += '.' + cls.join('.');
        const p = cur.parentElement;
        if (p){
          const same = Array.from(p.children).filter(n => n.tagName === cur.tagName);
          if (same.length > 1) sel += ':nth-of-type(' + (same.indexOf(cur)+1) + ')';
        }
        parts.unshift(sel);
        cur = p;
      }
      return parts.join(' > ');
    }catch(e){ return ''; }
  }
  function __pc_highlight(el){
    try{
      if (!el || el.nodeType !== 1) return;
      if (!__pc_hl){
        __pc_hl = document.createElement('div');
        __pc_hl.id = '__procode_inspector_hl__';
        __pc_hl.style.cssText = 'position:fixed;z-index:2147483647;pointer-events:none;border:2px solid #6366f1;background:rgba(99,102,241,0.12);border-radius:4px;box-sizing:border-box;';
        document.documentElement.appendChild(__pc_hl);
      }
      const r = el.getBoundingClientRect();
      __pc_hl.style.left = r.left + 'px';
      __pc_hl.style.top = r.top + 'px';
      __pc_hl.style.width = Math.max(0, r.width) + 'px';
      __pc_hl.style.height = Math.max(0, r.height) + 'px';
    }catch(e){}
  }
  function __pc_info(el){
    try{
      const r = el.getBoundingClientRect();
      const cs = getComputedStyle(el);
      const attrs = {};
      try { for (const a of Array.from(el.attributes||[])) { if (a && a.name) attrs[a.name]=a.value; } } catch(_){}
      return {
        tag: el.tagName.toLowerCase(),
        selector: __pc_selector(el),
        text: (el.innerText || el.textContent || '').trim().slice(0, 500),
        html: (el.outerHTML || '').slice(0, 2000),
        rect: { x: r.x, y: r.y, width: r.width, height: r.height },
        styles: {
          display: cs.display,
          position: cs.position,
          color: cs.color,
          background: cs.backgroundColor,
          font: cs.font,
          margin: cs.margin,
          padding: cs.padding
        },
        attrs
      };
    }catch(e){ return { error: String(e) }; }
  }
  function __pc_onClick(e){
    if(!__pc_inspector_on) return;
    try{
      e.preventDefault(); e.stopPropagation();
      const el = e.target;
      __pc_highlight(el);
      window.parent.postMessage({ token: PREVIEW_TOKEN, type: 'inspector', payload: __pc_info(el) }, '*');
    }catch(err){}
  }
  function __pc_onMove(e){
    if(!__pc_inspector_on) return;
    try{ __pc_highlight(e.target); } catch(_){}
  }
  window.addEventListener('message', (e) => {
    const d = e.data;
    if (!d || typeof d !== 'object' || d.token !== PREVIEW_TOKEN) return;
    if (d.type === 'inspector-toggle') {
      __pc_inspector_on = !!d.enabled;
      try { document.documentElement.style.cursor = __pc_inspector_on ? 'crosshair' : ''; } catch(_){}
      if (__pc_inspector_on) {
        window.addEventListener('click', __pc_onClick, true);
        window.addEventListener('mousemove', __pc_onMove, true);
      } else {
        window.removeEventListener('click', __pc_onClick, true);
        window.removeEventListener('mousemove', __pc_onMove, true);
      }
      try { window.parent.postMessage({ token: PREVIEW_TOKEN, type: 'inspector', payload: { enabled: __pc_inspector_on } }, '*'); } catch(_){}
    }
    if (d.type === 'inspect-selector' && d.selector) {
      try { const el = document.querySelector(d.selector); if (el) __pc_highlight(el); } catch(_){}
    }
  });
  window.addEventListener('load', () => {
    try {
      window.parent.postMessage({ token: PREVIEW_TOKEN, type: 'load', executionTime: 0 }, '*');
    } catch(e){}
  });
})();
<\/script>
`;
            if (/<\/body>/i.test(html)) return html.replace(/<\/body>/i, bridge + '</body>');
            if (/<\/html>/i.test(html)) return html.replace(/<\/html>/i, bridge + '</html>');
            return html + bridge;
        } catch (e) {
            return html;
        }
    },

    createHtmlWrapper: function(path) {
        const fileName = path.split('/').pop();
        const content = FileSystem.read(path);
        const ext = Utils.getExtension(path);
        
        let processedCode = content;
        let additionalScripts = '';
        let additionalStyles = '';
        const moduleWarning = (label) =>
            'console.error("Module imports/exports detected in ' + label + '. The preview cannot resolve modules. Use a UMD template or run a bundler.");';
        const indentLines = (value, spaces) => value
            .split('\n')
            .map(line => ' '.repeat(spaces) + line)
            .join('\n');
        
        // Process based on file type
        switch (ext) {
            case 'jsx':
            case 'tsx':
                try {
                    const babelPresets = ext === 'tsx'
                        ? [['env', { modules: false }], 'react', ['typescript', { isTSX: true, allExtensions: true }]]
                        : [['env', { modules: false }], 'react'];
                    processedCode = Babel.transform(content, {
                        presets: babelPresets,
                        filename: path
                    }).code;
                    additionalScripts = '<script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>\n' +
                                       '<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>';
                } catch (error) {
                    Console.error(`JSX Transpilation Error: ${error.message}`);
                    processedCode = `console.error("JSX Transpilation Error: ${error.message}");`;
                }
                break;
                
            case 'ts':
                try {
                    processedCode = ts.transpileModule(content, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2020,
                            module: ts.ModuleKind.None
                        }
                    }).outputText;
                } catch (error) {
                    Console.error(`TypeScript Compilation Error: ${error.message}`);
                    processedCode = `console.error("TypeScript Compilation Error: ${error.message}");`;
                }
                break;
                
            case 'css': {
                const safeCss = content.replace(/<\/style>/gi, '<\\/style>');
                additionalStyles = `<style>\n${safeCss}\n
</style>`;
                processedCode = '';
                break;
            }

            case 'vue':
                try {
                    // Simple Vue template compilation
                    const templateMatch = content.match(/<template>([\s\S]*?)<\/template>/);
                    const scriptTagMatch = content.match(/<script([^>]*)>([\s\S]*?)<\/script>/i);
                    const styleMatch = content.match(/<style[\s\S]*?>([\s\S]*?)<\/style>/);
                    
                    additionalScripts = '<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"><\/script>';
                    
                    const template = templateMatch ? templateMatch[1].trim() : '';
                    const scriptAttrs = scriptTagMatch ? scriptTagMatch[1] : '';
                    let script = scriptTagMatch ? scriptTagMatch[2].trim() : '';
                    const isSetup = /\bsetup\b/i.test(scriptAttrs);
                    const isTs = /\blang=['"]ts['"]/i.test(scriptAttrs);
                    const vueImports = new Set();
                    const warnings = [];
                    const bindingNames = new Set();

                    if (script) {
                        const scriptLines = script.split(/\r?\n/);
                        const keptLines = [];
                        scriptLines.forEach((line) => {
                            const trimmed = line.trim();
                            const vueNamedImport = trimmed.match(/^import\s+{([^}]+)}\s+from\s+['"]vue['"];?$/);
                            if (vueNamedImport) {
                                vueNamedImport[1].split(',').forEach((name) => {
                                    const clean = name.trim().split(' as ')[0];
                                    if (clean) vueImports.add(clean);
                                });
                                return;
                            }
                            if (/^import\s+[A-Za-z_$][\w$]*\s+from\s+['"]vue['"];?$/.test(trimmed)) {
                                return;
                            }
                            if (/^import\s+/.test(trimmed)) {
                                warnings.push('Module import ignored in preview: ' + trimmed);
                                return;
                            }
                            keptLines.push(line);
                        });
                        script = keptLines.join('\n');

                        script.split(/\r?\n/).forEach((line) => {
                            let match = line.match(/^\s*(?:const|let|var)\s+([A-Za-z_$][\w$]*)/);
                            if (match) {
                                bindingNames.add(match[1]);
                                return;
                            }
                            match = line.match(/^\s*function\s+([A-Za-z_$][\w$]*)/);
                            if (match) {
                                bindingNames.add(match[1]);
                            }
                        });
                    }

                    if (vueImports.size) {
                        script = 'const { ' + Array.from(vueImports).join(', ') + ' } = Vue;\n' + script;
                    }

                    if (isTs && script) {
                        script = ts.transpileModule(script, {
                            compilerOptions: {
                                target: ts.ScriptTarget.ES2020,
                                module: ts.ModuleKind.None
                            }
                        }).outputText;
                    }

                    const warningsCode = warnings.map((warning) =>
                        'console.warn(' + JSON.stringify(warning) + ');'
                    ).join('\n');
                    const safeTemplate = template.replace(/`/g, '\\`');

                    if (!template) {
                        processedCode = "console.error('Vue template missing <template> block.');";
                    } else if (isSetup) {
                        const returnNames = Array.from(bindingNames);
                        const returnLine = returnNames.length
                            ? 'return { ' + returnNames.join(', ') + ' };'
                            : 'return {};';
                        const setupBody = [warningsCode, script, returnLine].filter(Boolean).join('\n');
                        const indentedSetup = indentLines(setupBody, 12);

                        processedCode = `
                            const { createApp } = Vue;

                            const component = {
                                setup() {
${indentedSetup}
                                }
                            };

                            component.template = \`${safeTemplate}\`;
                            createApp(component).mount('#app');
                        `;
                    } else {
                        let componentScript = script || '';
                        if (componentScript && /\bexport\s+default\b/.test(componentScript)) {
                            componentScript = componentScript.replace(/\bexport\s+default\b/, 'const component =');
                        } else if (!componentScript) {
                            componentScript = 'const component = {};';
                        } else if (!/\bcomponent\b/.test(componentScript)) {
                            componentScript = 'const component = {};\n' + componentScript;
                        }

                        const body = [warningsCode, componentScript].filter(Boolean).join('\n');

                        processedCode = `
                            const { createApp } = Vue;
                            ${body}

                            if (typeof component !== 'undefined') {
                                component.template = \`${safeTemplate}\`;
                                createApp(component).mount('#app');
                            } else {
                                console.error('Vue component not found');
                            }
                        `;
                    }
                    
                    if (styleMatch) {
                        const safeStyle = styleMatch[1].replace(/<\/style>/gi, '<\\/style>');
                        additionalStyles = `<style>${safeStyle}
</style>`;
                    }
                } catch (error) {
                    Console.error(`Vue Compilation Error: ${error.message}`);
                    processedCode = `console.error("Vue Compilation Error: ${error.message}");`;
                }
                break;
        }
        
        if (processedCode && this.hasModuleSyntax(processedCode)) {
            const stripped = this.stripModuleSyntax(processedCode);
            if (stripped.warnings.length) {
                const warningCode = stripped.warnings.map((message) =>
                    `console.warn(${JSON.stringify(message)});`
                ).join('\n');
                processedCode = `${warningCode}\n${stripped.code}`;
            } else {
                processedCode = stripped.code;
            }
            if (this.hasModuleSyntax(processedCode)) {
                processedCode = moduleWarning(fileName);
            }
        }

        const safeProcessedCode = processedCode
            ? processedCode.replace(/<\/script>/gi, '<\\/script>')
            : '';
        
        return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName} - ProCode Preview</title>
    ${additionalScripts}
    ${additionalStyles}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem; 
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        header { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .console-output { 
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            min-height: 200px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 400px;
        }
        .console-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log { color: #e2e8f0; }
        .error { color: #ef4444; }
        .warn { color: #f59e0b; }
        .info { color: #3b82f6; }
        .success { color: #22c55e; }
        pre { 
            background: #0f172a; 
            color: #e2e8f0; 
            padding: 1rem; 
            border-radius: 8px; 
            overflow: auto;
            margin: 1rem 0;
            font-size: 11px;
        }
        .execution-time {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }
    
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>${fileName}</h1>
            <p>Running in ProCode IDE Preview  ${new Date().toLocaleTimeString()}</p>
        </header>
        
        <div id="app"></div>
        <div id="root"></div>
        <div id="app-output"></div>
        
        <div class="console-output">
            <div class="console-title">
                <span>Console Output</span>
                <button onclick="clearConsole()" style="background:#334155; color:#94a3b8; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer;">
                    Clear
                </button>
            </div>
            <div id="console-output"></div>
            <div class="execution-time" id="execution-time"></div>
        </div>
    </div>
    
    <script>
        const startTime = performance.now();
        const consoleOutput = document.getElementById('console-output');
        const executionTime = document.getElementById('execution-time');
        
        function addOutput(type, args) {
            if (!consoleOutput) return;
            const argList = Array.isArray(args) ? args : [args];
            const div = document.createElement('div');
            div.className = type;
            
            const safeArgs = argList.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (error) {
                        return String(arg);
                    }
                }
                return String(arg);
            });

            const escapeHtml = (value) => String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            const formattedArgs = argList.map((arg, index) => {
                const safe = escapeHtml(safeArgs[index]);
                if (typeof arg === 'object') {
                    return '<pre>' + safe + '</pre>';
                }
                return '<span>' + safe + '</span>';
            }).join(' ');
            
            div.innerHTML = formattedArgs;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Send to parent for IDE console
            try {
                window.parent.postMessage({
                    token: ${previewTokenJson},
                    type: 'console',
                    level: type,
                    args: safeArgs
                }, '*');
            } catch (error) {
                // Ignore postMessage errors for non-serializable data
            }
        }

        const nativeConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function interceptConsole(level) {
            return function(...args) {
                if (nativeConsole[level]) {
                    nativeConsole[level].apply(console, args);
                }
                addOutput(level, args);
            };
        }

        function clearConsole() {
            if (consoleOutput) {
                consoleOutput.innerHTML = '';
            }
            if (executionTime) {
                executionTime.textContent = '';
            }
        }

        console.log = interceptConsole('log');
        console.error = interceptConsole('error');
        console.warn = interceptConsole('warn');
        console.info = interceptConsole('info');

        // Performance monitoring
        window.addEventListener('load', function() {
            const endTime = performance.now();
            const executionTime = (endTime - startTime).toFixed(2);
            
            document.getElementById('execution-time').textContent =
                'Execution time: ' + executionTime + 'ms';
            
            window.parent.postMessage({ 
                token: ${previewTokenJson},
                    type: 'load',
                executionTime: executionTime 
            }, '*');
        });
    <\/script>
    
    <script>
        ${safeProcessedCode}
    <\/script>
</body>
</html>`;
    },
    
    runPython: function(path) {
        Console.clear();
        Console.info(` Running Python: ${path}`);
        this.updateRunButton(true);
        
        if (!window.pyodide) {
            Console.info('Loading Pyodide runtime...');
            
            loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"
            }).then(pyodide => {
                window.pyodide = pyodide;
                this.executePythonCode(path);
            }).catch(error => {
                Console.error('Failed to load Pyodide:', error);
                this.updateRunButton(false);
            });
        } else {
            this.executePythonCode(path);
        }
    },
    
    executePythonCode: function(path) {
        const code = FileSystem.read(path);
        const fileName = path.split('/').pop();
        
        Console.info(` Executing: ${fileName}`);
        Console.info('-'.repeat(50));
        
        try {
            // Set up Python environment
            window.pyodide.runPython(`
import sys
import io
import traceback

# Capture stdout and stderr
class OutputCapture:
    def __init__(self):
        self.buffer = []
    
    def write(self, text):
        self.buffer.append(text)
    
    def flush(self):
        pass
    
    def get_output(self):
        return ''.join(self.buffer)

stdout_capture = OutputCapture()
stderr_capture = OutputCapture()
sys.stdout = stdout_capture
sys.stderr = stderr_capture
`);
            
            // Execute the code
            window.pyodide.runPython(code);
            
            // Get captured output
            const stdout = window.pyodide.runPython('stdout_capture.get_output()');
            const stderr = window.pyodide.runPython('stderr_capture.get_output()');
            
            if (stdout) {
                Console.info('Output:');
                stdout.split('\n').forEach(line => {
                    if (line.trim()) Console.log(line);
                });
            }
            
            if (stderr) {
                Console.error('Errors:');
                stderr.split('\n').forEach(line => {
                    if (line.trim()) Console.error(line);
                });
            }
            
            Console.info('-'.repeat(50));
            Console.success(' Python execution completed');
            
        } catch (error) {
            Console.error('Python execution failed:');
            Console.error(error.toString());
            
            // Try to get Python traceback
            try {
                const traceback = window.pyodide.runPython(`
import traceback
try:
    traceback.format_exc()
except:
    "No traceback available"
`);
                if (traceback && traceback !== 'None') {
                    Console.error('Traceback:');
                    traceback.split('\n').forEach(line => {
                        if (line.trim()) Console.error(line);
                    });
                }
            } catch (e) {
                // Ignore traceback errors
            }
        } finally {
            this.updateRunButton(false);
        }
    },
    
    reload: function() {
        const frame = document.getElementById('preview-frame');
        if (frame) {
            frame.srcdoc = frame.srcdoc;
            Console.info('Preview reloaded');
        }
    },
    
    popout: function() {
        const frame = document.getElementById('preview-frame');
        const html = frame.srcdoc;
        
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();
        
        Utils.toast('Opened in new window', 'info');
    },
    
    toggleMobile: function() {
        const frame = document.getElementById('preview-frame');
        frame.classList.toggle('mobile-preview');
        
        if (frame.classList.contains('mobile-preview')) {
            frame.style.width = '375px';
            frame.style.margin = '0 auto';
            frame.style.border = '16px solid #333';
            frame.style.borderRadius = '36px';
            Console.info(' Mobile preview enabled');
        } else {
            frame.style.width = '100%';
            frame.style.margin = '0';
            frame.style.border = 'none';
            frame.style.borderRadius = '0';
            Console.info(' Desktop preview enabled');
        }
    },
    
    updateRunButton: function(isRunning) {
        this.isRunning = isRunning;
        
        const button = document.getElementById('run-btn');
        if (!button) return;
        
        if (isRunning) {
            button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> RUNNING';
            button.setAttribute('aria-busy', 'true');
        } else {
            button.innerHTML = '<i class="fas fa-play"></i> RUN';
            button.removeAttribute('aria-busy');
        }
    }
};

// ============================================
// DEBUGGER MANAGER
// ============================================
const Debugger = {
    isActive: false,
    breakpoints: new Map(),
    variables: {},
    callStack: [],
    
    toggle: function() {
        this.isActive = !this.isActive;
        
        if (this.isActive) {
            this.start();
        } else {
            this.stop();
        }
        
        Utils.toast(`Debugger ${this.isActive ? 'enabled' : 'disabled'}`, 
                   this.isActive ? 'success' : 'info');
    },
    
    start: function() {
        Console.clear();
        Console.info(' Debugger started');
        Console.info('Breakpoints: None');
        Console.info('Variables: Waiting for execution...');
        
        // Update UI
        const debugBtn = document.querySelector('[title*="Debug"]');
        if (debugBtn) {
            debugBtn.style.color = 'var(--error)';
            debugBtn.innerHTML = '<i class="fas fa-bug"></i> DEBUG ON';
        }
        
        // Initialize debug panel
        Panel.show('console');
        
        // Setup breakpoint markers in editor
        this.setupBreakpoints();
    },
    
    stop: function() {
        Console.info(' Debugger stopped');
        
        // Clear breakpoint markers
        this.clearBreakpoints();
        
        // Update UI
        const debugBtn = document.querySelector('[title*="Debug"]');
        if (debugBtn) {
            debugBtn.style.color = '';
            debugBtn.innerHTML = '<i class="fas fa-bug"></i>';
        }
        
        this.isActive = false;
    },
    
    setupBreakpoints: function() {
        // Add breakpoint decoration to editor
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            // Remove existing decorations
            this.clearBreakpoints();
            
            // Add breakpoint gutter
            const breakpointDecorations = [];
            
            this.breakpoints.forEach((bp, _key) => {
                if (bp && bp.path === IDE.state.activeTab) {
                    breakpointDecorations.push({
                        range: new monaco.Range(bp.line, 1, bp.line, 1),
                        options: {
                            isWholeLine: false,
                            glyphMarginClassName: 'breakpoint-glyph',
                            glyphMarginHoverMessage: { value: 'Breakpoint' }
                        }
                    });
                }
            });
            
            editor.deltaDecorations([], breakpointDecorations);
        }
    },
    
    clearBreakpoints: function() {
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            const decorations = editor.getModel().getAllDecorations();
            const breakpointDecorations = decorations.filter(d => 
                d.options.glyphMarginClassName === 'breakpoint-glyph'
            );
            
            editor.deltaDecorations(
                breakpointDecorations.map(d => d.id),
                []
            );
        }
    },
    
    toggleBreakpoint: function(line) {
        const path = IDE.state.activeTab;
        if (!path) return;
        
        const key = `${path}:${line}`;
        
        if (this.breakpoints.has(key)) {
            this.breakpoints.delete(key);
            Console.info(` Breakpoint removed at line ${line}`);
        } else {
            this.breakpoints.set(key, {
                path: path,
                line: line,
                condition: null,
                hitCount: 0
            });
            Console.info(` Breakpoint added at line ${line}`);
        }
        
        this.setupBreakpoints();
    },
    
    continue: function() {
        Console.info(' Continuing execution...');
        // This would trigger the next breakpoint or run to completion
    },
    
    stepOver: function() {
        Console.info(' Stepping over...');
        // Step over the current line
    },
    
    stepInto: function() {
        Console.info(' Stepping into...');
        // Step into function
    },
    
    stepOut: function() {
        Console.info(' Stepping out...');
        // Step out of function
    },
    
    evaluateExpression: function(expression) {
        try {
            // Try to evaluate the expression
            const result = eval(expression);
            Console.log(` ${expression} = ${JSON.stringify(result)}`);
            return result;
        } catch (error) {
            Console.error(`Evaluation failed: ${error.message}`);
            return undefined;
        }
    },
    
    inspectVariable: function(name) {
        if (this.variables[name] !== undefined) {
            Console.log(` ${name}: ${JSON.stringify(this.variables[name], null, 2)}`);
            return this.variables[name];
        } else {
            Console.warn(`Variable "${name}" not found in current scope`);
            return undefined;
        }
    },
    
    watchExpression: function(expression) {
        // Add to watch list
        Console.info(` Watching: ${expression}`);
        
        // Evaluate and show initial value
        const value = this.evaluateExpression(expression);
        if (value !== undefined) {
            Console.log(`Initial value: ${JSON.stringify(value)}`);
        }
    },
    
    clearBreakpointsAll: function() {
        this.breakpoints.clear();
        this.clearBreakpoints();
        Console.info(' All breakpoints cleared');
    }
};

// ============================================
// PANEL MANAGER
// ============================================
const Panel = {
    show: function(panelId) {
        // Update active panel
        IDE.state.panel = panelId;
        
        // Update tab UI
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-panel="${panelId}"]`).classList.add('active');
        
        // Show corresponding panel content
        const panels = ['term-host', 'console-host', 'problems-host', 'output-host'];
        panels.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(`${panelId}-host`).classList.remove('hidden');
        
        if (panelId === 'console') {
            Console.resetBadge();
        }
        
        // Ensure panel is visible
        const panel = document.getElementById('panel-btm');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
        }
        
        // Fit terminal if showing terminal
        if (panelId === 'term') {
            setTimeout(() => TerminalManager.fit(), 50);
        }
    },
    
    toggle: function() {
        const panel = document.getElementById('panel-btm');
        panel.classList.toggle('hidden');
        
        if (!panel.classList.contains('hidden')) {
            this.show(IDE.state.panel);
        }
    },
    
    resize: function(height) {
        const panel = document.getElementById('panel-btm');
        panel.style.height = `${height}px`;
        
        // Adjust editor container
        const editorContainer = document.getElementById('editor-container');
        if (editorContainer) {
            const headerHeight = document.querySelector('header').offsetHeight;
            const tabsHeight = document.querySelector('.tabs').offsetHeight;
            const workspaceHeight = window.innerHeight - headerHeight;
            const panelHeight = panel.classList.contains('hidden') ? 0 : height;
            
            editorContainer.style.height = `${workspaceHeight - tabsHeight - panelHeight}px`;
        }
        
        // Fit terminal
        TerminalManager.fit();
    }
};

// ============================================
// AI ASSISTANT MANAGER
// ============================================
const AI = {
    isVisible: false,
    messages: [],
    conversationId: Utils.uuid(),
    
    toggle: function() {
        this.isVisible = !this.isVisible;
        const aiFloat = document.getElementById('ai-float');
        
        if (this.isVisible) {
            aiFloat.style.display = 'flex';
            document.getElementById('ai-input').focus();
        } else {
            aiFloat.style.display = 'none';
        }
    },
    
    send: function() {
        const input = document.getElementById('ai-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        this.addMessage(message, 'user');
        input.value = '';
        
        // Process locally
        this.showTyping(true);
        this.processQuery(message);
        this.showTyping(false);
    },
    
    processQuery: function(query) {
        let response = '';
        
        // Simple rule-based responses for demonstration
        if (query.toLowerCase().includes('hello') || query.toLowerCase().includes('hi')) {
            response = "Hello! I'm your AI coding assistant. How can I help you with your code today?";
        } else if (query.toLowerCase().includes('bug') || query.toLowerCase().includes('error')) {
            response = this.generateBugFixResponse(query);
        } else if (query.toLowerCase().includes('create') || query.toLowerCase().includes('generate')) {
            response = this.generateCodeResponse(query);
        } else if (query.toLowerCase().includes('explain') || query.toLowerCase().includes('how')) {
            response = this.generateExplanationResponse(query);
        } else if (query.toLowerCase().includes('optimize') || query.toLowerCase().includes('refactor')) {
            response = this.generateOptimizationResponse(query);
        } else {
            response = `I understand you're asking about "${query}". As an AI coding assistant, I can help you with:\n\n` +
                      `1. **Debugging**: Describe the error and I'll suggest fixes\n` +
                      `2. **Code Generation**: Ask me to create functions, components, or algorithms\n` +
                      `3. **Code Review**: Share your code and I'll suggest improvements\n` +
                      `4. **Learning**: Ask for explanations of concepts or code\n\n` +
                      `What would you like to focus on?`;
        }
        
        this.addMessage(response, 'assistant');
    },
    
    generateBugFixResponse: function(query) {
        const currentCode = EditorManager.getCurrentEditor()?.getValue() || '';
        
        // Simple bug detection for demonstration
        let suggestions = [];
        
        if (currentCode.includes('console.log') && !currentCode.includes('//')) {
            suggestions.push(" Remove console.log statements before production deployment");
        }
        
        if (currentCode.includes('var ')) {
            suggestions.push(" Replace 'var' with 'const' or 'let' for better scoping");
        }
        
        if (currentCode.includes('==') && !currentCode.includes('===')) {
            suggestions.push(" Use strict equality (===) instead of loose equality (==)");
        }
        
        if (currentCode.includes('forEach') && currentCode.includes('async')) {
            suggestions.push(" Use for...of loop instead of forEach with async functions");
        }
        
        if (suggestions.length === 0) {
            suggestions.push(" Review error messages in the console panel");
            suggestions.push(" Add try-catch blocks for error handling");
            suggestions.push(" Use TypeScript for type safety");
        }
        
        return `I'll help you debug! Based on common issues:\n\n${suggestions.map(s => ` ${s}`).join('\n')}\n\n` +
               `Could you share the specific error message or code snippet you're having trouble with?`;
    },
    
    generateCodeResponse: function(query) {
        const templates = {
            'react component': `import React from 'react';

interface Props {
  title: string;
  description?: string;
}

export const ExampleComponent: React.FC<Props> = ({ title, description }) => {
  const [count, setCount] = React.useState(0);

  return (
    <div className="example-component">
      <h2>{title}</h2>
      {description && <p>{description}</p>}
      <button onClick={() => setCount(count + 1)}>
        Clicked {count} times
      </button>
    </div>
  );
};`,
            
            'function': `/**
 * Description of what the function does
 * @param {type} paramName - Description of parameter
 * @returns {type} Description of return value
 */
function exampleFunction(paramName) {
  // Input validation
  if (!paramName) {
    throw new Error('paramName is required');
  }

  try {
    // Core logic here
    const result = paramName.toUpperCase();
    
    // Return the result
    return result;
  } catch (error) {
    // Error handling
    console.error('Function failed:', error);
    throw error;
  }
}`,
            
            'api call': `async function fetchData(url, options = {}) {
  const defaultOptions = {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    },
    ...options
  };

  try {
    const response = await fetch(url, defaultOptions);
    
    if (!response.ok) {
      throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}`,
            
            'css grid': `.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  padding: 1.5rem;
}

.grid-item {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.grid-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}`,
            
            'python class': `class ExampleClass:
    """A class example with proper typing and documentation"""
    
    def __init__(self, name: str, value: int = 0):
        """
        Initialize the class
        
        Args:
            name: The name of the instance
            value: Starting value
        """
        self.name = name
        self.value = value
        self._private_attr = "internal"
    
    def increment(self, amount: int = 1) -> int:
        """
        Increment the value
        
        Args:
            amount: Amount to increment by
            
        Returns:
            The new value
        """
        self.value += amount
        return self.value
    
    @property
    def display_name(self) -> str:
        """Formatted display name"""
        return f"{self.name}: {self.value}"
    
    @classmethod
    def create_default(cls) -> 'ExampleClass':
        """Factory method to create default instance"""
        return cls("default", 100)`
        };
        
        const lowerQuery = query.toLowerCase();
        let matchedTemplate = 'function';
        
        for (const [key, template] of Object.entries(templates)) {
            if (lowerQuery.includes(key)) {
                matchedTemplate = template;
                break;
            }
        }
        
        return `Here's a template for what you requested:\n\n\`\`\`${matchedTemplate.includes('interface Props') ? 'tsx' : matchedTemplate.includes('def ') ? 'python' : matchedTemplate.includes('class ') ? 'css' : 'javascript'}\n${matchedTemplate}\n\`\`\`\n\nWould you like me to customize this for your specific use case?`;
    },
    
    generateExplanationResponse: function(query) {
        const currentCode = EditorManager.getCurrentEditor()?.getValue() || '';
        const selection = EditorManager.getSelection();
        
        let codeToExplain = selection || currentCode;
        
        if (codeToExplain.length > 500) {
            codeToExplain = codeToExplain.substring(0, 500) + '...';
        }
        
        return `Let me explain this code:\n\n\`\`\`javascript\n${codeToExplain}\n\`\`\`\n\n**Key Points:**\n\n` +
               `1. **Purpose**: This code appears to be ${this.guessCodePurpose(codeToExplain)}\n` +
               `2. **Structure**: ${this.analyzeCodeStructure(codeToExplain)}\n` +
               `3. **Best Practices**: ${this.suggestBestPractices(codeToExplain)}\n\n` +
               `**Learning Resources**:\n` +
               ` [MDN Web Docs](https://developer.mozilla.org/)\n` +
               ` [JavaScript Info](https://javascript.info/)\n` +
               ` [React Documentation](https://reactjs.org/docs/)\n\n` +
               `Is there a specific part you'd like me to explain in more detail?`;
    },
    
    generateOptimizationResponse: function(query) {
        return `**Code Optimization Suggestions:**\n\n` +
               `1. **Performance**:\n` +
               `    Use Web Workers for CPU-intensive tasks\n` +
               `    Implement debouncing/throttling for event handlers\n` +
               `    Lazy load non-critical resources\n\n` +
               `2. **Memory**:\n` +
               `    Clean up event listeners and timeouts\n` +
               `    Use weak references for caches\n` +
               `    Avoid memory leaks in closures\n\n` +
               `3. **Bundle Size**:\n` +
               `    Code splitting and dynamic imports\n` +
               `    Tree shaking with proper ES6 modules\n` +
               `    Compress images and assets\n\n` +
               `4. **Render Performance**:\n` +
               `    Virtualize long lists\n` +
               `    Use CSS transforms for animations\n` +
               `    Implement shouldComponentUpdate or React.memo\n\n` +
               `Could you share the specific code you'd like me to optimize?`;
    },
    
    guessCodePurpose: function(code) {
        if (code.includes('fetch') || code.includes('axios') || code.includes('HTTP')) {
            return 'handling HTTP requests or API communication';
        } else if (code.includes('useState') || code.includes('useEffect')) {
            return 'React component state management';
        } else if (code.includes('addEventListener')) {
            return 'handling user interactions or events';
        } else if (code.includes('querySelector') || code.includes('getElementById')) {
            return 'DOM manipulation';
        } else {
            return 'performing some computational logic';
        }
    },
    
    analyzeCodeStructure: function(code) {
        const lines = code.split('\n').length;
        const functions = (code.match(/function|=>/g) || []).length;
        const classes = (code.match(/class\s+\w+/g) || []).length;
        
        return `The code has ${lines} lines, ${functions} functions/methods, and ${classes} classes.`;
    },
    
    suggestBestPractices: function(code) {
        const suggestions = [];
        
        if (!code.includes('try') && code.includes('fetch')) {
            suggestions.push('Add error handling with try-catch');
        }
        
        if (code.includes('innerHTML')) {
            suggestions.push('Consider using textContent instead of innerHTML for security');
        }
        
        if (code.includes('setTimeout') && !code.includes('clearTimeout')) {
            suggestions.push('Clean up timeouts to prevent memory leaks');
        }
        
        if (suggestions.length === 0) {
            return 'The code structure looks good. Consider adding comments for complex logic.';
        }
        
        return suggestions.join(', ');
    },
    
    addMessage: function(content, role) {
        const messagesDiv = document.getElementById('ai-messages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg-bubble msg-${role}`;
        
        // Process content for code blocks
        let processedContent = content;
        const codeBlocks = content.match(/```[\s\S]*?```/g) || [];
        
        codeBlocks.forEach((block, index) => {
            const langMatch = block.match(/```(\w+)/);
            const lang = langMatch ? langMatch[1] : 'javascript';
            const code = block.replace(/```\w*\n/, '').replace(/```$/, '');
            
            const codeBlockId = `code-block-${Date.now()}-${index}`;
            processedContent = processedContent.replace(block, 
                `<div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">${lang}</span>
                        <button class="copy-btn" onclick="Utils.copyToClipboard(document.getElementById('${codeBlockId}').textContent)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre id="${codeBlockId}">${Utils.escapeHtml(code)}</pre>
                </div>`
            );
        });
        
        messageDiv.innerHTML = processedContent;
        messagesDiv.appendChild(messageDiv);
        
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Add to messages array
        this.messages.push({
            role: role,
            content: content,
            timestamp: new Date().toISOString()
        });
        
        // Limit messages to last 50
        if (this.messages.length > 50) {
            this.messages = this.messages.slice(-50);
        }
    },
    
    showTyping: function(show) {
        const typingIndicator = document.getElementById('ai-typing');
        const sendBtn = document.getElementById('ai-send-btn');
        
        if (show) {
            typingIndicator.classList.remove('hidden');
            sendBtn.disabled = true;
        } else {
            typingIndicator.classList.add('hidden');
            sendBtn.disabled = false;
        }
    },
    
    clear: function() {
        const messagesDiv = document.getElementById('ai-messages');
        messagesDiv.innerHTML = `
            <div class="msg-bubble msg-sys">
                <div style="font-weight:600; margin-bottom:8px;"> Hello! I'm your AI coding assistant.</div>
                <div style="margin-bottom:8px;">I can help you with:</div>
                <ul style="margin-left:20px; margin-bottom:8px;">
                    <li>Writing and explaining code</li>
                    <li>Debugging and fixing errors</li>
                    <li>Generating components and functions</li>
                    <li>Optimizing and refactoring</li>
                    <li>Answering programming questions</li>
                </ul>
                <div>What would you like to work on?</div>
            </div>
        `;
        
        this.messages = [];
        this.conversationId = Utils.uuid();
        
        Utils.toast('Chat cleared', 'info');
    }
};

// ============================================
// PROJECT TEMPLATES MANAGER
// ============================================
const ProjectTemplates = {
    show: function() {
        document.getElementById('templates-modal').style.display = 'flex';
        
        // Setup template selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.onclick = () => {
                document.querySelectorAll('.template-card').forEach(c => {
                    c.style.border = '1px solid transparent';
                });
                card.style.border = '2px solid var(--primary)';
                IDE.state.projectType = card.dataset.template;
            };
        });
    },
    
    hide: function() {
        document.getElementById('templates-modal').style.display = 'none';
    },
    
    create: function() {
        if (!IDE.state.projectType) {
            Utils.toast('Please select a template', 'warning');
            return;
        }
        
        const template = IDE.state.templates[IDE.state.projectType];
        
        // Clear current files
        IDE.state.files = {};
        
        // Create template files
        for (const [path, content] of Object.entries(template)) {
            IDE.state.files[path] = content;
        }
        
        // Save and refresh
        FileSystem.save(true);
        FileSystem.refreshTree();
        
        // Open main file
        const mainFile = Object.keys(template).find(f => 
            f.includes('index.') || f.includes('main.') || f.includes('App.')
        ) || Object.keys(template)[0];
        
        if (mainFile) {
            TabManager.open(mainFile);
        }
        
        this.hide();
        Utils.toast(`Created ${IDE.state.projectType} project`, 'success');
    }
};

// ============================================
// GIT INTEGRATION MANAGER
// ============================================
const Git = {
    branch: function() {
        Console.warn('Git integration is not available in this environment.');
        return 'local';
    },
    
    status: function() {
        const dirtyFiles = IDE.state.dirtyTabs.size;
        
        if (dirtyFiles === 0) {
            Console.info('No local changes');
            document.getElementById('git-status-text').textContent = 'Local clean';
        } else {
            Console.info(`${dirtyFiles} local change${dirtyFiles === 1 ? '' : 's'}`);
            document.getElementById('git-status-text').textContent = `${dirtyFiles} local`;
        }
        
        return dirtyFiles;
    },
    
    commit: function() {
        Console.warn('Git commit requires an external terminal.');
        Utils.toast('Git commit not available in this environment', 'warning');
    },
    
    push: function() {
        Console.warn('Git push requires an external terminal.');
        Utils.toast('Git push not available in this environment', 'warning');
    },
    
    init: function() {
        Console.warn('Git init requires an external terminal.');
        Utils.toast('Git init not available in this environment', 'warning');
    }
};

// ============================================
// SEARCH MANAGER
// ============================================
const Search = {
    findInProject: function() {
        LayoutManager.setSide('search');
        document.getElementById('search-input').focus();
    },
    
    replace: function() {
        LayoutManager.setSide('search');
        document.getElementById('search-input').focus();
    },
    

    execute: async function() {
        const query = document.getElementById('search-input').value;
        const replace = document.getElementById('replace-input').value;
        const caseSensitive = document.getElementById('case-sensitive').checked;
        const wholeWord = document.getElementById('whole-word').checked;
        
        if (!query) {
            Utils.toast('Enter search query', 'warning');
            return;
        }
        
        // Show loading
        const container = document.getElementById('search-results');
        container.innerHTML = '<div style="padding:40px; text-align:center;"><i class="fas fa-spinner fa-spin" style="font-size:32px; color:var(--primary);"></i><div style="margin-top:16px;">Searching...</div></div>';
        
        try {
            // Use worker for search
            const result = await FileSystem.searchInFilesAsync(query, {
                caseSensitive: caseSensitive,
                wholeWord: wholeWord,
                regex: false
            });
            
            console.log(` Search completed in ${result.duration.toFixed(2)}ms`);
            console.log(`Found ${result.matchCount} matches in ${result.totalFiles} files`);
            
            this.displayResults(result.results, query, replace);
            
        } catch (error) {
            console.error('Search failed:', error);
            container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--error);">Search failed: ' + error.message + '</div>';
        }
    },
    
    displayResults: function(results, query, replace) {
        const container = document.getElementById('search-results');
        // Options
        const caseSensitive = !!document.getElementById('case-sensitive')?.checked;
        const wholeWord = !!document.getElementById('whole-word')?.checked;
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = '<div style="padding:16px; text-align:center; color:var(--text-dim);">No results found</div>';
            return;
        }
        
        // Group by file
        const grouped = {};
        results.forEach(result => {
            if (!grouped[result.path]) {
                grouped[result.path] = [];
            }
            grouped[result.path].push(result);
        });
        
        // Render results
        for (const [path, matches] of Object.entries(grouped)) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'search-file-group';
            fileDiv.style.marginBottom = '16px';
            
            const fileName = path.split('/').pop();
            const [iconClass, iconColor] = Utils.getFileIcon(path);
            
            fileDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--bg-panel); border-radius:8px; margin-bottom:8px;">
                    <i class="${iconClass}" style="color:${iconColor}"></i>
                    <span style="font-weight:500; flex:1;">${fileName}</span>
                    <span style="font-size:11px; color:var(--text-dim);">${matches.length} match${matches.length === 1 ? '' : 'es'}</span>
                    <button class="btn icon small" onclick="TabManager.open('${path}')" title="Open file">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
            `;
            
            const matchesDiv = document.createElement('div');
            matchesDiv.style.padding = '0 8px';
            
            matches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'search-match';
                matchDiv.style.padding = '8px';
                matchDiv.style.borderBottom = '1px solid var(--border)';
                matchDiv.style.cursor = 'pointer';
                matchDiv.style.fontFamily = "'JetBrains Mono', monospace";
                matchDiv.style.fontSize = '11px';
                
                // Highlight the match in the line
                let lineContent = match.content;
                if (query) {
                    const regex = (typeof _buildSearchRegex === 'function')
                        ? _buildSearchRegex(query, { caseSensitive, wholeWord, regex: false })
                        : new RegExp((wholeWord ? ('\b' + _escapeRegExp(query) + '\b') : _escapeRegExp(query)), caseSensitive ? 'g' : 'gi');
                    lineContent = lineContent.replace(regex, '<mark style="background:var(--warn); color:black; padding:0 2px;">$&</mark>');
                }
                
                matchDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="color:var(--text-dim);">Line ${match.line}</span>
                        ${replace ? `<button class="btn icon small" onclick="Search.replaceSingle('${path}', ${match.line}, '${query}', '${replace}')" title="Replace this match">
                            <i class="fas fa-exchange-alt"></i>
                        </button>` : ''}
                    </div>
                    <div>${lineContent}</div>
                `;
                
                matchDiv.onclick = () => {
                    TabManager.open(path);
                    EditorManager.goToLine(match.line);
                };
                
                matchesDiv.appendChild(matchDiv);
            });
            
            // Add replace all for this file
            if (replace) {
                const replaceAllBtn = document.createElement('button');
                replaceAllBtn.className = 'btn small';
                replaceAllBtn.style.marginTop = '8px';
                replaceAllBtn.style.width = '100%';
                replaceAllBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> Replace All in File (${matches.length})`;
                replaceAllBtn.onclick = () => {
                    this.replaceInFile(path, query, replace, {
                        caseSensitive: caseSensitive,
                        wholeWord: wholeWord
                    });
                };
                
                matchesDiv.appendChild(replaceAllBtn);
            }
            
            fileDiv.appendChild(matchesDiv);
            container.appendChild(fileDiv);
        }
        
        // Add total stats
        const totalMatches = results.length;
        const totalFiles = Object.keys(grouped).length;
        
        const stats = document.createElement('div');
        stats.style.padding = '12px';
        stats.style.borderTop = '1px solid var(--border)';
        stats.style.marginTop = '16px';
        stats.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <span style="color:var(--text-dim);">Found </span>
                    <span style="font-weight:600;">${totalMatches}</span>
                    <span style="color:var(--text-dim);"> match${totalMatches === 1 ? '' : 'es'} in </span>
                    <span style="font-weight:600;">${totalFiles}</span>
                    <span style="color:var(--text-dim);"> file${totalFiles === 1 ? '' : 's'}</span>
                </div>
                ${replace ? `
                <button class="btn primary small" onclick="Search.replaceAll('${query}', '${replace}', ${caseSensitive}, ${wholeWord})">
                    <i class="fas fa-exchange-alt"></i> Replace All
                </button>
                ` : ''}
            </div>
        `;
        
        container.appendChild(stats);
    },
    
    replaceSingle: function(path, line, find, replace) {
        const content = FileSystem.read(path);
        const lines = content.split('\n');
        
        if (line > 0 && line <= lines.length) {
            const original = lines[line - 1];
            const replaced = original.replace(new RegExp(find, 'gi'), replace);
            
            if (original !== replaced) {
                lines[line - 1] = replaced;
                FileSystem.write(path, lines.join('\n'));
                
                Utils.toast('Replaced match', 'success');
                this.execute(); // Refresh results
            }
        }
    },
    
    replaceInFile: function(path, find, replace, options) {
        const content = FileSystem.read(path);
        const regex = new RegExp(
            options.regex ? find : (options.wholeWord ? `\\b${find}\\b` : find),
            options.caseSensitive ? 'g' : 'gi'
        );
        
        const newContent = content.replace(regex, replace);
        
        if (newContent !== content) {
            FileSystem.write(path, newContent);
            Utils.toast(`Replaced in ${path}`, 'success');
            this.execute(); // Refresh results
        }
    },
    
    replaceAll: function(find, replace, caseSensitive, wholeWord) {
        if (!confirm(`Replace all occurrences of "${find}" with "${replace}"?`)) {
            return;
        }
        
        const result = FileSystem.replaceInFiles(find, replace, {
            caseSensitive: caseSensitive,
            wholeWord: wholeWord
        });
        
        Utils.toast(`Replaced ${result.replacedCount} occurrences in ${result.fileCount} files`, 'success');
        this.execute(); // Refresh results
    }
};

// ============================================
// LAYOUT MANAGER (Continued)
// ============================================
const LayoutManager = {
    toggleLayout: function(panel, forceShow = false) {
        switch(panel) {
            case 'terminal':
                const termPanel = document.getElementById('panel-btm');
                if (forceShow) {
                    termPanel.classList.remove('hidden');
                    Panel.show('term');
                } else {
                    termPanel.classList.toggle('hidden');
                    if (!termPanel.classList.contains('hidden')) {
                        Panel.show('term');
                    }
                }
                break;
                
            case 'preview':
                const previewWrap = document.getElementById('preview-wrap');
                const resizer = document.getElementById('rs-preview');
                
                if (forceShow) {
                    previewWrap.classList.add('visible');
                    resizer.classList.remove('hidden');
                } else {
                    previewWrap.classList.toggle('visible');
                    resizer.classList.toggle('hidden', !previewWrap.classList.contains('visible'));
                }
                
                // Update preview URL
                if (previewWrap.classList.contains('visible')) {
                    const url = document.getElementById('preview-url');
                    const frame = document.getElementById('preview-frame');
                    if (frame.srcdoc) {
                        url.value = 'data:text/html;charset=utf-8,' + encodeURIComponent(frame.srcdoc);
                    }
                }
                break;
                
            case 'split':
                this.splitEditor();
                break;
        }
    },
    
    setSide: function(side) {
        // Update active sidebar
        IDE.state.sidebar = side;
        
        // Update UI
        document.querySelectorAll('.sidebar').forEach(el => {
            el.classList.remove('active');
        });
        
        document.querySelectorAll('.act-btn').forEach(el => {
            el.classList.remove('active');
        });
        
        const sidebar = document.getElementById(`side-${side}`);
        const button = document.querySelector(`[data-id="${side}"]`);
        
        if (sidebar) sidebar.classList.add('active');
        if (button) button.classList.add('active');
    },
    
    splitEditor: function() {
        if (IDE.state.splitView) {
            // Already split, close split
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const pane = document.createElement('div');
            pane.className = 'editor-pane';
            pane.id = 'editor-pane-1';
            pane.innerHTML = '<div id="monaco-root-1" style="width:100%; height:100%;"></div>';
            
            container.appendChild(pane);
            
            // Reinitialize editor
            EditorManager.createEditor('monaco-root-1');
            
            // Restore active file
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab);
            }
            
            IDE.state.splitView = false;
            IDE.state.editorLayout = 'single';
            
            Utils.toast('Split view disabled', 'info');
        } else {
            // Create split view
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            // Create two panes
            const pane1 = document.createElement('div');
            pane1.className = 'editor-pane';
            pane1.id = 'editor-pane-1';
            pane1.innerHTML = '<div id="monaco-root-1" style="width:100%; height:100%;"></div>';
            
            const pane2 = document.createElement('div');
            pane2.className = 'editor-pane';
            pane2.id = 'editor-pane-2';
            pane2.innerHTML = '<div id="monaco-root-2" style="width:100%; height:100%;"></div>';
            
            container.appendChild(pane1);
            container.appendChild(pane2);
            
            // Initialize editors
            EditorManager.createEditor('monaco-root-1');
            EditorManager.createEditor('monaco-root-2');
            
            IDE.state.splitView = true;
            IDE.state.editorLayout = 'split';
            
            // Copy current file to second pane if exists
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab, 'monaco-root-1');
                EditorManager.setFile(IDE.state.activeTab, 'monaco-root-2');
            }
            
            Utils.toast('Split view enabled', 'info');
        }
    },
    
    openInSplit: function(path) {
        if (!IDE.state.splitView) {
            this.splitEditor();
        }
        
        // Open file in second pane
        setTimeout(() => {
            EditorManager.setFile(path, 'monaco-root-2');
            Utils.toast(`Opened in split view: ${path.split('/').pop()}`, 'info');
        }, 100);
    }
};

// ============================================
// SETTINGS MANAGER (Continued)
// ============================================
const Settings = {
    _inited: false,

    init: function() {
        if (this._inited) return;
        this._inited = true;

        const modal = document.getElementById('settings-modal');
        if (!modal) return;

        // Settings tabs (scoped to settings modal to avoid clashing with editor file tabs)
        modal.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', () => {
                this.switchTab(tab.dataset.tab || 'editor');
            });
        });

        // Theme options click-to-select
        modal.querySelectorAll('.theme-option').forEach(opt => {
            opt.addEventListener('click', () => {
                modal.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
            });
        });
    },

    show: function() {
        const modal = document.getElementById('settings-modal');
        if (!modal) return;

        modal.style.display = 'flex';
        this.init();
        this.switchTab('editor');
        this.loadSettings();
    },

    hide: function() {
        const modal = document.getElementById('settings-modal');
        if (modal) modal.style.display = 'none';
    },

    switchTab: function(tabKey) {
        const modal = document.getElementById('settings-modal');
        if (!modal) return;

        modal.querySelectorAll('.tabs .tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tabKey);
        });

        modal.querySelectorAll('.settings-tab').forEach(panel => {
            panel.classList.toggle('hidden', panel.id !== `settings-${tabKey}`);
        });
    },

    loadSettings: function() {
        const s = IDE.state.settings;

        // Editor
        const fs = document.getElementById('font-size-input');
        if (fs) fs.value = s.editor.fontSize;

        const ts = document.getElementById('tab-size-value');
        if (ts) ts.textContent = s.editor.tabSize;

        const ww = document.getElementById('word-wrap-toggle');
        if (ww) ww.checked = !!s.editor.wordWrap;

        const mm = document.getElementById('minimap-toggle');
        if (mm) mm.checked = !!s.editor.minimap;

        const ln = document.getElementById('line-numbers-toggle');
        if (ln) ln.checked = !!s.editor.lineNumbers;

        const fos = document.getElementById('format-on-save-toggle');
        if (fos) fos.checked = !!s.editor.formatOnSave;

        const as = document.getElementById('autosave-toggle');
        if (as) as.checked = !!s.editor.autoSave;

        // Appearance
        const anim = document.getElementById('animation-toggle');
        if (anim) anim.checked = !!s.appearance.animation;

        const rm = document.getElementById('reduce-motion-toggle');
        if (rm) rm.checked = !!s.appearance.reduceMotion;

        const cm = document.getElementById('compact-mode-toggle');
        if (cm) cm.checked = !!s.appearance.compactMode;

        // Theme options
        document.querySelectorAll('#settings-modal .theme-option').forEach(option => {
            option.classList.toggle('active', option.dataset.theme === s.appearance.theme);
        });

        // Features
        const rs = document.getElementById('restore-session-toggle');
        if (rs) rs.checked = s.features.restoreSession !== false;

        const pc = document.getElementById('persist-cursor-toggle');
        if (pc) pc.checked = s.features.persistCursor !== false;

        const cl = document.getElementById('codelens-toggle');
        if (cl) cl.checked = !!s.features.codeLens;

        const bc = document.getElementById('breadcrumbs-toggle');
        if (bc) bc.checked = !!s.features.breadcrumbs;

        const sn = document.getElementById('snippets-toggle');
        if (sn) sn.checked = !!s.features.snippetSuggestions;

        const lp = document.getElementById('live-preview-toggle');
        if (lp) lp.checked = !!s.features.livePreview;

        const git = document.getElementById('git-toggle');
        if (git) git.checked = !!s.features.gitIntegration;

        // Terminal
        const tfs = document.getElementById('terminal-font-size-input');
        if (tfs) tfs.value = s.terminal.fontSize;

        const tcb = document.getElementById('terminal-cursor-blink-toggle');
        if (tcb) tcb.checked = !!s.terminal.cursorBlink;

        const tcs = document.getElementById('terminal-cursor-style-select');
        if (tcs) tcs.value = s.terminal.cursorStyle || 'block';

        // AI
        const aien = document.getElementById('ai-enabled-toggle');
        if (aien) aien.checked = !!s.ai.enabled;

        const aim = document.getElementById('ai-model-input');
        if (aim) aim.value = s.ai.model || 'local';

        const ait = document.getElementById('ai-temperature-input');
        if (ait) ait.value = s.ai.temperature;

        const amax = document.getElementById('ai-maxTokens-input');
        if (amax) amax.value = s.ai.maxTokens;

        // Apply theme to UI
        this.applyTheme();
    },

    save: function() {
        const s = IDE.state.settings;

        // Editor
        const fs = document.getElementById('font-size-input');
        if (fs) s.editor.fontSize = Math.max(8, Math.min(32, parseInt(fs.value || '14', 10)));

        const ts = document.getElementById('tab-size-value');
        if (ts) s.editor.tabSize = Math.max(1, Math.min(8, parseInt(ts.textContent || '4', 10)));

        const ww = document.getElementById('word-wrap-toggle');
        if (ww) s.editor.wordWrap = !!ww.checked;

        const mm = document.getElementById('minimap-toggle');
        if (mm) s.editor.minimap = !!mm.checked;

        const ln = document.getElementById('line-numbers-toggle');
        if (ln) s.editor.lineNumbers = !!ln.checked;

        const fos = document.getElementById('format-on-save-toggle');
        if (fos) s.editor.formatOnSave = !!fos.checked;

        const as = document.getElementById('autosave-toggle');
        if (as) s.editor.autoSave = !!as.checked;

        // Appearance
        const anim = document.getElementById('animation-toggle');
        if (anim) s.appearance.animation = !!anim.checked;

        const rm = document.getElementById('reduce-motion-toggle');
        if (rm) s.appearance.reduceMotion = !!rm.checked;

        const cm = document.getElementById('compact-mode-toggle');
        if (cm) s.appearance.compactMode = !!cm.checked;

        const activeTheme = document.querySelector('#settings-modal .theme-option.active');
        if (activeTheme) s.appearance.theme = activeTheme.dataset.theme;

        // Features
        const rs = document.getElementById('restore-session-toggle');
        if (rs) s.features.restoreSession = !!rs.checked;

        const pc = document.getElementById('persist-cursor-toggle');
        if (pc) s.features.persistCursor = !!pc.checked;

        const cl = document.getElementById('codelens-toggle');
        if (cl) s.features.codeLens = !!cl.checked;

        const bc = document.getElementById('breadcrumbs-toggle');
        if (bc) s.features.breadcrumbs = !!bc.checked;

        const sn = document.getElementById('snippets-toggle');
        if (sn) s.features.snippetSuggestions = !!sn.checked;

        const lp = document.getElementById('live-preview-toggle');
        if (lp) s.features.livePreview = !!lp.checked;

        const git = document.getElementById('git-toggle');
        if (git) s.features.gitIntegration = !!git.checked;

        // Terminal
        const tfs = document.getElementById('terminal-font-size-input');
        if (tfs) s.terminal.fontSize = Math.max(8, Math.min(32, parseInt(tfs.value || '13', 10)));

        const tcb = document.getElementById('terminal-cursor-blink-toggle');
        if (tcb) s.terminal.cursorBlink = !!tcb.checked;

        const tcs = document.getElementById('terminal-cursor-style-select');
        if (tcs) s.terminal.cursorStyle = tcs.value || 'block';

        // AI
        const aien = document.getElementById('ai-enabled-toggle');
        if (aien) s.ai.enabled = !!aien.checked;

        const aim = document.getElementById('ai-model-input');
        if (aim) s.ai.model = (aim.value || 'local').trim();

        const ait = document.getElementById('ai-temperature-input');
        if (ait) s.ai.temperature = Math.max(0, Math.min(1, parseFloat(ait.value || '0.7')));

        const amax = document.getElementById('ai-maxTokens-input');
        if (amax) s.ai.maxTokens = Math.max(64, parseInt(amax.value || '1000', 10));

        // Apply to subsystems
        try { EditorManager.applySettings(); } catch (e) { console.warn('Editor applySettings failed', e); }
        try { if (TerminalManager.applySettings) TerminalManager.applySettings(); } catch (e) { console.warn('Terminal applySettings failed', e); }

        // Apply theme to UI
        this.applyTheme();

        // Save to persistent storage
        try { FileSystem.save(true); } catch (e) { console.warn('Save failed', e); }
        try { if (window.SessionManager) SessionManager.save(true); } catch (e) {}

        this.hide();
        Utils.toast('Settings saved', 'success');
    },

    changeFontSize: function(delta) {
        const input = document.getElementById('font-size-input');
        if (!input) return;
        let value = parseInt(input.value || '14', 10) + delta;
        value = Math.max(8, Math.min(32, value));
        input.value = value;
    },

    changeTerminalFontSize: function(delta) {
        const input = document.getElementById('terminal-font-size-input');
        if (!input) return;
        let value = parseInt(input.value || '13', 10) + delta;
        value = Math.max(8, Math.min(32, value));
        input.value = value;
    },

    changeTabSize: function(delta) {
        const span = document.getElementById('tab-size-value');
        if (!span) return;
        let value = parseInt(span.textContent || '4', 10) + delta;
        value = Math.max(1, Math.min(8, value));
        span.textContent = value;
    },

        applyTheme: function() {
        const s = IDE.state.settings;
        const theme = s.appearance.theme;
        const root = document.documentElement;
        const body = document.body || document.documentElement;

        // UI theme variables
        switch (theme) {
            case 'light':
                root.style.setProperty('--bg', '#ffffff');
                root.style.setProperty('--bg-dark', '#f5f5f7');
                root.style.setProperty('--bg-panel', '#ffffff');
                root.style.setProperty('--bg-side', '#fafafa');
                root.style.setProperty('--border', '#e5e7eb');
                root.style.setProperty('--text', '#111827');
                root.style.setProperty('--text-dim', '#6b7280');
                break;
            case 'night':
                root.style.setProperty('--bg', '#05050a');
                root.style.setProperty('--bg-dark', '#05050a');
                root.style.setProperty('--bg-panel', '#0b0b12');
                root.style.setProperty('--bg-side', '#090910');
                root.style.setProperty('--border', '#1f1f2a');
                root.style.setProperty('--text', '#e5e7eb');
                root.style.setProperty('--text-dim', '#8b8b99');
                break;
            default: // dark
                root.style.setProperty('--bg', '#0b0b0f');
                root.style.setProperty('--bg-dark', '#09090b');
                root.style.setProperty('--bg-panel', '#18181b');
                root.style.setProperty('--bg-side', '#121215');
                root.style.setProperty('--border', '#27272a');
                root.style.setProperty('--text', '#e4e4e7');
                root.style.setProperty('--text-dim', '#71717a');
        }

        // Motion / density
        const prefersReduced = (() => {
            try { return window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; }
            catch { return false; }
        })();

        const reduceMotion = !!s.appearance.reduceMotion || (prefersReduced && s.appearance.animation === false);
        const animEnabled = (s.appearance.animation !== false) && !reduceMotion;

        body.classList.toggle('reduce-motion', reduceMotion);
        body.classList.toggle('no-anim', !animEnabled);
        body.classList.toggle('compact', !!s.appearance.compactMode);

        // Sync editor theme with UI theme (sane default)
        const desiredEditorTheme = (theme === 'light') ? 'vs' : 'vs-dark';
        if (s.editor && s.editor.theme !== desiredEditorTheme) {
            s.editor.theme = desiredEditorTheme;
        }
        try {
            if (window.monaco && monaco.editor && monaco.editor.setTheme) {
                monaco.editor.setTheme(desiredEditorTheme);
            }
        } catch (e) {}

        // Update theme-color for mobile UIs
        try {
            let meta = document.querySelector('meta[name="theme-color"]');
            if (!meta) {
                meta = document.createElement('meta');
                meta.name = 'theme-color';
                document.head.appendChild(meta);
            }
            meta.setAttribute('content', getComputedStyle(root).getPropertyValue('--bg').trim() || '#0b0b0f');
        } catch (e) {}
    }
};

// ============================================
// ULTRA+ (v19.0): WORKSPACE I/O + SNAPSHOTS + SHORTCUTS
// ============================================

const WorkspaceIO = {
    dirHandle: null,
    openedAt: null,

    isSupported: function() {
        return ('showDirectoryPicker' in window) && ('FileSystemFileHandle' in window || 'FileSystemHandle' in window);
    },

    // Read a folder into IDE.state.files
    openDirectory: async function({ replace = true } = {}) {
        try {
            if (!this.isSupported()) {
                Utils.toast('File System Access API not supported. Use Import instead (ZIP / files).', 'info');
                return false;
            }

            // Unsaved changes guard
            if (replace && IDE.state?.dirtyTabs && IDE.state.dirtyTabs.size > 0) {
                const ok = confirm('You have unsaved changes. Continue and replace the current workspace?');
                if (!ok) return false;
            }

            const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
            if (!handle) return false;

            const { files, skipped } = await this._readDirectoryRecursive(handle, '');
            if (replace) {
                IDE.state.files = files;
                IDE.state.tabs = [];
                IDE.state.activeTab = null;
                IDE.state.dirtyTabs.clear();
            } else {
                Object.assign(IDE.state.files, files);
            }

            this.dirHandle = handle;
            this.openedAt = Date.now();

            FileSystem.save(true);
            FileSystem.refreshTree();

            const count = Object.keys(files).length;
            Utils.toast(` Opened folder: ${count} file(s)${skipped ? ` (skipped ${skipped})` : ''}`, 'success');
            return true;
        } catch (e) {
            if (e && e.name === 'AbortError') return false;
            Utils.toast('Open folder failed: ' + (e?.message || String(e)), 'error');
            return false;
        }
    },

    // Write all current files back to the opened folder
    syncToDisk: async function({ onlyDirty = false } = {}) {
        try {
            if (!this.dirHandle) {
                Utils.toast('No folder opened. Use "Workspace: Open Folder" first.', 'warning');
                return false;
            }

            const files = IDE.state.files || {};
            const dirty = IDE.state.dirtyTabs || new Set();
            let wrote = 0;
            let skipped = 0;

            for (const [path, content] of Object.entries(files)) {
                if (!path || path.endsWith('.keep')) continue;
                if (onlyDirty && !dirty.has(path)) { skipped++; continue; }

                try {
                    await this._writeFileToDirectory(this.dirHandle, path, content);
                    wrote++;
                } catch (e) {
                    console.warn('Sync write failed:', path, e);
                }
            }

            FileSystem.save(true);
            if (onlyDirty) dirty.clear();

            Utils.toast(` Synced to disk: ${wrote} file(s)${skipped ? `, skipped ${skipped}` : ''}`, 'success');
            return true;
        } catch (e) {
            Utils.toast('Sync failed: ' + (e?.message || String(e)), 'error');
            return false;
        }
    },

    // Pull the opened folder again and merge into workspace
    pullFromDisk: async function() {
        try {
            if (!this.dirHandle) {
                Utils.toast('No folder opened. Use "Workspace: Open Folder" first.', 'warning');
                return false;
            }

            const { files, skipped } = await this._readDirectoryRecursive(this.dirHandle, '');
            const dirty = IDE.state.dirtyTabs || new Set();

            let updated = 0, ignored = 0;
            for (const [path, content] of Object.entries(files)) {
                if (dirty.has(path)) { ignored++; continue; }
                if (IDE.state.files[path] !== content) {
                    IDE.state.files[path] = content;
                    updated++;
                }
            }

            FileSystem.save(true);
            FileSystem.refreshTree();

            if (IDE.state.activeTab && FileSystem.exists(IDE.state.activeTab)) {
                try { EditorManager.setFile(IDE.state.activeTab); } catch (_) {}
            }

            Utils.toast(` Pulled from disk: updated ${updated}${ignored ? `, ignored ${ignored} dirty` : ''}${skipped ? ` (skipped ${skipped})` : ''}`, 'success');
            return true;
        } catch (e) {
            Utils.toast('Pull failed: ' + (e?.message || String(e)), 'error');
            return false;
        }
    },

    _readDirectoryRecursive: async function(dirHandle, prefix) {
        const files = {};
        let skipped = 0;

        for await (const [name, handle] of dirHandle.entries()) {
            if (!name) continue;
            // skip common junk by default
            if (name === 'node_modules' || name === '.git' || name === '.DS_Store') { skipped++; continue; }
            if (name.startsWith('.') && name !== '.env') { skipped++; continue; }

            if (handle.kind === 'file') {
                try {
                    const file = await handle.getFile();
                    // safety size cap
                    if (file.size > 5 * 1024 * 1024) { skipped++; continue; }
                    const text = await file.text();
                    files[prefix + name] = text;
                } catch (e) {
                    skipped++;
                }
            } else if (handle.kind === 'directory') {
                const sub = await this._readDirectoryRecursive(handle, prefix + name + '/');
                Object.assign(files, sub.files);
                skipped += sub.skipped;
            }
        }

        return { files, skipped };
    },

    _writeFileToDirectory: async function(rootDirHandle, path, content) {
        const parts = String(path).split('/').filter(Boolean);
        if (parts.length === 0) return;

        let dir = rootDirHandle;
        for (let i = 0; i < parts.length - 1; i++) {
            dir = await dir.getDirectoryHandle(parts[i], { create: true });
        }

        const fileHandle = await dir.getFileHandle(parts[parts.length - 1], { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(content ?? '');
        await writable.close();
    }
};

const SnapshotManager = {
    KEY_LIST: () => `procode_snapshots_v${IDE.version}`,
    _cache: null,

    _supportsDB: function() {
        return !!window.indexedDB && !!window.IndexedDBManager;
    },

    _loadListLocal: function() {
        try {
            const raw = localStorage.getItem(this.KEY_LIST());
            const list = raw ? JSON.parse(raw) : [];
            return Array.isArray(list) ? list : [];
        } catch { return []; }
    },

    _saveListLocal: function(list) {
        try { localStorage.setItem(this.KEY_LIST(), JSON.stringify(list)); } catch {}
    },

    _snapshotKey: function(id) { return `procode_snapshot_${IDE.version}_${id}`; },

    list: async function() {
        if (this._cache) return this._cache;

        if (this._supportsDB()) {
            try {
                await IndexedDBManager.init();
                const list = await IndexedDBManager.getSetting(this.KEY_LIST());
                this._cache = Array.isArray(list) ? list : [];
                return this._cache;
            } catch (e) {}
        }

        this._cache = this._loadListLocal();
        return this._cache;
    },

    _saveList: async function(list) {
        this._cache = list;
        if (this._supportsDB()) {
            try {
                await IndexedDBManager.init();
                await IndexedDBManager.setSetting(this.KEY_LIST(), list);
                return;
            } catch (e) {}
        }
        this._saveListLocal(list);
    },

    create: async function(name = 'Snapshot') {
        const id = Utils.uuid('snap_');
        const ts = Date.now();

        const payload = {
            id, name, ts,
            files: IDE.state.files,
            tabs: IDE.state.tabs,
            activeTab: IDE.state.activeTab,
            settings: IDE.state.settings,
            viewStates: (window.SessionManager ? SessionManager.viewStates : {})
        };

        // Store payload (prefer IndexedDB, fallback localStorage w/ compression if available)
        let stored = false;

        if (this._supportsDB()) {
            try {
                await IndexedDBManager.init();
                await IndexedDBManager.setSetting(this._snapshotKey(id), payload);
                stored = true;
            } catch (e) {}
        }

        if (!stored) {
            try {
                const json = JSON.stringify(payload);
                const data = (window.LZString && LZString.compressToUTF16) ? ('lz:' + LZString.compressToUTF16(json)) : ('raw:' + json);
                localStorage.setItem(this._snapshotKey(id), data);
                stored = true;
            } catch (e) {}
        }

        if (!stored) {
            Utils.toast('Snapshot failed (storage full?)', 'error');
            return false;
        }

        // Update list (max 15)
        const list = await this.list();
        const next = [{ id, name, ts }, ...list].slice(0, 15);
        await this._saveList(next);

        Utils.toast(` Snapshot created: ${name}`, 'success');
        return true;
    },

    createPrompt: async function() {
        const name = prompt('Snapshot name:', `Snapshot ${new Date().toLocaleString()}`);
        if (!name) return false;
        return this.create(name);
    },

    _loadPayload: async function(id) {
        if (this._supportsDB()) {
            try {
                await IndexedDBManager.init();
                const p = await IndexedDBManager.getSetting(this._snapshotKey(id));
                if (p && p.files) return p;
            } catch (e) {}
        }

        try {
            const raw = localStorage.getItem(this._snapshotKey(id));
            if (!raw) return null;
            if (raw.startsWith('lz:') && window.LZString) {
                const json = LZString.decompressFromUTF16(raw.slice(3));
                return JSON.parse(json);
            }
            if (raw.startsWith('raw:')) return JSON.parse(raw.slice(4));
        } catch (e) {}
        return null;
    },

    restore: async function(id) {
        const payload = await this._loadPayload(id);
        if (!payload || !payload.files) {
            Utils.toast('Snapshot not found', 'warning');
            return false;
        }

        const ok = confirm(`Restore snapshot "${payload.name || id}"? This will replace current workspace in memory.`);
        if (!ok) return false;

        IDE.state.files = payload.files || IDE.state.files;
        IDE.state.tabs = Array.isArray(payload.tabs) ? payload.tabs : [];
        IDE.state.activeTab = payload.activeTab || null;
        IDE.state.settings = payload.settings || IDE.state.settings;

        if (window.SessionManager && payload.viewStates && typeof payload.viewStates === 'object') {
            SessionManager.viewStates = payload.viewStates;
        }

        try { Settings.applyTheme(); } catch (e) {}
        try { EditorManager.applySettings(); } catch (e) {}

        FileSystem.save(true);
        FileSystem.refreshTree();

        if (IDE.state.activeTab && FileSystem.exists(IDE.state.activeTab)) {
            TabManager.open(IDE.state.activeTab);
        }

        Utils.toast(' Snapshot restored', 'success');
        return true;
    },

    delete: async function(id) {
        const ok = confirm('Delete this snapshot?');
        if (!ok) return false;

        if (this._supportsDB()) {
            try {
                await IndexedDBManager.init();
                await IndexedDBManager.setSetting(this._snapshotKey(id), null);
            } catch (e) {}
        }
        try { localStorage.removeItem(this._snapshotKey(id)); } catch {}

        const list = await this.list();
        const next = list.filter(s => s.id !== id);
        await this._saveList(next);

        Utils.toast('Snapshot deleted', 'info');
        return true;
    },

    showManager: async function() {
        const list = await this.list();
        const html = `
        <div class="modal-overlay" id="snapshots-modal">
          <div class="modal" style="width: 680px; max-width: calc(100vw - 24px);">
            <div class="modal-header">
              <h3><i class="fas fa-camera"></i> Snapshots</h3>
              <button class="btn icon small" onclick="document.getElementById('snapshots-modal')?.remove()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow:auto;">
              <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                <button class="btn" onclick="SnapshotManager.createPrompt()"><i class="fas fa-plus"></i> Create</button>
                <div style="color: var(--text-dim); font-size: 12px;">Tip: Use snapshots before big refactors.</div>
              </div>

              ${list.length ? `
                <div style="display:flex; flex-direction:column; gap:8px;">
                  ${list.map(s => `
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background: var(--bg-dark);">
                      <div style="min-width:0;">
                        <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${Utils.escapeHtml(s.name || 'Snapshot')}</div>
                        <div style="font-size:12px; color:var(--text-dim); margin-top:2px;">${new Date(s.ts).toLocaleString()}</div>
                      </div>
                      <div style="display:flex; gap:8px; flex-shrink:0;">
                        <button class="btn small" onclick="SnapshotManager.restore('${s.id}')"><i class="fas fa-undo"></i> Restore</button>
                        <button class="btn danger small" onclick="SnapshotManager.delete('${s.id}'); document.getElementById('snapshots-modal')?.remove(); SnapshotManager.showManager();"><i class="fas fa-trash"></i></button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <div style="padding:20px; text-align:center; color:var(--text-dim);">
                  No snapshots yet.
                </div>
              `}
            </div>
            <div class="modal-footer">
              <button class="btn" onclick="document.getElementById('snapshots-modal')?.remove()">Close</button>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    }
};

const ShortcutsModal = {
    show: function() {
        const html = `
        <div class="modal-overlay" id="shortcuts-modal">
          <div class="modal" style="width: 760px; max-width: calc(100vw - 24px);">
            <div class="modal-header">
              <h3><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
              <button class="btn icon small" onclick="document.getElementById('shortcuts-modal')?.remove()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow:auto;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                ${[
                    ['Ctrl + N', 'New file'],
                    ['Ctrl + S', 'Save project'],
                    ['Ctrl + Shift + S', 'Export ZIP'],
                    ['Ctrl + Z / Ctrl + Shift + Z', 'Undo / Redo'],
                    ['Ctrl + F', 'Find in file'],
                    ['Ctrl + Shift + F', 'Find in project'],
                    ['Ctrl + H', 'Replace'],
                    ['Ctrl + P', 'Quick open file'],
                    ['Ctrl + Shift + P', 'Command palette'],
                    ['Ctrl + B', 'Toggle Preview'],
                    ['Ctrl + `', 'Toggle Terminal'],
                    ['Ctrl + \\', 'Split editor'],
                    ['F5', 'Run'],
                    ['F9', 'Debugger'],
                    ['Ctrl + Shift + I', 'Toggle Inspector'],
                    ['Ctrl + Alt + O', 'Open folder (FS Access)'],
                    ['Ctrl + Alt + S', 'Sync to disk (FS Access)'],
                    ['Ctrl + Alt + R', 'Pull from disk (FS Access)'],
                    ['F1', 'Show shortcuts'],
                ].map(([k,v]) => `
                  <div style="display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background: var(--bg-dark);">
                    <div style="font-family: JetBrains Mono, monospace; font-size: 12px;">${k}</div>
                    <div style="color: var(--text-dim); font-size: 12px; text-align:right;">${v}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn" onclick="document.getElementById('shortcuts-modal')?.remove()">Close</button>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    }
};

const UltraPlus = {
    getCommandPaletteEntries: function() {
        return [
            { name: 'Workspace: Open Folder (FS Access)', shortcut: 'Ctrl+Alt+O', icon: 'fa-folder-open', action: () => WorkspaceIO.openDirectory({ replace: true }) },
            { name: 'Workspace: Sync to Disk (FS Access)', shortcut: 'Ctrl+Alt+S', icon: 'fa-upload', action: () => WorkspaceIO.syncToDisk({ onlyDirty: false }) },
            { name: 'Workspace: Pull from Disk (FS Access)', shortcut: 'Ctrl+Alt+R', icon: 'fa-download', action: () => WorkspaceIO.pullFromDisk() },
            { name: 'Snapshots: Create', shortcut: '', icon: 'fa-camera', action: () => SnapshotManager.createPrompt() },
            { name: 'Snapshots: Manage', shortcut: '', icon: 'fa-history', action: () => SnapshotManager.showManager() },
            { name: 'Help: Keyboard Shortcuts', shortcut: 'F1', icon: 'fa-keyboard', action: () => ShortcutsModal.show() },
            { name: 'View: Toggle Compact Mode', shortcut: '', icon: 'fa-compress-arrows-alt', action: () => { IDE.state.settings.appearance.compactMode = !IDE.state.settings.appearance.compactMode; Settings.applyTheme(); FileSystem.save(true); } },
            { name: 'View: Toggle Reduce Motion', shortcut: '', icon: 'fa-person-walking', action: () => { IDE.state.settings.appearance.reduceMotion = !IDE.state.settings.appearance.reduceMotion; Settings.applyTheme(); FileSystem.save(true); } },
        ];
    },

    initDragDrop: function() {
        const overlay = document.getElementById('drag-overlay');
        if (!overlay) return;

        let counter = 0;

        const show = () => {
            overlay.classList.add('visible');
            overlay.setAttribute('aria-hidden', 'false');
        };
        const hide = () => {
            overlay.classList.remove('visible');
            overlay.setAttribute('aria-hidden', 'true');
        };

        window.addEventListener('dragenter', (e) => {
            if (!e.dataTransfer) return;
            counter++;
            e.preventDefault();
            show();
        });

        window.addEventListener('dragover', (e) => {
            if (!e.dataTransfer) return;
            e.preventDefault();
            show();
        });

        window.addEventListener('dragleave', (e) => {
            counter = Math.max(0, counter - 1);
            if (counter === 0) hide();
        });

        window.addEventListener('drop', async (e) => {
            if (!e.dataTransfer) return;
            e.preventDefault();
            counter = 0;
            hide();

            try {
                if (FileSystem.importFromDataTransfer) {
                    await FileSystem.importFromDataTransfer(e.dataTransfer, '');
                } else {
                    // fallback
                    const files = Array.from(e.dataTransfer.files || []);
                    if (files.length) {
                        await FileSystem.importFromFiles(files, '');
                    }
                }
            } catch (err) {
                Utils.toast('Import failed: ' + (err?.message || String(err)), 'error');
            }
        });
    }
};

// Expose for command palette actions
window.WorkspaceIO = WorkspaceIO;
window.SnapshotManager = SnapshotManager;
window.ShortcutsModal = ShortcutsModal;
window.UltraPlus = UltraPlus;

// ============================================
// SESSION MANAGER (ULTRA)
// ============================================

const SessionManager = {
    KEY: () => `procode_session_v${IDE.version}`,
    viewStates: {},
    _lastHash: '',
    _timer: null,

    init: function() {
        // Load cached session viewstates early (safe)
        try {
            const raw = localStorage.getItem(this.KEY());
            if (raw) {
                const s = JSON.parse(raw);
                if (s && s.viewStates && typeof s.viewStates === 'object') {
                    this.viewStates = s.viewStates;
                }
            }
        } catch (e) {}

        // Periodic save (cheap, only writes when changed)
        if (this._timer) clearInterval(this._timer);
        this._timer = setInterval(() => this.save(false), 2500);
    },

    isRestoreEnabled: function() {
        return IDE.state?.settings?.features?.restoreSession !== false;
    },

    isPersistCursorEnabled: function() {
        return IDE.state?.settings?.features?.persistCursor !== false;
    },

    _normalizePath: function(p) {
        if (!p) return '';
        return String(p).replace(/^\/+/, '');
    },

    _uriToPath: function(uri) {
        try {
            const p = uri?.path || uri?.fsPath || '';
            return this._normalizePath(p);
        } catch { return ''; }
    },

    captureViewStateFromEditor: function(editor) {
        if (!this.isPersistCursorEnabled()) return;
        if (!editor || !editor.getModel || !editor.saveViewState) return;

        const model = editor.getModel();
        if (!model) return;

        const path = this._uriToPath(model.uri);
        if (!path) return;

        try {
            this.viewStates[path] = editor.saveViewState();
        } catch (e) {}
    },

    restoreViewStateToEditor: function(path, editor) {
        if (!this.isPersistCursorEnabled()) return;
        if (!editor || !editor.restoreViewState) return;

        const p = this._normalizePath(path);
        const st = this.viewStates[p];
        if (!st) return;

        try {
            editor.restoreViewState(st);
        } catch (e) {}
    },

    restore: function() {
        if (!this.isRestoreEnabled()) return false;

        try {
            const raw = localStorage.getItem(this.KEY());
            if (!raw) return false;

            const s = JSON.parse(raw);
            if (!s || !Array.isArray(s.tabs) || s.tabs.length === 0) return false;

            // Only keep existing files
            const tabs = s.tabs.filter(p => FileSystem.exists(p));
            if (!tabs.length) return false;

            IDE.state.tabs = tabs;
            IDE.state.activeTab = (s.activeTab && tabs.includes(s.activeTab)) ? s.activeTab : tabs[0];

            if (s.viewStates && typeof s.viewStates === 'object') {
                this.viewStates = s.viewStates;
            }

            // Render tabs + open active
            TabManager.render();
            TabManager.open(IDE.state.activeTab);

            // Restore layout state (best-effort)
            if (typeof s.splitView === 'boolean') {
                IDE.state.splitView = s.splitView;
            }
            if (s.editorLayout) {
                IDE.state.editorLayout = s.editorLayout;
            }

            Utils.toast(' Session restored', 'success');
            return true;
        } catch (e) {
            console.warn('Session restore failed', e);
            return false;
        }
    },

    save: function(force = false) {
        try {
            const snapshot = {
                version: IDE.version,
                build: IDE.build,
                ts: Date.now(),
                tabs: Array.isArray(IDE.state.tabs) ? [...IDE.state.tabs] : [],
                activeTab: IDE.state.activeTab || null,
                splitView: !!IDE.state.splitView,
                editorLayout: IDE.state.editorLayout || 'single',
                viewStates: this.isPersistCursorEnabled() ? this.viewStates : {}
            };

            const hash = JSON.stringify([snapshot.tabs, snapshot.activeTab, snapshot.splitView, snapshot.editorLayout, Object.keys(snapshot.viewStates).length]);
            if (!force && hash === this._lastHash) return;

            this._lastHash = hash;
            localStorage.setItem(this.KEY(), JSON.stringify(snapshot));
        } catch (e) {}
    }
};

// ============================================
// COMMAND PALETTE MANAGER
// ============================================
const CommandPalette = {
    mode: 'commands', // 'commands' | 'files'

    show: function(mode = 'commands') {
        this.mode = mode;

        const palette = document.getElementById('command-palette');
        palette.classList.remove('hidden');

        const input = document.getElementById('command-input');
        input.value = '';
        input.placeholder = (mode === 'files') ? 'Type to search files (use ">" for commands)' : 'Type a command';
        input.focus();

        this.refreshCommands();
    },

    hide: function() {
        document.getElementById('command-palette').classList.add('hidden');
    },

    _score: function(text, query) {
        if (!query) return 1;
        const t = String(text).toLowerCase();
        const q = String(query).toLowerCase();

        // Direct substring is best
        const idx = t.indexOf(q);
        if (idx >= 0) return 1000 - idx;

        // Fuzzy: all chars in order
        let ti = 0;
        let score = 0;
        for (let qi = 0; qi < q.length; qi++) {
            const ch = q[qi];
            const found = t.indexOf(ch, ti);
            if (found === -1) return 0;
            score += 10;
            // closer is better
            score += Math.max(0, 20 - (found - ti));
            ti = found + 1;
        }
        return score;
    },

    _basename: function(path) {
        const p = String(path || '');
        const parts = p.split('/');
        return parts[parts.length - 1] || p;
    },

    _renderSection: function(listEl, title) {
        const sec = document.createElement('div');
        sec.className = 'command-section';
        sec.textContent = title;
        listEl.appendChild(sec);
    },

    _renderItem: function(listEl, { icon, text, shortcut, onClick, className = '' }) {
        const item = document.createElement('div');
        item.className = `command-item ${className}`.trim();
        item.innerHTML = `
            <div class="command-icon"><i class="fas ${icon}"></i></div>
            <div class="command-text">${text}</div>
            <div class="command-shortcut">${shortcut || ''}</div>
        `;
        item.onclick = onClick;
        listEl.appendChild(item);
        return item;
    },

    refreshCommands: function() {
        const list = document.getElementById('command-list');
        if (!list) return;
        list.innerHTML = '';

        const input = document.getElementById('command-input');
        const raw = (input?.value || '').trim();

        // ">" forces command mode
        const forcedCommands = raw.startsWith('>');
        const query = forcedCommands ? raw.slice(1).trim() : raw;
        const effectiveMode = forcedCommands ? 'commands' : this.mode;

        // Command list
        const commands = [
            // File operations
            { id: 'new-file', text: 'New File', icon: 'fa-file-plus', shortcut: 'Ctrl+N', action: () => FileSystem.createFilePrompt() },
            { id: 'new-folder', text: 'New Folder', icon: 'fa-folder-plus', action: () => FileSystem.createFolderPrompt() },
            { id: 'save', text: 'Save', icon: 'fa-save', shortcut: 'Ctrl+S', action: () => FileSystem.save(true) },
            { id: 'save-all', text: 'Save All', icon: 'fa-save', action: () => FileSystem.save(true) },
            { id: 'close-all', text: 'Close All Tabs', icon: 'fa-times', action: () => TabManager.closeAll() },

            // Edit operations
            { id: 'undo', text: 'Undo', icon: 'fa-undo', shortcut: 'Ctrl+Z', action: () => FileSystem.undo() },
            { id: 'redo', text: 'Redo', icon: 'fa-redo', shortcut: 'Ctrl+Y', action: () => FileSystem.redo() },
            { id: 'format', text: 'Format Document', icon: 'fa-indent', shortcut: 'Shift+Alt+F', action: () => EditorManager.formatDocument?.() },

            // Search
            { id: 'find', text: 'Find', icon: 'fa-search', shortcut: 'Ctrl+F', action: () => EditorManager.findText?.('') },
            { id: 'find-project', text: 'Find in Project', icon: 'fa-search-plus', shortcut: 'Ctrl+Shift+F', action: () => Search.findInProject?.() },

            // View
            { id: 'toggle-preview', text: 'Toggle Preview', icon: 'fa-eye', shortcut: 'Ctrl+B', action: () => LayoutManager.toggleLayout('preview') },
            { id: 'toggle-terminal', text: 'Toggle Terminal', icon: 'fa-terminal', shortcut: 'Ctrl+`', action: () => LayoutManager.toggleLayout('terminal') },
            { id: 'toggle-inspector', text: 'Toggle Inspector', icon: 'fa-crosshairs', shortcut: 'Ctrl+Shift+I', action: () => Inspector?.toggle?.() },

            // Settings
            { id: 'settings', text: 'Open Settings', icon: 'fa-cog', shortcut: 'Ctrl+,', action: () => Settings.show() },
        ];

        // Allow external commands
        if (typeof ViewErrorsCommand !== 'undefined') commands.push(ViewErrorsCommand);

        // ULTRA+ dynamic command injection
        try {
            if (window.UltraPlus && UltraPlus.getCommandPaletteEntries) {
                const extras = UltraPlus.getCommandPaletteEntries().map((c, i) => ({
                    id: c.id || `ultraplus-${i}`,
                    text: c.text || c.name || `ULTRA+ ${i + 1}`,
                    icon: c.icon || 'fa-bolt',
                    shortcut: c.shortcut || '',
                    action: typeof c.action === 'function' ? c.action : (() => {})
                }));
                commands.push(...extras);
            }
        } catch (e) {}

        const cmdMatches = commands
            .map(c => ({ ...c, _score: this._score(`${c.text} ${c.id}`, query) }))
            .filter(c => !query || c._score > 0)
            .sort((a, b) => b._score - a._score)
            .slice(0, 20);

        // File matches (when in files mode OR when query looks like a path)
        let fileMatches = [];
        if (effectiveMode === 'files' || (query.includes('/') && !forcedCommands)) {
            const files = Object.keys(IDE.state.files || {});
            fileMatches = files
                .map(p => ({ path: p, _score: this._score(p, query) }))
                .filter(f => !query || f._score > 0)
                .sort((a, b) => b._score - a._score)
                .slice(0, 25);
        }

        const anyFiles = fileMatches.length > 0;
        const anyCmds = cmdMatches.length > 0;

        if (effectiveMode === 'files') {
            this._renderSection(list, 'Files');
            if (!anyFiles) {
                const empty = document.createElement('div');
                empty.className = 'command-item';
                empty.innerHTML = `<div style="flex:1; text-align:center; color:var(--text-dim);">No files found</div>`;
                list.appendChild(empty);
            } else {
                fileMatches.forEach(f => {
                    const base = this._basename(f.path);
                    const text = `
                        <div class="cp-title">${base}</div>
                        <div class="cp-desc">${f.path}</div>
                    `;
                    const item = document.createElement('div');
                    item.className = 'command-item file-item';
                    item.innerHTML = `
                        <div class="command-icon"><i class="fas fa-file-code"></i></div>
                        <div class="command-text">${text}</div>
                        <div class="command-shortcut"></div>
                    `;
                    item.onclick = () => {
                        TabManager.open(f.path);
                        this.hide();
                    };
                    list.appendChild(item);
                });
            }

            // Also show commands section for convenience (especially when query is empty)
            this._renderSection(list, 'Commands');
            cmdMatches.slice(0, 12).forEach(cmd => {
                this._renderItem(list, {
                    icon: cmd.icon,
                    text: cmd.text,
                    shortcut: cmd.shortcut || '',
                    onClick: () => { cmd.action?.(); this.hide(); }
                });
            });
        } else {
            this._renderSection(list, 'Commands');
            if (!anyCmds) {
                const empty = document.createElement('div');
                empty.className = 'command-item';
                empty.innerHTML = `<div style="flex:1; text-align:center; color:var(--text-dim);">No commands found</div>`;
                list.appendChild(empty);
            } else {
                cmdMatches.forEach(cmd => {
                    this._renderItem(list, {
                        icon: cmd.icon,
                        text: cmd.text,
                        shortcut: cmd.shortcut || '',
                        onClick: () => { cmd.action?.(); this.hide(); }
                    });
                });
            }
        }

        // Auto-select first actionable item
        const first = list.querySelector('.command-item');
        if (first) first.classList.add('selected');
    },

    handleKey: function(event) {
        if (event.key === 'Escape') {
            this.hide();
            return;
        }

        if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
            event.preventDefault();
            const items = Array.from(document.querySelectorAll('#command-list .command-item'))
                .filter(el => !el.classList.contains('command-section'));
            if (!items.length) return;

            let currentIndex = items.findIndex(i => i.classList.contains('selected'));
            if (currentIndex >= 0) items[currentIndex].classList.remove('selected');

            if (event.key === 'ArrowDown') currentIndex = (currentIndex + 1) % items.length;
            else currentIndex = (currentIndex - 1 + items.length) % items.length;

            items[currentIndex].classList.add('selected');
            items[currentIndex].scrollIntoView({ block: 'nearest' });
        }

        if (event.key === 'Enter') {
            const selected = document.querySelector('#command-list .command-item.selected');
            if (selected) selected.click();
        }

        // refresh as user types
        setTimeout(() => this.refreshCommands(), 10);
    }
};

// ============================================
// TUTORIAL MANAGER
// ============================================
const Tutorial = {
    start: function() {
        Console.clear();
        Console.info(' Starting ProCode IDE Tutorial');
        Console.info('='.repeat(50));
        
        const steps = [
            {
                title: 'Welcome to ProCode IDE',
                content: 'This is a full-featured web development environment built with modern web technologies.',
                action: () => {
                    Utils.toast('Welcome!', 'info');
                }
            },
            {
                title: 'File Explorer',
                content: 'Use the file explorer on the left to navigate your project files.',
                action: () => {
                    LayoutManager.setSide('expl');
                }
            },
            {
                title: 'Editor',
                content: 'The editor supports syntax highlighting, auto-completion, and multiple cursors.',
                action: () => {
                    const editor = EditorManager.getCurrentEditor();
                    if (editor) editor.focus();
                }
            },
            {
                title: 'Terminal',
                content: 'Access the integrated terminal with support for commands and package management.',
                action: () => {
                    LayoutManager.toggleLayout('terminal', true);
                }
            },
            {
                title: 'Preview',
                content: 'See live previews of your web applications with hot reload.',
                action: () => {
                    LayoutManager.toggleLayout('preview', true);
                }
            },
            {
                title: 'AI Assistant',
                content: 'Get coding help from the AI assistant for debugging and code generation.',
                action: () => {
                    AI.toggle();
                }
            }
        ];
        
        let currentStep = 0;
        
        const showStep = (index) => {
            if (index >= steps.length) {
                Console.info(' Tutorial completed!');
                Utils.toast('Tutorial completed!', 'success');
                return;
            }
            
            const step = steps[index];
            Console.info(` Step ${index + 1}: ${step.title}`);
            Console.info(step.content);
            Console.info('---');
            
            step.action();
            
            if (index < steps.length - 1) {
                setTimeout(() => showStep(index + 1), 2000);
            }
        };
        
        showStep(currentStep);
    }
};

// ============================================
// NOTIFICATIONS MANAGER
// ============================================
const Notifications = {
    isVisible: false,
    notifications: [],
    
    toggle: function() {
        this.isVisible = !this.isVisible;
        
        if (this.isVisible) {
            this.showNotifications();
        } else {
            this.hideNotifications();
        }
    },
    
    showNotifications: function() {
        // Create notifications panel
        const panel = document.createElement('div');
        panel.id = 'notifications-panel';
        panel.className = 'modal-overlay';
        panel.style.alignItems = 'flex-start';
        panel.style.justifyContent = 'flex-end';
        panel.style.padding = '20px';
        
        panel.innerHTML = `
            <div class="modal" style="width:400px; max-height:80vh; margin:0;">
                <div class="modal-header">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <button class="btn icon small" onclick="Notifications.toggle()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="notifications-list">
                    <div style="text-align:center; padding:40px; color:var(--text-dim);">
                        No notifications
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="Notifications.clearAll()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(panel);
        
        this.updateNotificationsList();
    },
    
    hideNotifications: function() {
        const panel = document.getElementById('notifications-panel');
        if (panel) {
            panel.remove();
        }
        this.isVisible = false;
    },
    
    updateNotificationsList: function() {
        const list = document.getElementById('notifications-list');
        if (!list) return;
        
        if (this.notifications.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">No notifications</div>';
            return;
        }
        
        list.innerHTML = '';
        
        this.notifications.slice().reverse().forEach((notification, index) => {
            const item = document.createElement('div');
            item.className = 'notification-item';
            item.style.padding = '12px';
            item.style.borderBottom = '1px solid var(--border)';
            item.style.display = 'flex';
            item.style.gap = '12px';
            item.style.alignItems = 'flex-start';
            
            const icon = notification.type === 'error' ? 'fa-times-circle' :
                        notification.type === 'warning' ? 'fa-exclamation-triangle' :
                        notification.type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            const iconColor = notification.type === 'error' ? 'var(--error)' :
                             notification.type === 'warning' ? 'var(--warn)' :
                             notification.type === 'success' ? 'var(--success)' : 'var(--primary)';
            
            item.innerHTML = `
                <i class="fas ${icon}" style="color:${iconColor}; margin-top:2px;"></i>
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:500; margin-bottom:4px;">${notification.title}</div>
                    <div style="font-size:11px; color:var(--text-dim);">${notification.message}</div>
                    <div style="font-size:9px; color:var(--text-dim); margin-top:4px;">
                        ${Utils.formatDate(notification.timestamp, 'relative')}
                    </div>
                </div>
                <button class="btn icon small" onclick="Notifications.removeNotification(${this.notifications.length - 1 - index})" style="color:var(--text-dim);">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            list.appendChild(item);
        });
    },
    
    add: function(title, message, type = 'info') {
        const notification = {
            id: Utils.uuid(),
            title: title,
            message: message,
            type: type,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        this.notifications.push(notification);
        
        // Keep only last 50 notifications
        if (this.notifications.length > 50) {
            this.notifications.shift();
        }
        
        // Update badge
        this.updateBadge();
        
        // Update UI if visible
        if (this.isVisible) {
            this.updateNotificationsList();
        }
        
        // Show toast
        Utils.toast(message, type);
    },
    
    removeNotification: function(index) {
        if (index >= 0 && index < this.notifications.length) {
            this.notifications.splice(index, 1);
            this.updateBadge();
            this.updateNotificationsList();
        }
    },
    
    clearAll: function() {
        this.notifications = [];
        this.updateBadge();
        this.updateNotificationsList();
        Utils.toast('All notifications cleared', 'info');
    },
    
    updateBadge: function() {
        const unreadCount = this.notifications.filter(n => !n.read).length;
        const badge = document.querySelector('[title="Notifications"] .badge');
        
        if (badge) {
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }
};

// THM VO cui file, trc window.addEventListener('load')
class MemoryManager {
    constructor() {
        this.cleanupTasks = [];
        this.memoryWarningThreshold = 0.85; // 85% memory usage
        this.checkInterval = 30000; // 30s
        
        this.startMonitoring();
    }
    
    startMonitoring() {
        //  Monitor memory usage if available
        if (performance.memory) {
            setInterval(() => this.checkMemory(), this.checkInterval);
        }
        
        //  Setup page visibility change handler
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.performMaintenance();
            }
        });
    }
    
    checkMemory() {
        if (!performance.memory) return;
        
        const { usedJSHeapSize, jsHeapSizeLimit } = performance.memory;
        const usage = usedJSHeapSize / jsHeapSizeLimit;
        
        if (usage > this.memoryWarningThreshold) {
            console.warn(` High memory usage: ${(usage * 100).toFixed(1)}%`);
            this.performMaintenance();
        }
    }
    
    performMaintenance() {
        console.log(' Performing memory maintenance...');
        
        //  Clear editor cache
        if (EditorManager.instances) {
            Object.values(EditorManager.instances).forEach(editor => {
                if (editor && editor.getModel()) {
                    const model = editor.getModel();
                    // Clear undo/redo history if too large
                    if (model.getAlternativeVersionId() > 100) {
                        // model.pushEditOperations([], [], () => null);
                    }
                }
            });
        }
        
        //  Clear file cache
        if (FileSystem.fileCache) {
            const cacheSize = Object.keys(FileSystem.fileCache).length;
            if (cacheSize > 50) {
                FileSystem.fileCache = {};
                console.log(`Cleared ${cacheSize} cached files`);
            }
        }
        
        //  Clear terminal history
        if (TerminalManager.terminals) {
            Object.values(TerminalManager.terminals).forEach(term => {
                if (term.commandHistory && term.commandHistory.length > 100) {
                    term.commandHistory = term.commandHistory.slice(-50);
                }
            });
        }
        
        //  Clear console
        if (Console.getHost()) {
            const host = Console.getHost();
            const children = host.children;
            if (children.length > Console.maxEntries) {
                while (children.length > Console.maxEntries / 2) {
                    host.removeChild(children[0]);
                }
            }
        }
        
        //  Flush IndexedDB
        if (IndexedDBManager.batcher) {
            IndexedDBManager.batcher.flush();
        }
        
        //  Clear expired cache
        IndexedDBManager.clearExpiredCache();
        
        //  Run custom cleanup tasks
        this.cleanupTasks.forEach(task => {
            try {
                task();
            } catch (error) {
                console.error('Cleanup task failed:', error);
            }
        });
        
        console.log(' Maintenance complete');
    }
    
    registerCleanupTask(task) {
        this.cleanupTasks.push(task);
    }
    
    dispose() {
        this.cleanupTasks = [];
    }
}

// Initialize
window.memoryManager = new MemoryManager();

// Register cleanup for page unload
window.addEventListener('beforeunload', () => {
    window.memoryManager.performMaintenance();
    window.memoryManager.dispose();
});

// ============================================
// INITIALIZATION AND STARTUP
// ============================================
window.addEventListener('load', async function() {
    console.log(' ProCode IDE v19.0 - Hyper Ultimate ULTRA Edition');
    console.log(' Build:', IDE.build);
    
    // Update boot progress
    const updateProgress = (message, percent) => {
        document.getElementById('boot-status').textContent = message;
        document.getElementById('boot-progress-fill').style.width = percent + '%';
    };
    
    updateProgress('Loading core modules...', 10);
    
    // Initialize components
    try {
        updateProgress('Initializing file system...', 20);
        await FileSystem.init();
        
        updateProgress('Loading editor engine...', 40);

await EditorManager.init();

// ULTRA: auto-recovery (crash-safe) and session restore
try { if (window.AutoRecovery && AutoRecovery.checkRecovery) AutoRecovery.checkRecovery(); } catch (e) {}
try { if (window.SessionManager && (!window.AutoRecovery || !AutoRecovery.didRestore)) SessionManager.restore(); } catch (e) {}

updateProgress('Starting terminal...', 60);
        TerminalManager.init();
        try { if (TerminalManager.applySettings) TerminalManager.applySettings(); } catch (e) {}
        Console.init();
        // Web Worker is initialized on-demand by the editor/terminal subsystems.
        updateProgress('Loading AI assistant...', 80);
        // AI will load on first use
        
        updateProgress('Finalizing setup...', 95);
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup resizable panels
        setupResizablePanels();
        
        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        updateProgress('Ready!', 100);
        
        // Hide loader with delay
        setTimeout(() => {
            document.getElementById('loader-overlay').style.display = 'none';
            Utils.toast('ProCode IDE v19.0 loaded successfully!', 'success');
            
            // Show welcome notification
            Notifications.add(
                'Welcome to ProCode IDE v19.0',
                'Start coding with multi-language support, AI assistant, and live preview.',
                'info'
            );
        }, 500);
        
    } catch (error) {
        console.error('Startup failed:', error);
        updateProgress(`Startup failed: ${error.message}`, 100);
        
        setTimeout(() => {
            document.getElementById('loader-overlay').innerHTML = `
                <div style="text-align:center; color:var(--error);">
                    <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:20px;"></i>
                    <div style="font-size:16px; font-weight:600; margin-bottom:10px;">Startup Failed</div>
                    <div style="font-size:13px; color:var(--text-dim); margin-bottom:20px;">${error.message}</div>
                    <button class="btn primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Reload IDE
                    </button>
                </div>
            `;
        }, 1000);
    }
});

// THM ngay sau window.addEventListener('load'...)
class GlobalErrorHandler {
    constructor() {
        this.errors = [];
        this.maxErrors = 50;
    this._dedup = new Map();
    this._dedupWindowMs = 2500;
    this._dedupMaxBurst = 3;
    this._inConsoleCapture = false;
        this.setupHandlers();
    }
    
    setupHandlers() {
        //  Global error handler
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error,
                timestamp: new Date().toISOString()
            });
            
            // Prevent default only for non-critical errors
            if (!this.isCriticalError(event.error)) {
                event.preventDefault();
            }
        });
        
        //  Unhandled promise rejection
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'unhandledRejection',
                message: event.reason?.message || String(event.reason),
                error: event.reason,
                timestamp: new Date().toISOString()
            });
            
            event.preventDefault();
        });
        
        //  Console error override (safe, no recursion)
        this._originalConsoleError = (this._originalConsoleError || console.error).bind(console);
        console.error = (...args) => {
            // Always log using the original console.error
            this._originalConsoleError(...args);

            // Prevent recursion / infinite loops if handleError logs too
            if (this._inConsoleCapture) return;
            this._inConsoleCapture = true;
            try {
                this.handleError({
                    type: 'console',
                    message: args.map(a => {
                        try {
                            if (a instanceof Error) return a.stack || a.message || String(a);
                            if (typeof a === 'object') return JSON.stringify(a, this.safeStringifyReplacer(), 2);
                            return String(a);
                        } catch {
                            return String(a);
                        }
                    }).join(' '),
                    timestamp: new Date().toISOString()
                });
            } finally {
                this._inConsoleCapture = false;
            }
        };
    }
    
    handleError(error) {
        // Deduplicate noisy repeated errors to prevent UI/console spam
        try {
            const sig = (() => {
                const t = Object.prototype.toString.call(error);
                const msg = (error && (error.message || error.reason || error.name)) ? String(error.message || error.reason || error.name) : '';
                const stk = (error && error.stack) ? String(error.stack).slice(0, 200) : '';
                return t + '|' + msg + '|' + stk;
            })();
            const now = Date.now();
            const entry = this._dedup.get(sig) || { count: 0, first: now, last: 0 };
            entry.count += 1;
            entry.last = now;
            if ((now - entry.first) >= this._dedupWindowMs) { entry.count = 1; entry.first = now; }
            this._dedup.set(sig, entry);
            if (entry.count > this._dedupMaxBurst) {
                if (entry.count === this._dedupMaxBurst + 1) {
                    (this._originalConsoleWarn || console.warn).call(console, ' Suppressing repeated error spam:', msg || t);
                }
                return;
            }
        } catch (_) {}

        this.errors.push(error);
        
        // Keep only recent errors
        if (this.errors.length > this.maxErrors) {
            this.errors.shift();
        }
        
        try { (this._originalConsoleError || console.error).call(console, ' Error caught:', error); } catch (_) {}
        
        // Show user-friendly message for critical errors
        if (this.isCriticalError(error.error)) {
            this.showCriticalError(error);
        }
        
        // Log to backend if configured
        this.logError(error);
    }
    
    isCriticalError(error) {
        if (!error) return false;
        
        const criticalMessages = [
            'out of memory',
            'script error',
            'network error',
            'quota exceeded'
        ];
        
        const message = (error.message || '').toLowerCase();
        return criticalMessages.some(msg => message.includes(msg));
    }
    
    showCriticalError(error) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.style.zIndex = '99999';
        overlay.innerHTML = `
            <div class="modal" style="width:600px;">
                <div class="modal-header" style="background:var(--error);">
                    <h3 style="color:white;"><i class="fas fa-exclamation-triangle"></i> Critical Error</h3>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom:16px;">The IDE encountered a critical error:</p>
                    <pre style="background:#1e1e1e; color:#fff; padding:12px; border-radius:8px; overflow:auto; max-height:200px;">${Utils.escapeHtml(error.message)}</pre>
                    <p style="margin-top:16px; color:var(--text-dim); font-size:12px;">
                        Your work has been auto-saved. You may need to reload the page.
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="this.closest('.modal-overlay').remove()">Dismiss</button>
                    <button class="btn primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Reload IDE
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Auto-save before showing error
        if (FileSystem.autoSave) {
            FileSystem.autoSave.forceFlush();
        }
    }

    safeStringifyReplacer() {
        const seen = new WeakSet();
        return (key, value) => {
            if (typeof value === 'object' && value !== null) {
                if (seen.has(value)) return '[Circular]';
                seen.add(value);
            }
            if (typeof value === 'function') return `[Function ${value.name || 'anonymous'}]`;
            if (value instanceof Error) {
                return { name: value.name, message: value.message, stack: value.stack };
            }
            return value;
        };
    }

    logError(error) {
        // Could send to analytics/logging service
        // For now, just store locally
        try {
            const errorLog = JSON.parse(localStorage.getItem('procode_error_log') || '[]');
            errorLog.push(error);
            
            // Keep only last 100 errors
            if (errorLog.length > 100) {
                errorLog.splice(0, errorLog.length - 100);
            }
            
            localStorage.setItem('procode_error_log', JSON.stringify(errorLog));
        } catch (e) {
            // Ignore storage errors
        }
    }
    
    getRecentErrors() {
        return this.errors.slice(-10);
    }
    
    clearErrors() {
        this.errors = [];
        localStorage.removeItem('procode_error_log');
    }
}

// Initialize
window.errorHandler = new GlobalErrorHandler();

// Add error viewer command to Command Palette
// (thm vo CommandPalette.refreshCommands)
const ViewErrorsCommand = {
    id: 'view-errors',
    text: 'View Recent Errors',
    icon: 'fa-bug',
    action: () => {
        const errors = window.errorHandler.getRecentErrors();
        if (errors.length === 0) {
            Utils.toast('No recent errors', 'info');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal" style="width:800px;">
                <div class="modal-header">
                    <h3><i class="fas fa-bug"></i> Recent Errors (${errors.length})</h3>
                    <button class="btn icon small" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height:500px; overflow-y:auto;">
                    ${errors.map(err => `
                        <div style="margin-bottom:16px; padding:12px; background:var(--bg-side); border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="font-weight:600; color:var(--error);">${err.type}</span>
                                <span style="font-size:11px; color:var(--text-dim);">${Utils.formatDate(err.timestamp, 'relative')}</span>
                            </div>
                            <pre style="font-size:11px; overflow-x:auto;">${Utils.escapeHtml(err.message)}</pre>
                        </div>
                    `).join('')}
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    <button class="btn danger" onclick="window.errorHandler.clearErrors(); this.closest('.modal-overlay').remove(); Utils.toast('Errors cleared', 'info');">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
};

function setupEventListeners() {
    // ULTRA init
    try { Settings.init(); } catch(e) {}
    try { if (window.SessionManager) SessionManager.init(); } catch(e) {}

    // Command palette input
    const commandInput = document.getElementById('command-input');
    if (commandInput) {
        commandInput.addEventListener('input', () => CommandPalette.refreshCommands());
        commandInput.addEventListener('keydown', (e) => CommandPalette.handleKey(e));
    }
    
    // Search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') Search.execute();
        });
    }
    
    // AI input
    const aiInput = document.getElementById('ai-input');
    if (aiInput) {
        aiInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                AI.send();
            }
        });
    }
    
    // Spotlight search
    const spotlight = document.getElementById('spotlight');
    if (spotlight) {
        spotlight.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const query = spotlight.value.trim();
                if (query) {
                    // Search for files containing the query
                    const files = Object.keys(IDE.state.files).filter(path => 
                        path.toLowerCase().includes(query.toLowerCase())
                    );
                    
                    if (files.length > 0) {
                        TabManager.open(files[0]);
                        spotlight.value = '';
                    } else {
                        Utils.toast('No files found', 'warning');
                    }
                }
            }
        });
    }
    
    // Close modals on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // Close open modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Close command palette
            CommandPalette.hide();
            
            // Close context menus
            document.querySelectorAll('.context-menu').forEach(menu => {
                menu.remove();
            });
            
            // Close AI assistant
            if (AI.isVisible) {
                AI.toggle();
            }
        }
    });
    
    // Auto-save on blur
    window.addEventListener('blur', () => {
        if (IDE.state.settings.editor.autoSave && IDE.state.dirtyTabs.size > 0) {
            FileSystem.save();
        }
    });

    // Drag & drop import overlay (ULTRA+)
    try { if (window.UltraPlus) UltraPlus.initDragDrop(); } catch(e) {}
}

function setupResizablePanels() {
    // Sidebar resizer
    const sideResizer = document.getElementById('rs-side');
    const sidebar = document.querySelector('.sidebar.active');
    const actBar = document.querySelector('.act-bar');
    
    if (sideResizer && sidebar) {
        let isResizing = false;
        
        sideResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            sideResizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            
            const startX = e.clientX;
            const startWidth = sidebar.offsetWidth;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                let newWidth = startWidth + deltaX;
                
                // Constrain width
                newWidth = Math.max(200, Math.min(600, newWidth));
                
                sidebar.style.width = newWidth + 'px';
                document.documentElement.style.setProperty('--side-w', newWidth + 'px');
            }
            
            function onMouseUp() {
                isResizing = false;
                sideResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
    
    // Panel resizer
    const panelResizer = document.getElementById('rs-panel');
    const panel = document.getElementById('panel-btm');
    
    if (panelResizer && panel) {
        let isResizing = false;
        
        panelResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            panelResizer.classList.add('dragging');
            document.body.style.cursor = 'row-resize';
            
            const startY = e.clientY;
            const startHeight = panel.offsetHeight;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaY = startY - e.clientY;
                let newHeight = startHeight + deltaY;
                
                // Constrain height
                newHeight = Math.max(100, Math.min(window.innerHeight - 200, newHeight));
                
                Panel.resize(newHeight);
            }
            
            function onMouseUp() {
                isResizing = false;
                panelResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
    
    // Preview resizer
    const previewResizer = document.getElementById('rs-preview');
    const previewWrap = document.getElementById('preview-wrap');
    
    if (previewResizer && previewWrap) {
        let isResizing = false;
        
        previewResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            previewResizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            
            const startX = e.clientX;
            const startWidth = previewWrap.offsetWidth;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaX = startX - e.clientX;
                let newWidth = startWidth + deltaX;
                
                // Constrain width
                newWidth = Math.max(300, Math.min(window.innerWidth - 400, newWidth));
                
                previewWrap.style.width = newWidth + 'px';
            }
            
            function onMouseUp() {
                isResizing = false;
                previewResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Don't trigger if typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        const ctrl = e.ctrlKey || e.metaKey;
        const shift = e.shiftKey;
        const alt = e.altKey;
        

        // Command palette & quick open
        if (ctrl && !shift && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            try { CommandPalette.show('files'); } catch (_) {}
        }
        if (ctrl && shift && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            try { CommandPalette.show('commands'); } catch (_) {}
        }

        // File operations
        if (ctrl && e.key === 'n') {
            e.preventDefault();
            FileSystem.createFilePrompt();
        }
        
        if (ctrl && e.key === 's') {
            e.preventDefault();
            FileSystem.save(true);
        }        if (ctrl && shift && e.key === 'S') {
            e.preventDefault();
            FileSystem.exportZip();
        }

        // Workspace I/O (ULTRA+)
        if (ctrl && alt && e.key.toLowerCase() === 'o') {
            e.preventDefault();
            try { WorkspaceIO.openDirectory({ replace: true }); } catch (_) {}
        }

        if (ctrl && alt && e.key.toLowerCase() === 's') {
            e.preventDefault();
            try { WorkspaceIO.syncToDisk({ onlyDirty: false }); } catch (_) {}
        }

        if (ctrl && alt && e.key.toLowerCase() === 'r') {
            e.preventDefault();
            try { WorkspaceIO.pullFromDisk(); } catch (_) {}
        }

        if (e.key === 'F1') {
            e.preventDefault();
            try { ShortcutsModal.show(); } catch (_) {}
        }

        // Edit operations
        if (ctrl && e.key === 'z') {
            e.preventDefault();
            FileSystem.undo();
        }
        
        if (ctrl && shift && e.key === 'Z') {
            e.preventDefault();
            FileSystem.redo();
        }
        
        if (ctrl && e.key === 'f') {
            e.preventDefault();
            EditorManager.findText('');
        }
        
        if (ctrl && shift && e.key === 'f') {
            e.preventDefault();
            Search.findInProject();
        }
        
        if (ctrl && e.key === 'h') {
            e.preventDefault();
            Search.replace();
        }
        
        
// View operations
if (ctrl && shift && e.key.toLowerCase() === 'p') {
    e.preventDefault();
    CommandPalette.show('commands');
}

if (ctrl && !shift && e.key.toLowerCase() === 'p') {
    e.preventDefault();
    CommandPalette.show('files');
}

if (ctrl && e.key === 'b') {
            e.preventDefault();
            LayoutManager.toggleLayout('preview');
        }
        
        if (ctrl && e.key === '`') {
            e.preventDefault();
            LayoutManager.toggleLayout('terminal');
        }
        
        if (ctrl && e.key === '\\') {
            e.preventDefault();
            LayoutManager.splitEditor();
        }
        
        if (ctrl && e.key === '=') {
            e.preventDefault();
            EditorManager.zoomIn();
        }
        
        if (ctrl && e.key === '-') {
            e.preventDefault();
            EditorManager.zoomOut();
        }
        
        if (ctrl && e.key === '0') {
            e.preventDefault();
            EditorManager.resetZoom();
        }
        
        

        // Inspector
        if (ctrl && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
            e.preventDefault();
            try { Inspector.toggle(); } catch (_) {}
        }
// Run/debug
        if (e.key === 'F5') {
            e.preventDefault();
            Runner.exec();
        }
        
        if (e.key === 'F9') {
            e.preventDefault();
            Debugger.toggle();
        }
        
        if (shift && e.key === 'F5') {
            e.preventDefault();
            Runner.reload();
        }
        
        // AI assistant
        if (ctrl && shift && e.key === 'A') {
            e.preventDefault();
            AI.toggle();
        }
        
        // Toggle panels
        if (ctrl && e.key === 'j') {
            e.preventDefault();
            Panel.toggle();
        }
        
        // Format code
        if (ctrl && shift && e.key === 'F') {
            e.preventDefault();
            EditorManager.formatCode();
        }
        
        // Quick navigation
        if (ctrl && e.key === 'g') {
            e.preventDefault();
            const line = prompt('Go to line:', '1');
            if (line) {
                EditorManager.goToLine(parseInt(line));
            }
        }
        
        // Find symbol
        if (ctrl && shift && e.key === 'O') {
            e.preventDefault();
            FileSystem.updateOutline();
        }
    });
}

// ============================================

// ============================================
// INSPECTOR (Preview DOM inspector via postMessage)  v19.0
// ============================================
Inspector = {
    enabled: false,
    last: null,
    _els: null,

    init: function() {
        if (this._els) return;
        this._els = {
            panel: document.getElementById('inspector-panel'),
            hint: document.getElementById('inspector-hint'),
            status: document.getElementById('inspector-status'),
            selector: document.getElementById('inspector-selector'),
            tag: document.getElementById('inspector-tag'),
            text: document.getElementById('inspector-text'),
            rect: document.getElementById('inspector-rect'),
            styles: document.getElementById('inspector-styles'),
            html: document.getElementById('inspector-html'),
            close: document.getElementById('inspector-close'),
            copySel: document.getElementById('inspector-copy-selector'),
            copyHtml: document.getElementById('inspector-copy-html')
        };

        this._els.close?.addEventListener('click', () => this.setEnabled(false));
        this._els.copySel?.addEventListener('click', async () => {
            const v = this.last?.selector || '';
            if (!v) return Utils.toast('No selector to copy', 'warning');
            try { await navigator.clipboard.writeText(v); Utils.toast('Selector copied', 'success'); } 
            catch { Utils.toast('Clipboard permission denied', 'warning'); }
        });
        this._els.copyHtml?.addEventListener('click', async () => {
            const v = this.last?.html || '';
            if (!v) return Utils.toast('No HTML to copy', 'warning');
            try { await navigator.clipboard.writeText(v); Utils.toast('HTML copied', 'success'); } 
            catch { Utils.toast('Clipboard permission denied', 'warning'); }
        });
    },

    toggle: function() {
        this.setEnabled(!this.enabled);
    },

    setEnabled: function(v) {
        this.init();
        this.enabled = !!v;

        this._els?.panel?.classList.toggle('visible', this.enabled);
        this._els?.hint?.classList.toggle('visible', this.enabled);
        if (this._els?.status) this._els.status.textContent = this.enabled ? 'Waiting' : 'Off';

        // Visual state on toolbar button (best effort)
        const btn = document.querySelector('.preview-toolbar button[onclick*="Inspector.toggle"]');
        btn?.classList.toggle('primary', this.enabled);

        // Tell preview frame
        if (typeof Runner?.postToPreview === 'function') {
            Runner.postToPreview({ type: 'inspector-toggle', enabled: this.enabled });
        } else {
            // Fallback: try to post directly
            try {
                const frame = document.getElementById('preview-frame');
                frame?.contentWindow?.postMessage({ token: Runner?._previewToken, type: 'inspector-toggle', enabled: this.enabled }, '*');
            } catch(e){}
        }

        Utils.toast(this.enabled ? 'Inspector enabled' : 'Inspector disabled', this.enabled ? 'success' : 'info');
    },

    onMessage: function(payload) {
        if (!payload) return;

        // handshake update
        if (typeof payload.enabled === 'boolean') {
            if (this._els?.status) this._els.status.textContent = payload.enabled ? 'Ready' : 'Off';
            return;
        }

        this.last = payload;
        if (this._els?.status) this._els.status.textContent = 'Selected';

        if (this._els?.selector) this._els.selector.textContent = payload.selector || '';
        if (this._els?.tag) this._els.tag.textContent = payload.tag || '';
        if (this._els?.text) this._els.text.textContent = payload.text || '';

        const r = payload.rect;
        if (this._els?.rect) {
            this._els.rect.textContent = r ? `${Math.round(r.width)}${Math.round(r.height)} @ (${Math.round(r.x)}, ${Math.round(r.y)})` : '';
        }

        if (this._els?.styles) {
            this._els.styles.textContent = payload.styles ? JSON.stringify(payload.styles, null, 2) : '';
        }
        if (this._els?.html) {
            this._els.html.textContent = payload.html || '';
        }
    }
};

// Patch Runner to add a safe postMessage helper and inspector message handling
(function(){
    if (!Runner || Runner.__inspectorPatched) return;
    Runner.__inspectorPatched = true;

    Runner.postToPreview = function(msg) {
        try {
            const frame = document.getElementById('preview-frame');
            if (!frame || !frame.contentWindow) return false;
            const payload = Object.assign({ token: this._previewToken }, msg || {});
            frame.contentWindow.postMessage(payload, '*');
            return true;
        } catch (e) { return false; }
    };

    // Extend message handler
    const _orig = Runner.handleIframeMessage?.bind(Runner);
    Runner.handleIframeMessage = function(event) {
        try {
            const frame = document.getElementById('preview-frame');
            if (frame && event.source !== frame.contentWindow) return;
            const d = event.data;
            if (!d || typeof d !== 'object') return;
            if (Runner._previewToken && d.token !== Runner._previewToken) return;

            if (d.type === 'inspector') {
                Inspector.onMessage(d.payload);
                return;
            }
        } catch(e) {}

        return _orig ? _orig(event) : undefined;
    };

    // Ensure we re-sync inspector state after preview loads
    const _origRunWeb = Runner.runWeb?.bind(Runner);
    Runner.runWeb = function(path) {
        const r = _origRunWeb ? _origRunWeb(path) : undefined;
        // If inspector was enabled, keep it enabled after a short delay
        if (Inspector?.enabled) {
            setTimeout(() => Runner.postToPreview({ type: 'inspector-toggle', enabled: true }), 350);
        }
        return r;
    };
})();


// EXPORT GLOBAL FUNCTIONS FOR HTML ONCLICK
// ============================================
window.FS = FileSystem;
window.EditorManager = EditorManager;
window.TabManager = TabManager;
window.TerminalManager = TerminalManager;
window.Runner = Runner;
window.Inspector = Inspector;
window.Debugger = Debugger;
window.Panel = Panel;
window.AI = AI;
window.ProjectTemplates = ProjectTemplates;
window.Git = Git;
window.Search = Search;
window.LayoutManager = LayoutManager;
window.Layout = LayoutManager;
window.Settings = Settings;
window.SessionManager = SessionManager;
window.CommandPalette = CommandPalette;
window.Tutorial = Tutorial;
window.Notifications = Notifications;
window.Utils = Utils;
window.IDE = IDE;

// Initialize on window load
window.addEventListener('DOMContentLoaded', () => {
    // Set initial cursor position
    document.getElementById('cursor-pos').textContent = 'Ln 1, Col 1';
    document.getElementById('file-lang').textContent = 'Plain Text';
    document.getElementById('file-enc').textContent = 'UTF-8';
    document.getElementById('file-size').textContent = '0 B';
    document.getElementById('line-endings').textContent = 'LF';
    document.getElementById('git-status-text').textContent = 'Local clean';
    document.getElementById('status-indicator').className = 'status-dot';
});

// Service Worker registration (optional in single-file build)
// If you exported a sw.js next to this HTML (Command Palette  PWA: Export PWA Bundle), the IDE will register it.
if ('serviceWorker' in navigator && location.protocol !== 'file:') {
    window.addEventListener('load', async () => {
        const swPath = './sw.js';
        try {
            const existing = await navigator.serviceWorker.getRegistration();
            if (existing) {
                console.log('ServiceWorker already registered:', existing);
                try { if (window.PWA && typeof window.PWA._hookReg === 'function') window.PWA._hookReg(existing); } catch {}
                return;
            }

            // Some hosts disallow HEAD; do a small GET check.
            const res = await fetch(swPath, { cache: 'no-store' });
            if (!res || !res.ok) throw new Error('sw.js not found');
            const reg = await navigator.serviceWorker.register(swPath);
            console.log('ServiceWorker registered:', reg);
            try { if (window.PWA && typeof window.PWA._hookReg === 'function') window.PWA._hookReg(reg); } catch {}
        } catch (error) {
            console.log('ServiceWorker not registered (single-file mode):', error);
        }
    });
}

// Online/offline detection
window.addEventListener('online', () => {
    document.getElementById('status-indicator').className = 'status-dot';
    Utils.toast('Back online', 'success');
});

window.addEventListener('offline', () => {
    document.getElementById('status-indicator').className = 'status-dot offline';
    Utils.toast('Working offline', 'warning');
});
// Setup cleanup on page unload
window.addEventListener('beforeunload', (e) => {
    // Save everything
    FileSystem.save(true);
    
    // Cleanup editors
    EditorManager.cleanup();
    
    // Terminate worker
    if (FileSystem.worker) {
        FileSystem.terminateWorker();
    }
    
    // Cleanup terminal
    Object.values(TerminalManager.terminals).forEach(terminal => {
        if (terminal.instance) {
            terminal.instance.dispose();
        }
    });
});
// ============================================
// AUTO-RECOVERY SYSTEM
// ============================================
const AutoRecovery = {
    STORAGE_KEY: () => `procode_recovery_v${IDE.version}_latest`,
    CLEAN_EXIT_KEY: () => `procode_clean_exit_v${IDE.version}`,
    INTERVAL: 30000, // 30 seconds
    didRestore: false,

    init: function() {
        // Mark this run as "unclean" until we unload cleanly
        try { localStorage.setItem(this.CLEAN_EXIT_KEY(), '0'); } catch (e) {}

        // Start auto-save
        this.startAutoSave();

        // Setup beforeunload (best-effort)
        window.addEventListener('beforeunload', () => {
            try { this.onBeforeUnload(); } catch (e) {}
        });
    },

    onBeforeUnload: function() {
        // Only save a recovery point if there are unsaved changes
        if (IDE.state?.dirtyTabs && IDE.state.dirtyTabs.size > 0) {
            this.saveRecoveryPoint();
        } else {
            this.clearRecovery();
        }

        // Mark clean exit
        try { localStorage.setItem(this.CLEAN_EXIT_KEY(), '1'); } catch (e) {}
    },

    startAutoSave: function() {
        setInterval(() => {
            try {
                // Avoid noisy writes while idle
                if (document.hidden) return;
                this.saveRecoveryPoint();
            } catch (e) {}
        }, this.INTERVAL);
    },

    saveRecoveryPoint: function() {
        // Only if there's something meaningful to recover
        if (!IDE.state?.dirtyTabs || IDE.state.dirtyTabs.size === 0) return;

        const payload = {
            ts: Date.now(),
            files: IDE.state.files,
            tabs: IDE.state.tabs,
            activeTab: IDE.state.activeTab,
            viewStates: (window.SessionManager && SessionManager.isPersistCursorEnabled())
                ? SessionManager.viewStates
                : {}
        };

        try {
            localStorage.setItem(this.STORAGE_KEY(), JSON.stringify(payload));
        } catch (e) {
            // Storage might be full; ignore silently
        }
    },

    checkRecovery: function() {
        try {
            const clean = localStorage.getItem(this.CLEAN_EXIT_KEY()) === '1';
            if (clean) {
                // Clean exit -> no prompt; clear stale recovery
                this.clearRecovery();
                return false;
            }

            const raw = localStorage.getItem(this.STORAGE_KEY());
            if (!raw) return false;

            const data = JSON.parse(raw);
            if (!data || !data.files) {
                this.clearRecovery();
                return false;
            }

            const age = Date.now() - (data.ts || 0);
            const maxAge = 1000 * 60 * 60 * 24 * 3; // 3 days
            if (age > maxAge) {
                this.clearRecovery();
                return false;
            }

            const ok = confirm(' Detected an unclean exit. Restore your last auto-save?');
            if (!ok) {
                this.clearRecovery();
                return false;
            }

            this.restore(data);
            return true;
        } catch (error) {
            console.error('Failed to check recovery:', error);
            this.clearRecovery();
            return false;
        }
    },

    restore: function(recoveryData) {
        try {
            IDE.state.files = recoveryData.files || IDE.state.files;
            IDE.state.tabs = Array.isArray(recoveryData.tabs) ? recoveryData.tabs : IDE.state.tabs;
            IDE.state.activeTab = recoveryData.activeTab || IDE.state.activeTab;

            // Restore viewStates if present
            if (window.SessionManager && recoveryData.viewStates && typeof recoveryData.viewStates === 'object') {
                SessionManager.viewStates = recoveryData.viewStates;
            }

            FileSystem.save(true);
            FileSystem.refreshTree();

            if (IDE.state.activeTab) {
                TabManager.open(IDE.state.activeTab);
            }

            this.didRestore = true;
            Utils.toast(' Work restored from auto-save', 'success');
            this.clearRecovery();
        } catch (error) {
            Utils.toast('Failed to restore: ' + error.message, 'error');
        }
    },

    clearRecovery: function() {
        try { localStorage.removeItem(this.STORAGE_KEY()); } catch (e) {}
    }
};

// Initialize auto-recovery (recovery prompt runs after boot)
AutoRecovery.init();


/* ============================================================
 * SUPERPATCH v10-INFINITY (2025-12-31)
 * - Removes duplicated/truncated code path
 * - Hardens storage + dependency loading
 * - Fixes debugger breakpoint rendering + gutter toggles
 * - Adds system diagnostics (Ctrl+Shift+D) + dependency loader
 * ============================================================ */
(function(){
  'use strict';
  try {
    if (window.__PROCODEIDE_SUPERPATCH_V10__) return;
    window.__PROCODEIDE_SUPERPATCH_V10__ = { ts: Date.now() };
  } catch(e) {}

  // 1) Safe Storage patch (localStorage/sessionStorage no-crash + in-memory fallback)
  (function(){
    try{
      if (window.__PC_STORAGE_PATCHED__) return;
      window.__PC_STORAGE_PATCHED__ = true;

      const fallback = new WeakMap(); // Storage -> Map
      const getMap = (storage) => {
        let m = fallback.get(storage);
        if (!m) { m = new Map(); fallback.set(storage, m); }
        return m;
      };

      const orig = {
        getItem: Storage.prototype.getItem,
        setItem: Storage.prototype.setItem,
        removeItem: Storage.prototype.removeItem,
        clear: Storage.prototype.clear
      };

      Storage.prototype.setItem = function(k, v) {
        try {
          return orig.setItem.call(this, k, v);
        } catch (e) {
          try { getMap(this).set(String(k), String(v)); } catch (_) {}
          try {
            if (!this.__pc_fallback_warned__) {
              this.__pc_fallback_warned__ = true;
              console.warn('Storage.setItem failed; using in-memory fallback for this session.', e);
            }
          } catch (_) {}
          return undefined;
        }
      };

      Storage.prototype.getItem = function(k) {
        try {
          const r = orig.getItem.call(this, k);
          if (r !== null) return r;
        } catch (_) {}
        try {
          const m = getMap(this);
          const key = String(k);
          return m.has(key) ? m.get(key) : null;
        } catch (_) {
          return null;
        }
      };

      Storage.prototype.removeItem = function(k) {
        try { orig.removeItem.call(this, k); } catch (_) {}
        try { getMap(this).delete(String(k)); } catch (_) {}
      };

      Storage.prototype.clear = function() {
        try { orig.clear.call(this); } catch (_) {}
        try { getMap(this).clear(); } catch (_) {}
      };
    } catch (e) {
      console.warn('Storage hardening patch failed', e);
    }
  })();

  // 2) Dependency loader (fallback CDNs)
  window.ProCodeDeps = window.ProCodeDeps || (function(){
    const loaded = new Set();

    function waitFor(check, timeoutMs = 12000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        const tick = () => {
          try { if (check()) return resolve(true); } catch (_) {}
          if (Date.now() - start > timeoutMs) return reject(new Error('timeout'));
          requestAnimationFrame(tick);
        };
        tick();
      });
    }

    function loadScript(url) {
      return new Promise((resolve, reject) => {
        if (loaded.has(url)) return resolve(true);
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.onload = () => { loaded.add(url); resolve(true); };
        s.onerror = () => reject(new Error('Failed to load script: ' + url));
        document.head.appendChild(s);
      });
    }

    async function ensureAny(urls, check) {
      if (check()) return true;
      for (const url of urls) {
        try {
          await loadScript(url);
          await waitFor(check, 15000);
          return true;
        } catch (e) {
          console.warn(e);
        }
      }
      throw new Error('Missing dependency (all fallbacks failed)');
    }

    return {
      ensureToastify: () => ensureAny([
        'https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js'
      ], () => typeof window.Toastify === 'function'),

      ensureJSZip: () => ensureAny([
        'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
        'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js'
      ], () => typeof window.JSZip === 'function'),

      ensureFileSaver: () => ensureAny([
        'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js',
        'https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js'
      ], () => typeof window.saveAs === 'function'),

      ensureMarked: () => ensureAny([
        'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js'
      ], () => typeof window.marked === 'function'),

      ensureBabel: () => ensureAny([
        'https://unpkg.com/@babel/standalone@7.23.6/babel.min.js',
        'https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.6/babel.min.js'
      ], () => (window.Babel && typeof Babel.transform === 'function')),

      ensurePyodideLoader: () => ensureAny([
        'https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js'
      ], () => typeof window.loadPyodide === 'function'),

      ensureAll: async () => {
        const results = {};
        const tasks = [
          ['Toastify', 'ensureToastify'],
          ['JSZip', 'ensureJSZip'],
          ['FileSaver', 'ensureFileSaver'],
          ['marked', 'ensureMarked'],
          ['Babel', 'ensureBabel'],
          ['Pyodide', 'ensurePyodideLoader']
        ];
        for (const [name, fn] of tasks) {
          try { await window.ProCodeDeps[fn](); results[name] = 'OK'; }
          catch (_) { results[name] = 'MISSING'; }
        }
        return results;
      }
    };
  })();

  // 3) Runner.runPython hardening (handle missing loadPyodide gracefully)
  (function(){
    try {
      if (!window.Runner || typeof Runner.runPython !== 'function') return;
      if (Runner.__pc_v10_patched_py__) return;
      Runner.__pc_v10_patched_py__ = true;

      const orig = Runner.runPython.bind(Runner);
      Runner.runPython = function(path) {
        try {
          if (!window.pyodide && typeof window.loadPyodide !== 'function' &&
              window.ProCodeDeps && typeof ProCodeDeps.ensurePyodideLoader === 'function') {
            try { Console?.info?.('Loading Pyodide loader (fallback)'); } catch (_) {}
            ProCodeDeps.ensurePyodideLoader()
              .then(() => orig(path))
              .catch(err => {
                try { Console?.error?.('Pyodide loader unavailable:', err); } catch (_) {}
                try { Runner.updateRunButton?.(false); } catch (_) {}
                try { Utils?.toast?.('Pyodide loader missing (offline?). Cannot run Python.', 'error'); } catch (_) {}
              });
            return;
          }
        } catch (_) {}
        return orig(path);
      };
    } catch (e) {
      console.warn('Runner Python patch failed', e);
    }
  })();

  // 4) Breakpoints persistence (survive reloads)
  (function(){
    try {
      if (!window.Debugger) return;
      if (Debugger.__pc_v10_bp__) return;
      Debugger.__pc_v10_bp__ = true;

      const KEY = 'procodeide.breakpoints.v1';

      Debugger.saveBreakpoints = function() {
        try {
          const arr = Array.from(this.breakpoints?.values?.() || [])
            .filter(b => b && b.path && typeof b.line === 'number')
            .map(b => ({ path: b.path, line: b.line, condition: b.condition || null }));
          localStorage.setItem(KEY, JSON.stringify({ v: 1, ts: Date.now(), breakpoints: arr }));
        } catch (e) {
          console.warn('Failed to save breakpoints', e);
        }
      };

      Debugger.loadBreakpoints = function() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return;
          const obj = JSON.parse(raw);
          if (!obj || !Array.isArray(obj.breakpoints)) return;

          this.breakpoints = new Map();
          for (const b of obj.breakpoints) {
            if (!b || !b.path || typeof b.line !== 'number') continue;
            const key = `${b.path}:${b.line}`;
            this.breakpoints.set(key, { path: b.path, line: b.line, condition: b.condition || null, hitCount: 0 });
          }
        } catch (e) {
          console.warn('Failed to load breakpoints', e);
        }
      };

      if (typeof Debugger.toggleBreakpoint === 'function') {
        const origToggle = Debugger.toggleBreakpoint.bind(Debugger);
        Debugger.toggleBreakpoint = function(line) {
          const r = origToggle(line);
          try { Debugger.saveBreakpoints(); } catch (_) {}
          return r;
        };
      }

      try { Debugger.loadBreakpoints(); } catch (_) {}

      window.addEventListener('load', () => {
        setTimeout(() => {
          try { Debugger.setupBreakpoints?.(); } catch (_) {}
        }, 1200);
      });
    } catch (e) {
      console.warn('Breakpoint persistence patch failed', e);
    }
  })();

  // 5) System diagnostics modal (Ctrl+Shift+D)
  window.SystemDiagnostics = window.SystemDiagnostics || {
    collect: async function() {
      const deps = {
        Monaco: !!(window.monaco && monaco.editor),
        JSZip: typeof window.JSZip === 'function',
        FileSaver: typeof window.saveAs === 'function',
        Toastify: typeof window.Toastify === 'function',
        marked: typeof window.marked === 'function',
        Babel: !!(window.Babel && typeof Babel.transform === 'function'),
        PyodideLoader: typeof window.loadPyodide === 'function',
        PyodideRuntime: !!window.pyodide
      };

      let sw = { supported: ('serviceWorker' in navigator), registered: false, scope: '', state: '' };
      try {
        if (sw.supported) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            sw.registered = true;
            sw.scope = reg.scope || '';
            sw.state = reg.active ? reg.active.state : (reg.installing ? reg.installing.state : '');
          }
        }
      } catch (_) {}

      let storage = { localStorage: true, sessionStorage: true };
      try { localStorage.setItem('__pc_test__', '1'); localStorage.removeItem('__pc_test__'); } catch (_) { storage.localStorage = false; }
      try { sessionStorage.setItem('__pc_test__', '1'); sessionStorage.removeItem('__pc_test__'); } catch (_) { storage.sessionStorage = false; }

      const errors = (window.errorHandler && typeof errorHandler.getRecentErrors === 'function')
        ? errorHandler.getRecentErrors()
        : [];

      return {
        ts: new Date().toISOString(),
        ide: { version: window.IDE?.version, build: window.IDE?.build },
        url: location.href,
        online: navigator.onLine,
        ua: navigator.userAgent,
        storage,
        deps,
        serviceWorker: sw,
        recentErrors: errors.slice(0, 25)
      };
    },

    show: async function() {
      let report;
      try { report = await this.collect(); } catch (e) { report = { error: String(e) }; }

      const pretty = (obj) => {
        try { return JSON.stringify(obj, null, 2); } catch (_) { return String(obj); }
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal" style="width:860px; max-width:95vw;">
          <div class="modal-header">
            <h3><i class="fas fa-stethoscope"></i> System Diagnostics</h3>
            <button class="btn icon small" onclick="this.closest('.modal-overlay').remove()"><i class="fas fa-times"></i></button>
          </div>
          <div class="modal-body" style="max-height:70vh; overflow:auto;">
            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
              <button class="btn" id="pc-diag-copy"><i class="fas fa-copy"></i> Copy report</button>
              <button class="btn" id="pc-diag-load"><i class="fas fa-cloud-download-alt"></i> Load missing deps</button>
              <button class="btn" id="pc-diag-refresh"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <pre style="white-space:pre-wrap; background:var(--bg-secondary); border:1px solid var(--border); padding:12px; border-radius:10px; font-size:12px;">${pretty(report)}</pre>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const close = () => { try { modal.remove(); } catch (_) {} };
      modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

      const copyBtn = modal.querySelector('#pc-diag-copy');
      const loadBtn = modal.querySelector('#pc-diag-load');
      const refBtn  = modal.querySelector('#pc-diag-refresh');

      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          const txt = pretty(report);
          try {
            await navigator.clipboard.writeText(txt);
            Utils?.toast?.('Diagnostics copied to clipboard', 'success');
          } catch (_) {
            try {
              const ta = document.createElement('textarea');
              ta.value = txt;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              ta.remove();
              Utils?.toast?.('Diagnostics copied (fallback)', 'success');
            } catch (_) {
              Utils?.toast?.('Copy failed', 'error');
            }
          }
        });
      }

      if (loadBtn) {
        loadBtn.addEventListener('click', async () => {
          try {
            Utils?.toast?.('Loading missing dependencies...', 'info');
            await (window.ProCodeDeps?.ensureAll?.() || Promise.resolve({}));
            Utils?.toast?.('Dependency load completed', 'success');
            report = await this.collect();
            const pre = modal.querySelector('pre');
            if (pre) pre.textContent = pretty(report);
          } catch (_) {
            Utils?.toast?.('Failed to load dependencies', 'error');
          }
        });
      }

      if (refBtn) {
        refBtn.addEventListener('click', async () => {
          report = await this.collect();
          const pre = modal.querySelector('pre');
          if (pre) pre.textContent = pretty(report);
        });
      }
    }
  };

  // 6) Shortcut + Command Palette integration
  (function(){
    // Ctrl+Shift+D
    window.addEventListener('keydown', (e) => {
      try {
        if (e.ctrlKey && e.shiftKey && (e.key === 'D' || e.key === 'd')) {
          e.preventDefault();
          window.SystemDiagnostics?.show?.();
        }
      } catch (_) {}
    });

    // Inject into UltraPlus entries if available
    try {
      if (window.UltraPlus && typeof UltraPlus.getCommandPaletteEntries === 'function' && !UltraPlus.__pc_v10_diag__) {
        UltraPlus.__pc_v10_diag__ = true;
        const orig = UltraPlus.getCommandPaletteEntries.bind(UltraPlus);
        UltraPlus.getCommandPaletteEntries = function() {
          const list = orig() || [];
          list.push({ name: 'Diagnostics: System Report', shortcut: 'Ctrl+Shift+D', icon: 'fa-stethoscope', action: () => SystemDiagnostics.show() });
          list.push({ name: 'System: Load Missing Dependencies', shortcut: '', icon: 'fa-cloud-download-alt', action: async () => {
            try { Utils?.toast?.('Loading missing dependencies...', 'info'); await ProCodeDeps.ensureAll(); Utils?.toast?.('Dependencies loaded', 'success'); } catch (_) { Utils?.toast?.('Failed to load dependencies', 'error'); }
          }});
          return list;
        };
      }
    } catch (_) {}
  })();

  // 7) Build string update
  try {
    if (window.IDE && typeof IDE.build === 'string' && IDE.build.indexOf('SUPERPATCH v10') === -1) {
      IDE.build = IDE.build + ' / SUPERPATCH v10-INFINITY (2025-12-31)';
    }
  } catch (_) {}
})();


</script>
</body>
</html>
